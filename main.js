/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var ie=Object.defineProperty;var Ie=Object.getOwnPropertyDescriptor;var Ne=Object.getOwnPropertyNames;var we=Object.prototype.hasOwnProperty;var Le=(s,a)=>{for(var e in a)ie(s,e,{get:a[e],enumerable:!0})},Pe=(s,a,e,n)=>{if(a&&typeof a=="object"||typeof a=="function")for(let t of Ne(a))!we.call(s,t)&&t!==e&&ie(s,t,{get:()=>a[t],enumerable:!(n=Ie(a,t))||n.enumerable});return s};var be=s=>Pe(ie({},"__esModule",{value:!0}),s);var Ze={};Le(Ze,{default:()=>te});module.exports=be(Ze);var N=require("obsidian");var L=class{static error(a,e){console.error(`${this.PREFIX} ERROR:`,a,e!==void 0?e:"")}static warn(a,e){console.warn(`${this.PREFIX} WARN:`,a,e!==void 0?e:"")}static info(a,e){console.info(`${this.PREFIX} INFO:`,a,e!==void 0?e:"")}static debug(a,e){var t,i;let n=!1;try{typeof process!="undefined"&&(process!=null&&process.env)&&(n=!1)}catch(r){n=!1}!n&&typeof window!="undefined"&&(n=((t=window.location)==null?void 0:t.hostname)==="localhost"||((i=window.location)==null?void 0:i.hostname)==="127.0.0.1"),n&&console.debug(`${this.PREFIX} DEBUG:`,a,e!==void 0?e:"")}};L.PREFIX="[Vault Organizer]";var D={MAX_PATTERN_LENGTH:500,MAX_CAPTURING_GROUPS:20,MAX_NESTING_DEPTH:10,MAX_ALTERNATIONS:50},Ce=[/\([^)]*[+*]\)[+*]/,/[+*]{2,}/,/\([^)]*\|[^)]*\)[+*]/,/\(\([^)]*[+*]\)[+*]\)/];function ae(s,a){let e=[];if(s.length>D.MAX_PATTERN_LENGTH)return{valid:!1,error:`Pattern too long (${s.length} chars). Maximum: ${D.MAX_PATTERN_LENGTH}`};for(let r of Ce)if(r.test(s))return{valid:!1,error:"Pattern contains potentially dangerous nested quantifiers that could cause performance issues"};let n=(s.match(/(?<!\\)\(/g)||[]).length;if(n>D.MAX_CAPTURING_GROUPS)return{valid:!1,error:`Too many capturing groups (${n}). Maximum: ${D.MAX_CAPTURING_GROUPS}`};let t=(s.match(/(?<!\\)\|/g)||[]).length;if(t>D.MAX_ALTERNATIONS)return{valid:!1,error:`Too many alternations (${t}). Maximum: ${D.MAX_ALTERNATIONS}`};let i=xe(s);if(i>D.MAX_NESTING_DEPTH)return{valid:!1,error:`Nesting too deep (${i} levels). Maximum: ${D.MAX_NESTING_DEPTH}`};s.includes(".*.*")&&e.push("Pattern contains multiple .* which may be slow on large inputs"),s.includes(".+.+")&&e.push("Pattern contains multiple .+ which may be slow on large inputs");try{return{valid:!0,regex:new RegExp(s,a),warnings:e.length>0?e:void 0}}catch(r){return{valid:!1,error:`Invalid regex syntax: ${r instanceof Error?r.message:String(r)}`}}}function xe(s){let a=0,e=0,n=!1;for(let t=0;t<s.length;t++){let i=s[t];if(n){n=!1;continue}if(i==="\\"){n=!0;continue}i==="("?(e++,a=Math.max(a,e)):i===")"&&(e=Math.max(0,e-1))}return a}function Te(s,a){var u;let e=a[s.key];if(e==null)return!1;let n=Array.isArray(e),t=n?e:[e],i=(u=s.matchType)!=null?u:"equals";if(i==="regex"){if(!(s.value instanceof RegExp))return!1;let c=s.value;return c.lastIndex=0,t.some(h=>{let p=String(h);return c.lastIndex=0,c.test(p)})}let r=De(String(s.value),n),o=i==="contains"||i==="starts-with"||i==="ends-with"?r.filter(c=>c.length>0):r;return o.length?t.some(c=>{let h=String(c);return o.some(p=>Me(h,p,i,s.caseInsensitive))}):!1}function re(s,a,e){var t;let n=e!=null?e:(t=this.app.metadataCache.getFileCache(s))==null?void 0:t.frontmatter;if(n)return a.find(i=>{var h;if(i.enabled===!1)return!1;let r={key:i.key,matchType:i.matchType,value:i.value,caseInsensitive:i.caseInsensitive},o=Te(r,n);if(!i.conditions||i.conditions.length===0)return o;let u=i.conditions.map(p=>Te(p,n));return((h=i.conditionOperator)!=null?h:"AND")==="AND"?o&&u.every(p=>p):o||u.some(p=>p)})}function De(s,a){if(!a)return[s];let e=s.trim(),n=e.split(/\s+/).map(i=>i.trim()).filter(Boolean);if(!n.length)return[e];let t=new Set;return e&&t.add(e),n.forEach(i=>t.add(i)),Array.from(t)}function Me(s,a,e,n){let t=n?s.toLowerCase():s,i=n?a.toLowerCase():a;switch(e){case"contains":return t.includes(i);case"starts-with":return t.startsWith(i);case"ends-with":return t.endsWith(i);case"equals":default:return t===i}}function Fe(s){var e;let a=(e=s.matchType)!=null?e:"equals";if(a==="regex"){let n=s.value instanceof RegExp?s.value.source:String(s.value),t=s.value instanceof RegExp?s.value.flags:"";return{key:s.key,matchType:a,value:n,isRegex:!0,flags:t,caseInsensitive:s.caseInsensitive}}return{key:s.key,matchType:a,value:String(s.value),caseInsensitive:s.caseInsensitive}}function ve(s){return s.map(a=>{var t,i;let e=(t=a.matchType)!=null?t:"equals",n={key:a.key,matchType:e,value:e==="regex"&&a.value instanceof RegExp?a.value.source:String(a.value),destination:a.destination,enabled:(i=a.enabled)!=null?i:!1,debug:a.debug,caseInsensitive:a.caseInsensitive,conditionOperator:a.conditionOperator,conflictResolution:a.conflictResolution};return e==="regex"&&(n.isRegex=!0,n.flags=a.value instanceof RegExp?a.value.flags:""),a.conditions&&a.conditions.length>0&&(n.conditions=a.conditions.map(Fe)),n})}function oe(s){return s==="contains"||s==="starts-with"||s==="ends-with"}function le(s){return typeof s.value=="string"&&s.value.trim().length>0}function Ue(s){var e;let a=(e=s.matchType)!=null?e:s.isRegex?"regex":"equals";if(a==="regex"){let n=ae(s.value,s.flags);if(!n.valid){L.warn(`Failed to deserialize regex condition for key "${s.key}": ${n.error}`,s.value);return}return n.warnings&&n.warnings.length>0&&L.warn(`Regex condition for key "${s.key}" has warnings`,n.warnings.join("; ")),{key:s.key,matchType:a,value:n.regex,caseInsensitive:s.caseInsensitive}}return{key:s.key,matchType:a,value:s.value,caseInsensitive:s.caseInsensitive}}function Re(s=[]){let a=[],e=[],n=[];return s.forEach((t,i)=>{var u,c,h;let r=(u=t.matchType)!=null?u:t.isRegex?"regex":"equals",o;if(t.conditions&&t.conditions.length>0){let p=t.conditions.map(Ue).filter(m=>m!==void 0);p.length>0&&(o=p)}if(r==="regex"){let p=ae(t.value,t.flags);if(p.valid){p.warnings&&p.warnings.length>0&&L.warn(`Regex for frontmatter rule "${t.key}" has performance warnings`,p.warnings.join("; "));let m={key:t.key,matchType:r,value:p.regex,destination:t.destination,enabled:(c=t.enabled)!=null?c:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:o,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};a.push(m),e.push({index:i,rule:m})}else{let m=p.error||"Unknown validation error",T=t.destination?` (destination: "${t.destination}")`:"";L.warn(`Failed to deserialize regex for frontmatter rule "${t.key}"${T}: ${m}. Rule will be ignored.`,t.value),n.push({index:i,message:m,rule:{...t,matchType:r},cause:new Error(m)})}}else{let p={key:t.key,matchType:r,value:t.value,destination:t.destination,enabled:(h=t.enabled)!=null?h:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:o,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};a.push(p),e.push({index:i,rule:p})}}),{rules:a,successes:e,errors:n}}var F=class extends Error{constructor(a){super(a),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},ce=class extends F{constructor(e,n,t){let i=k(n);super(`Permission denied: Cannot ${i} "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${k(this.operation)} "${this.filePath}". Check file permissions and try again.`}},M=class extends F{constructor(e,n,t,i,r){let o=k(i),u=n?`Cannot ${o} "${e}" to "${n}"`:`Cannot ${o} "${e}"`;super(`File conflict: ${u} - file ${t}`);this.sourcePath=e;this.destinationPath=n;this.conflictType=t;this.operation=i;this.originalError=r}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use","max-attempts":"exceeded maximum attempts to find a unique filename"},n=k(this.operation);return`${this.destinationPath?`Cannot ${n} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${n} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},I=class extends F{constructor(e,n,t){super(`Invalid path "${e}": ${n}${t?` - ${t}`:""}`);this.path=e;this.reason=n;this.details=t}getUserMessage(){let n={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${n}${t}.`}},ue=class extends F{constructor(e,n,t){let i=k(n);super(`File operation failed: ${i} on "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){var t;let e=k(this.operation),n=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${n}.`}};function G(s,a,e,n){let t=s instanceof Error?s:new Error(String(s)),i=t.message.toLowerCase(),r="code"in t?t.code:void 0;return r==="EACCES"||r==="EPERM"||i.includes("permission")||i.includes("eacces")||i.includes("eperm")||i.includes("access denied")?new ce(a,e,t):r==="EEXIST"||i.includes("already exists")||i.includes("eexist")||i.includes("file exists")?new M(a,n||a,"exists",e,t):r==="EBUSY"||i.includes("locked")||i.includes("ebusy")?new M(a,n||a,"locked",e,t):r==="ETXTBSY"||i.includes("in use")||i.includes("being used")||i.includes("etxtbsy")?new M(a,n||a,"in-use",e,t):r==="EINVAL"||i.includes("invalid path")||i.includes("invalid character")||i.includes("einval")?new I(n||a,"invalid-characters",t.message):r==="ENAMETOOLONG"||i.includes("path too long")||i.includes("enametoolong")?new I(n||a,"too-long",t.message):new ue(a,e,t)}function k(s){return s.replace(/-/g," ")}var Se=require("obsidian");var W={MAX_UNIQUE_FILENAME_ATTEMPTS:100,BULK_OPERATION_BATCH_SIZE:100,BULK_OPERATION_BATCH_DELAY_MS:10},ge={SETTINGS_SAVE_MS:300,METADATA_REFRESH_MS:1e3},V={WINDOWS_MAX_PATH:260,UNIX_MAX_PATH:4096,MAX_COMPONENT_LENGTH:255,MAX_ARRAY_PATH_DEPTH:5};var Ve=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),ze=/[<>:"|?*\x00-\x1F]/,$e=/^([A-Za-z]:[\\/]|\/)/,ke=/(^|[\\/])\.\.($|[\\/])/,Be=/\/{2,}|\\{2,}/;function X(s,a={}){let{allowEmpty:e=!1,allowAbsolute:n=!1,maxLength:t=V.WINDOWS_MAX_PATH,checkReservedNames:i=!0}=a,r=[];if(!s||s.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:r}:{valid:!1,error:new I(s,"empty")};if($e.test(s)&&!n)return{valid:!1,error:new I(s,"absolute","Use relative paths within the vault")};if(ke.test(s))return{valid:!1,error:new I(s,"traversal",'Paths cannot contain ".." segments')};let o=(0,Se.normalizePath)(s);Be.test(o)&&(o=o.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),r.push("Multiple consecutive slashes were normalized")),o=o.trim().replace(/^\/+|\/+$/g,"");let u=o.match(ze);if(u)return{valid:!1,error:new I(s,"invalid-characters",`Contains invalid character: "${u[0]}"`)};if(o.length>t)return{valid:!1,error:new I(s,"too-long",`Path length (${o.length}) exceeds maximum (${t})`)};let c=o.split("/").filter(Boolean);for(let h of c){if(h.length>V.MAX_COMPONENT_LENGTH)return{valid:!1,error:new I(s,"too-long",`Path component "${h}" exceeds ${V.MAX_COMPONENT_LENGTH} characters`)};if(i){let p=h.split(".")[0].toUpperCase();if(Ve.has(p))return{valid:!1,error:new I(s,"reserved-name",`"${h}" is a reserved system name on Windows`)}}if(h.endsWith(".")||h.endsWith(" "))return{valid:!1,error:new I(s,"invalid-characters",`Path component "${h}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:o,warnings:r.length>0?r:void 0}}function de(s){return X(s,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var q={REORGANIZE:{name:"Reorganize notes based on frontmatter rules",description:"Apply all configured rules to reorganize vault files"},UNDO:{name:"Undo last automatic move",description:"Revert the most recent file move"},VIEW_HISTORY:{name:"View move history",description:"Show all recent file moves and undo options"}},v={RULE_NAME:"Frontmatter rule",RULE_DESCRIPTION:"Move files to destination folder based on frontmatter matching",EXCLUSION_PATTERNS_NAME:"Exclusion Patterns",EXCLUSION_PATTERNS_DESCRIPTION:"Files and folders matching these patterns will not be automatically organized",TOOLTIPS:{ACTIVATE_RULE:"Activate this rule",MOVE_UP:"Move rule up",MOVE_DOWN:"Move rule down",BROWSE_FRONTMATTER:"Browse frontmatter keys",BROWSE_TAGS:"Browse tags",CASE_INSENSITIVE:"Case insensitive matching",DEBUG_MODE:"Enable debug mode",TEST_ALL_RULES:"Preview what moves would be made without actually moving files",CONFLICT_RESOLUTION:"How to handle file conflicts at destination",CONDITION_OPERATOR:"How to combine multiple conditions (AND/OR)",ADD_CONDITION:"Add another condition to this rule",EXCLUSION_PATTERN:"Glob pattern (e.g., Templates/**, *.excalidraw)"},PLACEHOLDERS:{KEY:"key",VALUE:"value",DESTINATION:"destination folder (supports {variables})",FLAGS:"flags",EXCLUSION_PATTERN:"e.g., Templates/**, Archive/**"},BUTTONS:{REMOVE:"Remove",ADD_RULE:"Add Rule",APPLY_NOW:"Apply now",TEST_ALL_RULES:"Test All Rules",ADD_CONDITION:"+",REMOVE_CONDITION:"Remove Condition",ADD_EXCLUSION:"Add Pattern"},LABELS:{CONFLICT_RESOLUTION:"On Conflict:",CONDITION_OPERATOR:"Combine:",CONDITIONS_SECTION:"Additional Conditions"},WARNINGS:{INVALID_REGEX:s=>`Invalid regular expression: ${s}`,VALUE_REQUIRED:"Value is required for contains/starts-with/ends-with rules."}},O={TEST_ALL_RULES:{TITLE:"Test All Rules - Preview",NO_MOVES_OVERALL:"No files would be moved. All files are either already in the correct location or have no matching rules.",NO_MOVES_ALREADY_CORRECT:"No files would be moved. All matching files are already in the correct location.",FILES_WOULD_MOVE:s=>`${s} file(s) would be moved:`,SKIPPED_SECTION:"Skipped due to invalid destinations",INVALID_DESTINATION_WARNING:"Destination path is invalid and the move cannot be previewed.",LABELS:{FILE:"File:",FROM:"From:",TO:"To:",RULE:"Rule:",WARNINGS:"Warnings:"},BUTTONS:{CLOSE:"Close"}},MOVE_HISTORY:{TITLE:"Move History",NO_HISTORY:"No move history yet.",SHOWING_COUNT:(s,a)=>`Showing ${s} of last ${a} moves.`,MOST_RECENT_PREFIX:"\u{1F504} Most Recent: ",TIME_PREFIX:s=>`\u23F0 ${s}`,LABELS:{FROM:"From:",TO:"To:",RULE:"Rule:"},BUTTONS:{UNDO:"Undo This Move",CLEAR_HISTORY:"Clear History",CLOSE:"Close"},NOTICES:{HISTORY_CLEARED:"Move history cleared."}}},C={UNDO:{NO_MOVES:"No moves to undo.",FILE_NOT_EXISTS:s=>`Cannot undo: File no longer exists at ${s}`,NOT_A_FILE:s=>`Cannot undo: ${s} is not a file.`,DESTINATION_EXISTS:s=>`Cannot undo: A file already exists at ${s}`,SUCCESS:(s,a)=>`Undone: Moved ${s} back to ${a}`},DEBUG:{EMPTY_DESTINATION:(s,a)=>`DEBUG: ${s} would not be moved because destination is empty in ${a}.`,WOULD_MOVE:(s,a,e)=>`DEBUG: ${s} would be moved to ${a}/${e}`},REGEX_PARSE_ERROR:(s,a)=>`Failed to parse regular expression for rule "${s}": ${a}`},ye={NESTED_BATCH_OPERATION:"Nested batch operations are not supported. Using existing batch context."},K={FILE_PROCESSING:{EXPECTED_ERROR:s=>`Expected error during file processing - ${s}`,UNEXPECTED_ERROR:"Unexpected error during file processing",UNDO_FAILED:"Undo operation failed"}},B={equals:"Equals",contains:"Contains","starts-with":"Starts with","ends-with":"Ends with",regex:"Regex"};var he={rules:[],moveHistory:[],maxHistorySize:50,excludePatterns:[]},pe=[{value:"equals",label:B.equals},{value:"contains",label:B.contains},{value:"starts-with",label:B["starts-with"]},{value:"ends-with",label:B["ends-with"]},{value:"regex",label:B.regex}];function Y(s){var n,t,i,r,o,u;let a=(n=s.matchType)!=null?n:s.isRegex?"regex":"equals",e={...s,matchType:a,key:(t=s.key)!=null?t:"",value:(i=s.value)!=null?i:"",destination:(r=s.destination)!=null?r:"",enabled:(o=s.enabled)!=null?o:!1};return a==="regex"?(e.isRegex=!0,e.flags=(u=s.flags)!=null?u:""):(delete e.isRegex,delete e.flags),e}var w=require("obsidian");var U=require("obsidian");var j=class extends U.FuzzySuggestModal{constructor(e,n,t){super(e);this.tags=n;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},Z=class extends U.FuzzySuggestModal{constructor(e,n,t){super(e);this.keys=n;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},Q=class extends U.Modal{constructor(e,n,t){super(e);this.results=n;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:O.TEST_ALL_RULES.TITLE});let n=this.results.filter(o=>o.newPath&&!o.error),t=this.results.filter(o=>o.error);if(n.length===0&&t.length===0)e.createEl("p",{text:O.TEST_ALL_RULES.NO_MOVES_OVERALL});else{if(n.length){e.createEl("p",{text:O.TEST_ALL_RULES.FILES_WOULD_MOVE(n.length)});let o=e.createDiv({cls:"vault-organizer-test-results"});o.style.maxHeight="400px",o.style.overflowY="auto",o.style.marginTop="1em",n.forEach(u=>{var A,_;let c=o.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let h=c.createDiv();h.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:u.file.basename});let p=c.createDiv();p.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:u.currentPath});let m=c.createDiv();m.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.TO}),m.createSpan({text:u.newPath||"(unknown)"});let T=c.createDiv();if(T.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.RULE}),T.createSpan({text:`Rule ${u.ruleIndex+1} (${((A=this.rules[u.ruleIndex])==null?void 0:A.key)||"unknown"})`}),(_=u.warnings)!=null&&_.length){let g=c.createDiv();g.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.WARNINGS}),g.createSpan({text:u.warnings.join("; ")})}})}else e.createEl("p",{text:O.TEST_ALL_RULES.NO_MOVES_ALREADY_CORRECT});if(t.length){e.createEl("h3",{text:O.TEST_ALL_RULES.SKIPPED_SECTION});let o=e.createDiv({cls:"vault-organizer-test-results"});o.style.maxHeight="400px",o.style.overflowY="auto",o.style.marginTop="1em",t.forEach(u=>{var A,_,g,l;let c=o.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let h=c.createDiv();h.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:u.file.basename});let p=c.createDiv();p.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:u.currentPath});let m=c.createDiv();m.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.RULE}),m.createSpan({text:`Rule ${u.ruleIndex+1} (${((A=this.rules[u.ruleIndex])==null?void 0:A.key)||"unknown"})`});let T=c.createDiv();if(T.createEl("strong",{text:"Reason: "}),T.createSpan({text:(g=(_=u.error)==null?void 0:_.getUserMessage())!=null?g:O.TEST_ALL_RULES.INVALID_DESTINATION_WARNING}),(l=u.warnings)!=null&&l.length){let d=c.createDiv();d.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.WARNINGS}),d.createSpan({text:u.warnings.join("; ")})}})}}let i=e.createDiv({cls:"modal-button-container"});i.style.marginTop="1.5em",i.style.textAlign="right";let r=i.createEl("button",{text:O.TEST_ALL_RULES.BUTTONS.CLOSE});r.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},J=class extends U.Modal{constructor(e,n){super(e);this.plugin=n}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:O.MOVE_HISTORY.TITLE}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:O.MOVE_HISTORY.NO_HISTORY});else{e.createEl("p",{text:O.MOVE_HISTORY.SHOWING_COUNT(this.plugin.settings.moveHistory.length,this.plugin.settings.maxHistorySize)});let r=e.createDiv({cls:"vault-organizer-history-container"});r.style.maxHeight="500px",r.style.overflowY="auto",r.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((o,u)=>{let c=r.createDiv({cls:"vault-organizer-history-item"});c.style.marginBottom="1em",c.style.padding="0.8em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px",c.style.position="relative",u===0&&(c.style.backgroundColor="var(--background-secondary-alt)",c.style.borderColor="var(--interactive-accent)");let h=c.createDiv();h.style.marginBottom="0.5em",h.style.fontWeight="bold";let m=new Date(o.timestamp).toLocaleString();u===0&&h.createEl("span",{text:O.MOVE_HISTORY.MOST_RECENT_PREFIX,cls:"vault-organizer-recent-label"}),h.createSpan({text:o.fileName});let T=c.createDiv();T.style.fontSize="0.9em",T.style.color="var(--text-muted)",T.style.marginBottom="0.5em",T.textContent=O.MOVE_HISTORY.TIME_PREFIX(m);let A=c.createDiv();A.createEl("strong",{text:O.MOVE_HISTORY.LABELS.FROM}),A.createSpan({text:o.fromPath});let _=c.createDiv();_.createEl("strong",{text:O.MOVE_HISTORY.LABELS.TO}),_.createSpan({text:o.toPath});let g=c.createDiv();if(g.createEl("strong",{text:O.MOVE_HISTORY.LABELS.RULE}),g.createSpan({text:o.ruleKey||"(unknown)"}),u===0){let l=c.createDiv();l.style.marginTop="0.8em";let d=l.createEl("button",{text:O.MOVE_HISTORY.BUTTONS.UNDO});d.style.backgroundColor="var(--interactive-accent)",d.style.color="var(--text-on-accent)",d.style.padding="0.4em 0.8em",d.style.border="none",d.style.borderRadius="4px",d.style.cursor="pointer",d.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="1.5em",n.style.textAlign="right";let t=n.createEl("button",{text:O.MOVE_HISTORY.BUTTONS.CLEAR_HISTORY});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new U.Notice(O.MOVE_HISTORY.NOTICES.HISTORY_CLEARED),this.close()};let i=n.createEl("button",{text:O.MOVE_HISTORY.BUTTONS.CLOSE});i.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};function Oe(s){let a=new Set(["g","i","m","s","u","y","d"]),e=s.split(""),n=[],t=[];for(let i of e)a.has(i)?t.includes(i)||t.push(i):i.trim()&&n.push(i);return{valid:n.length===0,sanitized:t.join(""),invalid:n}}var ee=class extends w.PluginSettingTab{constructor(e,n){super(e,n);this.aggregatedTags=[];this.frontmatterKeys=[];this.metadataCacheDirty=!0;this.plugin=n,this.debouncedSaveOnly=(0,w.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},ge.SETTINGS_SAVE_MS),this.debouncedRefreshMetadata=(0,w.debounce)(()=>{this.metadataCacheDirty=!0},ge.METADATA_REFRESH_MS),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.debouncedRefreshMetadata()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,i,r;let e=new Set;((r=(i=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:i.call(t))!=null?r:[]).forEach(o=>{let u=this.plugin.app.metadataCache.getFileCache(o);if(!u)return;let c=(0,w.getAllTags)(u);c&&c.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((o,u)=>o.localeCompare(u)),this.metadataCacheDirty=!1}getAggregatedTags(){return(this.metadataCacheDirty||!this.aggregatedTags.length)&&this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,i,r;let e=new Set;((r=(i=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:i.call(t))!=null?r:[]).forEach(o=>{let u=this.plugin.app.metadataCache.getFileCache(o),c=u==null?void 0:u.frontmatter;c&&Object.keys(c).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((o,u)=>o.localeCompare(u)),this.metadataCacheDirty=!1}getFrontmatterKeys(){return(this.metadataCacheDirty||!this.frontmatterKeys.length)&&this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,n){if(!e.length)return;new j(this.app,e,n).open()}openFrontmatterKeyPicker(e,n){if(!e.length)return;new Z(this.app,e,n).open()}toggleTagValue(e,n){let t=e.split(/\s+/).filter(Boolean);return(t.includes(n)?t.filter(o=>o!==n):[...t,n]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.metadataCacheDirty=!0,this.plugin.settings.rules=this.plugin.settings.rules.map(Y),this.plugin.settings.rules.forEach((n,t)=>{var _;let i=(_=n.matchType)!=null?_:"equals",r=new w.Setting(e).setName(`${v.RULE_NAME} ${t+1}`).setDesc(v.RULE_DESCRIPTION);r.settingEl.classList.add("setting-item");let o=document.createElement("div");o.classList.add("vault-organizer-rule-message"),o.style.display="none",r.settingEl.appendChild(o);let u=()=>{var d;let g=this.plugin.settings.rules[t],l=(d=g==null?void 0:g.enabled)!=null?d:!1;r.settingEl.classList.toggle("vault-organizer-rule-disabled",!l)};r.addToggle(g=>{var l;return g.setTooltip(v.TOOLTIPS.ACTIVATE_RULE).setValue((l=n.enabled)!=null?l:!1).onChange(async d=>{let E=this.plugin.settings.rules[t];E&&(E.enabled=d,u(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),u())})}),r.addExtraButton(g=>g.setIcon("arrow-up").setTooltip(v.TOOLTIPS.MOVE_UP).setDisabled(t===0).onClick(async()=>{if(t===0)return;let l=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=l,this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(d){new w.Notice("Failed to save settings. Rule order was not changed."),console.error("Settings save error:",d);let E=this.plugin.settings.rules[t-1];this.plugin.settings.rules[t-1]=this.plugin.settings.rules[t],this.plugin.settings.rules[t]=E}})),r.addExtraButton(g=>g.setIcon("arrow-down").setTooltip(v.TOOLTIPS.MOVE_DOWN).setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let l=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=l,this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(d){new w.Notice("Failed to save settings. Rule order was not changed."),console.error("Settings save error:",d);let E=this.plugin.settings.rules[t+1];this.plugin.settings.rules[t+1]=this.plugin.settings.rules[t],this.plugin.settings.rules[t]=E}}));let c=()=>{var $;let g=this.plugin.getRuleErrorForIndex(t),l=this.plugin.settings.rules[t],d=($=l==null?void 0:l.matchType)!=null?$:"equals",E=oe(d),P=l?le(l):!1;g?(o.classList.add("vault-organizer-rule-error"),o.classList.remove("vault-organizer-rule-warning"),o.textContent=v.WARNINGS.INVALID_REGEX(g.message),o.style.display=""):E&&!P?(o.classList.add("vault-organizer-rule-warning"),o.classList.remove("vault-organizer-rule-error"),o.textContent=v.WARNINGS.VALUE_REQUIRED,o.style.display=""):(o.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),o.textContent="",o.style.display="none")},h;r.addText(g=>{h=g,g.setPlaceholder(v.PLACEHOLDERS.KEY).setValue(n.key).onChange(l=>{let d=this.plugin.settings.rules[t];d&&(d.key=l,this.scheduleSaveOnly())})}),r.addExtraButton(g=>g.setIcon("list").setTooltip(v.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let l=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(l,d=>{let E=this.plugin.settings.rules[t];!E||!h||(h.setValue(d),E.key=d,this.scheduleSaveOnly())})}));let p;r.addText(g=>{p=g,g.setPlaceholder(v.PLACEHOLDERS.VALUE).setValue(n.value).onChange(l=>{let d=this.plugin.settings.rules[t];d&&(d.value=l,this.scheduleSaveOnly(),c())})}),r.addExtraButton(g=>g.setIcon("hashtag").setTooltip(v.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let l=this.getAggregatedTags();this.openTagPicker(l,d=>{let E=this.plugin.settings.rules[t];if(!E||!p)return;let P=this.toggleTagValue(p.getValue(),d);p.setValue(P),E.value=P,this.scheduleSaveOnly()})})),r.addText(g=>g.setPlaceholder(v.PLACEHOLDERS.DESTINATION).setValue(n.destination).onChange(l=>{let d=this.plugin.settings.rules[t];d&&(d.destination=l,this.scheduleSaveOnly())}));let m,T,A=()=>{var d;let g=this.plugin.settings.rules[t],l=((d=g==null?void 0:g.matchType)!=null?d:"equals")==="regex";m&&(m.inputEl.toggleAttribute("disabled",!l),m.inputEl.disabled=!l,m.inputEl.style.display=l?"":"none"),T&&(T.toggleEl.style.display=l?"none":"")};r.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),pe.forEach(l=>g.addOption(l.value,l.label)),g.setValue(i).onChange(async l=>{var E;let d=this.plugin.settings.rules[t];d&&(d.matchType=l,l==="regex"?(d.isRegex=!0,d.flags=(E=d.flags)!=null?E:""):(delete d.isRegex,"flags"in d&&delete d.flags),A(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),A(),c())})}),r.addDropdown(g=>{var l;g.selectEl.setAttribute("aria-label","Conflict resolution"),g.selectEl.setAttribute("title",v.TOOLTIPS.CONFLICT_RESOLUTION),g.addOption("fail","Fail"),g.addOption("skip","Skip"),g.addOption("append-number","Add number"),g.addOption("append-timestamp","Add timestamp"),g.setValue((l=n.conflictResolution)!=null?l:"fail").onChange(d=>{let E=this.plugin.settings.rules[t];E&&(E.conflictResolution=d,this.scheduleSaveOnly())})}),r.addDropdown(g=>{var l;g.selectEl.setAttribute("aria-label","Condition operator"),g.selectEl.setAttribute("title",v.TOOLTIPS.CONDITION_OPERATOR),g.addOption("AND","AND"),g.addOption("OR","OR"),g.setValue((l=n.conditionOperator)!=null?l:"AND").onChange(d=>{let E=this.plugin.settings.rules[t];E&&(E.conditionOperator=d,this.scheduleSaveOnly())})}),r.addText(g=>{var l;m=g,g.setPlaceholder(v.PLACEHOLDERS.FLAGS).setValue((l=n.flags)!=null?l:"").onChange(d=>{let E=this.plugin.settings.rules[t];if(E&&E.matchType==="regex"){let P=Oe(d);P.valid?(g.inputEl.classList.remove("vault-organizer-invalid-flags"),g.inputEl.title=""):(g.inputEl.classList.add("vault-organizer-invalid-flags"),g.inputEl.title=`Invalid flag(s): ${P.invalid.join(", ")}. Valid flags: g, i, m, s, u, y, d`),E.flags=P.sanitized,d!==P.sanitized&&g.setValue(P.sanitized),this.scheduleSaveOnly()}})}),A(),r.addToggle(g=>{var l;T=g,g.setTooltip(v.TOOLTIPS.CASE_INSENSITIVE).setValue((l=n.caseInsensitive)!=null?l:!1).onChange(async d=>{let E=this.plugin.settings.rules[t];E&&(E.caseInsensitive=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),r.addToggle(g=>{var l;return g.setTooltip(v.TOOLTIPS.DEBUG_MODE).setValue((l=n.debug)!=null?l:!1).onChange(async d=>{let E=this.plugin.settings.rules[t];E&&(E.debug=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),r.addButton(g=>g.setButtonText(v.BUTTONS.ADD_CONDITION).setTooltip(v.TOOLTIPS.ADD_CONDITION).onClick(async()=>{let l=this.plugin.settings.rules[t];if(l){l.conditions||(l.conditions=[]),l.conditions.push({key:"",value:"",matchType:"equals"}),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(d){new w.Notice("Failed to save settings. Please try again."),console.error("Settings save error:",d),l.conditions.pop()}}})),r.addButton(g=>g.setButtonText(v.BUTTONS.REMOVE).onClick(async()=>{let l=this.plugin.settings.rules.splice(t,1)[0];this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(d){new w.Notice("Failed to save settings. Rule was not removed."),console.error("Settings save error:",d),this.plugin.settings.rules.splice(t,0,l)}})),n.conditions&&n.conditions.length>0&&n.conditions.forEach((g,l)=>{var fe;let d=new w.Setting(e).setName(`${v.LABELS.CONDITIONS_SECTION} ${l+1}`).setClass("vault-organizer-condition"),E;d.addText(S=>{E=S,S.setPlaceholder(v.PLACEHOLDERS.KEY).setValue(g.key).onChange(y=>{var R;let f=this.plugin.settings.rules[t];(R=f==null?void 0:f.conditions)!=null&&R[l]&&(f.conditions[l].key=y,this.scheduleSaveOnly())})}),d.addExtraButton(S=>S.setIcon("list").setTooltip(v.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let y=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(y,f=>{var b;let R=this.plugin.settings.rules[t];!((b=R==null?void 0:R.conditions)!=null&&b[l])||!E||(E.setValue(f),R.conditions[l].key=f,this.scheduleSaveOnly())})}));let P;d.addText(S=>{P=S,S.setPlaceholder(v.PLACEHOLDERS.VALUE).setValue(g.value).onChange(y=>{var R;let f=this.plugin.settings.rules[t];(R=f==null?void 0:f.conditions)!=null&&R[l]&&(f.conditions[l].value=y,this.scheduleSaveOnly())})}),d.addExtraButton(S=>S.setIcon("hashtag").setTooltip(v.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let y=this.getAggregatedTags();this.openTagPicker(y,f=>{var x;let R=this.plugin.settings.rules[t];if(!((x=R==null?void 0:R.conditions)!=null&&x[l])||!P)return;let b=this.toggleTagValue(P.getValue(),f);P.setValue(b),R.conditions[l].value=b,this.scheduleSaveOnly()})}));let $=(fe=g.matchType)!=null?fe:"equals",H,ne,se=()=>{var R,b;let S=this.plugin.settings.rules[t],y=(R=S==null?void 0:S.conditions)==null?void 0:R[l],f=((b=y==null?void 0:y.matchType)!=null?b:"equals")==="regex";H&&(H.inputEl.toggleAttribute("disabled",!f),H.inputEl.disabled=!f,H.inputEl.style.display=f?"":"none"),ne&&(ne.toggleEl.style.display=f?"none":"")};d.addDropdown(S=>{S.selectEl.setAttribute("aria-label","Match type"),pe.forEach(y=>S.addOption(y.value,y.label)),S.setValue($).onChange(async y=>{var R,b;let f=this.plugin.settings.rules[t];(R=f==null?void 0:f.conditions)!=null&&R[l]&&(f.conditions[l].matchType=y,y==="regex"?(f.conditions[l].isRegex=!0,f.conditions[l].flags=(b=f.conditions[l].flags)!=null?b:""):(delete f.conditions[l].isRegex,"flags"in f.conditions[l]&&delete f.conditions[l].flags),se(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),se())})}),d.addText(S=>{var y;H=S,S.setPlaceholder(v.PLACEHOLDERS.FLAGS).setValue((y=g.flags)!=null?y:"").onChange(f=>{var b;let R=this.plugin.settings.rules[t];if((b=R==null?void 0:R.conditions)!=null&&b[l]&&R.conditions[l].matchType==="regex"){let x=Oe(f);x.valid?(S.inputEl.classList.remove("vault-organizer-invalid-flags"),S.inputEl.title=""):(S.inputEl.classList.add("vault-organizer-invalid-flags"),S.inputEl.title=`Invalid flag(s): ${x.invalid.join(", ")}. Valid flags: g, i, m, s, u, y, d`),R.conditions[l].flags=x.sanitized,f!==x.sanitized&&S.setValue(x.sanitized),this.scheduleSaveOnly()}})}),d.addToggle(S=>{var y;ne=S,S.setTooltip(v.TOOLTIPS.CASE_INSENSITIVE).setValue((y=g.caseInsensitive)!=null?y:!1).onChange(async f=>{var b;let R=this.plugin.settings.rules[t];(b=R==null?void 0:R.conditions)!=null&&b[l]&&(R.conditions[l].caseInsensitive=f,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),d.addButton(S=>S.setButtonText(v.BUTTONS.REMOVE_CONDITION).onClick(async()=>{let y=this.plugin.settings.rules[t];if(!(y!=null&&y.conditions))return;let f=y.conditions.splice(l,1)[0];this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(R){new w.Notice("Failed to save settings. Condition was not removed."),console.error("Settings save error:",R),y.conditions.splice(l,0,f)}})),se()}),c(),u()}),new w.Setting(e).addButton(n=>n.setButtonText(v.BUTTONS.ADD_RULE).onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(t){new w.Notice("Failed to save settings. Rule was not added."),console.error("Settings save error:",t),this.plugin.settings.rules.pop()}})),new w.Setting(e).addButton(n=>n.setButtonText(v.BUTTONS.APPLY_NOW).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(n=>n.setButtonText(v.BUTTONS.TEST_ALL_RULES).setTooltip(v.TOOLTIPS.TEST_ALL_RULES).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new Q(this.app,t,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,i)=>{var T,A;let r=t.querySelector(".vault-organizer-rule-message");if(!r)return;let o=this.plugin.settings.rules[i],u=(T=o==null?void 0:o.enabled)!=null?T:!1;t.classList.toggle("vault-organizer-rule-disabled",!u);let c=this.plugin.getRuleErrorForIndex(i),h=(A=o==null?void 0:o.matchType)!=null?A:"equals",p=oe(h),m=o?le(o):!1;c?(r.classList.add("vault-organizer-rule-error"),r.classList.remove("vault-organizer-rule-warning"),r.textContent=v.WARNINGS.INVALID_REGEX(c.message),r.style.display=""):p&&!m?(r.classList.add("vault-organizer-rule-warning"),r.classList.remove("vault-organizer-rule-error"),r.textContent=v.WARNINGS.VALUE_REQUIRED,r.style.display=""):(r.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),r.textContent="",r.style.display="none")})}};var He=200,z=new Map;function Ge(s){let a=z.get(s);if(a)return z.delete(s),z.set(s,a),a;let e=We(s);if(z.size>=He){let n=z.keys().next().value;n!==void 0&&z.delete(n)}return z.set(s,e),e}function We(s){s.length>1e3&&(L.warn(`Exclusion pattern too long (${s.length} chars), truncating to 1000`),s=s.substring(0,1e3));let a="^",e=0,n=0,t=50;for(;e<s.length;){let i=s[e];if(i==="*"){if(n++,n>t){L.warn(`Exclusion pattern has too many wildcards (>${t}), ignoring excess`),e+=1;continue}s[e+1]==="*"?(a+=".*",e+=2):(a+="[^/]*",e+=1)}else if(i==="?"){if(n++,n>t){L.warn(`Exclusion pattern has too many wildcards (>${t}), ignoring excess`),e+=1;continue}a+="[^/]",e+=1}else if(i==="["){let r=s.indexOf("]",e);r===-1?(a+="\\[",e+=1):(a+=s.substring(e,r+1),e=r+1)}else/[.+^${}()|\\]/.test(i)?(a+="\\"+i,e+=1):(a+=i,e+=1)}return a+="$",new RegExp(a)}function me(s,a){if(!a||a.length===0)return!1;let e=s.replace(/\\/g,"/");for(let n of a){if(!n||n.trim()==="")continue;let t=n.trim().replace(/\\/g,"/");if(Ge(t).test(e))return!0;if(!t.includes("*")&&!t.includes("?")&&!t.includes("[")){let r=t.replace(/\/$/,"");if(e===r||e.startsWith(r+"/")){let o=e.split("/");if(r.split("/").every((h,p)=>o[p]===h))return!0}}}return!1}var Xe=100,Ye=/^[a-zA-Z_][a-zA-Z0-9_-]{0,99}$/;function qe(s){return!s||s.length===0||s.length>Xe||s.includes("..")||s.includes("/")||s.includes("\\")?!1:Ye.test(s)}function Ke(s){let a=/\{([^}]+)\}/g,e=[],n;for(;(n=a.exec(s))!==null;){let t=n[1];qe(t)&&e.push(t)}return e}function Ae(s){if(s==null)return"";let a=String(s);return a=a.replace(/[<>:"|?*]/g,""),a=a.replace(/\\/g,"-"),a=a.replace(/\//g,"-"),a=a.trim().replace(/^\.+|\.+$/g,""),a=a.replace(/\s+/g," "),a}function _e(s,a){let e=Ke(s);if(e.length===0)return{substitutedPath:s,substituted:[],missing:[],hasVariables:!1};let n=[],t=[],i=[],r=s;for(let o of e){let u=a==null?void 0:a[o],c=new RegExp(`\\{${je(o)}\\}`,"g");if(u==null)t.push(o),r=r.replace(c,"");else{n.push(o);let h;if(Array.isArray(u)){let p=u.slice(0,V.MAX_ARRAY_PATH_DEPTH);u.length>V.MAX_ARRAY_PATH_DEPTH&&i.push(o),h=p.map(m=>Ae(m)).filter(Boolean).join("/")}else h=Ae(u);r=r.replace(c,h)}}return r=r.replace(/\/+/g,"/").replace(/^\/+|\/+$/g,""),r=r.split("/").filter(Boolean).join("/"),{substitutedPath:r,substituted:n,missing:t,hasVariables:!0,truncated:i.length>0?i:void 0}}function je(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ee(s,a,e){var h,p,m,T,A,_,g;let n=[],t=s.trim();if(!t)return{valid:!1,error:new I(s,"empty","Destination path cannot be empty"),warnings:n};let i=_e(t,e);i.missing.length>0&&n.push(`Missing variables: ${i.missing.join(", ")}`);let r=i.substitutedPath,o=de(r);if(!o.valid||!o.sanitizedPath)return{valid:!1,substitution:i,error:(h=o.error)!=null?h:new I(r,"invalid-characters","Destination path validation failed"),warnings:[...n,...(p=o.warnings)!=null?p:[]]};let u=o.sanitizedPath,c=X(`${u}/${a}`,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});return!c.valid||!c.sanitizedPath?{valid:!1,substitution:i,destinationFolder:u,error:(m=c.error)!=null?m:new I(`${u}/${a}`,"invalid-characters","Full path validation failed"),warnings:[...n,...(T=o.warnings)!=null?T:[],...(A=c.warnings)!=null?A:[]]}:{valid:!0,destinationFolder:u,fullPath:c.sanitizedPath,substitution:i,warnings:[...n,...(_=o.warnings)!=null?_:[],...(g=c.warnings)!=null?g:[]].filter(Boolean)}}var te=class extends N.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[];this.batchOperationInProgress=!1;this.filesBeingProcessed=new Set}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async n=>{!(n instanceof N.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async n=>{!(n instanceof N.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:q.REORGANIZE.name,callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:q.UNDO.name,callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:q.VIEW_HISTORY.name,callback:()=>{new J(this.app,this).open()}}),this.ruleSettingTab=new ee(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),n=Array.isArray(e==null?void 0:e.rules)?e.rules.map(Y):[];this.settings={...he,...e,rules:n,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:he.maxHistorySize,excludePatterns:Array.isArray(e==null?void 0:e.excludePatterns)?e.excludePatterns:[]}}async saveSettings(){this.settings.rules=this.settings.rules.map(Y),!this.batchOperationInProgress&&await this.saveData(this.settings)}async withBatchOperation(e){if(this.batchOperationInProgress)return L.warn(ye.NESTED_BATCH_OPERATION),await e();this.batchOperationInProgress=!0;try{return await e()}finally{this.batchOperationInProgress=!1,await this.saveData(this.settings)}}updateRulesFromSettings(){let{rules:e,successes:n,errors:t}=Re(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:n,errors:t}}async persistSettingsAndRefreshRules(){var r;let{successes:e,errors:n}=this.updateRulesFromSettings(),t=ve(e.map(o=>o.rule)),i=[...this.settings.rules];e.forEach((o,u)=>{i[o.index]=t[u]}),this.settings.rules=i,await this.saveSettings(),n.length&&n.forEach(o=>{let u=o.rule.key||"(unnamed rule)",c=C.REGEX_PARSE_ERROR(u,o.message);new N.Notice(c)}),(r=this.ruleSettingTab)==null||r.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(n=>n.index===e)}async recordMove(e,n,t,i){if(!e||!n||!t||!i)throw new I(e||n||"(empty)","empty","fromPath, toPath, fileName, and ruleKey are required for recording move history");let r={timestamp:Date.now(),fileName:t,fromPath:e,toPath:n,ruleKey:i};this.settings.moveHistory.unshift(r),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new N.Notice(C.UNDO.NO_MOVES);return}let e=this.settings.moveHistory[0],n=this.app.vault.getAbstractFileByPath(e.toPath);if(!n){new N.Notice(C.UNDO.FILE_NOT_EXISTS(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(n instanceof N.TFile)){new N.Notice(C.UNDO.NOT_A_FILE(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new N.Notice(C.UNDO.DESTINATION_EXISTS(e.fromPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let i=e.fromPath.lastIndexOf("/");if(i>0){let r=e.fromPath.substring(0,i);await this.ensureFolderExists(r)}await this.app.fileManager.renameFile(n,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new N.Notice(C.UNDO.SUCCESS(e.fileName,e.fromPath))}catch(i){let r=G(i,e.toPath,"move",e.fromPath);new N.Notice(r.getUserMessage()),L.warn(K.FILE_PROCESSING.UNDO_FAILED,i)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let n=X(e,{allowEmpty:!1,allowAbsolute:!1});if(!n.valid||!n.sanitizedPath)throw n.error||new I(e,"invalid-characters","Path validation failed");let i=n.sanitizedPath.split("/").filter(Boolean);if(!i.length)return;let r="";for(let o of i){r=r?`${r}/${o}`:o;let u=this.app.vault.getAbstractFileByPath(r);if(u){if(u instanceof N.TFile)throw new M(r,void 0,"exists","create-folder");continue}try{await this.app.vault.createFolder(r)}catch(c){throw G(c,r,"create-folder")}}}generateUniqueFilename(e,n,t){if(t==="append-timestamp"){let u=Date.now(),c=`${e}-${u}${n}`;return this.app.vault.getAbstractFileByPath(c)?`${e}-${u}-${Math.random().toString(36).substring(2,8)}${n}`:c}let i=1,r;for(;i<=W.MAX_UNIQUE_FILENAME_ATTEMPTS;){if(r=`${e}-${i}${n}`,!this.app.vault.getAbstractFileByPath(r))return r;i++}L.warn(`Could not find unique numbered filename after ${W.MAX_UNIQUE_FILENAME_ATTEMPTS} attempts. Falling back to timestamp-based naming for ${e}${n}`);let o=Date.now();return`${e}-${o}${n}`}async applyRulesToFile(e){var r,o;let n=e.path;if(this.filesBeingProcessed.has(n))return;this.filesBeingProcessed.add(n);let t,i;try{if(me(e.path,this.settings.excludePatterns))return;let u=this.app.metadataCache.getFileCache(e),c=u==null?void 0:u.frontmatter;if(!c)return;let h=re.call(this,e,this.rules,c);if(!h)return;let p=h.destination.trim();if(!p){if(h.debug){let l=this.app.vault.getName();new N.Notice(C.DEBUG.EMPTY_DESTINATION(e.basename,l))}return}let m=Ee(p,e.name,c);if(!m.valid||!m.fullPath||!m.destinationFolder)throw(r=m.error)!=null?r:new I(p,"invalid-characters","Destination validation failed");h.debug&&m.substitution&&m.substitution.missing.length>0&&new N.Notice(`DEBUG: Missing variables in destination: ${m.substitution.missing.join(", ")}`);let T=m.fullPath,A=m.destinationFolder;if(t=T,e.path===T)return;if(h.debug){let l=this.app.vault.getName();new N.Notice(C.DEBUG.WOULD_MOVE(e.basename,l,A));return}if(await this.ensureFolderExists(A),this.app.vault.getAbstractFileByPath(T)){let l=(o=h.conflictResolution)!=null?o:"fail";if(l==="skip")return;if(l==="append-number"||l==="append-timestamp"){let d=e.name.lastIndexOf("."),E=d>0?e.name.substring(0,d):e.name,P=d>0?e.name.substring(d):"",$=`${A}/${E}`;T=this.generateUniqueFilename($,P,l),t=T}else throw new M(T,e.path,"exists","move")}let g=e.path;T!==n&&(this.filesBeingProcessed.add(T),i=T);try{await this.app.fileManager.renameFile(e,T),await this.recordMove(g,T,e.name,h.key)}catch(l){throw i&&i!==n&&(this.filesBeingProcessed.delete(i),i=void 0),G(l,e.path,"move",T)}}catch(u){if(u instanceof F)new N.Notice(u.getUserMessage()),L.warn(K.FILE_PROCESSING.EXPECTED_ERROR(u.name),u.message);else{let c=G(u,e.path,"move",t);new N.Notice(c.getUserMessage()),L.error(K.FILE_PROCESSING.UNEXPECTED_ERROR,u)}}finally{this.filesBeingProcessed.delete(n),i&&i!==n&&this.filesBeingProcessed.delete(i)}}async reorganizeAllMarkdownFiles(){var n,t;let e=(t=(n=this.app.vault).getMarkdownFiles)==null?void 0:t.call(n);e!=null&&e.length&&await this.withBatchOperation(async()=>{for(let i=0;i<e.length;i++){let r=e[i];await this.applyRulesToFile(r),(i+1)%W.BULK_OPERATION_BATCH_SIZE===0&&await new Promise(o=>setTimeout(o,W.BULK_OPERATION_BATCH_DELAY_MS))}})}testAllRules(){var t,i,r,o,u;let e=((i=(t=this.app.vault).getMarkdownFiles)==null?void 0:i.call(t))||[],n=[];for(let c of e){if(me(c.path,this.settings.excludePatterns))continue;let h=this.app.metadataCache.getFileCache(c),p=h==null?void 0:h.frontmatter;if(!p)continue;let m=this.rules.findIndex(l=>l.enabled===!1?!1:re.call(this,c,[l],p));if(m===-1)continue;let A=this.rules[m].destination.trim();if(!A)continue;let _=Ee(A,c.name,p);if(!_.valid||!_.fullPath){n.push({file:c,currentPath:c.path,ruleIndex:m,error:(r=_.error)!=null?r:new I(A,"invalid-characters","Unknown validation error"),warnings:(o=_.warnings)!=null&&o.length?_.warnings:void 0});continue}let g=_.fullPath;c.path!==g&&n.push({file:c,currentPath:c.path,newPath:g,ruleIndex:m,warnings:(u=_.warnings)!=null&&u.length?_.warnings:void 0})}return n}};
