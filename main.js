/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var A=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var X=Object.getOwnPropertyNames;var J=Object.prototype.hasOwnProperty;var Z=(i,l)=>{for(var e in l)A(i,e,{get:l[e],enumerable:!0})},Q=(i,l,e,s)=>{if(l&&typeof l=="object"||typeof l=="function")for(let t of X(l))!J.call(i,t)&&t!==e&&A(i,t,{get:()=>l[t],enumerable:!(s=Y(l,t))||s.enumerable});return i};var ee=i=>Q(A({},"__esModule",{value:!0}),i);var ce={};Z(ce,{default:()=>k});module.exports=ee(ce);var m=require("obsidian");function $(i,l,e){var t;let s=e!=null?e:(t=this.app.metadataCache.getFileCache(i))==null?void 0:t.frontmatter;if(s)return l.find(r=>{var p;if(r.enabled===!1)return!1;let a=s[r.key];if(a==null)return!1;let n=Array.isArray(a),c=n?a:[a],o=(p=r.matchType)!=null?p:"equals";if(o==="regex"){if(!(r.value instanceof RegExp))return!1;let f=r.value;return c.some(y=>{let b=String(y);return f.lastIndex=0,f.test(b)})}let h=te(String(r.value),n),v=o==="contains"||o==="starts-with"||o==="ends-with"?h.filter(f=>f.length>0):h;return v.length?c.some(f=>{let y=String(f);return v.some(b=>se(y,b,o,r.caseInsensitive))}):!1})}function te(i,l){if(!l)return[i];let e=i.trim(),s=e.split(/\s+/).map(r=>r.trim()).filter(Boolean);if(!s.length)return[e];let t=new Set;return e&&t.add(e),s.forEach(r=>t.add(r)),Array.from(t)}function se(i,l,e,s){let t=s?i.toLowerCase():i,r=s?l.toLowerCase():l;switch(e){case"contains":return t.includes(r);case"starts-with":return t.startsWith(r);case"ends-with":return t.endsWith(r);case"equals":default:return t===r}}function K(i){return i.map(l=>{var s,t,r;let e=(s=l.matchType)!=null?s:"equals";if(e==="regex"){let a=l.value instanceof RegExp?l.value.source:String(l.value),n=l.value instanceof RegExp?l.value.flags:"";return{key:l.key,matchType:e,value:a,destination:l.destination,enabled:(t=l.enabled)!=null?t:!1,isRegex:!0,flags:n,debug:l.debug,caseInsensitive:l.caseInsensitive}}return{key:l.key,matchType:e,value:String(l.value),destination:l.destination,enabled:(r=l.enabled)!=null?r:!1,debug:l.debug,caseInsensitive:l.caseInsensitive}})}function M(i){return i==="contains"||i==="starts-with"||i==="ends-with"}function O(i){return typeof i.value=="string"&&i.value.trim().length>0}function _(i=[]){let l=[],e=[],s=[];return i.forEach((t,r)=>{var n,c,o;let a=(n=t.matchType)!=null?n:t.isRegex?"regex":"equals";if(a==="regex")try{let h=new RegExp(t.value,t.flags),v={key:t.key,matchType:a,value:h,destination:t.destination,enabled:(c=t.enabled)!=null?c:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};l.push(v),e.push({index:r,rule:v})}catch(h){let v=h instanceof Error?h.message:String(h),p=t.destination?` (destination: "${t.destination}")`:"",f=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${p}: ${v}. Rule will be ignored.`;console.warn(f),s.push({index:r,message:v,rule:{...t,matchType:a},cause:h})}else{let h={key:t.key,matchType:a,value:t.value,destination:t.destination,enabled:(o=t.enabled)!=null?o:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};l.push(h),e.push({index:r,rule:h})}}),{rules:l,successes:e,errors:s}}var T=class extends Error{constructor(l){super(l),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},D=class extends T{constructor(e,s,t){let r=S(s);super(`Permission denied: Cannot ${r} "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${S(this.operation)} "${this.filePath}". Check file permissions and try again.`}},z=class extends T{constructor(e,s,t,r,a){let n=S(r),c=s?`Cannot ${n} "${e}" to "${s}"`:`Cannot ${n} "${e}"`;super(`File conflict: ${c} - file ${t}`);this.sourcePath=e;this.destinationPath=s;this.conflictType=t;this.operation=r;this.originalError=a}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},s=S(this.operation);return`${this.destinationPath?`Cannot ${s} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${s} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},x=class extends T{constructor(e,s,t){super(`Invalid path "${e}": ${s}${t?` - ${t}`:""}`);this.path=e;this.reason=s;this.details=t}getUserMessage(){let s={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${s}${t}.`}},V=class extends T{constructor(e,s,t){let r=S(s);super(`File operation failed: ${r} on "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){var t;let e=S(this.operation),s=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${s}.`}};function P(i,l,e,s){let t=i instanceof Error?i:new Error(String(i)),r=t.message.toLowerCase();return r.includes("permission")||r.includes("eacces")||r.includes("eperm")||r.includes("access denied")?new D(l,e,t):r.includes("already exists")||r.includes("eexist")||r.includes("file exists")?new z(l,s||l,"exists",e,t):r.includes("locked")||r.includes("ebusy")?new z(l,s||l,"locked",e,t):r.includes("in use")||r.includes("being used")||r.includes("etxtbsy")?new z(l,s||l,"in-use",e,t):r.includes("invalid path")||r.includes("invalid character")||r.includes("einval")?new x(s||l,"invalid-characters"):r.includes("path too long")||r.includes("enametoolong")?new x(s||l,"too-long"):new V(l,e,t)}function S(i){return i.replace(/-/g," ")}var j=require("obsidian");var I={windows:260,unix:4096,component:255},ne=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),ae=/[<>:"|?*\x00-\x1F]/,re=/^([A-Za-z]:[\\/]|\/)/,ie=/(^|[\\/])\.\.($|[\\/])/,oe=/\/{2,}|\\{2,}/;function C(i,l={}){let{allowEmpty:e=!1,allowAbsolute:s=!1,maxLength:t=I.windows,checkReservedNames:r=!0}=l,a=[];if(!i||i.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:a}:{valid:!1,error:new x(i,"empty")};if(re.test(i)&&!s)return{valid:!1,error:new x(i,"absolute","Use relative paths within the vault")};if(ie.test(i))return{valid:!1,error:new x(i,"traversal",'Paths cannot contain ".." segments')};let n=(0,j.normalizePath)(i);oe.test(n)&&(n=n.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),a.push("Multiple consecutive slashes were normalized")),n=n.trim().replace(/^\/+|\/+$/g,"");let c=n.match(ae);if(c)return{valid:!1,error:new x(i,"invalid-characters",`Contains invalid character: "${c[0]}"`)};if(n.length>t)return{valid:!1,error:new x(i,"too-long",`Path length (${n.length}) exceeds maximum (${t})`)};let o=n.split("/").filter(Boolean);for(let h of o){if(h.length>I.component)return{valid:!1,error:new x(i,"too-long",`Path component "${h}" exceeds ${I.component} characters`)};if(r){let v=h.split(".")[0].toUpperCase();if(ne.has(v))return{valid:!1,error:new x(i,"reserved-name",`"${h}" is a reserved system name on Windows`)}}if(h.endsWith(".")||h.endsWith(" "))return{valid:!1,error:new x(i,"invalid-characters",`Path component "${h}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:n,warnings:a.length>0?a:void 0}}function L(i){return C(i,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var G={rules:[],moveHistory:[],maxHistorySize:50},le=[{value:"equals",label:"Equals"},{value:"contains",label:"Contains"},{value:"starts-with",label:"Starts with"},{value:"ends-with",label:"Ends with"},{value:"regex",label:"Regular expression"}];function H(i){var s,t,r,a,n,c;let l=(s=i.matchType)!=null?s:i.isRegex?"regex":"equals",e={...i,matchType:l,key:(t=i.key)!=null?t:"",value:(r=i.value)!=null?r:"",destination:(a=i.destination)!=null?a:"",enabled:(n=i.enabled)!=null?n:!1};return l==="regex"?(e.isRegex=!0,e.flags=(c=i.flags)!=null?c:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var k=class extends m.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[]}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async s=>{!(s instanceof m.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async s=>{!(s instanceof m.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:"Reorganize notes based on frontmatter rules",callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:"Undo last automatic move",callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:"View move history",callback:()=>{new W(this.app,this).open()}}),this.ruleSettingTab=new B(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),s=Array.isArray(e==null?void 0:e.rules)?e.rules.map(H):[];this.settings={...G,...e,rules:s,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:G.maxHistorySize}}async saveSettings(){let e=this.settings.rules.map(H);this.settings.rules=e,await this.saveData({...this.settings,rules:e})}updateRulesFromSettings(){let{rules:e,successes:s,errors:t}=_(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:s,errors:t}}async persistSettingsAndRefreshRules(){var a;let{successes:e,errors:s}=this.updateRulesFromSettings(),t=K(e.map(n=>n.rule)),r=[...this.settings.rules];e.forEach((n,c)=>{r[n.index]=t[c]}),this.settings.rules=r,await this.saveSettings(),s.length&&s.forEach(n=>{let o=`Failed to parse regular expression for rule "${n.rule.key||"(unnamed rule)"}": ${n.message}`;new m.Notice(o)}),(a=this.ruleSettingTab)==null||a.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(s=>s.index===e)}async recordMove(e,s,t,r){let a={timestamp:Date.now(),fileName:t,fromPath:e,toPath:s,ruleKey:r};this.settings.moveHistory.unshift(a),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new m.Notice("No moves to undo.");return}let e=this.settings.moveHistory[0],s=this.app.vault.getAbstractFileByPath(e.toPath);if(!s){new m.Notice(`Cannot undo: File no longer exists at ${e.toPath}`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(s instanceof m.TFile)){new m.Notice(`Cannot undo: ${e.toPath} is not a file.`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new m.Notice(`Cannot undo: A file already exists at ${e.fromPath}`);return}try{let r=e.fromPath.lastIndexOf("/");if(r>0){let a=e.fromPath.substring(0,r);await this.ensureFolderExists(a)}await this.app.fileManager.renameFile(s,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new m.Notice(`Undone: Moved ${e.fileName} back to ${e.fromPath}`)}catch(r){let a=P(r,e.toPath,"move",e.fromPath);new m.Notice(a.getUserMessage()),console.error("[Vault Organizer] Undo failed:",r)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let s=C(e,{allowEmpty:!1,allowAbsolute:!1});if(!s.valid)throw s.error;let r=s.sanitizedPath.split("/").filter(Boolean);if(!r.length)return;let a="";for(let n of r)if(a=a?`${a}/${n}`:n,!this.app.vault.getAbstractFileByPath(a))try{await this.app.vault.createFolder(a)}catch(c){throw P(c,a,"create-folder")}}async applyRulesToFile(e){var r;let s=e.basename,t;try{let a=(r=this.app.metadataCache.getFileCache(e))==null?void 0:r.frontmatter;if(!a)return;let n=$.call(this,e,this.rules,a);if(!n)return;let c=n.destination.trim();if(!c){if(n.debug){let y=this.app.vault.getName();new m.Notice(`DEBUG: ${e.basename} would not be moved because destination is empty in ${y}.`)}return}let o=L(c);if(!o.valid)throw o.error;let h=o.sanitizedPath,v=C(`${h}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!v.valid)throw v.error;let p=v.sanitizedPath;if(t=p,e.path===p)return;if(n.debug){let y=this.app.vault.getName();new m.Notice(`DEBUG: ${e.basename} would be moved to ${y}/${h}`);return}await this.ensureFolderExists(h);let f=e.path;try{await this.app.fileManager.renameFile(e,p),await this.recordMove(f,p,e.name,n.key)}catch(y){throw P(y,e.path,"move",p)}}catch(a){if(a instanceof T)new m.Notice(a.getUserMessage()),console.error(`[Vault Organizer] ${a.name}:`,a.message,a);else{let n=P(a,e.path,"move",t);new m.Notice(n.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",a)}}}async reorganizeAllMarkdownFiles(){var s,t;let e=(t=(s=this.app.vault).getMarkdownFiles)==null?void 0:t.call(s);if(e!=null&&e.length)for(let r of e)await this.applyRulesToFile(r)}testAllRules(){var t,r,a,n,c,o,h,v;let e=((r=(t=this.app.vault).getMarkdownFiles)==null?void 0:r.call(t))||[],s=[];for(let p of e){let f=(a=this.app.metadataCache.getFileCache(p))==null?void 0:a.frontmatter;if(!f)continue;let y=this.rules.findIndex(R=>R.enabled===!1?!1:$.call(this,p,[R],f));if(y===-1)continue;let g=this.rules[y].destination.trim();if(!g)continue;let u=L(g);if(!u.valid){s.push({file:p,currentPath:p.path,ruleIndex:y,error:u.error,warnings:u.warnings});continue}let d=(n=u.sanitizedPath)!=null?n:"",w=d?`${d}/${p.name}`:p.name,E=C(w,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!E.valid){let R=[...(c=u.warnings)!=null?c:[],...(o=E.warnings)!=null?o:[]];s.push({file:p,currentPath:p.path,ruleIndex:y,error:E.error,warnings:R.length?R:void 0});continue}let F=E.sanitizedPath;if(p.path!==F){let R=[...(h=u.warnings)!=null?h:[],...(v=E.warnings)!=null?v:[]];s.push({file:p,currentPath:p.path,newPath:F,ruleIndex:y,warnings:R.length?R:void 0})}}return s}},B=class extends m.PluginSettingTab{constructor(e,s){super(e,s);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=s,this.debouncedSaveOnly=(0,m.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},300),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,r,a;let e=new Set;((a=(r=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(t))!=null?a:[]).forEach(n=>{let c=this.plugin.app.metadataCache.getFileCache(n);if(!c)return;let o=(0,m.getAllTags)(c);o&&o.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((n,c)=>n.localeCompare(c))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,r,a;let e=new Set;((a=(r=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(t))!=null?a:[]).forEach(n=>{let c=this.plugin.app.metadataCache.getFileCache(n),o=c==null?void 0:c.frontmatter;o&&Object.keys(o).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((n,c)=>n.localeCompare(c))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,s){if(!e.length)return;new N(this.app,e,s).open()}openFrontmatterKeyPicker(e,s){if(!e.length)return;new q(this.app,e,s).open()}toggleTagValue(e,s){let t=e.split(/\s+/).filter(Boolean);return(t.includes(s)?t.filter(n=>n!==s):[...t,s]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(H),this.plugin.settings.rules.forEach((s,t)=>{var b;let r=(b=s.matchType)!=null?b:"equals",a=new m.Setting(e).setName(`Rule ${t+1}`).setDesc("Destination folder is required before the rule can move files.");a.settingEl.classList.add("setting-item");let n=document.createElement("div");n.classList.add("vault-organizer-rule-message"),n.style.display="none",a.settingEl.appendChild(n);let c=()=>{var d;let g=this.plugin.settings.rules[t],u=(d=g==null?void 0:g.enabled)!=null?d:!1;a.settingEl.classList.toggle("vault-organizer-rule-disabled",!u)};a.addToggle(g=>{var u;return g.setTooltip("Activate this rule").setValue((u=s.enabled)!=null?u:!1).onChange(async d=>{let w=this.plugin.settings.rules[t];w&&(w.enabled=d,c(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),c())})}),a.addExtraButton(g=>g.setIcon("arrow-up").setTooltip("Move rule up").setDisabled(t===0).onClick(async()=>{if(t===0)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),a.addExtraButton(g=>g.setIcon("arrow-down").setTooltip("Move rule down").setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let o=()=>{var F;let g=this.plugin.getRuleErrorForIndex(t),u=this.plugin.settings.rules[t],d=(F=u==null?void 0:u.matchType)!=null?F:"equals",w=M(d),E=u?O(u):!1;g?(n.classList.add("vault-organizer-rule-error"),n.classList.remove("vault-organizer-rule-warning"),n.textContent=`Invalid regular expression: ${g.message}`,n.style.display=""):w&&!E?(n.classList.add("vault-organizer-rule-warning"),n.classList.remove("vault-organizer-rule-error"),n.textContent="Value is required for contains/starts-with/ends-with rules.",n.style.display=""):(n.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),n.textContent="",n.style.display="none")},h;a.addText(g=>{h=g,g.setPlaceholder("key").setValue(s.key).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.key=u,this.scheduleSaveOnly())})}),a.addExtraButton(g=>g.setIcon("list").setTooltip("Browse frontmatter keys").onClick(()=>{let u=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(u,d=>{let w=this.plugin.settings.rules[t];!w||!h||(h.setValue(d),w.key=d,this.scheduleSaveOnly())})}));let v;a.addText(g=>{v=g,g.setPlaceholder("value").setValue(s.value).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.value=u,this.scheduleSaveOnly(),o())})}),a.addExtraButton(g=>g.setIcon("hashtag").setTooltip("Browse tags").onClick(()=>{let u=this.getAggregatedTags();this.openTagPicker(u,d=>{let w=this.plugin.settings.rules[t];if(!w||!v)return;let E=this.toggleTagValue(v.getValue(),d);v.setValue(E),w.value=E,this.scheduleSaveOnly()})})),a.addText(g=>g.setPlaceholder("destination folder (required)").setValue(s.destination).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.destination=u,this.scheduleSaveOnly())}));let p,f,y=()=>{var d;let g=this.plugin.settings.rules[t],u=((d=g==null?void 0:g.matchType)!=null?d:"equals")==="regex";p&&(p.inputEl.toggleAttribute("disabled",!u),p.inputEl.disabled=!u,p.inputEl.style.display=u?"":"none"),f&&(f.toggleEl.style.display=u?"none":"")};a.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),le.forEach(u=>g.addOption(u.value,u.label)),g.setValue(r).onChange(async u=>{var w;let d=this.plugin.settings.rules[t];d&&(d.matchType=u,u==="regex"?(d.isRegex=!0,d.flags=(w=d.flags)!=null?w:""):(delete d.isRegex,"flags"in d&&delete d.flags),y(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),y(),o())})}),a.addText(g=>{var u;p=g,g.setPlaceholder("flags").setValue((u=s.flags)!=null?u:"").onChange(d=>{let w=this.plugin.settings.rules[t];w&&w.matchType==="regex"&&(w.flags=d,this.scheduleSaveOnly())})}),y(),a.addToggle(g=>{var u;f=g,g.setTooltip("Case insensitive matching").setValue((u=s.caseInsensitive)!=null?u:!1).onChange(async d=>{let w=this.plugin.settings.rules[t];w&&(w.caseInsensitive=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),a.addToggle(g=>{var u;return g.setTooltip("Enable debug mode").setValue((u=s.debug)!=null?u:!1).onChange(async d=>{let w=this.plugin.settings.rules[t];w&&(w.debug=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),a.addButton(g=>g.setButtonText("Remove").onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),o(),c()}),new m.Setting(e).addButton(s=>s.setButtonText("Add Rule").onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new m.Setting(e).addButton(s=>s.setButtonText("Apply now").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(s=>s.setButtonText("Test All Rules").setTooltip("Preview what moves would be made without actually moving files").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new U(this.app,t,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,r)=>{var f,y;let a=t.querySelector(".vault-organizer-rule-message");if(!a)return;let n=this.plugin.settings.rules[r],c=(f=n==null?void 0:n.enabled)!=null?f:!1;t.classList.toggle("vault-organizer-rule-disabled",!c);let o=this.plugin.getRuleErrorForIndex(r),h=(y=n==null?void 0:n.matchType)!=null?y:"equals",v=M(h),p=n?O(n):!1;o?(a.classList.add("vault-organizer-rule-error"),a.classList.remove("vault-organizer-rule-warning"),a.textContent=`Invalid regular expression: ${o.message}`,a.style.display=""):v&&!p?(a.classList.add("vault-organizer-rule-warning"),a.classList.remove("vault-organizer-rule-error"),a.textContent="Value is required for contains/starts-with/ends-with rules.",a.style.display=""):(a.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),a.textContent="",a.style.display="none")})}},N=class extends m.FuzzySuggestModal{constructor(e,s,t){super(e);this.tags=s;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},q=class extends m.FuzzySuggestModal{constructor(e,s,t){super(e);this.keys=s;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},U=class extends m.Modal{constructor(e,s,t){super(e);this.results=s;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Test All Rules - Preview"});let s=this.results.filter(n=>n.newPath&&!n.error),t=this.results.filter(n=>n.error);if(s.length===0&&t.length===0)e.createEl("p",{text:"No files would be moved. All files are either already in the correct location or have no matching rules."});else{if(s.length){e.createEl("p",{text:`${s.length} file(s) would be moved:`});let n=e.createDiv({cls:"vault-organizer-test-results"});n.style.maxHeight="400px",n.style.overflowY="auto",n.style.marginTop="1em",s.forEach(c=>{var y,b;let o=n.createDiv({cls:"vault-organizer-test-result-item"});o.style.marginBottom="1em",o.style.padding="0.5em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px";let h=o.createDiv();h.createEl("strong",{text:"File: "}),h.createSpan({text:c.file.basename});let v=o.createDiv();v.createEl("strong",{text:"From: "}),v.createSpan({text:c.currentPath});let p=o.createDiv();p.createEl("strong",{text:"To: "}),p.createSpan({text:c.newPath});let f=o.createDiv();if(f.createEl("strong",{text:"Rule: "}),f.createSpan({text:`Rule ${c.ruleIndex+1} (${((y=this.rules[c.ruleIndex])==null?void 0:y.key)||"unknown"})`}),(b=c.warnings)!=null&&b.length){let g=o.createDiv();g.createEl("strong",{text:"Warnings: "}),g.createSpan({text:c.warnings.join("; ")})}})}else e.createEl("p",{text:"No files would be moved. All matching files are already in the correct location."});if(t.length){e.createEl("h3",{text:"Skipped due to invalid destinations"});let n=e.createDiv({cls:"vault-organizer-test-results"});n.style.maxHeight="400px",n.style.overflowY="auto",n.style.marginTop="1em",t.forEach(c=>{var y,b,g,u;let o=n.createDiv({cls:"vault-organizer-test-result-item"});o.style.marginBottom="1em",o.style.padding="0.5em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px";let h=o.createDiv();h.createEl("strong",{text:"File: "}),h.createSpan({text:c.file.basename});let v=o.createDiv();v.createEl("strong",{text:"From: "}),v.createSpan({text:c.currentPath});let p=o.createDiv();p.createEl("strong",{text:"Rule: "}),p.createSpan({text:`Rule ${c.ruleIndex+1} (${((y=this.rules[c.ruleIndex])==null?void 0:y.key)||"unknown"})`});let f=o.createDiv();if(f.createEl("strong",{text:"Reason: "}),f.createSpan({text:(g=(b=c.error)==null?void 0:b.getUserMessage())!=null?g:"Destination path is invalid and the move cannot be previewed."}),(u=c.warnings)!=null&&u.length){let d=o.createDiv();d.createEl("strong",{text:"Warnings: "}),d.createSpan({text:c.warnings.join("; ")})}})}}let r=e.createDiv({cls:"modal-button-container"});r.style.marginTop="1.5em",r.style.textAlign="right";let a=r.createEl("button",{text:"Close"});a.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},W=class extends m.Modal{constructor(e,s){super(e);this.plugin=s}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Move History"}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:"No move history yet."});else{e.createEl("p",{text:`Showing ${this.plugin.settings.moveHistory.length} of last ${this.plugin.settings.maxHistorySize} moves.`});let a=e.createDiv({cls:"vault-organizer-history-container"});a.style.maxHeight="500px",a.style.overflowY="auto",a.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((n,c)=>{let o=a.createDiv({cls:"vault-organizer-history-item"});o.style.marginBottom="1em",o.style.padding="0.8em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px",o.style.position="relative",c===0&&(o.style.backgroundColor="var(--background-secondary-alt)",o.style.borderColor="var(--interactive-accent)");let h=o.createDiv();h.style.marginBottom="0.5em",h.style.fontWeight="bold";let p=new Date(n.timestamp).toLocaleString();c===0&&h.createEl("span",{text:"\u{1F504} Most Recent: ",cls:"vault-organizer-recent-label"}),h.createSpan({text:n.fileName});let f=o.createDiv();f.style.fontSize="0.9em",f.style.color="var(--text-muted)",f.style.marginBottom="0.5em",f.textContent=`\u23F0 ${p}`;let y=o.createDiv();y.createEl("strong",{text:"From: "}),y.createSpan({text:n.fromPath});let b=o.createDiv();b.createEl("strong",{text:"To: "}),b.createSpan({text:n.toPath});let g=o.createDiv();if(g.createEl("strong",{text:"Rule: "}),g.createSpan({text:n.ruleKey||"(unknown)"}),c===0){let u=o.createDiv();u.style.marginTop="0.8em";let d=u.createEl("button",{text:"Undo This Move"});d.style.backgroundColor="var(--interactive-accent)",d.style.color="var(--text-on-accent)",d.style.padding="0.4em 0.8em",d.style.border="none",d.style.borderRadius="4px",d.style.cursor="pointer",d.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let s=e.createDiv({cls:"modal-button-container"});s.style.marginTop="1.5em",s.style.textAlign="right";let t=s.createEl("button",{text:"Clear History"});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new m.Notice("Move history cleared."),this.close()};let r=s.createEl("button",{text:"Close"});r.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};
