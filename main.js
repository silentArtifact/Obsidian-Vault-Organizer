/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var L=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(i,l)=>{for(var e in l)L(i,e,{get:l[e],enumerable:!0})},se=(i,l,e,s)=>{if(l&&typeof l=="object"||typeof l=="function")for(let t of Q(l))!ee.call(i,t)&&t!==e&&L(i,t,{get:()=>l[t],enumerable:!(s=Z(l,t))||s.enumerable});return i};var ne=i=>se(L({},"__esModule",{value:!0}),i);var de={};te(de,{default:()=>H});module.exports=ne(de);var w=require("obsidian");var re=new Set(["__proto__","constructor","prototype"]);function B(i,l,e){var t;let s=e!=null?e:(t=this.app.metadataCache.getFileCache(i))==null?void 0:t.frontmatter;if(s)return l.find(n=>{var m;if(n.enabled===!1||re.has(n.key))return!1;let a=s[n.key];if(a==null)return!1;let r=Array.isArray(a),c=r?a:[a],o=(m=n.matchType)!=null?m:"equals";if(o==="regex"){if(!(n.value instanceof RegExp))return!1;let p=n.value;return c.some(v=>{let b=String(v);return p.lastIndex=0,p.test(b)})}let h=ae(String(n.value),r),f=o==="contains"||o==="starts-with"||o==="ends-with"?h.filter(p=>p.length>0):h;return f.length?c.some(p=>{let v=String(p);return f.some(b=>ie(v,b,o,n.caseInsensitive))}):!1})}function ae(i,l){if(!l)return[i];let e=i.trim(),s=e.split(/\s+/).map(n=>n.trim()).filter(Boolean);if(!s.length)return[e];let t=new Set;return e&&t.add(e),s.forEach(n=>t.add(n)),Array.from(t)}function ie(i,l,e,s){let t=s?i.toLowerCase():i,n=s?l.toLowerCase():l;switch(e){case"contains":return t.includes(n);case"starts-with":return t.startsWith(n);case"ends-with":return t.endsWith(n);case"equals":default:return t===n}}function G(i){return i.map(l=>{var s,t,n;let e=(s=l.matchType)!=null?s:"equals";if(e==="regex"){let a=l.value instanceof RegExp?l.value.source:String(l.value),r=l.value instanceof RegExp?l.value.flags:"";return{key:l.key,matchType:e,value:a,destination:l.destination,enabled:(t=l.enabled)!=null?t:!1,isRegex:!0,flags:r,debug:l.debug,caseInsensitive:l.caseInsensitive}}return{key:l.key,matchType:e,value:String(l.value),destination:l.destination,enabled:(n=l.enabled)!=null?n:!1,debug:l.debug,caseInsensitive:l.caseInsensitive}})}function N(i){return i==="contains"||i==="starts-with"||i==="ends-with"}function U(i){return typeof i.value=="string"&&i.value.trim().length>0}function Y(i=[]){let l=[],e=[],s=[];return i.forEach((t,n)=>{var r,c,o;let a=(r=t.matchType)!=null?r:t.isRegex?"regex":"equals";if(a==="regex")try{let h=new RegExp(t.value,t.flags),f={key:t.key,matchType:a,value:h,destination:t.destination,enabled:(c=t.enabled)!=null?c:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};l.push(f),e.push({index:n,rule:f})}catch(h){let f=h instanceof Error?h.message:String(h),m=t.destination?` (destination: "${t.destination}")`:"",p=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${m}: ${f}. Rule will be ignored.`;console.warn(p),s.push({index:n,message:f,rule:{...t,matchType:a},cause:h})}else{let h={key:t.key,matchType:a,value:t.value,destination:t.destination,enabled:(o=t.enabled)!=null?o:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};l.push(h),e.push({index:n,rule:h})}}),{rules:l,successes:e,errors:s}}var S=class extends Error{constructor(l){super(l),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},q=class extends S{constructor(e,s,t){let n=F(s);super(`Permission denied: Cannot ${n} "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${F(this.operation)} "${this.filePath}". Check file permissions and try again.`}},C=class extends S{constructor(e,s,t,n,a){let r=F(n),c=s?`Cannot ${r} "${e}" to "${s}"`:`Cannot ${r} "${e}"`;super(`File conflict: ${c} - file ${t}`);this.sourcePath=e;this.destinationPath=s;this.conflictType=t;this.operation=n;this.originalError=a}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},s=F(this.operation);return`${this.destinationPath?`Cannot ${s} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${s} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},x=class extends S{constructor(e,s,t){super(`Invalid path "${e}": ${s}${t?` - ${t}`:""}`);this.path=e;this.reason=s;this.details=t}getUserMessage(){let s={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${s}${t}.`}},_=class extends S{constructor(e,s,t){let n=F(s);super(`File operation failed: ${n} on "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){var t;let e=F(this.operation),s=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${s}.`}};function k(i,l,e,s){let t=i instanceof Error?i:new Error(String(i)),n=t.message.toLowerCase();return n.includes("permission")||n.includes("eacces")||n.includes("eperm")||n.includes("access denied")?new q(l,e,t):n.includes("already exists")||n.includes("eexist")||n.includes("file exists")?new C(l,s||l,"exists",e,t):n.includes("locked")||n.includes("ebusy")?new C(l,s||l,"locked",e,t):n.includes("in use")||n.includes("being used")||n.includes("etxtbsy")?new C(l,s||l,"in-use",e,t):n.includes("invalid path")||n.includes("invalid character")||n.includes("einval")?new x(s||l,"invalid-characters"):n.includes("path too long")||n.includes("enametoolong")?new x(s||l,"too-long"):new _(l,e,t)}function F(i){return i.replace(/-/g," ")}var X=require("obsidian");var W={windows:260,unix:4096,component:255},oe=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),le=/[<>:"|?*\x00-\x1F]/,ce=/^([A-Za-z]:[\\/]|\/)/,ue=/(^|[\\/])\.\.($|[\\/])/,ge=/\/{2,}|\\{2,}/;function A(i,l={}){let{allowEmpty:e=!1,allowAbsolute:s=!1,maxLength:t=W.windows,checkReservedNames:n=!0}=l,a=[];if(!i||i.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:a}:{valid:!1,error:new x(i,"empty")};if(ce.test(i)&&!s)return{valid:!1,error:new x(i,"absolute","Use relative paths within the vault")};if(ue.test(i))return{valid:!1,error:new x(i,"traversal",'Paths cannot contain ".." segments')};let r=(0,X.normalizePath)(i);ge.test(r)&&(r=r.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),a.push("Multiple consecutive slashes were normalized")),r=r.trim().replace(/^\/+|\/+$/g,"");let c=r.match(le);if(c)return{valid:!1,error:new x(i,"invalid-characters",`Contains invalid character: "${c[0]}"`)};if(r.length>t)return{valid:!1,error:new x(i,"too-long",`Path length (${r.length}) exceeds maximum (${t})`)};let o=r.split("/").filter(Boolean);for(let h of o){if(h.length>W.component)return{valid:!1,error:new x(i,"too-long",`Path component "${h}" exceeds ${W.component} characters`)};if(n){let f=h.split(".")[0].toUpperCase();if(oe.has(f))return{valid:!1,error:new x(i,"reserved-name",`"${h}" is a reserved system name on Windows`)}}if(h.endsWith(".")||h.endsWith(" "))return{valid:!1,error:new x(i,"invalid-characters",`Path component "${h}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:r,warnings:a.length>0?a:void 0}}function K(i){return A(i,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var j={rules:[],moveHistory:[],maxHistorySize:50},J=[{value:"equals",label:"Equals"},{value:"contains",label:"Contains"},{value:"starts-with",label:"Starts with"},{value:"ends-with",label:"Ends with"},{value:"regex",label:"Regular expression"}];function M(i){var s,t,n,a,r,c;let l=(s=i.matchType)!=null?s:i.isRegex?"regex":"equals",e={...i,matchType:l,key:(t=i.key)!=null?t:"",value:(n=i.value)!=null?n:"",destination:(a=i.destination)!=null?a:"",enabled:(r=i.enabled)!=null?r:!1};return l==="regex"?(e.isRegex=!0,e.flags=(c=i.flags)!=null?c:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var R=require("obsidian");var z=require("obsidian"),$=class extends z.FuzzySuggestModal{constructor(e,s,t){super(e);this.tags=s;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},O=class extends z.FuzzySuggestModal{constructor(e,s,t){super(e);this.keys=s;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},D=class extends z.Modal{constructor(e,s,t){super(e);this.results=s;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Test All Rules - Preview"});let s=this.results.filter(r=>r.newPath&&!r.error),t=this.results.filter(r=>r.error);if(s.length===0&&t.length===0)e.createEl("p",{text:"No files would be moved. All files are either already in the correct location or have no matching rules."});else{if(s.length){e.createEl("p",{text:`${s.length} file(s) would be moved:`});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",s.forEach(c=>{var v,b;let o=r.createDiv({cls:"vault-organizer-test-result-item"});o.style.marginBottom="1em",o.style.padding="0.5em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px";let h=o.createDiv();h.createEl("strong",{text:"File: "}),h.createSpan({text:c.file.basename});let f=o.createDiv();f.createEl("strong",{text:"From: "}),f.createSpan({text:c.currentPath});let m=o.createDiv();m.createEl("strong",{text:"To: "}),m.createSpan({text:c.newPath||"(unknown)"});let p=o.createDiv();if(p.createEl("strong",{text:"Rule: "}),p.createSpan({text:`Rule ${c.ruleIndex+1} (${((v=this.rules[c.ruleIndex])==null?void 0:v.key)||"unknown"})`}),(b=c.warnings)!=null&&b.length){let g=o.createDiv();g.createEl("strong",{text:"Warnings: "}),g.createSpan({text:c.warnings.join("; ")})}})}else e.createEl("p",{text:"No files would be moved. All matching files are already in the correct location."});if(t.length){e.createEl("h3",{text:"Skipped due to invalid destinations"});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",t.forEach(c=>{var v,b,g,u;let o=r.createDiv({cls:"vault-organizer-test-result-item"});o.style.marginBottom="1em",o.style.padding="0.5em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px";let h=o.createDiv();h.createEl("strong",{text:"File: "}),h.createSpan({text:c.file.basename});let f=o.createDiv();f.createEl("strong",{text:"From: "}),f.createSpan({text:c.currentPath});let m=o.createDiv();m.createEl("strong",{text:"Rule: "}),m.createSpan({text:`Rule ${c.ruleIndex+1} (${((v=this.rules[c.ruleIndex])==null?void 0:v.key)||"unknown"})`});let p=o.createDiv();if(p.createEl("strong",{text:"Reason: "}),p.createSpan({text:(g=(b=c.error)==null?void 0:b.getUserMessage())!=null?g:"Destination path is invalid and the move cannot be previewed."}),(u=c.warnings)!=null&&u.length){let d=o.createDiv();d.createEl("strong",{text:"Warnings: "}),d.createSpan({text:c.warnings.join("; ")})}})}}let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="1.5em",n.style.textAlign="right";let a=n.createEl("button",{text:"Close"});a.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},V=class extends z.Modal{constructor(e,s){super(e);this.plugin=s}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Move History"}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:"No move history yet."});else{e.createEl("p",{text:`Showing ${this.plugin.settings.moveHistory.length} of last ${this.plugin.settings.maxHistorySize} moves.`});let a=e.createDiv({cls:"vault-organizer-history-container"});a.style.maxHeight="500px",a.style.overflowY="auto",a.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((r,c)=>{let o=a.createDiv({cls:"vault-organizer-history-item"});o.style.marginBottom="1em",o.style.padding="0.8em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px",o.style.position="relative",c===0&&(o.style.backgroundColor="var(--background-secondary-alt)",o.style.borderColor="var(--interactive-accent)");let h=o.createDiv();h.style.marginBottom="0.5em",h.style.fontWeight="bold";let m=new Date(r.timestamp).toLocaleString();c===0&&h.createEl("span",{text:"\u{1F504} Most Recent: ",cls:"vault-organizer-recent-label"}),h.createSpan({text:r.fileName});let p=o.createDiv();p.style.fontSize="0.9em",p.style.color="var(--text-muted)",p.style.marginBottom="0.5em",p.textContent=`\u23F0 ${m}`;let v=o.createDiv();v.createEl("strong",{text:"From: "}),v.createSpan({text:r.fromPath});let b=o.createDiv();b.createEl("strong",{text:"To: "}),b.createSpan({text:r.toPath});let g=o.createDiv();if(g.createEl("strong",{text:"Rule: "}),g.createSpan({text:r.ruleKey||"(unknown)"}),c===0){let u=o.createDiv();u.style.marginTop="0.8em";let d=u.createEl("button",{text:"Undo This Move"});d.style.backgroundColor="var(--interactive-accent)",d.style.color="var(--text-on-accent)",d.style.padding="0.4em 0.8em",d.style.border="none",d.style.borderRadius="4px",d.style.cursor="pointer",d.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let s=e.createDiv({cls:"modal-button-container"});s.style.marginTop="1.5em",s.style.textAlign="right";let t=s.createEl("button",{text:"Clear History"});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new z.Notice("Move history cleared."),this.close()};let n=s.createEl("button",{text:"Close"});n.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};var I=class extends R.PluginSettingTab{constructor(e,s){super(e,s);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=s,this.debouncedSaveOnly=(0,R.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},300),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,n,a;let e=new Set;((a=(n=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:n.call(t))!=null?a:[]).forEach(r=>{let c=this.plugin.app.metadataCache.getFileCache(r);if(!c)return;let o=(0,R.getAllTags)(c);o&&o.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((r,c)=>r.localeCompare(c))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,n,a;let e=new Set;((a=(n=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:n.call(t))!=null?a:[]).forEach(r=>{let c=this.plugin.app.metadataCache.getFileCache(r),o=c==null?void 0:c.frontmatter;o&&Object.keys(o).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((r,c)=>r.localeCompare(c))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,s){if(!e.length)return;new $(this.app,e,s).open()}openFrontmatterKeyPicker(e,s){if(!e.length)return;new O(this.app,e,s).open()}toggleTagValue(e,s){let t=e.split(/\s+/).filter(Boolean);return(t.includes(s)?t.filter(r=>r!==s):[...t,s]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(M),this.plugin.settings.rules.forEach((s,t)=>{var b;let n=(b=s.matchType)!=null?b:"equals",a=new R.Setting(e).setName(`Rule ${t+1}`).setDesc("Destination folder is required before the rule can move files.");a.settingEl.classList.add("setting-item");let r=document.createElement("div");r.classList.add("vault-organizer-rule-message"),r.style.display="none",a.settingEl.appendChild(r);let c=()=>{var d;let g=this.plugin.settings.rules[t],u=(d=g==null?void 0:g.enabled)!=null?d:!1;a.settingEl.classList.toggle("vault-organizer-rule-disabled",!u)};a.addToggle(g=>{var u;return g.setTooltip("Activate this rule").setValue((u=s.enabled)!=null?u:!1).onChange(async d=>{let y=this.plugin.settings.rules[t];y&&(y.enabled=d,c(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),c())})}),a.addExtraButton(g=>g.setIcon("arrow-up").setTooltip("Move rule up").setDisabled(t===0).onClick(async()=>{if(t===0)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),a.addExtraButton(g=>g.setIcon("arrow-down").setTooltip("Move rule down").setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let o=()=>{var P;let g=this.plugin.getRuleErrorForIndex(t),u=this.plugin.settings.rules[t],d=(P=u==null?void 0:u.matchType)!=null?P:"equals",y=N(d),E=u?U(u):!1;g?(r.classList.add("vault-organizer-rule-error"),r.classList.remove("vault-organizer-rule-warning"),r.textContent=`Invalid regular expression: ${g.message}`,r.style.display=""):y&&!E?(r.classList.add("vault-organizer-rule-warning"),r.classList.remove("vault-organizer-rule-error"),r.textContent="Value is required for contains/starts-with/ends-with rules.",r.style.display=""):(r.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),r.textContent="",r.style.display="none")},h;a.addText(g=>{h=g,g.setPlaceholder("key").setValue(s.key).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.key=u,this.scheduleSaveOnly())})}),a.addExtraButton(g=>g.setIcon("list").setTooltip("Browse frontmatter keys").onClick(()=>{let u=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(u,d=>{let y=this.plugin.settings.rules[t];!y||!h||(h.setValue(d),y.key=d,this.scheduleSaveOnly())})}));let f;a.addText(g=>{f=g,g.setPlaceholder("value").setValue(s.value).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.value=u,this.scheduleSaveOnly(),o())})}),a.addExtraButton(g=>g.setIcon("hashtag").setTooltip("Browse tags").onClick(()=>{let u=this.getAggregatedTags();this.openTagPicker(u,d=>{let y=this.plugin.settings.rules[t];if(!y||!f)return;let E=this.toggleTagValue(f.getValue(),d);f.setValue(E),y.value=E,this.scheduleSaveOnly()})})),a.addText(g=>g.setPlaceholder("destination folder (required)").setValue(s.destination).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.destination=u,this.scheduleSaveOnly())}));let m,p,v=()=>{var d;let g=this.plugin.settings.rules[t],u=((d=g==null?void 0:g.matchType)!=null?d:"equals")==="regex";m&&(m.inputEl.toggleAttribute("disabled",!u),m.inputEl.disabled=!u,m.inputEl.style.display=u?"":"none"),p&&(p.toggleEl.style.display=u?"none":"")};a.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),J.forEach(u=>g.addOption(u.value,u.label)),g.setValue(n).onChange(async u=>{var y;let d=this.plugin.settings.rules[t];d&&(d.matchType=u,u==="regex"?(d.isRegex=!0,d.flags=(y=d.flags)!=null?y:""):(delete d.isRegex,"flags"in d&&delete d.flags),v(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),v(),o())})}),a.addText(g=>{var u;m=g,g.setPlaceholder("flags").setValue((u=s.flags)!=null?u:"").onChange(d=>{let y=this.plugin.settings.rules[t];y&&y.matchType==="regex"&&(y.flags=d,this.scheduleSaveOnly())})}),v(),a.addToggle(g=>{var u;p=g,g.setTooltip("Case insensitive matching").setValue((u=s.caseInsensitive)!=null?u:!1).onChange(async d=>{let y=this.plugin.settings.rules[t];y&&(y.caseInsensitive=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),a.addToggle(g=>{var u;return g.setTooltip("Enable debug mode").setValue((u=s.debug)!=null?u:!1).onChange(async d=>{let y=this.plugin.settings.rules[t];y&&(y.debug=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),a.addButton(g=>g.setButtonText("Remove").onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),o(),c()}),new R.Setting(e).addButton(s=>s.setButtonText("Add Rule").onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new R.Setting(e).addButton(s=>s.setButtonText("Apply now").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(s=>s.setButtonText("Test All Rules").setTooltip("Preview what moves would be made without actually moving files").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new D(this.app,t,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,n)=>{var p,v;let a=t.querySelector(".vault-organizer-rule-message");if(!a)return;let r=this.plugin.settings.rules[n],c=(p=r==null?void 0:r.enabled)!=null?p:!1;t.classList.toggle("vault-organizer-rule-disabled",!c);let o=this.plugin.getRuleErrorForIndex(n),h=(v=r==null?void 0:r.matchType)!=null?v:"equals",f=N(h),m=r?U(r):!1;o?(a.classList.add("vault-organizer-rule-error"),a.classList.remove("vault-organizer-rule-warning"),a.textContent=`Invalid regular expression: ${o.message}`,a.style.display=""):f&&!m?(a.classList.add("vault-organizer-rule-warning"),a.classList.remove("vault-organizer-rule-error"),a.textContent="Value is required for contains/starts-with/ends-with rules.",a.style.display=""):(a.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),a.textContent="",a.style.display="none")})}};var H=class extends w.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[]}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async s=>{!(s instanceof w.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async s=>{!(s instanceof w.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:"Reorganize notes based on frontmatter rules",callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:"Undo last automatic move",callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:"View move history",callback:()=>{new V(this.app,this).open()}}),this.ruleSettingTab=new I(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),s=Array.isArray(e==null?void 0:e.rules)?e.rules.map(M):[];this.settings={...j,...e,rules:s,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:j.maxHistorySize}}async saveSettings(){let e=this.settings.rules.map(M);this.settings.rules=e,await this.saveData({...this.settings,rules:e})}updateRulesFromSettings(){let{rules:e,successes:s,errors:t}=Y(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:s,errors:t}}async persistSettingsAndRefreshRules(){var a;let{successes:e,errors:s}=this.updateRulesFromSettings(),t=G(e.map(r=>r.rule)),n=[...this.settings.rules];e.forEach((r,c)=>{n[r.index]=t[c]}),this.settings.rules=n,await this.saveSettings(),s.length&&s.forEach(r=>{let o=`Failed to parse regular expression for rule "${r.rule.key||"(unnamed rule)"}": ${r.message}`;new w.Notice(o)}),(a=this.ruleSettingTab)==null||a.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(s=>s.index===e)}async recordMove(e,s,t,n){let a={timestamp:Date.now(),fileName:t,fromPath:e,toPath:s,ruleKey:n};this.settings.moveHistory.unshift(a),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new w.Notice("No moves to undo.");return}let e=this.settings.moveHistory[0],s=this.app.vault.getAbstractFileByPath(e.toPath);if(!s){new w.Notice(`Cannot undo: File no longer exists at ${e.toPath}`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(s instanceof w.TFile)){new w.Notice(`Cannot undo: ${e.toPath} is not a file.`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new w.Notice(`Cannot undo: A file already exists at ${e.fromPath}`),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let n=e.fromPath.lastIndexOf("/");if(n>0){let a=e.fromPath.substring(0,n);await this.ensureFolderExists(a)}await this.app.fileManager.renameFile(s,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new w.Notice(`Undone: Moved ${e.fileName} back to ${e.fromPath}`)}catch(n){let a=k(n,e.toPath,"move",e.fromPath);new w.Notice(a.getUserMessage()),console.error("[Vault Organizer] Undo failed:",n)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let s=A(e,{allowEmpty:!1,allowAbsolute:!1});if(!s.valid||!s.sanitizedPath)throw s.error||new Error("Path validation failed");let n=s.sanitizedPath.split("/").filter(Boolean);if(!n.length)return;let a="";for(let r of n)if(a=a?`${a}/${r}`:r,!this.app.vault.getAbstractFileByPath(a))try{await this.app.vault.createFolder(a)}catch(c){throw k(c,a,"create-folder")}}async applyRulesToFile(e){var t;let s;try{let n=(t=this.app.metadataCache.getFileCache(e))==null?void 0:t.frontmatter;if(!n)return;let a=B.call(this,e,this.rules,n);if(!a)return;let r=a.destination.trim();if(!r){if(a.debug){let p=this.app.vault.getName();new w.Notice(`DEBUG: ${e.basename} would not be moved because destination is empty in ${p}.`)}return}let c=K(r);if(!c.valid||!c.sanitizedPath)throw c.error||new Error("Destination path validation failed");let o=c.sanitizedPath,h=A(`${o}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!h.valid||!h.sanitizedPath)throw h.error||new Error("Full path validation failed");let f=h.sanitizedPath;if(s=f,e.path===f)return;if(a.debug){let p=this.app.vault.getName();new w.Notice(`DEBUG: ${e.basename} would be moved to ${p}/${o}`);return}await this.ensureFolderExists(o);let m=e.path;try{await this.app.fileManager.renameFile(e,f),await this.recordMove(m,f,e.name,a.key)}catch(p){throw k(p,e.path,"move",f)}}catch(n){if(n instanceof S)new w.Notice(n.getUserMessage()),console.error(`[Vault Organizer] ${n.name}:`,n.message,n);else{let a=k(n,e.path,"move",s);new w.Notice(a.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",n)}}}async reorganizeAllMarkdownFiles(){var s,t;let e=(t=(s=this.app.vault).getMarkdownFiles)==null?void 0:t.call(s);if(e!=null&&e.length)for(let n of e)await this.applyRulesToFile(n)}testAllRules(){var t,n,a,r,c,o,h,f;let e=((n=(t=this.app.vault).getMarkdownFiles)==null?void 0:n.call(t))||[],s=[];for(let m of e){let p=(a=this.app.metadataCache.getFileCache(m))==null?void 0:a.frontmatter;if(!p)continue;let v=this.rules.findIndex(T=>T.enabled===!1?!1:B.call(this,m,[T],p));if(v===-1)continue;let g=this.rules[v].destination.trim();if(!g)continue;let u=K(g);if(!u.valid){s.push({file:m,currentPath:m.path,ruleIndex:v,error:u.error,warnings:u.warnings});continue}let d=(r=u.sanitizedPath)!=null?r:"",y=d?`${d}/${m.name}`:m.name,E=A(y,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!E.valid||!E.sanitizedPath){let T=[...(c=u.warnings)!=null?c:[],...(o=E.warnings)!=null?o:[]];s.push({file:m,currentPath:m.path,ruleIndex:v,error:E.error,warnings:T.length?T:void 0});continue}let P=E.sanitizedPath;if(m.path!==P){let T=[...(h=u.warnings)!=null?h:[],...(f=E.warnings)!=null?f:[]];s.push({file:m,currentPath:m.path,newPath:P,ruleIndex:v,warnings:T.length?T:void 0})}}return s}};
