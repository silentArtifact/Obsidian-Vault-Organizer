/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var J=Object.defineProperty;var fe=Object.getOwnPropertyDescriptor;var Te=Object.getOwnPropertyNames;var ve=Object.prototype.hasOwnProperty;var ye=(s,i)=>{for(var e in i)J(s,e,{get:i[e],enumerable:!0})},Se=(s,i,e,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of Te(i))!ve.call(s,t)&&t!==e&&J(s,t,{get:()=>i[t],enumerable:!(n=fe(i,t))||n.enumerable});return s};var Re=s=>Se(J({},"__esModule",{value:!0}),s);var Me={};ye(Me,{default:()=>Z});module.exports=Re(Me);var L=require("obsidian");function ge(s,i){var u;let e=i[s.key];if(e==null)return!1;let n=Array.isArray(e),t=n?e:[e],a=(u=s.matchType)!=null?u:"equals";if(a==="regex"){if(!(s.value instanceof RegExp))return!1;let d=s.value;return t.some(h=>{let p=String(h);return d.lastIndex=0,d.test(p)})}let o=Oe(String(s.value),n),r=a==="contains"||a==="starts-with"||a==="ends-with"?o.filter(d=>d.length>0):o;return r.length?t.some(d=>{let h=String(d);return r.some(p=>be(h,p,a,s.caseInsensitive))}):!1}function ee(s,i,e){var t;let n=e!=null?e:(t=this.app.metadataCache.getFileCache(s))==null?void 0:t.frontmatter;if(n)return i.find(a=>{var h;if(a.enabled===!1)return!1;let o={key:a.key,matchType:a.matchType,value:a.value,caseInsensitive:a.caseInsensitive},r=ge(o,n);if(!a.conditions||a.conditions.length===0)return r;let u=a.conditions.map(p=>ge(p,n));return((h=a.conditionOperator)!=null?h:"AND")==="AND"?r&&u.every(p=>p):r||u.some(p=>p)})}function Oe(s,i){if(!i)return[s];let e=s.trim(),n=e.split(/\s+/).map(a=>a.trim()).filter(Boolean);if(!n.length)return[e];let t=new Set;return e&&t.add(e),n.forEach(a=>t.add(a)),Array.from(t)}function be(s,i,e,n){let t=n?s.toLowerCase():s,a=n?i.toLowerCase():i;switch(e){case"contains":return t.includes(a);case"starts-with":return t.startsWith(a);case"ends-with":return t.endsWith(a);case"equals":default:return t===a}}function Ae(s){var e;let i=(e=s.matchType)!=null?e:"equals";if(i==="regex"){let n=s.value instanceof RegExp?s.value.source:String(s.value),t=s.value instanceof RegExp?s.value.flags:"";return{key:s.key,matchType:i,value:n,isRegex:!0,flags:t,caseInsensitive:s.caseInsensitive}}return{key:s.key,matchType:i,value:String(s.value),caseInsensitive:s.caseInsensitive}}function de(s){return s.map(i=>{var t,a;let e=(t=i.matchType)!=null?t:"equals",n={key:i.key,matchType:e,value:e==="regex"&&i.value instanceof RegExp?i.value.source:String(i.value),destination:i.destination,enabled:(a=i.enabled)!=null?a:!1,debug:i.debug,caseInsensitive:i.caseInsensitive,conditionOperator:i.conditionOperator,conflictResolution:i.conflictResolution};return e==="regex"&&(n.isRegex=!0,n.flags=i.value instanceof RegExp?i.value.flags:""),i.conditions&&i.conditions.length>0&&(n.conditions=i.conditions.map(Ae)),n})}function te(s){return s==="contains"||s==="starts-with"||s==="ends-with"}function ne(s){return typeof s.value=="string"&&s.value.trim().length>0}function Le(s){var e;let i=(e=s.matchType)!=null?e:s.isRegex?"regex":"equals";if(i==="regex")try{let n=new RegExp(s.value,s.flags);return{key:s.key,matchType:i,value:n,caseInsensitive:s.caseInsensitive}}catch(n){console.warn(`[Vault Organizer] Failed to deserialize regex condition for key "${s.key}":`,n);return}return{key:s.key,matchType:i,value:s.value,caseInsensitive:s.caseInsensitive}}function he(s=[]){let i=[],e=[],n=[];return s.forEach((t,a)=>{var u,d,h;let o=(u=t.matchType)!=null?u:t.isRegex?"regex":"equals",r;if(t.conditions&&t.conditions.length>0){let p=t.conditions.map(Le).filter(m=>m!==void 0);p.length>0&&(r=p)}if(o==="regex")try{let p=new RegExp(t.value,t.flags),m={key:t.key,matchType:o,value:p,destination:t.destination,enabled:(d=t.enabled)!=null?d:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:r,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};i.push(m),e.push({index:a,rule:m})}catch(p){let m=p instanceof Error?p.message:String(p),R=t.destination?` (destination: "${t.destination}")`:"",A=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${R}: ${m}. Rule will be ignored.`;console.warn(A),n.push({index:a,message:m,rule:{...t,matchType:o},cause:p})}else{let p={key:t.key,matchType:o,value:t.value,destination:t.destination,enabled:(h=t.enabled)!=null?h:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:r,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};i.push(p),e.push({index:a,rule:p})}}),{rules:i,successes:e,errors:n}}var M=class extends Error{constructor(i){super(i),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},se=class extends M{constructor(e,n,t){let a=V(n);super(`Permission denied: Cannot ${a} "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${V(this.operation)} "${this.filePath}". Check file permissions and try again.`}},D=class extends M{constructor(e,n,t,a,o){let r=V(a),u=n?`Cannot ${r} "${e}" to "${n}"`:`Cannot ${r} "${e}"`;super(`File conflict: ${u} - file ${t}`);this.sourcePath=e;this.destinationPath=n;this.conflictType=t;this.operation=a;this.originalError=o}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},n=V(this.operation);return`${this.destinationPath?`Cannot ${n} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${n} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},C=class extends M{constructor(e,n,t){super(`Invalid path "${e}": ${n}${t?` - ${t}`:""}`);this.path=e;this.reason=n;this.details=t}getUserMessage(){let n={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${n}${t}.`}},ie=class extends M{constructor(e,n,t){let a=V(n);super(`File operation failed: ${a} on "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){var t;let e=V(this.operation),n=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${n}.`}};function B(s,i,e,n){let t=s instanceof Error?s:new Error(String(s)),a=t.message.toLowerCase();return a.includes("permission")||a.includes("eacces")||a.includes("eperm")||a.includes("access denied")?new se(i,e,t):a.includes("already exists")||a.includes("eexist")||a.includes("file exists")?new D(i,n||i,"exists",e,t):a.includes("locked")||a.includes("ebusy")?new D(i,n||i,"locked",e,t):a.includes("in use")||a.includes("being used")||a.includes("etxtbsy")?new D(i,n||i,"in-use",e,t):a.includes("invalid path")||a.includes("invalid character")||a.includes("einval")?new C(n||i,"invalid-characters",t.message):a.includes("path too long")||a.includes("enametoolong")?new C(n||i,"too-long",t.message):new ie(i,e,t)}function V(s){return s.replace(/-/g," ")}var pe=require("obsidian");var ae={windows:260,unix:4096,component:255},we=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),Ie=/[<>:"|?*\x00-\x1F]/,xe=/^([A-Za-z]:[\\/]|\/)/,Ce=/(^|[\\/])\.\.($|[\\/])/,Pe=/\/{2,}|\\{2,}/;function H(s,i={}){let{allowEmpty:e=!1,allowAbsolute:n=!1,maxLength:t=ae.windows,checkReservedNames:a=!0}=i,o=[];if(!s||s.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:o}:{valid:!1,error:new C(s,"empty")};if(xe.test(s)&&!n)return{valid:!1,error:new C(s,"absolute","Use relative paths within the vault")};if(Ce.test(s))return{valid:!1,error:new C(s,"traversal",'Paths cannot contain ".." segments')};let r=(0,pe.normalizePath)(s);Pe.test(r)&&(r=r.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),o.push("Multiple consecutive slashes were normalized")),r=r.trim().replace(/^\/+|\/+$/g,"");let u=r.match(Ie);if(u)return{valid:!1,error:new C(s,"invalid-characters",`Contains invalid character: "${u[0]}"`)};if(r.length>t)return{valid:!1,error:new C(s,"too-long",`Path length (${r.length}) exceeds maximum (${t})`)};let d=r.split("/").filter(Boolean);for(let h of d){if(h.length>ae.component)return{valid:!1,error:new C(s,"too-long",`Path component "${h}" exceeds ${ae.component} characters`)};if(a){let p=h.split(".")[0].toUpperCase();if(we.has(p))return{valid:!1,error:new C(s,"reserved-name",`"${h}" is a reserved system name on Windows`)}}if(h.endsWith(".")||h.endsWith(" "))return{valid:!1,error:new C(s,"invalid-characters",`Path component "${h}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:r,warnings:o.length>0?o:void 0}}function G(s){return H(s,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var Y={REORGANIZE:{name:"Reorganize notes based on frontmatter rules",description:"Apply all configured rules to reorganize vault files"},UNDO:{name:"Undo last automatic move",description:"Revert the most recent file move"},VIEW_HISTORY:{name:"View move history",description:"Show all recent file moves and undo options"}},f={RULE_NAME:"Frontmatter rule",RULE_DESCRIPTION:"Move files to destination folder based on frontmatter matching",EXCLUSION_PATTERNS_NAME:"Exclusion Patterns",EXCLUSION_PATTERNS_DESCRIPTION:"Files and folders matching these patterns will not be automatically organized",TOOLTIPS:{ACTIVATE_RULE:"Activate this rule",MOVE_UP:"Move rule up",MOVE_DOWN:"Move rule down",BROWSE_FRONTMATTER:"Browse frontmatter keys",BROWSE_TAGS:"Browse tags",CASE_INSENSITIVE:"Case insensitive matching",DEBUG_MODE:"Enable debug mode",TEST_ALL_RULES:"Preview what moves would be made without actually moving files",CONFLICT_RESOLUTION:"How to handle file conflicts at destination",CONDITION_OPERATOR:"How to combine multiple conditions (AND/OR)",ADD_CONDITION:"Add another condition to this rule",EXCLUSION_PATTERN:"Glob pattern (e.g., Templates/**, *.excalidraw)"},PLACEHOLDERS:{KEY:"key",VALUE:"value",DESTINATION:"destination folder (supports {variables})",FLAGS:"flags",EXCLUSION_PATTERN:"e.g., Templates/**, Archive/**"},BUTTONS:{REMOVE:"Remove",ADD_RULE:"Add Rule",APPLY_NOW:"Apply now",TEST_ALL_RULES:"Test All Rules",ADD_CONDITION:"+",REMOVE_CONDITION:"Remove Condition",ADD_EXCLUSION:"Add Pattern"},LABELS:{CONFLICT_RESOLUTION:"On Conflict:",CONDITION_OPERATOR:"Combine:",CONDITIONS_SECTION:"Additional Conditions"},WARNINGS:{INVALID_REGEX:s=>`Invalid regular expression: ${s}`,VALUE_REQUIRED:"Value is required for contains/starts-with/ends-with rules."}},S={TEST_ALL_RULES:{TITLE:"Test All Rules - Preview",NO_MOVES_OVERALL:"No files would be moved. All files are either already in the correct location or have no matching rules.",NO_MOVES_ALREADY_CORRECT:"No files would be moved. All matching files are already in the correct location.",FILES_WOULD_MOVE:s=>`${s} file(s) would be moved:`,SKIPPED_SECTION:"Skipped due to invalid destinations",INVALID_DESTINATION_WARNING:"Destination path is invalid and the move cannot be previewed.",LABELS:{FILE:"File:",FROM:"From:",TO:"To:",RULE:"Rule:",WARNINGS:"Warnings:"},BUTTONS:{CLOSE:"Close"}},MOVE_HISTORY:{TITLE:"Move History",NO_HISTORY:"No move history yet.",SHOWING_COUNT:(s,i)=>`Showing ${s} of last ${i} moves.`,MOST_RECENT_PREFIX:"\u{1F504} Most Recent: ",TIME_PREFIX:s=>`\u23F0 ${s}`,LABELS:{FROM:"From:",TO:"To:",RULE:"Rule:"},BUTTONS:{UNDO:"Undo This Move",CLEAR_HISTORY:"Clear History",CLOSE:"Close"},NOTICES:{HISTORY_CLEARED:"Move history cleared."}}},F={UNDO:{NO_MOVES:"No moves to undo.",FILE_NOT_EXISTS:s=>`Cannot undo: File no longer exists at ${s}`,NOT_A_FILE:s=>`Cannot undo: ${s} is not a file.`,DESTINATION_EXISTS:s=>`Cannot undo: A file already exists at ${s}`,SUCCESS:(s,i)=>`Undone: Moved ${s} back to ${i}`},DEBUG:{EMPTY_DESTINATION:(s,i)=>`DEBUG: ${s} would not be moved because destination is empty in ${i}.`,WOULD_MOVE:(s,i,e)=>`DEBUG: ${s} would be moved to ${i}/${e}`},REGEX_PARSE_ERROR:(s,i)=>`Failed to parse regular expression for rule "${s}": ${i}`},U={equals:"Equals",contains:"Contains","starts-with":"Starts with","ends-with":"Ends with",regex:"Regex"};var re={rules:[],moveHistory:[],maxHistorySize:50,excludePatterns:[]},oe=[{value:"equals",label:U.equals},{value:"contains",label:U.contains},{value:"starts-with",label:U["starts-with"]},{value:"ends-with",label:U["ends-with"]},{value:"regex",label:U.regex}];function W(s){var n,t,a,o,r,u;let i=(n=s.matchType)!=null?n:s.isRegex?"regex":"equals",e={...s,matchType:i,key:(t=s.key)!=null?t:"",value:(a=s.value)!=null?a:"",destination:(o=s.destination)!=null?o:"",enabled:(r=s.enabled)!=null?r:!1};return i==="regex"?(e.isRegex=!0,e.flags=(u=s.flags)!=null?u:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var P=require("obsidian");var z=require("obsidian");var q=class extends z.FuzzySuggestModal{constructor(e,n,t){super(e);this.tags=n;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},K=class extends z.FuzzySuggestModal{constructor(e,n,t){super(e);this.keys=n;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},X=class extends z.Modal{constructor(e,n,t){super(e);this.results=n;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:S.TEST_ALL_RULES.TITLE});let n=this.results.filter(r=>r.newPath&&!r.error),t=this.results.filter(r=>r.error);if(n.length===0&&t.length===0)e.createEl("p",{text:S.TEST_ALL_RULES.NO_MOVES_OVERALL});else{if(n.length){e.createEl("p",{text:S.TEST_ALL_RULES.FILES_WOULD_MOVE(n.length)});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",n.forEach(u=>{var A,b;let d=r.createDiv({cls:"vault-organizer-test-result-item"});d.style.marginBottom="1em",d.style.padding="0.5em",d.style.border="1px solid var(--background-modifier-border)",d.style.borderRadius="4px";let h=d.createDiv();h.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:u.file.basename});let p=d.createDiv();p.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:u.currentPath});let m=d.createDiv();m.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.TO}),m.createSpan({text:u.newPath||"(unknown)"});let R=d.createDiv();if(R.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.RULE}),R.createSpan({text:`Rule ${u.ruleIndex+1} (${((A=this.rules[u.ruleIndex])==null?void 0:A.key)||"unknown"})`}),(b=u.warnings)!=null&&b.length){let g=d.createDiv();g.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.WARNINGS}),g.createSpan({text:u.warnings.join("; ")})}})}else e.createEl("p",{text:S.TEST_ALL_RULES.NO_MOVES_ALREADY_CORRECT});if(t.length){e.createEl("h3",{text:S.TEST_ALL_RULES.SKIPPED_SECTION});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",t.forEach(u=>{var A,b,g,l;let d=r.createDiv({cls:"vault-organizer-test-result-item"});d.style.marginBottom="1em",d.style.padding="0.5em",d.style.border="1px solid var(--background-modifier-border)",d.style.borderRadius="4px";let h=d.createDiv();h.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:u.file.basename});let p=d.createDiv();p.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:u.currentPath});let m=d.createDiv();m.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.RULE}),m.createSpan({text:`Rule ${u.ruleIndex+1} (${((A=this.rules[u.ruleIndex])==null?void 0:A.key)||"unknown"})`});let R=d.createDiv();if(R.createEl("strong",{text:"Reason: "}),R.createSpan({text:(g=(b=u.error)==null?void 0:b.getUserMessage())!=null?g:S.TEST_ALL_RULES.INVALID_DESTINATION_WARNING}),(l=u.warnings)!=null&&l.length){let c=d.createDiv();c.createEl("strong",{text:S.TEST_ALL_RULES.LABELS.WARNINGS}),c.createSpan({text:u.warnings.join("; ")})}})}}let a=e.createDiv({cls:"modal-button-container"});a.style.marginTop="1.5em",a.style.textAlign="right";let o=a.createEl("button",{text:S.TEST_ALL_RULES.BUTTONS.CLOSE});o.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},j=class extends z.Modal{constructor(e,n){super(e);this.plugin=n}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:S.MOVE_HISTORY.TITLE}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:S.MOVE_HISTORY.NO_HISTORY});else{e.createEl("p",{text:S.MOVE_HISTORY.SHOWING_COUNT(this.plugin.settings.moveHistory.length,this.plugin.settings.maxHistorySize)});let o=e.createDiv({cls:"vault-organizer-history-container"});o.style.maxHeight="500px",o.style.overflowY="auto",o.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((r,u)=>{let d=o.createDiv({cls:"vault-organizer-history-item"});d.style.marginBottom="1em",d.style.padding="0.8em",d.style.border="1px solid var(--background-modifier-border)",d.style.borderRadius="4px",d.style.position="relative",u===0&&(d.style.backgroundColor="var(--background-secondary-alt)",d.style.borderColor="var(--interactive-accent)");let h=d.createDiv();h.style.marginBottom="0.5em",h.style.fontWeight="bold";let m=new Date(r.timestamp).toLocaleString();u===0&&h.createEl("span",{text:S.MOVE_HISTORY.MOST_RECENT_PREFIX,cls:"vault-organizer-recent-label"}),h.createSpan({text:r.fileName});let R=d.createDiv();R.style.fontSize="0.9em",R.style.color="var(--text-muted)",R.style.marginBottom="0.5em",R.textContent=S.MOVE_HISTORY.TIME_PREFIX(m);let A=d.createDiv();A.createEl("strong",{text:S.MOVE_HISTORY.LABELS.FROM}),A.createSpan({text:r.fromPath});let b=d.createDiv();b.createEl("strong",{text:S.MOVE_HISTORY.LABELS.TO}),b.createSpan({text:r.toPath});let g=d.createDiv();if(g.createEl("strong",{text:S.MOVE_HISTORY.LABELS.RULE}),g.createSpan({text:r.ruleKey||"(unknown)"}),u===0){let l=d.createDiv();l.style.marginTop="0.8em";let c=l.createEl("button",{text:S.MOVE_HISTORY.BUTTONS.UNDO});c.style.backgroundColor="var(--interactive-accent)",c.style.color="var(--text-on-accent)",c.style.padding="0.4em 0.8em",c.style.border="none",c.style.borderRadius="4px",c.style.cursor="pointer",c.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="1.5em",n.style.textAlign="right";let t=n.createEl("button",{text:S.MOVE_HISTORY.BUTTONS.CLEAR_HISTORY});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new z.Notice(S.MOVE_HISTORY.NOTICES.HISTORY_CLEARED),this.close()};let a=n.createEl("button",{text:S.MOVE_HISTORY.BUTTONS.CLOSE});a.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};var Ne=300,_e=1e3,Q=class extends P.PluginSettingTab{constructor(e,n){super(e,n);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=n,this.debouncedSaveOnly=(0,P.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},Ne),this.debouncedRefreshMetadata=(0,P.debounce)(()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()},_e),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.debouncedRefreshMetadata()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,a,o;let e=new Set;((o=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?o:[]).forEach(r=>{let u=this.plugin.app.metadataCache.getFileCache(r);if(!u)return;let d=(0,P.getAllTags)(u);d&&d.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((r,u)=>r.localeCompare(u))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,a,o;let e=new Set;((o=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?o:[]).forEach(r=>{let u=this.plugin.app.metadataCache.getFileCache(r),d=u==null?void 0:u.frontmatter;d&&Object.keys(d).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((r,u)=>r.localeCompare(u))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,n){if(!e.length)return;new q(this.app,e,n).open()}openFrontmatterKeyPicker(e,n){if(!e.length)return;new K(this.app,e,n).open()}toggleTagValue(e,n){let t=e.split(/\s+/).filter(Boolean);return(t.includes(n)?t.filter(r=>r!==n):[...t,n]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(W),this.plugin.settings.rules.forEach((n,t)=>{var b;let a=(b=n.matchType)!=null?b:"equals",o=new P.Setting(e).setName(`${f.RULE_NAME} ${t+1}`).setDesc(f.RULE_DESCRIPTION);o.settingEl.classList.add("setting-item");let r=document.createElement("div");r.classList.add("vault-organizer-rule-message"),r.style.display="none",o.settingEl.appendChild(r);let u=()=>{var c;let g=this.plugin.settings.rules[t],l=(c=g==null?void 0:g.enabled)!=null?c:!1;o.settingEl.classList.toggle("vault-organizer-rule-disabled",!l)};o.addToggle(g=>{var l;return g.setTooltip(f.TOOLTIPS.ACTIVATE_RULE).setValue((l=n.enabled)!=null?l:!1).onChange(async c=>{let E=this.plugin.settings.rules[t];E&&(E.enabled=c,u(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),u())})}),o.addExtraButton(g=>g.setIcon("arrow-up").setTooltip(f.TOOLTIPS.MOVE_UP).setDisabled(t===0).onClick(async()=>{if(t===0)return;let l=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=l,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),o.addExtraButton(g=>g.setIcon("arrow-down").setTooltip(f.TOOLTIPS.MOVE_DOWN).setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let l=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=l,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let d=()=>{var x;let g=this.plugin.getRuleErrorForIndex(t),l=this.plugin.settings.rules[t],c=(x=l==null?void 0:l.matchType)!=null?x:"equals",E=te(c),I=l?ne(l):!1;g?(r.classList.add("vault-organizer-rule-error"),r.classList.remove("vault-organizer-rule-warning"),r.textContent=f.WARNINGS.INVALID_REGEX(g.message),r.style.display=""):E&&!I?(r.classList.add("vault-organizer-rule-warning"),r.classList.remove("vault-organizer-rule-error"),r.textContent=f.WARNINGS.VALUE_REQUIRED,r.style.display=""):(r.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),r.textContent="",r.style.display="none")},h;o.addText(g=>{h=g,g.setPlaceholder(f.PLACEHOLDERS.KEY).setValue(n.key).onChange(l=>{let c=this.plugin.settings.rules[t];c&&(c.key=l,this.scheduleSaveOnly())})}),o.addExtraButton(g=>g.setIcon("list").setTooltip(f.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let l=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(l,c=>{let E=this.plugin.settings.rules[t];!E||!h||(h.setValue(c),E.key=c,this.scheduleSaveOnly())})}));let p;o.addText(g=>{p=g,g.setPlaceholder(f.PLACEHOLDERS.VALUE).setValue(n.value).onChange(l=>{let c=this.plugin.settings.rules[t];c&&(c.value=l,this.scheduleSaveOnly(),d())})}),o.addExtraButton(g=>g.setIcon("hashtag").setTooltip(f.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let l=this.getAggregatedTags();this.openTagPicker(l,c=>{let E=this.plugin.settings.rules[t];if(!E||!p)return;let I=this.toggleTagValue(p.getValue(),c);p.setValue(I),E.value=I,this.scheduleSaveOnly()})})),o.addText(g=>g.setPlaceholder(f.PLACEHOLDERS.DESTINATION).setValue(n.destination).onChange(l=>{let c=this.plugin.settings.rules[t];c&&(c.destination=l,this.scheduleSaveOnly())}));let m,R,A=()=>{var c;let g=this.plugin.settings.rules[t],l=((c=g==null?void 0:g.matchType)!=null?c:"equals")==="regex";m&&(m.inputEl.toggleAttribute("disabled",!l),m.inputEl.disabled=!l,m.inputEl.style.display=l?"":"none"),R&&(R.toggleEl.style.display=l?"none":"")};o.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),oe.forEach(l=>g.addOption(l.value,l.label)),g.setValue(a).onChange(async l=>{var E;let c=this.plugin.settings.rules[t];c&&(c.matchType=l,l==="regex"?(c.isRegex=!0,c.flags=(E=c.flags)!=null?E:""):(delete c.isRegex,"flags"in c&&delete c.flags),A(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),A(),d())})}),o.addDropdown(g=>{var l;g.selectEl.setAttribute("aria-label","Conflict resolution"),g.selectEl.setAttribute("title",f.TOOLTIPS.CONFLICT_RESOLUTION),g.addOption("fail","Fail"),g.addOption("skip","Skip"),g.addOption("append-number","Add number"),g.addOption("append-timestamp","Add timestamp"),g.setValue((l=n.conflictResolution)!=null?l:"fail").onChange(c=>{let E=this.plugin.settings.rules[t];E&&(E.conflictResolution=c,this.scheduleSaveOnly())})}),o.addDropdown(g=>{var l;g.selectEl.setAttribute("aria-label","Condition operator"),g.selectEl.setAttribute("title",f.TOOLTIPS.CONDITION_OPERATOR),g.addOption("AND","AND"),g.addOption("OR","OR"),g.setValue((l=n.conditionOperator)!=null?l:"AND").onChange(c=>{let E=this.plugin.settings.rules[t];E&&(E.conditionOperator=c,this.scheduleSaveOnly())})}),o.addText(g=>{var l;m=g,g.setPlaceholder(f.PLACEHOLDERS.FLAGS).setValue((l=n.flags)!=null?l:"").onChange(c=>{let E=this.plugin.settings.rules[t];E&&E.matchType==="regex"&&(E.flags=c,this.scheduleSaveOnly())})}),A(),o.addToggle(g=>{var l;R=g,g.setTooltip(f.TOOLTIPS.CASE_INSENSITIVE).setValue((l=n.caseInsensitive)!=null?l:!1).onChange(async c=>{let E=this.plugin.settings.rules[t];E&&(E.caseInsensitive=c,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),o.addToggle(g=>{var l;return g.setTooltip(f.TOOLTIPS.DEBUG_MODE).setValue((l=n.debug)!=null?l:!1).onChange(async c=>{let E=this.plugin.settings.rules[t];E&&(E.debug=c,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),o.addButton(g=>g.setButtonText(f.BUTTONS.ADD_CONDITION).setTooltip(f.TOOLTIPS.ADD_CONDITION).onClick(async()=>{let l=this.plugin.settings.rules[t];l&&(l.conditions||(l.conditions=[]),l.conditions.push({key:"",value:"",matchType:"equals"}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display())})),o.addButton(g=>g.setButtonText(f.BUTTONS.REMOVE).onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),n.conditions&&n.conditions.length>0&&n.conditions.forEach((g,l)=>{var $;let c=new P.Setting(e).setName(`${f.LABELS.CONDITIONS_SECTION} ${l+1}`).setClass("vault-organizer-condition"),E;c.addText(T=>{E=T,T.setPlaceholder(f.PLACEHOLDERS.KEY).setValue(g.key).onChange(O=>{var y;let v=this.plugin.settings.rules[t];(y=v==null?void 0:v.conditions)!=null&&y[l]&&(v.conditions[l].key=O,this.scheduleSaveOnly())})}),c.addExtraButton(T=>T.setIcon("list").setTooltip(f.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let O=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(O,v=>{var w;let y=this.plugin.settings.rules[t];!((w=y==null?void 0:y.conditions)!=null&&w[l])||!E||(E.setValue(v),y.conditions[l].key=v,this.scheduleSaveOnly())})}));let I;c.addText(T=>{I=T,T.setPlaceholder(f.PLACEHOLDERS.VALUE).setValue(g.value).onChange(O=>{var y;let v=this.plugin.settings.rules[t];(y=v==null?void 0:v.conditions)!=null&&y[l]&&(v.conditions[l].value=O,this.scheduleSaveOnly())})}),c.addExtraButton(T=>T.setIcon("hashtag").setTooltip(f.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let O=this.getAggregatedTags();this.openTagPicker(O,v=>{var ue;let y=this.plugin.settings.rules[t];if(!((ue=y==null?void 0:y.conditions)!=null&&ue[l])||!I)return;let w=this.toggleTagValue(I.getValue(),v);I.setValue(w),y.conditions[l].value=w,this.scheduleSaveOnly()})}));let x=($=g.matchType)!=null?$:"equals",N,k,_=()=>{var y,w;let T=this.plugin.settings.rules[t],O=(y=T==null?void 0:T.conditions)==null?void 0:y[l],v=((w=O==null?void 0:O.matchType)!=null?w:"equals")==="regex";N&&(N.inputEl.toggleAttribute("disabled",!v),N.inputEl.disabled=!v,N.inputEl.style.display=v?"":"none"),k&&(k.toggleEl.style.display=v?"none":"")};c.addDropdown(T=>{T.selectEl.setAttribute("aria-label","Match type"),oe.forEach(O=>T.addOption(O.value,O.label)),T.setValue(x).onChange(async O=>{var y,w;let v=this.plugin.settings.rules[t];(y=v==null?void 0:v.conditions)!=null&&y[l]&&(v.conditions[l].matchType=O,O==="regex"?(v.conditions[l].isRegex=!0,v.conditions[l].flags=(w=v.conditions[l].flags)!=null?w:""):(delete v.conditions[l].isRegex,"flags"in v.conditions[l]&&delete v.conditions[l].flags),_(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),_())})}),c.addText(T=>{var O;N=T,T.setPlaceholder(f.PLACEHOLDERS.FLAGS).setValue((O=g.flags)!=null?O:"").onChange(v=>{var w;let y=this.plugin.settings.rules[t];(w=y==null?void 0:y.conditions)!=null&&w[l]&&y.conditions[l].matchType==="regex"&&(y.conditions[l].flags=v,this.scheduleSaveOnly())})}),c.addToggle(T=>{var O;k=T,T.setTooltip(f.TOOLTIPS.CASE_INSENSITIVE).setValue((O=g.caseInsensitive)!=null?O:!1).onChange(async v=>{var w;let y=this.plugin.settings.rules[t];(w=y==null?void 0:y.conditions)!=null&&w[l]&&(y.conditions[l].caseInsensitive=v,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),c.addButton(T=>T.setButtonText(f.BUTTONS.REMOVE_CONDITION).onClick(async()=>{let O=this.plugin.settings.rules[t];O!=null&&O.conditions&&(O.conditions.splice(l,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display())})),_()}),d(),u()}),new P.Setting(e).addButton(n=>n.setButtonText(f.BUTTONS.ADD_RULE).onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new P.Setting(e).addButton(n=>n.setButtonText(f.BUTTONS.APPLY_NOW).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(n=>n.setButtonText(f.BUTTONS.TEST_ALL_RULES).setTooltip(f.TOOLTIPS.TEST_ALL_RULES).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new X(this.app,t,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,a)=>{var R,A;let o=t.querySelector(".vault-organizer-rule-message");if(!o)return;let r=this.plugin.settings.rules[a],u=(R=r==null?void 0:r.enabled)!=null?R:!1;t.classList.toggle("vault-organizer-rule-disabled",!u);let d=this.plugin.getRuleErrorForIndex(a),h=(A=r==null?void 0:r.matchType)!=null?A:"equals",p=te(h),m=r?ne(r):!1;d?(o.classList.add("vault-organizer-rule-error"),o.classList.remove("vault-organizer-rule-warning"),o.textContent=f.WARNINGS.INVALID_REGEX(d.message),o.style.display=""):p&&!m?(o.classList.add("vault-organizer-rule-warning"),o.classList.remove("vault-organizer-rule-error"),o.textContent=f.WARNINGS.VALUE_REQUIRED,o.style.display=""):(o.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),o.textContent="",o.style.display="none")})}};function Fe(s){let i=/\{([^}]+)\}/g,e=[],n;for(;(n=i.exec(s))!==null;)e.push(n[1]);return e}function me(s){if(s==null)return"";let i=String(s);return i=i.replace(/[<>:"|?*]/g,""),i=i.replace(/\\/g,"-"),i=i.replace(/\//g,"-"),i=i.trim().replace(/^\.+|\.+$/g,""),i=i.replace(/\s+/g," "),i}function le(s,i){let e=Fe(s);if(e.length===0)return{substitutedPath:s,substituted:[],missing:[],hasVariables:!1};let n=[],t=[],a=s;for(let o of e){let r=i==null?void 0:i[o];if(r==null)t.push(o),a=a.replace(new RegExp(`\\{${Ee(o)}\\}`,"g"),"");else{n.push(o);let u;Array.isArray(r)?u=r.map(d=>me(d)).filter(Boolean).join(","):u=me(r),a=a.replace(new RegExp(`\\{${Ee(o)}\\}`,"g"),u)}}return a=a.replace(/\/+/g,"/").replace(/^\/+|\/+$/g,""),a=a.split("/").filter(Boolean).join("/"),{substitutedPath:a,substituted:n,missing:t,hasVariables:!0}}function Ee(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function De(s){let i="^",e=0;for(;e<s.length;){let n=s[e];if(n==="*")s[e+1]==="*"?(i+=".*",e+=2):(i+="[^/]*",e+=1);else if(n==="?")i+="[^/]",e+=1;else if(n==="["){let t=s.indexOf("]",e);t===-1?(i+="\\[",e+=1):(i+=s.substring(e,t+1),e=t+1)}else/[.+^${}()|\\]/.test(n)?(i+="\\"+n,e+=1):(i+=n,e+=1)}return i+="$",new RegExp(i)}function ce(s,i){if(!i||i.length===0)return!1;let e=s.replace(/\\/g,"/");for(let n of i){if(!n||n.trim()==="")continue;let t=n.trim().replace(/\\/g,"/");if(De(t).test(e))return!0;let o=t.replace(/\/$/,"");if(e.startsWith(o+"/"))return!0}return!1}var Z=class extends L.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[];this.batchOperationInProgress=!1}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async n=>{!(n instanceof L.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async n=>{!(n instanceof L.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:Y.REORGANIZE.name,callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:Y.UNDO.name,callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:Y.VIEW_HISTORY.name,callback:()=>{new j(this.app,this).open()}}),this.ruleSettingTab=new Q(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),n=Array.isArray(e==null?void 0:e.rules)?e.rules.map(W):[];this.settings={...re,...e,rules:n,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:re.maxHistorySize,excludePatterns:Array.isArray(e==null?void 0:e.excludePatterns)?e.excludePatterns:[]}}async saveSettings(){this.settings.rules=this.settings.rules.map(W),!this.batchOperationInProgress&&await this.saveData(this.settings)}async withBatchOperation(e){if(this.batchOperationInProgress)return console.warn("[Vault Organizer] Nested batch operations are not supported. Using existing batch context."),await e();this.batchOperationInProgress=!0;try{return await e()}finally{this.batchOperationInProgress=!1,await this.saveData(this.settings)}}updateRulesFromSettings(){let{rules:e,successes:n,errors:t}=he(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:n,errors:t}}async persistSettingsAndRefreshRules(){var o;let{successes:e,errors:n}=this.updateRulesFromSettings(),t=de(e.map(r=>r.rule)),a=[...this.settings.rules];e.forEach((r,u)=>{a[r.index]=t[u]}),this.settings.rules=a,await this.saveSettings(),n.length&&n.forEach(r=>{let u=r.rule.key||"(unnamed rule)",d=F.REGEX_PARSE_ERROR(u,r.message);new L.Notice(d)}),(o=this.ruleSettingTab)==null||o.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(n=>n.index===e)}async recordMove(e,n,t,a,o=!1){if(!e||!n||!t)throw new Error("Invalid move parameters: fromPath, toPath, and fileName are required");let r={timestamp:Date.now(),fileName:t,fromPath:e,toPath:n,ruleKey:a};this.settings.moveHistory.unshift(r),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),o||await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new L.Notice(F.UNDO.NO_MOVES);return}let e=this.settings.moveHistory[0],n=this.app.vault.getAbstractFileByPath(e.toPath);if(!n){new L.Notice(F.UNDO.FILE_NOT_EXISTS(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(n instanceof L.TFile)){new L.Notice(F.UNDO.NOT_A_FILE(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new L.Notice(F.UNDO.DESTINATION_EXISTS(e.fromPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let a=e.fromPath.lastIndexOf("/");if(a>0){let o=e.fromPath.substring(0,a);await this.ensureFolderExists(o)}await this.app.fileManager.renameFile(n,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new L.Notice(F.UNDO.SUCCESS(e.fileName,e.fromPath))}catch(a){let o=B(a,e.toPath,"move",e.fromPath);new L.Notice(o.getUserMessage()),console.error("[Vault Organizer] Undo failed:",a)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let n=H(e,{allowEmpty:!1,allowAbsolute:!1});if(!n.valid||!n.sanitizedPath)throw n.error||new Error("Path validation failed");let a=n.sanitizedPath.split("/").filter(Boolean);if(!a.length)return;let o="";for(let r of a){o=o?`${o}/${r}`:r;let u=this.app.vault.getAbstractFileByPath(o);if(u){if(u instanceof L.TFile)throw new D(o,void 0,"exists","create-folder");continue}try{await this.app.vault.createFolder(o)}catch(d){throw B(d,o,"create-folder")}}}generateUniqueFilename(e,n,t){if(t==="append-timestamp"){let r=Date.now();return`${e}-${r}${n}`}let a=1,o=`${e}-${a}${n}`;for(;this.app.vault.getAbstractFileByPath(o);)a++,o=`${e}-${a}${n}`;return o}async applyRulesToFile(e,n=!1){var a;let t;try{if(ce(e.path,this.settings.excludePatterns))return;let o=this.app.metadataCache.getFileCache(e),r=o==null?void 0:o.frontmatter;if(!r)return;let u=ee.call(this,e,this.rules,r);if(!u)return;let d=u.destination.trim();if(!d){if(u.debug){let c=this.app.vault.getName();new L.Notice(F.DEBUG.EMPTY_DESTINATION(e.basename,c))}return}let h=le(d,r),p=h.substitutedPath;u.debug&&h.missing.length>0&&new L.Notice(`DEBUG: Missing variables in destination: ${h.missing.join(", ")}`);let m=G(p);if(!m.valid||!m.sanitizedPath)throw m.error||new Error("Destination path validation failed");let R=m.sanitizedPath,A=H(`${R}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!A.valid||!A.sanitizedPath)throw A.error||new Error("Full path validation failed");let b=A.sanitizedPath;if(t=b,e.path===b)return;if(u.debug){let c=this.app.vault.getName();new L.Notice(F.DEBUG.WOULD_MOVE(e.basename,c,R));return}if(await this.ensureFolderExists(R),this.app.vault.getAbstractFileByPath(b)){let c=(a=u.conflictResolution)!=null?a:"fail";if(c==="skip")return;if(c==="append-number"||c==="append-timestamp"){let E=e.name.lastIndexOf("."),I=E>0?e.name.substring(0,E):e.name,x=E>0?e.name.substring(E):"",N=`${R}/${I}`;b=this.generateUniqueFilename(N,x,c),t=b}else throw new D(b,e.path,"exists","move")}let l=e.path;try{await this.app.fileManager.renameFile(e,b),await this.recordMove(l,b,e.name,u.key,n)}catch(c){throw B(c,e.path,"move",b)}}catch(o){if(o instanceof M)new L.Notice(o.getUserMessage()),console.error(`[Vault Organizer] ${o.name}:`,o.message,o);else{let r=B(o,e.path,"move",t);new L.Notice(r.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",o)}}}async reorganizeAllMarkdownFiles(){var n,t;let e=(t=(n=this.app.vault).getMarkdownFiles)==null?void 0:t.call(n);e!=null&&e.length&&await this.withBatchOperation(async()=>{for(let a of e)await this.applyRulesToFile(a,!0)})}testAllRules(){var t,a,o,r,u,d,h,p;let e=((a=(t=this.app.vault).getMarkdownFiles)==null?void 0:a.call(t))||[],n=[];for(let m of e){if(ce(m.path,this.settings.excludePatterns))continue;let R=this.app.metadataCache.getFileCache(m),A=R==null?void 0:R.frontmatter;if(!A)continue;let b=this.rules.findIndex(T=>T.enabled===!1?!1:ee.call(this,m,[T],A));if(b===-1)continue;let l=this.rules[b].destination.trim();if(!l)continue;let c=le(l,A),E=c.substitutedPath,I=c.missing.length>0?[`Missing variables: ${c.missing.join(", ")}`]:[],x=G(E);if(!x.valid){n.push({file:m,currentPath:m.path,ruleIndex:b,error:x.error,warnings:[...I,...(o=x.warnings)!=null?o:[]]});continue}let N=(r=x.sanitizedPath)!=null?r:"",k=N?`${N}/${m.name}`:m.name,_=H(k,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!_.valid||!_.sanitizedPath){let T=[...I,...(u=x.warnings)!=null?u:[],...(d=_.warnings)!=null?d:[]];n.push({file:m,currentPath:m.path,ruleIndex:b,error:_.error,warnings:T.length?T:void 0});continue}let $=_.sanitizedPath;if(m.path!==$){let T=[...I,...(h=x.warnings)!=null?h:[],...(p=_.warnings)!=null?p:[]];n.push({file:m,currentPath:m.path,newPath:$,ruleIndex:b,warnings:T.length?T:void 0})}}return n}};
