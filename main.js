/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var he=Object.defineProperty;var ze=Object.getOwnPropertyDescriptor;var Ve=Object.getOwnPropertyNames;var $e=Object.prototype.hasOwnProperty;var ke=(t,r)=>{for(var e in r)he(t,e,{get:r[e],enumerable:!0})},Be=(t,r,e,n)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Ve(r))!$e.call(t,s)&&s!==e&&he(t,s,{get:()=>r[s],enumerable:!(n=ze(r,s))||n.enumerable});return t};var He=t=>Be(he({},"__esModule",{value:!0}),t);var lt={};ke(lt,{default:()=>ce});module.exports=He(lt);var x=require("obsidian");var b=class{static error(r,e){console.error(`${this.PREFIX} ERROR:`,r,e!==void 0?e:"")}static warn(r,e){console.warn(`${this.PREFIX} WARN:`,r,e!==void 0?e:"")}static info(r,e){console.info(`${this.PREFIX} INFO:`,r,e!==void 0?e:"")}static debug(r,e){var s,i;let n=!1;try{typeof process!="undefined"&&(process!=null&&process.env)&&(n=!1)}catch(l){n=!1}!n&&typeof window!="undefined"&&(n=((s=window.location)==null?void 0:s.hostname)==="localhost"||((i=window.location)==null?void 0:i.hostname)==="127.0.0.1"),n&&console.debug(`${this.PREFIX} DEBUG:`,r,e!==void 0?e:"")}};b.PREFIX="[Vault Organizer]";var $={MAX_PATTERN_LENGTH:500,MAX_CAPTURING_GROUPS:20,MAX_NESTING_DEPTH:10,MAX_ALTERNATIONS:50},Ge=[/\([^)]*[+*]\)[+*]/,/[+*]{2,}/,/\([^)]*\|[^)]*\)[+*]/,/\(\([^)]*[+*]\)[+*]\)/];function pe(t,r){let e=[];if(t.length>$.MAX_PATTERN_LENGTH)return{valid:!1,error:`Pattern too long (${t.length} chars). Maximum: ${$.MAX_PATTERN_LENGTH}`};for(let l of Ge)if(l.test(t))return{valid:!1,error:"Pattern contains potentially dangerous nested quantifiers that could cause performance issues"};let n=(t.match(/(?<!\\)\(/g)||[]).length;if(n>$.MAX_CAPTURING_GROUPS)return{valid:!1,error:`Too many capturing groups (${n}). Maximum: ${$.MAX_CAPTURING_GROUPS}`};let s=(t.match(/(?<!\\)\|/g)||[]).length;if(s>$.MAX_ALTERNATIONS)return{valid:!1,error:`Too many alternations (${s}). Maximum: ${$.MAX_ALTERNATIONS}`};let i=We(t);if(i>$.MAX_NESTING_DEPTH)return{valid:!1,error:`Nesting too deep (${i} levels). Maximum: ${$.MAX_NESTING_DEPTH}`};t.includes(".*.*")&&e.push("Pattern contains multiple .* which may be slow on large inputs"),t.includes(".+.+")&&e.push("Pattern contains multiple .+ which may be slow on large inputs");try{return{valid:!0,regex:new RegExp(t,r),warnings:e.length>0?e:void 0}}catch(l){return{valid:!1,error:`Invalid regex syntax: ${l instanceof Error?l.message:String(l)}`}}}function We(t){let r=0,e=0,n=!1;for(let s=0;s<t.length;s++){let i=t[s];if(n){n=!1;continue}if(i==="\\"){n=!0;continue}i==="("?(e++,r=Math.max(r,e)):i===")"&&(e=Math.max(0,e-1))}return r}function Ne(t,r){var a;let e=r[t.key];if(e==null)return!1;let n=Array.isArray(e),s=n?e:[e],i=(a=t.matchType)!=null?a:"equals";if(i==="regex"){if(!(t.value instanceof RegExp))return!1;let c=t.value;return s.some(u=>{let d=String(u);return new RegExp(c.source,c.flags).test(d)})}let l=Xe(String(t.value),n),o=i==="contains"||i==="starts-with"||i==="ends-with"?l.filter(c=>c.length>0):l;return o.length?s.some(c=>{let u=String(c);return o.some(d=>Ye(u,d,i,t.caseInsensitive))}):!1}function me(t,r,e){var s;let n=e!=null?e:(s=this.app.metadataCache.getFileCache(t))==null?void 0:s.frontmatter;if(n)return r.find(i=>{var u,d;if(i.enabled===!1)return!1;let l={key:i.key,matchType:i.matchType,value:i.value,caseInsensitive:i.caseInsensitive},o=Ne(l,n);if(!((u=i.conditions)!=null&&u.length))return o;let a=i.conditions.map(p=>Ne(p,n));return((d=i.conditionOperator)!=null?d:"AND")==="AND"?o&&a.every(p=>p):o||a.some(p=>p)})}function Xe(t,r){if(!r)return[t];let e=t.trim(),n=e.split(/\s+/).map(i=>i.trim()).filter(Boolean);if(!n.length)return[e];let s=new Set;return e&&s.add(e),n.forEach(i=>s.add(i)),Array.from(s)}function Ye(t,r,e,n){let s=n?t.toLowerCase():t,i=n?r.toLowerCase():r;switch(e){case"contains":return s.includes(i);case"starts-with":return s.startsWith(i);case"ends-with":return s.endsWith(i);case"equals":default:return s===i}}function qe(t){var e;let r=(e=t.matchType)!=null?e:"equals";if(r==="regex"){let n=t.value instanceof RegExp?t.value.source:String(t.value),s=t.value instanceof RegExp?t.value.flags:"";return{key:t.key,matchType:r,value:n,isRegex:!0,flags:s,caseInsensitive:t.caseInsensitive}}return{key:t.key,matchType:r,value:String(t.value),caseInsensitive:t.caseInsensitive}}function we(t){return t.map(r=>{var s,i;let e=(s=r.matchType)!=null?s:"equals",n={key:r.key,matchType:e,value:e==="regex"&&r.value instanceof RegExp?r.value.source:String(r.value),destination:r.destination,enabled:(i=r.enabled)!=null?i:!1,debug:r.debug,caseInsensitive:r.caseInsensitive,conditionOperator:r.conditionOperator,conflictResolution:r.conflictResolution};return e==="regex"&&(n.isRegex=!0,n.flags=r.value instanceof RegExp?r.value.flags:""),r.conditions&&r.conditions.length>0&&(n.conditions=r.conditions.map(qe)),n})}function Ee(t){return t==="contains"||t==="starts-with"||t==="ends-with"}function fe(t){return typeof t.value=="string"&&t.value.trim().length>0}function Ke(t){var e;let r=(e=t.matchType)!=null?e:t.isRegex?"regex":"equals";if(r==="regex"){let n=pe(t.value,t.flags);if(!n.valid){b.warn(`Failed to deserialize regex condition for key "${t.key}": ${n.error}`,t.value);return}if(n.warnings&&n.warnings.length>0&&b.warn(`Regex condition for key "${t.key}" has warnings`,n.warnings.join("; ")),!n.regex){b.error("Unexpected: validation succeeded but regex is undefined",t.value);return}return{key:t.key,matchType:r,value:n.regex,caseInsensitive:t.caseInsensitive}}return{key:t.key,matchType:r,value:t.value,caseInsensitive:t.caseInsensitive}}function Pe(t=[]){let r=[],e=[],n=[];return t.forEach((s,i)=>{var a,c,u;let l=(a=s.matchType)!=null?a:s.isRegex?"regex":"equals",o;if(s.conditions&&s.conditions.length>0){let d=s.conditions.map(Ke).filter(p=>p!==void 0);d.length>0&&(o=d)}if(l==="regex"){let d=pe(s.value,s.flags);if(d.valid)if(d.warnings&&d.warnings.length>0&&b.warn(`Regex for frontmatter rule "${s.key}" has performance warnings`,d.warnings.join("; ")),d.regex){let p={key:s.key,matchType:l,value:d.regex,destination:s.destination,enabled:(c=s.enabled)!=null?c:!1,debug:s.debug,caseInsensitive:s.caseInsensitive,conditions:o,conditionOperator:s.conditionOperator,conflictResolution:s.conflictResolution};r.push(p),e.push({index:i,rule:p})}else{let p="Unexpected: validation succeeded but regex is undefined";b.error(p,s.value),n.push({index:i,message:p,rule:{...s,matchType:l},cause:new Error(p)})}else{let p=d.error||"Unknown validation error",f=s.destination?` (destination: "${s.destination}")`:"";b.warn(`Failed to deserialize regex for frontmatter rule "${s.key}"${f}: ${p}. Rule will be ignored.`,s.value),n.push({index:i,message:p,rule:{...s,matchType:l},cause:new Error(p)})}}else{let d={key:s.key,matchType:l,value:s.value,destination:s.destination,enabled:(u=s.enabled)!=null?u:!1,debug:s.debug,caseInsensitive:s.caseInsensitive,conditions:o,conditionOperator:s.conditionOperator,conflictResolution:s.conflictResolution};r.push(d),e.push({index:i,rule:d})}}),{rules:r,successes:e,errors:n}}var B=class extends Error{constructor(r){super(r),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},ve=class extends B{constructor(e,n,s){let i=X(n);super(`Permission denied: Cannot ${i} "${e}"`);this.filePath=e;this.operation=n;this.originalError=s}getUserMessage(){return`Permission denied: Cannot ${X(this.operation)} "${this.filePath}". Check file permissions and try again.`}},k=class extends B{constructor(e,n,s,i,l){let o=X(i),a=n?`Cannot ${o} "${e}" to "${n}"`:`Cannot ${o} "${e}"`;super(`File conflict: ${a} - file ${s}`);this.sourcePath=e;this.destinationPath=n;this.conflictType=s;this.operation=i;this.originalError=l}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use","max-attempts":"exceeded maximum attempts to find a unique filename"},n=X(this.operation);return`${this.destinationPath?`Cannot ${n} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${n} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},L=class extends B{constructor(e,n,s){super(`Invalid path "${e}": ${n}${s?` - ${s}`:""}`);this.path=e;this.reason=n;this.details=s}getUserMessage(){let n={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],s=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${n}${s}.`}},Te=class extends B{constructor(e,n,s){let i=X(n);super(`File operation failed: ${i} on "${e}"`);this.filePath=e;this.operation=n;this.originalError=s}getUserMessage(){var s;let e=X(this.operation),n=(s=this.originalError)!=null&&s.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${n}.`}};function K(t,r,e,n){let s=t instanceof Error?t:new Error(String(t)),i=s.message.toLowerCase(),l="code"in s?s.code:void 0;return l==="EACCES"||l==="EPERM"||i.includes("permission")||i.includes("eacces")||i.includes("eperm")||i.includes("access denied")?new ve(r,e,s):l==="EEXIST"||i.includes("already exists")||i.includes("eexist")||i.includes("file exists")?new k(r,n||r,"exists",e,s):l==="EBUSY"||i.includes("locked")||i.includes("ebusy")?new k(r,n||r,"locked",e,s):l==="ETXTBSY"||i.includes("in use")||i.includes("being used")||i.includes("etxtbsy")?new k(r,n||r,"in-use",e,s):l==="EINVAL"||i.includes("invalid path")||i.includes("invalid character")||i.includes("einval")?new L(n||r,"invalid-characters",s.message):l==="ENAMETOOLONG"||i.includes("path too long")||i.includes("enametoolong")?new L(n||r,"too-long",s.message):new Te(r,e,s)}function X(t){return t.replace(/-/g," ")}var Le=require("obsidian");var j={MAX_UNIQUE_FILENAME_ATTEMPTS:100,BULK_OPERATION_BATCH_SIZE:100,BULK_OPERATION_BATCH_DELAY_MS:10},Re={SETTINGS_SAVE_MS:300,METADATA_REFRESH_MS:1e3},G={WINDOWS_MAX_PATH:260,UNIX_MAX_PATH:4096,MAX_COMPONENT_LENGTH:255,MAX_ARRAY_PATH_DEPTH:5};var je=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),Ze=/[<>:"|?*\x00-\x1F]/,Qe=/^([A-Za-z]:[\\/]|\/)/,Je=/(^|[\\/])\.\.($|[\\/])/,et=/\/{2,}|\\{2,}/;function Z(t,r={}){let{allowEmpty:e=!1,allowAbsolute:n=!1,maxLength:s=G.WINDOWS_MAX_PATH,checkReservedNames:i=!0}=r,l=[];if(!t||t.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:l}:{valid:!1,error:new L(t,"empty")};if(Qe.test(t)&&!n)return{valid:!1,error:new L(t,"absolute","Use relative paths within the vault")};if(Je.test(t))return{valid:!1,error:new L(t,"traversal",'Paths cannot contain ".." segments')};let o=(0,Le.normalizePath)(t);et.test(o)&&(o=o.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),l.push("Multiple consecutive slashes were normalized")),o=o.trim().replace(/^\/+|\/+$/g,"");let a=o.match(Ze);if(a)return{valid:!1,error:new L(t,"invalid-characters",`Contains invalid character: "${a[0]}"`)};if(o.length>s)return{valid:!1,error:new L(t,"too-long",`Path length (${o.length}) exceeds maximum (${s})`)};let c=o.split("/").filter(Boolean);for(let u of c){if(u.length>G.MAX_COMPONENT_LENGTH)return{valid:!1,error:new L(t,"too-long",`Path component "${u}" exceeds ${G.MAX_COMPONENT_LENGTH} characters`)};if(i){let d=u.split(".")[0].toUpperCase();if(je.has(d))return{valid:!1,error:new L(t,"reserved-name",`"${u}" is a reserved system name on Windows`)}}if(u.endsWith(".")||u.endsWith(" "))return{valid:!1,error:new L(t,"invalid-characters",`Path component "${u}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:o,warnings:l.length>0?l:void 0}}function Se(t){return Z(t,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var ne={REORGANIZE:{name:"Reorganize notes based on frontmatter rules",description:"Apply all configured rules to reorganize vault files"},UNDO:{name:"Undo last automatic move",description:"Revert the most recent file move"},VIEW_HISTORY:{name:"View move history",description:"Show all recent file moves and undo options"}},E={RULE_NAME:"Frontmatter rule",RULE_DESCRIPTION:"Move files to destination folder based on frontmatter matching",EXCLUSION_PATTERNS_NAME:"Exclusion Patterns",EXCLUSION_PATTERNS_DESCRIPTION:"Files and folders matching these patterns will not be automatically organized",TOOLTIPS:{ACTIVATE_RULE:"Activate this rule",MOVE_UP:"Move rule up",MOVE_DOWN:"Move rule down",BROWSE_FRONTMATTER:"Browse frontmatter keys",BROWSE_TAGS:"Browse tags",CASE_INSENSITIVE:"Case insensitive matching",DEBUG_MODE:"Enable debug mode",TEST_ALL_RULES:"Preview what moves would be made without actually moving files",CONFLICT_RESOLUTION:"How to handle file conflicts at destination",CONDITION_OPERATOR:"How to combine multiple conditions (AND/OR)",ADD_CONDITION:"Add another condition to this rule",EXCLUSION_PATTERN:"Glob pattern (e.g., Templates/**, *.excalidraw)"},PLACEHOLDERS:{KEY:"key",VALUE:"value",DESTINATION:"destination folder (supports {variables})",FLAGS:"flags",EXCLUSION_PATTERN:"e.g., Templates/**, Archive/**"},BUTTONS:{REMOVE:"Remove",ADD_RULE:"Add Rule",APPLY_NOW:"Apply now",TEST_ALL_RULES:"Test All Rules",ADD_CONDITION:"+",REMOVE_CONDITION:"Remove Condition",ADD_EXCLUSION:"Add Pattern"},LABELS:{CONFLICT_RESOLUTION:"On Conflict:",CONDITION_OPERATOR:"Combine:",CONDITIONS_SECTION:"Additional Conditions"},WARNINGS:{INVALID_REGEX:t=>`Invalid regular expression: ${t}`,VALUE_REQUIRED:"Value is required for contains/starts-with/ends-with rules."}},O={TEST_ALL_RULES:{TITLE:"Test All Rules - Preview",NO_MOVES_OVERALL:"No files would be moved. All files are either already in the correct location or have no matching rules.",NO_MOVES_ALREADY_CORRECT:"No files would be moved. All matching files are already in the correct location.",FILES_WOULD_MOVE:t=>`${t} file(s) would be moved:`,SKIPPED_SECTION:"Skipped due to invalid destinations",INVALID_DESTINATION_WARNING:"Destination path is invalid and the move cannot be previewed.",LABELS:{FILE:"File:",FROM:"From:",TO:"To:",RULE:"Rule:",WARNINGS:"Warnings:"},BUTTONS:{CLOSE:"Close"}},MOVE_HISTORY:{TITLE:"Move History",NO_HISTORY:"No move history yet.",SHOWING_COUNT:(t,r)=>`Showing ${t} of last ${r} moves.`,MOST_RECENT_PREFIX:"\u{1F504} Most Recent: ",TIME_PREFIX:t=>`\u23F0 ${t}`,LABELS:{FROM:"From:",TO:"To:",RULE:"Rule:"},BUTTONS:{UNDO:"Undo This Move",CLEAR_HISTORY:"Clear History",CLOSE:"Close"},NOTICES:{HISTORY_CLEARED:"Move history cleared."}}},F={UNDO:{NO_MOVES:"No moves to undo.",FILE_NOT_EXISTS:t=>`Cannot undo: File no longer exists at ${t}`,NOT_A_FILE:t=>`Cannot undo: ${t} is not a file.`,DESTINATION_EXISTS:t=>`Cannot undo: A file already exists at ${t}`,SUCCESS:(t,r)=>`Undone: Moved ${t} back to ${r}`},DEBUG:{EMPTY_DESTINATION:(t,r)=>`DEBUG: ${t} would not be moved because destination is empty in ${r}.`,WOULD_MOVE:(t,r,e)=>`DEBUG: ${t} would be moved to ${r}/${e}`},REGEX_PARSE_ERROR:(t,r)=>`Failed to parse regular expression for rule "${t}": ${r}`},Ce={NESTED_BATCH_OPERATION:"Nested batch operations are not supported. Using existing batch context."},se={FILE_PROCESSING:{EXPECTED_ERROR:t=>`Expected error during file processing - ${t}`,UNEXPECTED_ERROR:"Unexpected error during file processing",UNDO_FAILED:"Undo operation failed"}},Y={equals:"Equals",contains:"Contains","starts-with":"Starts with","ends-with":"Ends with",regex:"Regex"};var ye={rules:[],moveHistory:[],maxHistorySize:50,excludePatterns:[]},Oe=[{value:"equals",label:Y.equals},{value:"contains",label:Y.contains},{value:"starts-with",label:Y["starts-with"]},{value:"ends-with",label:Y["ends-with"]},{value:"regex",label:Y.regex}];function Q(t){var n,s,i,l,o,a;let r=(n=t.matchType)!=null?n:t.isRegex?"regex":"equals",e={...t,matchType:r,key:(s=t.key)!=null?s:"",value:(i=t.value)!=null?i:"",destination:(l=t.destination)!=null?l:"",enabled:(o=t.enabled)!=null?o:!1};return r==="regex"?(e.isRegex=!0,e.flags=(a=t.flags)!=null?a:""):(delete e.isRegex,delete e.flags),e}var A=require("obsidian");var H=require("obsidian");var ie=class extends H.FuzzySuggestModal{constructor(e,n,s){super(e);this.tags=n;this.onSelect=s}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},ae=class extends H.FuzzySuggestModal{constructor(e,n,s){super(e);this.keys=n;this.onSelect=s}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},re=class extends H.Modal{constructor(e,n,s){super(e);this.results=n;this.rules=s}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:O.TEST_ALL_RULES.TITLE});let n=this.results.filter(o=>o.newPath&&!o.error),s=this.results.filter(o=>o.error);if(n.length===0&&s.length===0)e.createEl("p",{text:O.TEST_ALL_RULES.NO_MOVES_OVERALL});else{if(n.length){e.createEl("p",{text:O.TEST_ALL_RULES.FILES_WOULD_MOVE(n.length)});let o=e.createDiv({cls:"vault-organizer-test-results"});o.style.maxHeight="400px",o.style.overflowY="auto",o.style.marginTop="1em",n.forEach(a=>{var _,I;let c=o.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let u=c.createDiv();u.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FILE}),u.createSpan({text:a.file.basename});let d=c.createDiv();d.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FROM}),d.createSpan({text:a.currentPath});let p=c.createDiv();p.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.TO}),p.createSpan({text:a.newPath||"(unknown)"});let f=c.createDiv();if(f.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.RULE}),f.createSpan({text:`Rule ${a.ruleIndex+1} (${((_=this.rules[a.ruleIndex])==null?void 0:_.key)||"unknown"})`}),(I=a.warnings)!=null&&I.length){let P=c.createDiv();P.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.WARNINGS}),P.createSpan({text:a.warnings.join("; ")})}})}else e.createEl("p",{text:O.TEST_ALL_RULES.NO_MOVES_ALREADY_CORRECT});if(s.length){e.createEl("h3",{text:O.TEST_ALL_RULES.SKIPPED_SECTION});let o=e.createDiv({cls:"vault-organizer-test-results"});o.style.maxHeight="400px",o.style.overflowY="auto",o.style.marginTop="1em",s.forEach(a=>{var _,I,P,w;let c=o.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let u=c.createDiv();u.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FILE}),u.createSpan({text:a.file.basename});let d=c.createDiv();d.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.FROM}),d.createSpan({text:a.currentPath});let p=c.createDiv();p.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.RULE}),p.createSpan({text:`Rule ${a.ruleIndex+1} (${((_=this.rules[a.ruleIndex])==null?void 0:_.key)||"unknown"})`});let f=c.createDiv();if(f.createEl("strong",{text:"Reason: "}),f.createSpan({text:(P=(I=a.error)==null?void 0:I.getUserMessage())!=null?P:O.TEST_ALL_RULES.INVALID_DESTINATION_WARNING}),(w=a.warnings)!=null&&w.length){let C=c.createDiv();C.createEl("strong",{text:O.TEST_ALL_RULES.LABELS.WARNINGS}),C.createSpan({text:a.warnings.join("; ")})}})}}let i=e.createDiv({cls:"modal-button-container"});i.style.marginTop="1.5em",i.style.textAlign="right";let l=i.createEl("button",{text:O.TEST_ALL_RULES.BUTTONS.CLOSE});l.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},oe=class extends H.Modal{constructor(e,n){super(e);this.plugin=n}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:O.MOVE_HISTORY.TITLE}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:O.MOVE_HISTORY.NO_HISTORY});else{e.createEl("p",{text:O.MOVE_HISTORY.SHOWING_COUNT(this.plugin.settings.moveHistory.length,this.plugin.settings.maxHistorySize)});let l=e.createDiv({cls:"vault-organizer-history-container"});l.style.maxHeight="500px",l.style.overflowY="auto",l.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((o,a)=>{let c=l.createDiv({cls:"vault-organizer-history-item"});c.style.marginBottom="1em",c.style.padding="0.8em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px",c.style.position="relative",a===0&&(c.style.backgroundColor="var(--background-secondary-alt)",c.style.borderColor="var(--interactive-accent)");let u=c.createDiv();u.style.marginBottom="0.5em",u.style.fontWeight="bold";let p=new Date(o.timestamp).toLocaleString();a===0&&u.createEl("span",{text:O.MOVE_HISTORY.MOST_RECENT_PREFIX,cls:"vault-organizer-recent-label"}),u.createSpan({text:o.fileName});let f=c.createDiv();f.style.fontSize="0.9em",f.style.color="var(--text-muted)",f.style.marginBottom="0.5em",f.textContent=O.MOVE_HISTORY.TIME_PREFIX(p);let _=c.createDiv();_.createEl("strong",{text:O.MOVE_HISTORY.LABELS.FROM}),_.createSpan({text:o.fromPath});let I=c.createDiv();I.createEl("strong",{text:O.MOVE_HISTORY.LABELS.TO}),I.createSpan({text:o.toPath});let P=c.createDiv();if(P.createEl("strong",{text:O.MOVE_HISTORY.LABELS.RULE}),P.createSpan({text:o.ruleKey||"(unknown)"}),a===0){let w=c.createDiv();w.style.marginTop="0.8em";let C=w.createEl("button",{text:O.MOVE_HISTORY.BUTTONS.UNDO});C.style.backgroundColor="var(--interactive-accent)",C.style.color="var(--text-on-accent)",C.style.padding="0.4em 0.8em",C.style.border="none",C.style.borderRadius="4px",C.style.cursor="pointer",C.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="1.5em",n.style.textAlign="right";let s=n.createEl("button",{text:O.MOVE_HISTORY.BUTTONS.CLEAR_HISTORY});s.style.marginRight="0.5em",s.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new H.Notice(O.MOVE_HISTORY.NOTICES.HISTORY_CLEARED),this.close()};let i=n.createEl("button",{text:O.MOVE_HISTORY.BUTTONS.CLOSE});i.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};var tt=200,W=new Map;function be(t){let r=W.get(t);if(r)return W.delete(t),W.set(t,r),r;let e=nt(t);if(W.size>=tt){let n=W.keys().next().value;n!==void 0&&W.delete(n)}return W.set(t,e),e}function nt(t){t.length>1e3&&(b.warn(`Exclusion pattern too long (${t.length} chars), truncating to 1000`),t=t.substring(0,1e3));let r="^",e=0,n=0,s=50;for(;e<t.length;){let i=t[e];if(i==="*"){if(n++,n>s){b.warn(`Exclusion pattern has too many wildcards (>${s}), ignoring excess`),e+=1;continue}t[e+1]==="*"?(r+=".*",e+=2):(r+="[^/]*",e+=1)}else if(i==="?"){if(n++,n>s){b.warn(`Exclusion pattern has too many wildcards (>${s}), ignoring excess`),e+=1;continue}r+="[^/]",e+=1}else if(i==="["){let l=t.indexOf("]",e);l===-1?(r+="\\[",e+=1):(r+=t.substring(e,l+1),e=l+1)}else/[.+^${}()|\\]/.test(i)?(r+="\\"+i,e+=1):(r+=i,e+=1)}return r+="$",new RegExp(r)}function Ae(t,r){if(!r||r.length===0)return!1;let e=t.replace(/\\/g,"/");for(let n of r){if(!n||n.trim()==="")continue;let s=n.trim().replace(/\\/g,"/");if(be(s).test(e))return!0;if(!s.includes("*")&&!s.includes("?")&&!s.includes("[")){let l=s.replace(/\/$/,"");if(e===l||e.startsWith(l+"/")){let o=e.split("/");if(l.split("/").every((u,d)=>o[d]===u))return!0}}}return!1}function xe(t){if(!t||t.trim()==="")return{valid:!1,error:"Pattern cannot be empty"};if(/[<>:"|]/.test(t))return{valid:!1,error:"Pattern contains invalid characters"};try{return be(t),{valid:!0}}catch(r){return{valid:!1,error:"Invalid glob pattern syntax"}}}function De(t){let r=new Set(["g","i","m","s","u","y","d"]),e=t.split(""),n=[],s=[];for(let i of e)r.has(i)?s.includes(i)||s.push(i):i.trim()&&n.push(i);return{valid:n.length===0,sanitized:s.join(""),invalid:n}}var le=class extends A.PluginSettingTab{constructor(e,n){super(e,n);this.aggregatedTags=[];this.frontmatterKeys=[];this.metadataCacheDirty=!0;this.plugin=n,this.debouncedSaveOnly=(0,A.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},Re.SETTINGS_SAVE_MS),this.debouncedRefreshMetadata=(0,A.debounce)(()=>{this.metadataCacheDirty=!0},Re.METADATA_REFRESH_MS),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.debouncedRefreshMetadata()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var s,i,l;let e=new Set;((l=(i=(s=this.plugin.app.vault).getMarkdownFiles)==null?void 0:i.call(s))!=null?l:[]).forEach(o=>{let a=this.plugin.app.metadataCache.getFileCache(o);if(!a)return;let c=(0,A.getAllTags)(a);c&&c.forEach(u=>e.add(u))}),this.aggregatedTags=Array.from(e).sort((o,a)=>o.localeCompare(a)),this.metadataCacheDirty=!1}getAggregatedTags(){return(this.metadataCacheDirty||!this.aggregatedTags.length)&&this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var s,i,l;let e=new Set;((l=(i=(s=this.plugin.app.vault).getMarkdownFiles)==null?void 0:i.call(s))!=null?l:[]).forEach(o=>{let a=this.plugin.app.metadataCache.getFileCache(o),c=a==null?void 0:a.frontmatter;c&&Object.keys(c).filter(u=>u!=="position").forEach(u=>e.add(u))}),this.frontmatterKeys=Array.from(e).sort((o,a)=>o.localeCompare(a)),this.metadataCacheDirty=!1}getFrontmatterKeys(){return(this.metadataCacheDirty||!this.frontmatterKeys.length)&&this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,n){if(!e.length)return;new ie(this.app,e,n).open()}openFrontmatterKeyPicker(e,n){if(!e.length)return;new ae(this.app,e,n).open()}toggleTagValue(e,n){let s=e.split(/\s+/).filter(Boolean);return(s.includes(n)?s.filter(o=>o!==n):[...s,n]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.metadataCacheDirty=!0,this.plugin.settings.rules=this.plugin.settings.rules.map(Q),this.plugin.settings.rules.forEach((o,a)=>{var J,ee;let c=(J=o.matchType)!=null?J:"equals",u=new A.Setting(e).setName(`${E.RULE_NAME} ${a+1}`).setDesc(E.RULE_DESCRIPTION);u.settingEl.classList.add("setting-item");let d=document.createElement("div");d.classList.add("vault-organizer-rule-message"),d.style.display="none",u.settingEl.appendChild(d);let p=()=>{var m;let g=this.plugin.settings.rules[a],h=(m=g==null?void 0:g.enabled)!=null?m:!1;u.settingEl.classList.toggle("vault-organizer-rule-disabled",!h)};u.addToggle(g=>{var h;return g.setTooltip(E.TOOLTIPS.ACTIVATE_RULE).setValue((h=o.enabled)!=null?h:!1).onChange(async m=>{let v=this.plugin.settings.rules[a];v&&(v.enabled=m,p(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),p())})}),u.addExtraButton(g=>g.setIcon("arrow-up").setTooltip(E.TOOLTIPS.MOVE_UP).setDisabled(a===0).onClick(async()=>{if(a===0)return;let h=this.plugin.settings.rules[a];this.plugin.settings.rules[a]=this.plugin.settings.rules[a-1],this.plugin.settings.rules[a-1]=h,this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new A.Notice("Failed to save settings. Rule order was not changed."),console.error("Settings save error:",m);let v=this.plugin.settings.rules[a-1];this.plugin.settings.rules[a-1]=this.plugin.settings.rules[a],this.plugin.settings.rules[a]=v}})),u.addExtraButton(g=>g.setIcon("arrow-down").setTooltip(E.TOOLTIPS.MOVE_DOWN).setDisabled(a===this.plugin.settings.rules.length-1).onClick(async()=>{if(a===this.plugin.settings.rules.length-1)return;let h=this.plugin.settings.rules[a];this.plugin.settings.rules[a]=this.plugin.settings.rules[a+1],this.plugin.settings.rules[a+1]=h,this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new A.Notice("Failed to save settings. Rule order was not changed."),console.error("Settings save error:",m);let v=this.plugin.settings.rules[a+1];this.plugin.settings.rules[a+1]=this.plugin.settings.rules[a],this.plugin.settings.rules[a]=v}}));let f=()=>{var U;let g=this.plugin.getRuleErrorForIndex(a),h=this.plugin.settings.rules[a],m=(U=h==null?void 0:h.matchType)!=null?U:"equals",v=Ee(m),M=h?fe(h):!1;g?(d.classList.add("vault-organizer-rule-error"),d.classList.remove("vault-organizer-rule-warning"),d.textContent=E.WARNINGS.INVALID_REGEX(g.message),d.style.display=""):v&&!M?(d.classList.add("vault-organizer-rule-warning"),d.classList.remove("vault-organizer-rule-error"),d.textContent=E.WARNINGS.VALUE_REQUIRED,d.style.display=""):(d.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),d.textContent="",d.style.display="none")},_;u.addText(g=>{_=g,g.setPlaceholder(E.PLACEHOLDERS.KEY).setValue(o.key).onChange(h=>{let m=this.plugin.settings.rules[a];m&&(m.key=h,this.scheduleSaveOnly())})}),u.addExtraButton(g=>g.setIcon("list").setTooltip(E.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let h=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(h,m=>{let v=this.plugin.settings.rules[a];!v||!_||(_.setValue(m),v.key=m,this.scheduleSaveOnly())})}));let I;u.addText(g=>{I=g,g.setPlaceholder(E.PLACEHOLDERS.VALUE).setValue(o.value).onChange(h=>{let m=this.plugin.settings.rules[a];m&&(m.value=h,this.scheduleSaveOnly(),f())})}),u.addExtraButton(g=>g.setIcon("hashtag").setTooltip(E.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let h=this.getAggregatedTags();this.openTagPicker(h,m=>{let v=this.plugin.settings.rules[a];if(!v||!I)return;let M=this.toggleTagValue(I.getValue(),m);I.setValue(M),v.value=M,this.scheduleSaveOnly()})})),u.addText(g=>g.setPlaceholder(E.PLACEHOLDERS.DESTINATION).setValue(o.destination).onChange(h=>{let m=this.plugin.settings.rules[a];m&&(m.destination=h,this.scheduleSaveOnly())}));let P,w,C=()=>{var m;let g=this.plugin.settings.rules[a],h=((m=g==null?void 0:g.matchType)!=null?m:"equals")==="regex";P&&(P.inputEl.toggleAttribute("disabled",!h),P.inputEl.disabled=!h,P.inputEl.style.display=h?"":"none"),w&&(w.toggleEl.style.display=h?"none":"")};if(u.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),Oe.forEach(h=>g.addOption(h.value,h.label)),g.setValue(c).onChange(async h=>{var v;let m=this.plugin.settings.rules[a];m&&(m.matchType=h,h==="regex"?(m.isRegex=!0,m.flags=(v=m.flags)!=null?v:""):(delete m.isRegex,"flags"in m&&delete m.flags),C(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),C(),f())})}),u.addDropdown(g=>{var h;g.selectEl.setAttribute("aria-label","Conflict resolution"),g.selectEl.setAttribute("title",E.TOOLTIPS.CONFLICT_RESOLUTION),g.addOption("fail","Fail"),g.addOption("skip","Skip"),g.addOption("append-number","Add number"),g.addOption("append-timestamp","Add timestamp"),g.setValue((h=o.conflictResolution)!=null?h:"fail").onChange(m=>{let v=this.plugin.settings.rules[a];v&&(v.conflictResolution=m,this.scheduleSaveOnly())})}),u.addDropdown(g=>{var h;g.selectEl.setAttribute("aria-label","Condition operator"),g.selectEl.setAttribute("title",E.TOOLTIPS.CONDITION_OPERATOR),g.addOption("AND","AND"),g.addOption("OR","OR"),g.setValue((h=o.conditionOperator)!=null?h:"AND").onChange(m=>{let v=this.plugin.settings.rules[a];v&&(v.conditionOperator=m,this.scheduleSaveOnly())})}),u.addText(g=>{var h;P=g,g.setPlaceholder(E.PLACEHOLDERS.FLAGS).setValue((h=o.flags)!=null?h:"").onChange(m=>{let v=this.plugin.settings.rules[a];if(v&&v.matchType==="regex"){let M=De(m);M.valid?(g.inputEl.classList.remove("vault-organizer-invalid-flags"),g.inputEl.title=""):(g.inputEl.classList.add("vault-organizer-invalid-flags"),g.inputEl.title=`Invalid flag(s): ${M.invalid.join(", ")}. Valid flags: g, i, m, s, u, y, d`),v.flags=M.sanitized,m!==M.sanitized&&g.setValue(M.sanitized),this.scheduleSaveOnly()}})}),C(),u.addToggle(g=>{var h;w=g,g.setTooltip(E.TOOLTIPS.CASE_INSENSITIVE).setValue((h=o.caseInsensitive)!=null?h:!1).onChange(async m=>{let v=this.plugin.settings.rules[a];v&&(v.caseInsensitive=m,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),u.addToggle(g=>{var h;return g.setTooltip(E.TOOLTIPS.DEBUG_MODE).setValue((h=o.debug)!=null?h:!1).onChange(async m=>{let v=this.plugin.settings.rules[a];v&&(v.debug=m,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),u.addButton(g=>g.setButtonText(E.BUTTONS.ADD_CONDITION).setTooltip(E.TOOLTIPS.ADD_CONDITION).onClick(async()=>{let h=this.plugin.settings.rules[a];if(h){h.conditions||(h.conditions=[]),h.conditions.push({key:"",value:"",matchType:"equals"}),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new A.Notice("Failed to save settings. Please try again."),console.error("Settings save error:",m),h.conditions.pop()}}})),u.addButton(g=>g.setButtonText(E.BUTTONS.REMOVE).onClick(async()=>{let h=this.plugin.settings.rules.splice(a,1)[0];this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new A.Notice("Failed to save settings. Rule was not removed."),console.error("Settings save error:",m),this.plugin.settings.rules.splice(a,0,h)}})),o.conditions&&o.conditions.length>0){let g=document.createElement("div");g.className="vault-organizer-conditions-header",e.appendChild(g);let h=(ee=o.conditionOperator)!=null?ee:"AND",m=document.createElement("span");m.className=`vault-organizer-operator-badge vault-organizer-operator-${h.toLowerCase()}`,m.textContent=h,g.appendChild(m);let v=document.createElement("span");v.className="vault-organizer-operator-desc",v.textContent=h==="AND"?"All conditions below must match":"Any condition below can match",g.appendChild(v);let M=document.createElement("div");M.className="vault-organizer-conditions-container",e.appendChild(M),o.conditions.forEach((U,N)=>{var Ie;let z=new A.Setting(M).setName(`${E.LABELS.CONDITIONS_SECTION} ${N+1}`).setClass("vault-organizer-condition"),ue;z.addText(S=>{ue=S,S.setPlaceholder(E.PLACEHOLDERS.KEY).setValue(U.key).onChange(y=>{var R;let T=this.plugin.settings.rules[a];(R=T==null?void 0:T.conditions)!=null&&R[N]&&(T.conditions[N].key=y,this.scheduleSaveOnly())})}),z.addExtraButton(S=>S.setIcon("list").setTooltip(E.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let y=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(y,T=>{var D;let R=this.plugin.settings.rules[a];!((D=R==null?void 0:R.conditions)!=null&&D[N])||!ue||(ue.setValue(T),R.conditions[N].key=T,this.scheduleSaveOnly())})}));let te;z.addText(S=>{te=S,S.setPlaceholder(E.PLACEHOLDERS.VALUE).setValue(U.value).onChange(y=>{var R;let T=this.plugin.settings.rules[a];(R=T==null?void 0:T.conditions)!=null&&R[N]&&(T.conditions[N].value=y,this.scheduleSaveOnly())})}),z.addExtraButton(S=>S.setIcon("hashtag").setTooltip(E.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let y=this.getAggregatedTags();this.openTagPicker(y,T=>{var V;let R=this.plugin.settings.rules[a];if(!((V=R==null?void 0:R.conditions)!=null&&V[N])||!te)return;let D=this.toggleTagValue(te.getValue(),T);te.setValue(D),R.conditions[N].value=D,this.scheduleSaveOnly()})}));let Ue=(Ie=U.matchType)!=null?Ie:"equals",q,ge,de=()=>{var R,D;let S=this.plugin.settings.rules[a],y=(R=S==null?void 0:S.conditions)==null?void 0:R[N],T=((D=y==null?void 0:y.matchType)!=null?D:"equals")==="regex";q&&(q.inputEl.toggleAttribute("disabled",!T),q.inputEl.disabled=!T,q.inputEl.style.display=T?"":"none"),ge&&(ge.toggleEl.style.display=T?"none":"")};z.addDropdown(S=>{S.selectEl.setAttribute("aria-label","Match type"),Oe.forEach(y=>S.addOption(y.value,y.label)),S.setValue(Ue).onChange(async y=>{var R,D;let T=this.plugin.settings.rules[a];(R=T==null?void 0:T.conditions)!=null&&R[N]&&(T.conditions[N].matchType=y,y==="regex"?(T.conditions[N].isRegex=!0,T.conditions[N].flags=(D=T.conditions[N].flags)!=null?D:""):(delete T.conditions[N].isRegex,"flags"in T.conditions[N]&&delete T.conditions[N].flags),de(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),de())})}),z.addText(S=>{var y;q=S,S.setPlaceholder(E.PLACEHOLDERS.FLAGS).setValue((y=U.flags)!=null?y:"").onChange(T=>{var D;let R=this.plugin.settings.rules[a];if((D=R==null?void 0:R.conditions)!=null&&D[N]&&R.conditions[N].matchType==="regex"){let V=De(T);V.valid?(S.inputEl.classList.remove("vault-organizer-invalid-flags"),S.inputEl.title=""):(S.inputEl.classList.add("vault-organizer-invalid-flags"),S.inputEl.title=`Invalid flag(s): ${V.invalid.join(", ")}. Valid flags: g, i, m, s, u, y, d`),R.conditions[N].flags=V.sanitized,T!==V.sanitized&&S.setValue(V.sanitized),this.scheduleSaveOnly()}})}),z.addToggle(S=>{var y;ge=S,S.setTooltip(E.TOOLTIPS.CASE_INSENSITIVE).setValue((y=U.caseInsensitive)!=null?y:!1).onChange(async T=>{var D;let R=this.plugin.settings.rules[a];(D=R==null?void 0:R.conditions)!=null&&D[N]&&(R.conditions[N].caseInsensitive=T,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),z.addButton(S=>S.setButtonText(E.BUTTONS.REMOVE_CONDITION).onClick(async()=>{let y=this.plugin.settings.rules[a];if(!(y!=null&&y.conditions))return;let T=y.conditions.splice(N,1)[0];this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(R){new A.Notice("Failed to save settings. Condition was not removed."),console.error("Settings save error:",R),y.conditions.splice(N,0,T)}})),de()})}f(),p()}),new A.Setting(e).addButton(o=>o.setButtonText(E.BUTTONS.ADD_RULE).onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(a){new A.Notice("Failed to save settings. Rule was not added."),console.error("Settings save error:",a),this.plugin.settings.rules.pop()}})),new A.Setting(e).addButton(o=>o.setButtonText(E.BUTTONS.APPLY_NOW).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(o=>o.setButtonText(E.BUTTONS.TEST_ALL_RULES).setTooltip(E.TOOLTIPS.TEST_ALL_RULES).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let a=this.plugin.testAllRules();new re(this.app,a,this.plugin.settings.rules).open()})),new A.Setting(e).setName(E.EXCLUSION_PATTERNS_NAME).setDesc(E.EXCLUSION_PATTERNS_DESCRIPTION),this.plugin.settings.excludePatterns.forEach((o,a)=>{new A.Setting(e).setName(`Pattern ${a+1}`).addText(c=>{c.setPlaceholder(E.PLACEHOLDERS.EXCLUSION_PATTERN).setValue(o).onChange(async u=>{let d=u.trim(),p=xe(d);!p.valid&&d!==""?(c.inputEl.classList.add("vault-organizer-invalid-pattern"),c.inputEl.title=p.error||"Invalid pattern"):(c.inputEl.classList.remove("vault-organizer-invalid-pattern"),c.inputEl.title=""),this.plugin.settings.excludePatterns[a]=d,this.scheduleSaveOnly()}),c.inputEl.style.width="300px"}).addButton(c=>c.setButtonText(E.BUTTONS.REMOVE).setTooltip("Remove this exclusion pattern").onClick(async()=>{this.plugin.settings.excludePatterns.splice(a,1),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(u){new A.Notice("Failed to save settings. Pattern was not removed."),console.error("Settings save error:",u),this.plugin.settings.excludePatterns.splice(a,0,o)}}))}),new A.Setting(e).addButton(o=>o.setButtonText(E.BUTTONS.ADD_EXCLUSION).setTooltip("Add a new exclusion pattern").onClick(async()=>{this.plugin.settings.excludePatterns.push(""),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(a){new A.Notice("Failed to save settings. Pattern was not added."),console.error("Settings save error:",a),this.plugin.settings.excludePatterns.pop()}}));let n=document.createElement("div");n.className="vault-organizer-pattern-templates",e.appendChild(n);let s=document.createElement("h3");s.className="vault-organizer-templates-heading",s.textContent="Common Patterns",n.appendChild(s);let i=[{pattern:"Templates/**",description:"Exclude all files in Templates folder"},{pattern:"*.excalidraw.md",description:"Exclude Excalidraw drawings"},{pattern:"Archive/**",description:"Exclude all files in Archive folder"},{pattern:".obsidian/**",description:"Exclude Obsidian config files"},{pattern:"**/Daily Notes/**",description:"Exclude Daily Notes in any location"}],l=document.createElement("div");l.className="vault-organizer-template-list",n.appendChild(l),i.forEach(({pattern:o,description:a})=>{let c=document.createElement("div");c.className="vault-organizer-template-item",l.appendChild(c);let u=document.createElement("span");u.className="vault-organizer-template-pattern",u.textContent=o,c.appendChild(u);let d=document.createElement("span");d.className="vault-organizer-template-desc",d.textContent=` - ${a}`,c.appendChild(d);let p=document.createElement("button");p.className="vault-organizer-template-add-btn",p.textContent="Add",c.appendChild(p),p.addEventListener("click",async()=>{if(this.plugin.settings.excludePatterns.includes(o)){new A.Notice("This pattern is already in your exclusion list.");return}this.plugin.settings.excludePatterns.push(o),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),new A.Notice(`Added exclusion pattern: ${o}`),this.display()}catch(f){new A.Notice("Failed to save settings. Pattern was not added."),console.error("Settings save error:",f),this.plugin.settings.excludePatterns.pop()}})})}hide(){this.cancelPendingSaveOnly(),this.debouncedRefreshMetadata.cancel()}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((s,i)=>{var f,_;let l=s.querySelector(".vault-organizer-rule-message");if(!l)return;let o=this.plugin.settings.rules[i],a=(f=o==null?void 0:o.enabled)!=null?f:!1;s.classList.toggle("vault-organizer-rule-disabled",!a);let c=this.plugin.getRuleErrorForIndex(i),u=(_=o==null?void 0:o.matchType)!=null?_:"equals",d=Ee(u),p=o?fe(o):!1;c?(l.classList.add("vault-organizer-rule-error"),l.classList.remove("vault-organizer-rule-warning"),l.textContent=E.WARNINGS.INVALID_REGEX(c.message),l.style.display=""):d&&!p?(l.classList.add("vault-organizer-rule-warning"),l.classList.remove("vault-organizer-rule-error"),l.textContent=E.WARNINGS.VALUE_REQUIRED,l.style.display=""):(l.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),l.textContent="",l.style.display="none")})}};var st=100,it=/^[a-zA-Z_][a-zA-Z0-9_.-]{0,99}$/;function at(t){return!t||t.length===0||t.length>st||t.includes("..")||t.includes("/")||t.includes("\\")?!1:it.test(t)}function rt(t){let r=/\{([^}]+)\}/g,e=[],n;for(;(n=r.exec(t))!==null;){let s=n[1];at(s)&&e.push(s)}return e}function Me(t){if(t==null)return"";let r=String(t);return r=r.replace(/[<>:"|?*]/g,""),r=r.replace(/\\/g,"-"),r=r.replace(/\//g,"-"),r=r.trim().replace(/^\.+|\.+$/g,""),r=r.replace(/\s+/g," "),r}function Fe(t,r){let e=rt(t);if(e.length===0)return{substitutedPath:t,substituted:[],missing:[],hasVariables:!1};let n=[],s=[],i=[],l=t;for(let o of e){let a=r==null?void 0:r[o],c=new RegExp(`\\{${ot(o)}\\}`,"g");if(a==null)s.push(o),l=l.replace(c,"");else{n.push(o);let u;if(Array.isArray(a)){let d=a.slice(0,G.MAX_ARRAY_PATH_DEPTH);a.length>G.MAX_ARRAY_PATH_DEPTH&&i.push(o),u=d.map(p=>Me(p)).filter(Boolean).join("/")}else u=Me(a);l=l.replace(c,u)}}return l=l.replace(/\/+/g,"/").replace(/^\/+|\/+$/g,""),l=l.split("/").filter(Boolean).join("/"),{substitutedPath:l,substituted:n,missing:s,hasVariables:!0,truncated:i.length>0?i:void 0}}function ot(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _e(t,r,e){var u,d,p,f,_,I,P;let n=[],s=t.trim();if(!s)return{valid:!1,error:new L(t,"empty","Destination path cannot be empty"),warnings:n};let i=Fe(s,e);i.missing.length>0&&n.push(`Missing variables: ${i.missing.join(", ")}`);let l=i.substitutedPath,o=Se(l);if(!o.valid||!o.sanitizedPath)return{valid:!1,substitution:i,error:(u=o.error)!=null?u:new L(l,"invalid-characters","Destination path validation failed"),warnings:[...n,...(d=o.warnings)!=null?d:[]]};let a=o.sanitizedPath,c=Z(`${a}/${r}`,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});return!c.valid||!c.sanitizedPath?{valid:!1,substitution:i,destinationFolder:a,error:(p=c.error)!=null?p:new L(`${a}/${r}`,"invalid-characters","Full path validation failed"),warnings:[...n,...(f=o.warnings)!=null?f:[],...(_=c.warnings)!=null?_:[]]}:{valid:!0,destinationFolder:a,fullPath:c.sanitizedPath,substitution:i,warnings:[...n,...(I=o.warnings)!=null?I:[],...(P=c.warnings)!=null?P:[]].filter(Boolean)}}var ce=class extends x.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[];this.batchOperationInProgress=!1;this.filesBeingProcessed=new Set}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async n=>{!(n instanceof x.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async n=>{!(n instanceof x.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:ne.REORGANIZE.name,callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:ne.UNDO.name,callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:ne.VIEW_HISTORY.name,callback:()=>{new oe(this.app,this).open()}}),this.ruleSettingTab=new le(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var s;let e=await this.loadData(),n=Array.isArray(e==null?void 0:e.rules)?e.rules.map(Q):[];this.settings={...ye,...e,rules:n,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(s=e==null?void 0:e.maxHistorySize)!=null?s:ye.maxHistorySize,excludePatterns:Array.isArray(e==null?void 0:e.excludePatterns)?e.excludePatterns:[]}}async saveSettings(){this.settings.rules=this.settings.rules.map(Q),!this.batchOperationInProgress&&await this.saveData(this.settings)}async withBatchOperation(e){if(this.batchOperationInProgress)return b.warn(Ce.NESTED_BATCH_OPERATION),await e();this.batchOperationInProgress=!0;try{return await e()}finally{this.batchOperationInProgress=!1,await this.saveData(this.settings)}}updateRulesFromSettings(){let{rules:e,successes:n,errors:s}=Pe(this.settings.rules);return this.rules=e,this.ruleParseErrors=s,{successes:n,errors:s}}async persistSettingsAndRefreshRules(){var l;let{successes:e,errors:n}=this.updateRulesFromSettings(),s=we(e.map(o=>o.rule)),i=[...this.settings.rules];e.forEach((o,a)=>{i[o.index]=s[a]}),this.settings.rules=i,await this.saveSettings(),n.length&&n.forEach(o=>{let a=o.rule.key||"(unnamed rule)",c=F.REGEX_PARSE_ERROR(a,o.message);new x.Notice(c)}),(l=this.ruleSettingTab)==null||l.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(n=>n.index===e)}async recordMove(e,n,s,i){if(!e||!n||!s||!i)throw new L(e||n||"(empty)","empty","fromPath, toPath, fileName, and ruleKey are required for recording move history");let l={timestamp:Date.now(),fileName:s,fromPath:e,toPath:n,ruleKey:i};this.settings.moveHistory.unshift(l),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new x.Notice(F.UNDO.NO_MOVES);return}let e=this.settings.moveHistory[0],n=this.app.vault.getAbstractFileByPath(e.toPath);if(!n){new x.Notice(F.UNDO.FILE_NOT_EXISTS(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(n instanceof x.TFile)){new x.Notice(F.UNDO.NOT_A_FILE(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new x.Notice(F.UNDO.DESTINATION_EXISTS(e.fromPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let i=e.fromPath.lastIndexOf("/");if(i>0){let l=e.fromPath.substring(0,i);await this.ensureFolderExists(l)}await this.app.fileManager.renameFile(n,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new x.Notice(F.UNDO.SUCCESS(e.fileName,e.fromPath))}catch(i){let l=K(i,e.toPath,"move",e.fromPath);new x.Notice(l.getUserMessage()),b.warn(se.FILE_PROCESSING.UNDO_FAILED,i)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let n=Z(e,{allowEmpty:!1,allowAbsolute:!1});if(!n.valid||!n.sanitizedPath)throw n.error||new L(e,"invalid-characters","Path validation failed");let i=n.sanitizedPath.split("/").filter(Boolean);if(!i.length)return;let l="";for(let o of i){l=l?`${l}/${o}`:o;let a=this.app.vault.getAbstractFileByPath(l);if(a){if(a instanceof x.TFile)throw new k(l,void 0,"exists","create-folder");continue}try{await this.app.vault.createFolder(l)}catch(c){throw K(c,l,"create-folder")}}}generateUniqueFilename(e,n,s){if(s==="append-timestamp"){let a=Date.now(),c=`${e}-${a}${n}`;return this.app.vault.getAbstractFileByPath(c)?`${e}-${a}-${Math.random().toString(36).substring(2,8)}${n}`:c}let i=1,l;for(;i<=j.MAX_UNIQUE_FILENAME_ATTEMPTS;){if(l=`${e}-${i}${n}`,!this.app.vault.getAbstractFileByPath(l))return l;i++}b.warn(`Could not find unique numbered filename after ${j.MAX_UNIQUE_FILENAME_ATTEMPTS} attempts. Falling back to timestamp-based naming for ${e}${n}`);let o=Date.now();return`${e}-${o}${n}`}async applyRulesToFile(e){var l,o;let n=e.path;if(this.filesBeingProcessed.has(n))return;this.filesBeingProcessed.add(n);let s,i;try{if(Ae(e.path,this.settings.excludePatterns))return;let a=this.app.metadataCache.getFileCache(e),c=a==null?void 0:a.frontmatter;if(!c)return;let u=me.call(this,e,this.rules,c);if(!u)return;let d=u.destination.trim();if(!d){if(u.debug){let w=this.app.vault.getName();new x.Notice(F.DEBUG.EMPTY_DESTINATION(e.basename,w))}return}let p=_e(d,e.name,c);if(!p.valid||!p.fullPath||!p.destinationFolder)throw(l=p.error)!=null?l:new L(d,"invalid-characters","Destination validation failed");u.debug&&p.substitution&&p.substitution.missing.length>0&&new x.Notice(`DEBUG: Missing variables in destination: ${p.substitution.missing.join(", ")}`);let f=p.fullPath,_=p.destinationFolder;if(s=f,e.path===f)return;if(u.debug){let w=this.app.vault.getName();new x.Notice(F.DEBUG.WOULD_MOVE(e.basename,w,_));return}if(await this.ensureFolderExists(_),this.app.vault.getAbstractFileByPath(f)){let w=(o=u.conflictResolution)!=null?o:"fail";if(w==="skip")return;if(w==="append-number"||w==="append-timestamp"){let C=e.name.lastIndexOf("."),J=C>0?e.name.substring(0,C):e.name,ee=C>0?e.name.substring(C):"",g=`${_}/${J}`;f=this.generateUniqueFilename(g,ee,w),s=f}else throw new k(f,e.path,"exists","move")}let P=e.path;f!==n&&(this.filesBeingProcessed.add(f),i=f);try{await this.app.fileManager.renameFile(e,f),await this.recordMove(P,f,e.name,u.key)}catch(w){throw i&&i!==n&&(this.filesBeingProcessed.delete(i),i=void 0),K(w,e.path,"move",f)}}catch(a){if(a instanceof B)new x.Notice(a.getUserMessage()),b.warn(se.FILE_PROCESSING.EXPECTED_ERROR(a.name),a.message);else{let c=K(a,e.path,"move",s);new x.Notice(c.getUserMessage()),b.error(se.FILE_PROCESSING.UNEXPECTED_ERROR,a)}}finally{this.filesBeingProcessed.delete(n),i&&i!==n&&this.filesBeingProcessed.delete(i)}}async reorganizeAllMarkdownFiles(){var n,s;let e=(s=(n=this.app.vault).getMarkdownFiles)==null?void 0:s.call(n);e!=null&&e.length&&await this.withBatchOperation(async()=>{for(let i=0;i<e.length;i++){let l=e[i];await this.applyRulesToFile(l),(i+1)%j.BULK_OPERATION_BATCH_SIZE===0&&await new Promise(o=>setTimeout(o,j.BULK_OPERATION_BATCH_DELAY_MS))}})}testAllRules(){var s,i,l,o,a;let e=((i=(s=this.app.vault).getMarkdownFiles)==null?void 0:i.call(s))||[],n=[];for(let c of e){if(Ae(c.path,this.settings.excludePatterns))continue;let u=this.app.metadataCache.getFileCache(c),d=u==null?void 0:u.frontmatter;if(!d)continue;let p=this.rules.findIndex(w=>w.enabled===!1?!1:me.call(this,c,[w],d));if(p===-1)continue;let _=this.rules[p].destination.trim();if(!_)continue;let I=_e(_,c.name,d);if(!I.valid||!I.fullPath){n.push({file:c,currentPath:c.path,ruleIndex:p,error:(l=I.error)!=null?l:new L(_,"invalid-characters","Unknown validation error"),warnings:(o=I.warnings)!=null&&o.length?I.warnings:void 0});continue}let P=I.fullPath;c.path!==P&&n.push({file:c,currentPath:c.path,newPath:P,ruleIndex:p,warnings:(a=I.warnings)!=null&&a.length?I.warnings:void 0})}return n}};
