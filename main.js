/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var he=Object.defineProperty;var $e=Object.getOwnPropertyDescriptor;var Be=Object.getOwnPropertyNames;var He=Object.prototype.hasOwnProperty;var Ge=(n,r)=>{for(var e in r)he(n,e,{get:r[e],enumerable:!0})},We=(n,r,e,t)=>{if(r&&typeof r=="object"||typeof r=="function")for(let s of Be(r))!He.call(n,s)&&s!==e&&he(n,s,{get:()=>r[s],enumerable:!(t=$e(r,s))||t.enumerable});return n};var Xe=n=>We(he({},"__esModule",{value:!0}),n);var gt={};Ge(gt,{default:()=>ue});module.exports=Xe(gt);var x=require("obsidian");var b=class{static error(r,e){console.error(`${this.PREFIX} ERROR:`,r,e!==void 0?e:"")}static warn(r,e){console.warn(`${this.PREFIX} WARN:`,r,e!==void 0?e:"")}static info(r,e){console.info(`${this.PREFIX} INFO:`,r,e!==void 0?e:"")}static debug(r,e){var s,i;let t=!1;try{typeof process!="undefined"&&(process!=null&&process.env)&&(t=!1)}catch(c){t=!1}!t&&typeof window!="undefined"&&(t=((s=window.location)==null?void 0:s.hostname)==="localhost"||((i=window.location)==null?void 0:i.hostname)==="127.0.0.1"),t&&console.debug(`${this.PREFIX} DEBUG:`,r,e!==void 0?e:"")}};b.PREFIX="[Vault Organizer]";var k={MAX_PATTERN_LENGTH:500,MAX_CAPTURING_GROUPS:20,MAX_NESTING_DEPTH:10,MAX_ALTERNATIONS:50},Ye=[/\([^)]*[+*]\)[+*]/,/[+*]{2,}/,/\([^)]*\|[^)]*\)[+*]/,/\(\([^)]*[+*]\)[+*]\)/];function me(n,r){let e=[];if(n.length>k.MAX_PATTERN_LENGTH)return{valid:!1,error:`Pattern too long (${n.length} chars). Maximum: ${k.MAX_PATTERN_LENGTH}`};for(let c of Ye)if(c.test(n))return{valid:!1,error:"Pattern contains potentially dangerous nested quantifiers that could cause performance issues"};let t=(n.match(/(?<!\\)\(/g)||[]).length;if(t>k.MAX_CAPTURING_GROUPS)return{valid:!1,error:`Too many capturing groups (${t}). Maximum: ${k.MAX_CAPTURING_GROUPS}`};let s=(n.match(/(?<!\\)\|/g)||[]).length;if(s>k.MAX_ALTERNATIONS)return{valid:!1,error:`Too many alternations (${s}). Maximum: ${k.MAX_ALTERNATIONS}`};let i=qe(n);if(i>k.MAX_NESTING_DEPTH)return{valid:!1,error:`Nesting too deep (${i} levels). Maximum: ${k.MAX_NESTING_DEPTH}`};n.includes(".*.*")&&e.push("Pattern contains multiple .* which may be slow on large inputs"),n.includes(".+.+")&&e.push("Pattern contains multiple .+ which may be slow on large inputs");try{return{valid:!0,regex:new RegExp(n,r),warnings:e.length>0?e:void 0}}catch(c){return{valid:!1,error:`Invalid regex syntax: ${c instanceof Error?c.message:String(c)}`}}}function qe(n){let r=0,e=0,t=!1;for(let s=0;s<n.length;s++){let i=n[s];if(t){t=!1;continue}if(i==="\\"){t=!0;continue}i==="("?(e++,r=Math.max(r,e)):i===")"&&(e=Math.max(0,e-1))}return r}function Pe(n,r){var a;let e=r[n.key];if(e==null)return!1;let t=Array.isArray(e),s=t?e:[e],i=(a=n.matchType)!=null?a:"equals";if(i==="regex"){if(!(n.value instanceof RegExp))return!1;let l=n.value;return s.some(u=>{let g=String(u),h=l.flags;return n.caseInsensitive&&!h.includes("i")&&(h+="i"),new RegExp(l.source,h).test(g)})}let c=Ke(String(n.value),t),o=i==="contains"||i==="starts-with"||i==="ends-with"?c.filter(l=>l.length>0):c;return o.length?s.some(l=>{let u=String(l);return o.some(g=>je(u,g,i,n.caseInsensitive))}):!1}function Ee(n,r,e){var s;let t=e!=null?e:(s=this.app.metadataCache.getFileCache(n))==null?void 0:s.frontmatter;if(t)return r.find(i=>{var u,g;if(i.enabled===!1)return!1;let c={key:i.key,matchType:i.matchType,value:i.value,caseInsensitive:i.caseInsensitive},o=Pe(c,t);if(!((u=i.conditions)!=null&&u.length))return o;let a=i.conditions.map(h=>Pe(h,t));return((g=i.conditionOperator)!=null?g:"AND")==="AND"?o&&a.every(h=>h):o||a.some(h=>h)})}function Ke(n,r){if(!r)return[n];let e=n.trim(),t=e.split(/\s+/).map(i=>i.trim()).filter(Boolean);if(!t.length)return[e];let s=new Set;return e&&s.add(e),t.forEach(i=>s.add(i)),Array.from(s)}function je(n,r,e,t){let s=t?n.toLowerCase():n,i=t?r.toLowerCase():r;switch(e){case"contains":return s.includes(i);case"starts-with":return s.startsWith(i);case"ends-with":return s.endsWith(i);case"equals":default:return s===i}}function Qe(n){var e;let r=(e=n.matchType)!=null?e:"equals";if(r==="regex"){let t=n.value instanceof RegExp?n.value.source:String(n.value),s=n.value instanceof RegExp?n.value.flags:"";return{key:n.key,matchType:r,value:t,isRegex:!0,flags:s,caseInsensitive:n.caseInsensitive}}return{key:n.key,matchType:r,value:String(n.value),caseInsensitive:n.caseInsensitive}}function Ce(n){return n.map(r=>{var s,i;let e=(s=r.matchType)!=null?s:"equals",t={key:r.key,matchType:e,value:e==="regex"&&r.value instanceof RegExp?r.value.source:String(r.value),destination:r.destination,enabled:(i=r.enabled)!=null?i:!1,debug:r.debug,caseInsensitive:r.caseInsensitive,conditionOperator:r.conditionOperator,conflictResolution:r.conflictResolution};return e==="regex"&&(t.isRegex=!0,t.flags=r.value instanceof RegExp?r.value.flags:""),r.conditions&&r.conditions.length>0&&(t.conditions=r.conditions.map(Qe)),t})}function fe(n){return n==="contains"||n==="starts-with"||n==="ends-with"}function ve(n){return typeof n.value=="string"&&n.value.trim().length>0}function Ze(n){var e;let r=(e=n.matchType)!=null?e:n.isRegex?"regex":"equals";if(r==="regex"){let t=me(n.value,n.flags);if(!t.valid){b.warn(`Failed to deserialize regex condition for key "${n.key}": ${t.error}`,n.value);return}if(t.warnings&&t.warnings.length>0&&b.warn(`Regex condition for key "${n.key}" has warnings`,t.warnings.join("; ")),!t.regex){b.error("Unexpected: validation succeeded but regex is undefined",n.value);return}return{key:n.key,matchType:r,value:t.regex,caseInsensitive:n.caseInsensitive}}return{key:n.key,matchType:r,value:n.value,caseInsensitive:n.caseInsensitive}}function be(n=[]){let r=[],e=[],t=[];return n.forEach((s,i)=>{var a,l,u;let c=(a=s.matchType)!=null?a:s.isRegex?"regex":"equals",o;if(s.conditions&&s.conditions.length>0){let g=s.conditions.map(Ze).filter(h=>h!==void 0);g.length>0&&(o=g)}if(c==="regex"){let g=me(s.value,s.flags);if(g.valid)if(g.warnings&&g.warnings.length>0&&b.warn(`Regex for frontmatter rule "${s.key}" has performance warnings`,g.warnings.join("; ")),g.regex){let h={key:s.key,matchType:c,value:g.regex,destination:s.destination,enabled:(l=s.enabled)!=null?l:!1,debug:s.debug,caseInsensitive:s.caseInsensitive,conditions:o,conditionOperator:s.conditionOperator,conflictResolution:s.conflictResolution};r.push(h),e.push({index:i,rule:h})}else{let h="Unexpected: validation succeeded but regex is undefined";b.error(h,s.value),t.push({index:i,message:h,rule:{...s,matchType:c},cause:new Error(h)})}else{let h=g.error||"Unknown validation error",f=s.destination?` (destination: "${s.destination}")`:"";b.warn(`Failed to deserialize regex for frontmatter rule "${s.key}"${f}: ${h}. Rule will be ignored.`,s.value),t.push({index:i,message:h,rule:{...s,matchType:c},cause:new Error(h)})}}else{let g={key:s.key,matchType:c,value:s.value,destination:s.destination,enabled:(u=s.enabled)!=null?u:!1,debug:s.debug,caseInsensitive:s.caseInsensitive,conditions:o,conditionOperator:s.conditionOperator,conflictResolution:s.conflictResolution};r.push(g),e.push({index:i,rule:g})}}),{rules:r,successes:e,errors:t}}var B=class extends Error{constructor(r){super(r),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},Te=class extends B{constructor(e,t,s){let i=Y(t);super(`Permission denied: Cannot ${i} "${e}"`);this.filePath=e;this.operation=t;this.originalError=s}getUserMessage(){return`Permission denied: Cannot ${Y(this.operation)} "${this.filePath}". Check file permissions and try again.`}},$=class extends B{constructor(e,t,s,i,c){let o=Y(i),a=t?`Cannot ${o} "${e}" to "${t}"`:`Cannot ${o} "${e}"`;super(`File conflict: ${a} - file ${s}`);this.sourcePath=e;this.destinationPath=t;this.conflictType=s;this.operation=i;this.originalError=c}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use","max-attempts":"exceeded maximum attempts to find a unique filename"},t=Y(this.operation);return`${this.destinationPath?`Cannot ${t} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${t} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},C=class extends B{constructor(e,t,s){super(`Invalid path "${e}": ${t}${s?` - ${s}`:""}`);this.path=e;this.reason=t;this.details=s}getUserMessage(){let t={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],s=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${t}${s}.`}},ye=class extends B{constructor(e,t,s){let i=Y(t);super(`File operation failed: ${i} on "${e}"`);this.filePath=e;this.operation=t;this.originalError=s}getUserMessage(){var s;let e=Y(this.operation),t=(s=this.originalError)!=null&&s.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${t}.`}};function Z(n,r,e,t){let s=n instanceof Error?n:new Error(String(n)),i=s.message.toLowerCase(),c="code"in s?s.code:void 0;return c==="EACCES"||c==="EPERM"||i.includes("permission")||i.includes("eacces")||i.includes("eperm")||i.includes("access denied")?new Te(r,e,s):c==="EEXIST"||i.includes("already exists")||i.includes("eexist")||i.includes("file exists")?new $(r,t||r,"exists",e,s):c==="EBUSY"||i.includes("locked")||i.includes("ebusy")?new $(r,t||r,"locked",e,s):c==="ETXTBSY"||i.includes("in use")||i.includes("being used")||i.includes("etxtbsy")?new $(r,t||r,"in-use",e,s):c==="EINVAL"||i.includes("invalid path")||i.includes("invalid character")||i.includes("einval")?new C(t||r,"invalid-characters",s.message):c==="ENAMETOOLONG"||i.includes("path too long")||i.includes("enametoolong")?new C(t||r,"too-long",s.message):new ye(r,e,s)}function Y(n){return n.replace(/-/g," ")}var xe=require("obsidian");var G={MAX_UNIQUE_FILENAME_ATTEMPTS:100,BULK_OPERATION_BATCH_SIZE:100,BULK_OPERATION_BATCH_DELAY_MS:10},Re={SETTINGS_SAVE_MS:300,METADATA_REFRESH_MS:1e3},W={WINDOWS_MAX_PATH:260,UNIX_MAX_PATH:4096,MAX_COMPONENT_LENGTH:255,MAX_ARRAY_PATH_DEPTH:5};var Je=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),et=/[<>:"|?*\x00-\x1F]/,tt=/^([A-Za-z]:[\\/]|\/)/,nt=/(^|[\\/])\.\.($|[\\/])/,st=/\/{2,}|\\{2,}/;function J(n,r={}){let{allowEmpty:e=!1,allowAbsolute:t=!1,maxLength:s=W.WINDOWS_MAX_PATH,checkReservedNames:i=!0}=r,c=[];if(!n||n.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:c}:{valid:!1,error:new C(n,"empty")};if(tt.test(n)&&!t)return{valid:!1,error:new C(n,"absolute","Use relative paths within the vault")};if(nt.test(n))return{valid:!1,error:new C(n,"traversal",'Paths cannot contain ".." segments')};let o=(0,xe.normalizePath)(n);st.test(o)&&(o=o.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),c.push("Multiple consecutive slashes were normalized")),o=o.trim().replace(/^\/+|\/+$/g,"");let a=o.match(et);if(a)return{valid:!1,error:new C(n,"invalid-characters",`Contains invalid character: "${a[0]}"`)};if(o.length>s)return{valid:!1,error:new C(n,"too-long",`Path length (${o.length}) exceeds maximum (${s})`)};let l=o.split("/").filter(Boolean);for(let u of l){if(u.length>W.MAX_COMPONENT_LENGTH)return{valid:!1,error:new C(n,"too-long",`Path component "${u}" exceeds ${W.MAX_COMPONENT_LENGTH} characters`)};if(i){let g=u.split(".")[0].toUpperCase();if(Je.has(g))return{valid:!1,error:new C(n,"reserved-name",`"${u}" is a reserved system name on Windows`)}}if(u.endsWith(".")||u.endsWith(" "))return{valid:!1,error:new C(n,"invalid-characters",`Path component "${u}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:o,warnings:c.length>0?c:void 0}}function Se(n){return J(n,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var se={REORGANIZE:{name:"Reorganize notes based on frontmatter rules",description:"Apply all configured rules to reorganize vault files"},UNDO:{name:"Undo last automatic move",description:"Revert the most recent file move"},VIEW_HISTORY:{name:"View move history",description:"Show all recent file moves and undo options"}},E={RULE_NAME:"Frontmatter rule",RULE_DESCRIPTION:"Move files to destination folder based on frontmatter matching",EXCLUSION_PATTERNS_NAME:"Exclusion Patterns",EXCLUSION_PATTERNS_DESCRIPTION:"Files and folders matching these patterns will not be automatically organized",TOOLTIPS:{ACTIVATE_RULE:"Activate this rule",MOVE_UP:"Move rule up",MOVE_DOWN:"Move rule down",BROWSE_FRONTMATTER:"Browse frontmatter keys",BROWSE_TAGS:"Browse tags",CASE_INSENSITIVE:"Case insensitive matching",DEBUG_MODE:"Enable debug mode",TEST_ALL_RULES:"Preview what moves would be made without actually moving files",CONFLICT_RESOLUTION:"How to handle file conflicts at destination",CONDITION_OPERATOR:"How to combine multiple conditions (AND/OR)",ADD_CONDITION:"Add another condition to this rule",EXCLUSION_PATTERN:"Glob pattern (e.g., Templates/**, *.excalidraw)",DUPLICATE_RULE:"Create a copy of this rule"},PLACEHOLDERS:{KEY:"key",VALUE:"value",DESTINATION:"destination folder (supports {variables})",FLAGS:"flags",EXCLUSION_PATTERN:"e.g., Templates/**, Archive/**"},BUTTONS:{REMOVE:"Remove",ADD_RULE:"Add Rule",APPLY_NOW:"Apply now",TEST_ALL_RULES:"Test All Rules",ADD_CONDITION:"+",REMOVE_CONDITION:"Remove Condition",ADD_EXCLUSION:"Add Pattern",DUPLICATE:"Duplicate"},LABELS:{CONFLICT_RESOLUTION:"On Conflict:",CONDITION_OPERATOR:"Combine:",CONDITIONS_SECTION:"Additional Conditions"},WARNINGS:{INVALID_REGEX:n=>`Invalid regular expression: ${n}`,VALUE_REQUIRED:"Value is required for contains/starts-with/ends-with rules.",KEY_REQUIRED:"Frontmatter key is required for the rule to match."},SUCCESS:{RULE_VALID:"Rule is valid and ready to use"}},A={TEST_ALL_RULES:{TITLE:"Test All Rules - Preview",NO_MOVES_OVERALL:"No files would be moved. All files are either already in the correct location or have no matching rules.",NO_MOVES_ALREADY_CORRECT:"No files would be moved. All matching files are already in the correct location.",FILES_WOULD_MOVE:n=>`${n} file(s) would be moved:`,SKIPPED_SECTION:"Skipped due to invalid destinations",INVALID_DESTINATION_WARNING:"Destination path is invalid and the move cannot be previewed.",LABELS:{FILE:"File:",FROM:"From:",TO:"To:",RULE:"Rule:",WARNINGS:"Warnings:"},BUTTONS:{CLOSE:"Close"}},MOVE_HISTORY:{TITLE:"Move History",NO_HISTORY:"No move history yet.",SHOWING_COUNT:(n,r)=>`Showing ${n} of last ${r} moves.`,MOST_RECENT_PREFIX:"\u{1F504} Most Recent: ",TIME_PREFIX:n=>`\u23F0 ${n}`,LABELS:{FROM:"From:",TO:"To:",RULE:"Rule:"},BUTTONS:{UNDO:"Undo This Move",CLEAR_HISTORY:"Clear History",CLOSE:"Close"},NOTICES:{HISTORY_CLEARED:"Move history cleared."}}},U={UNDO:{NO_MOVES:"No moves to undo.",FILE_NOT_EXISTS:n=>`Cannot undo: File no longer exists at ${n}`,NOT_A_FILE:n=>`Cannot undo: ${n} is not a file.`,DESTINATION_EXISTS:n=>`Cannot undo: A file already exists at ${n}`,SUCCESS:(n,r)=>`Undone: Moved ${n} back to ${r}`},DEBUG:{EMPTY_DESTINATION:(n,r)=>`DEBUG: ${n} would not be moved because destination is empty in ${r}.`,WOULD_MOVE:(n,r,e)=>`DEBUG: ${n} would be moved to ${r}/${e}`},REGEX_PARSE_ERROR:(n,r)=>`Failed to parse regular expression for rule "${n}": ${r}`},De={NESTED_BATCH_OPERATION:"Nested batch operations are not supported. Using existing batch context."},ie={FILE_PROCESSING:{EXPECTED_ERROR:n=>`Expected error during file processing - ${n}`,UNEXPECTED_ERROR:"Unexpected error during file processing",UNDO_FAILED:"Undo operation failed"}},q={equals:"Equals",contains:"Contains","starts-with":"Starts with","ends-with":"Ends with",regex:"Regex"};var Oe={rules:[],moveHistory:[],maxHistorySize:50,excludePatterns:[]},Ae=[{value:"equals",label:q.equals},{value:"contains",label:q.contains},{value:"starts-with",label:q["starts-with"]},{value:"ends-with",label:q["ends-with"]},{value:"regex",label:q.regex}];function ee(n){var t,s,i,c,o,a;let r=(t=n.matchType)!=null?t:n.isRegex?"regex":"equals",e={...n,matchType:r,key:(s=n.key)!=null?s:"",value:(i=n.value)!=null?i:"",destination:(c=n.destination)!=null?c:"",enabled:(o=n.enabled)!=null?o:!1};return r==="regex"?(e.isRegex=!0,e.flags=(a=n.flags)!=null?a:""):(delete e.isRegex,delete e.flags),e}var I=require("obsidian");var H=require("obsidian");var ae=class extends H.FuzzySuggestModal{constructor(e,t,s){super(e);this.tags=t;this.onSelect=s}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},re=class extends H.FuzzySuggestModal{constructor(e,t,s){super(e);this.keys=t;this.onSelect=s}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},oe=class extends H.Modal{constructor(e,t,s){super(e);this.results=t;this.rules=s}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:A.TEST_ALL_RULES.TITLE});let t=this.results.filter(o=>o.newPath&&!o.error),s=this.results.filter(o=>o.error);if(t.length===0&&s.length===0)e.createEl("p",{text:A.TEST_ALL_RULES.NO_MOVES_OVERALL});else{if(t.length){e.createEl("p",{text:A.TEST_ALL_RULES.FILES_WOULD_MOVE(t.length)});let o=e.createDiv({cls:"vault-organizer-test-results"});o.style.maxHeight="400px",o.style.overflowY="auto",o.style.marginTop="1em",t.forEach(a=>{var L,P;let l=o.createDiv({cls:"vault-organizer-test-result-item"});l.style.marginBottom="1em",l.style.padding="0.5em",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="4px";let u=l.createDiv();u.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.FILE}),u.createSpan({text:a.file.basename});let g=l.createDiv();g.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.FROM}),g.createSpan({text:a.currentPath});let h=l.createDiv();h.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.TO}),h.createSpan({text:a.newPath||"(unknown)"});let f=l.createDiv();if(f.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.RULE}),f.createSpan({text:`Rule ${a.ruleIndex+1} (${((L=this.rules[a.ruleIndex])==null?void 0:L.key)||"unknown"})`}),(P=a.warnings)!=null&&P.length){let y=l.createDiv();y.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.WARNINGS}),y.createSpan({text:a.warnings.join("; ")})}})}else e.createEl("p",{text:A.TEST_ALL_RULES.NO_MOVES_ALREADY_CORRECT});if(s.length){e.createEl("h3",{text:A.TEST_ALL_RULES.SKIPPED_SECTION});let o=e.createDiv({cls:"vault-organizer-test-results"});o.style.maxHeight="400px",o.style.overflowY="auto",o.style.marginTop="1em",s.forEach(a=>{var L,P,y,N;let l=o.createDiv({cls:"vault-organizer-test-result-item"});l.style.marginBottom="1em",l.style.padding="0.5em",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="4px";let u=l.createDiv();u.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.FILE}),u.createSpan({text:a.file.basename});let g=l.createDiv();g.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.FROM}),g.createSpan({text:a.currentPath});let h=l.createDiv();h.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.RULE}),h.createSpan({text:`Rule ${a.ruleIndex+1} (${((L=this.rules[a.ruleIndex])==null?void 0:L.key)||"unknown"})`});let f=l.createDiv();if(f.createEl("strong",{text:"Reason: "}),f.createSpan({text:(y=(P=a.error)==null?void 0:P.getUserMessage())!=null?y:A.TEST_ALL_RULES.INVALID_DESTINATION_WARNING}),(N=a.warnings)!=null&&N.length){let w=l.createDiv();w.createEl("strong",{text:A.TEST_ALL_RULES.LABELS.WARNINGS}),w.createSpan({text:a.warnings.join("; ")})}})}}let i=e.createDiv({cls:"modal-button-container"});i.style.marginTop="1.5em",i.style.textAlign="right";let c=i.createEl("button",{text:A.TEST_ALL_RULES.BUTTONS.CLOSE});c.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},le=class extends H.Modal{constructor(e,t){super(e);this.plugin=t}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:A.MOVE_HISTORY.TITLE}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:A.MOVE_HISTORY.NO_HISTORY});else{e.createEl("p",{text:A.MOVE_HISTORY.SHOWING_COUNT(this.plugin.settings.moveHistory.length,this.plugin.settings.maxHistorySize)});let c=e.createDiv({cls:"vault-organizer-history-container"});c.style.maxHeight="500px",c.style.overflowY="auto",c.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((o,a)=>{let l=c.createDiv({cls:"vault-organizer-history-item"});l.style.marginBottom="1em",l.style.padding="0.8em",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="4px",l.style.position="relative",a===0&&(l.style.backgroundColor="var(--background-secondary-alt)",l.style.borderColor="var(--interactive-accent)");let u=l.createDiv();u.style.marginBottom="0.5em",u.style.fontWeight="bold";let h=new Date(o.timestamp).toLocaleString();a===0&&u.createEl("span",{text:A.MOVE_HISTORY.MOST_RECENT_PREFIX,cls:"vault-organizer-recent-label"}),u.createSpan({text:o.fileName});let f=l.createDiv();f.style.fontSize="0.9em",f.style.color="var(--text-muted)",f.style.marginBottom="0.5em",f.textContent=A.MOVE_HISTORY.TIME_PREFIX(h);let L=l.createDiv();L.createEl("strong",{text:A.MOVE_HISTORY.LABELS.FROM}),L.createSpan({text:o.fromPath});let P=l.createDiv();P.createEl("strong",{text:A.MOVE_HISTORY.LABELS.TO}),P.createSpan({text:o.toPath});let y=l.createDiv();if(y.createEl("strong",{text:A.MOVE_HISTORY.LABELS.RULE}),y.createSpan({text:o.ruleKey||"(unknown)"}),a===0){let N=l.createDiv();N.style.marginTop="0.8em";let w=N.createEl("button",{text:A.MOVE_HISTORY.BUTTONS.UNDO});w.style.backgroundColor="var(--interactive-accent)",w.style.color="var(--text-on-accent)",w.style.padding="0.4em 0.8em",w.style.border="none",w.style.borderRadius="4px",w.style.cursor="pointer",w.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let t=e.createDiv({cls:"modal-button-container"});t.style.marginTop="1.5em",t.style.textAlign="right";let s=t.createEl("button",{text:A.MOVE_HISTORY.BUTTONS.CLEAR_HISTORY});s.style.marginRight="0.5em",s.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new H.Notice(A.MOVE_HISTORY.NOTICES.HISTORY_CLEARED),this.close()};let i=t.createEl("button",{text:A.MOVE_HISTORY.BUTTONS.CLOSE});i.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};var it=200,X=new Map;function Me(n){let r=X.get(n);if(r)return X.delete(n),X.set(n,r),r;let e=at(n);if(X.size>=it){let t=X.keys().next().value;t!==void 0&&X.delete(t)}return X.set(n,e),e}function at(n){n.length>1e3&&(b.warn(`Exclusion pattern too long (${n.length} chars), truncating to 1000`),n=n.substring(0,1e3));let r="^",e=0,t=0,s=50;for(;e<n.length;){let i=n[e];if(i==="*"){if(t++,t>s){b.warn(`Exclusion pattern has too many wildcards (>${s}), ignoring excess`),e+=1;continue}n[e+1]==="*"?(r+=".*",e+=2):(r+="[^/]*",e+=1)}else if(i==="?"){if(t++,t>s){b.warn(`Exclusion pattern has too many wildcards (>${s}), ignoring excess`),e+=1;continue}r+="[^/]",e+=1}else if(i==="["){let c=n.indexOf("]",e);c===-1?(r+="\\[",e+=1):(r+=n.substring(e,c+1),e=c+1)}else/[.+^${}()|\\]/.test(i)?(r+="\\"+i,e+=1):(r+=i,e+=1)}return r+="$",new RegExp(r)}function Ie(n,r){if(!r||r.length===0)return!1;let e=n.replace(/\\/g,"/");for(let t of r){if(!t||t.trim()==="")continue;let s=t.trim().replace(/\\/g,"/");if(Me(s).test(e))return!0;if(!s.includes("*")&&!s.includes("?")&&!s.includes("[")){let c=s.replace(/\/$/,"");if(e===c||e.startsWith(c+"/")){let o=e.split("/");if(c.split("/").every((u,g)=>o[g]===u))return!0}}}return!1}function Fe(n){if(!n||n.trim()==="")return{valid:!1,error:"Pattern cannot be empty"};if(/[<>:"|]/.test(n))return{valid:!1,error:"Pattern contains invalid characters"};try{return Me(n),{valid:!0}}catch(r){return{valid:!1,error:"Invalid glob pattern syntax"}}}var rt=100,ot=/^[a-zA-Z_][a-zA-Z0-9_.-]{0,99}$/;function lt(n){return!n||n.length===0||n.length>rt||n.includes("..")||n.includes("/")||n.includes("\\")?!1:ot.test(n)}function _e(n){let r=/\{([^}]+)\}/g,e=[],t=[],s;for(;(s=r.exec(n))!==null;){let i=s[1];lt(i)?e.push(i):t.push(i)}return{variables:e,invalid:t}}function ct(n,r){if(!n||!r)return;if(!r.includes("."))return n[r];let e=r.split("."),t=n;for(let s of e){if(t==null||typeof t!="object")return;t=t[s]}return t}function ze(n){if(n==null)return"";let r=String(n);return r=r.replace(/[<>:"|?*]/g,""),r=r.replace(/\\/g,"-"),r=r.replace(/\//g,"-"),r=r.trim().replace(/^\.+|\.+$/g,""),r=r.replace(/\s+/g," "),r}function Ue(n,r){let e=_e(n),{variables:t,invalid:s}=e;if(t.length===0&&s.length===0)return{substitutedPath:n,substituted:[],missing:[],hasVariables:!1};let i=[],c=[],o=[],a=n;for(let l of t){let u=ct(r,l),g=new RegExp(`\\{${ut(l)}\\}`,"g");if(u==null)c.push(l),a=a.replace(g,"");else{i.push(l);let h;if(Array.isArray(u)){let f=u.slice(0,W.MAX_ARRAY_PATH_DEPTH);u.length>W.MAX_ARRAY_PATH_DEPTH&&o.push(l),h=f.map(L=>ze(L)).filter(Boolean).join("/")}else h=ze(u);a=a.replace(g,h)}}return a=a.replace(/\/+/g,"/").replace(/^\/+|\/+$/g,""),a=a.split("/").filter(Boolean).join("/"),{substitutedPath:a,substituted:i,missing:c,hasVariables:t.length>0||s.length>0,truncated:o.length>0?o:void 0,invalid:s.length>0?s:void 0}}function ut(n){return n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Ve(n){let r=new Set(["g","i","m","s","u","y","d"]),e=n.split(""),t=[],s=[];for(let i of e)r.has(i)?s.includes(i)||s.push(i):i.trim()&&t.push(i);return{valid:t.length===0,sanitized:s.join(""),invalid:t}}var ce=class extends I.PluginSettingTab{constructor(e,t){super(e,t);this.aggregatedTags=[];this.frontmatterKeys=[];this.aggregatedTagsDirty=!0;this.frontmatterKeysDirty=!0;this.plugin=t,this.debouncedSaveOnly=(0,I.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},Re.SETTINGS_SAVE_MS),this.debouncedRefreshMetadata=(0,I.debounce)(()=>{this.markMetadataCachesDirty()},Re.METADATA_REFRESH_MS),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.debouncedRefreshMetadata()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}markMetadataCachesDirty(){this.aggregatedTagsDirty=!0,this.frontmatterKeysDirty=!0}refreshAggregatedTags(){var s,i,c;let e=new Set;((c=(i=(s=this.plugin.app.vault).getMarkdownFiles)==null?void 0:i.call(s))!=null?c:[]).forEach(o=>{let a=this.plugin.app.metadataCache.getFileCache(o);if(!a)return;let l=(0,I.getAllTags)(a);l&&l.forEach(u=>e.add(u))}),this.aggregatedTags=Array.from(e).sort((o,a)=>o.localeCompare(a)),this.aggregatedTagsDirty=!1}getAggregatedTags(){return(this.aggregatedTagsDirty||!this.aggregatedTags.length)&&this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var s,i,c;let e=new Set;((c=(i=(s=this.plugin.app.vault).getMarkdownFiles)==null?void 0:i.call(s))!=null?c:[]).forEach(o=>{let a=this.plugin.app.metadataCache.getFileCache(o),l=a==null?void 0:a.frontmatter;l&&Object.keys(l).filter(u=>u!=="position").forEach(u=>e.add(u))}),this.frontmatterKeys=Array.from(e).sort((o,a)=>o.localeCompare(a)),this.frontmatterKeysDirty=!1}getFrontmatterKeys(){return(this.frontmatterKeysDirty||!this.frontmatterKeys.length)&&this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,t){if(!e.length)return;new ae(this.app,e,t).open()}openFrontmatterKeyPicker(e,t){if(!e.length)return;new re(this.app,e,t).open()}toggleTagValue(e,t){let s=e.split(/\s+/).filter(Boolean);return(s.includes(t)?s.filter(o=>o!==t):[...s,t]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.markMetadataCachesDirty(),this.plugin.settings.rules=this.plugin.settings.rules.map(ee),this.plugin.settings.rules.forEach((o,a)=>{var te,we;let l=(te=o.matchType)!=null?te:"equals",u=new I.Setting(e).setName(`${E.RULE_NAME} ${a+1}`).setDesc(E.RULE_DESCRIPTION);u.settingEl.classList.add("setting-item"),u.settingEl.classList.add("vault-organizer-rule-item"),u.settingEl.setAttribute("data-rule-index",String(a));let g=document.createElement("div");g.classList.add("vault-organizer-rule-message"),g.style.display="none",u.settingEl.appendChild(g);let h=()=>{var m;let p=this.plugin.settings.rules[a],d=(m=p==null?void 0:p.enabled)!=null?m:!1;u.settingEl.classList.toggle("vault-organizer-rule-disabled",!d)};u.addToggle(p=>{var d;return p.setTooltip(E.TOOLTIPS.ACTIVATE_RULE).setValue((d=o.enabled)!=null?d:!1).onChange(async m=>{let v=this.plugin.settings.rules[a];v&&(v.enabled=m,h(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),h())})}),u.addExtraButton(p=>p.setIcon("arrow-up").setTooltip(E.TOOLTIPS.MOVE_UP).setDisabled(a===0).onClick(async()=>{if(a===0)return;let d=this.plugin.settings.rules[a];this.plugin.settings.rules[a]=this.plugin.settings.rules[a-1],this.plugin.settings.rules[a-1]=d,this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new I.Notice("Failed to save settings. Rule order was not changed."),console.error("Settings save error:",m);let v=this.plugin.settings.rules[a-1];this.plugin.settings.rules[a-1]=this.plugin.settings.rules[a],this.plugin.settings.rules[a]=v}})),u.addExtraButton(p=>p.setIcon("arrow-down").setTooltip(E.TOOLTIPS.MOVE_DOWN).setDisabled(a===this.plugin.settings.rules.length-1).onClick(async()=>{if(a===this.plugin.settings.rules.length-1)return;let d=this.plugin.settings.rules[a];this.plugin.settings.rules[a]=this.plugin.settings.rules[a+1],this.plugin.settings.rules[a+1]=d,this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new I.Notice("Failed to save settings. Rule order was not changed."),console.error("Settings save error:",m);let v=this.plugin.settings.rules[a+1];this.plugin.settings.rules[a+1]=this.plugin.settings.rules[a],this.plugin.settings.rules[a]=v}}));let f=()=>{var F;let p=this.plugin.getRuleErrorForIndex(a),d=this.plugin.settings.rules[a],m=(F=d==null?void 0:d.matchType)!=null?F:"equals",v=fe(m),D=d?ve(d):!1,z=d?typeof d.key=="string"&&d.key.trim().length>0:!1,_=d?typeof d.destination=="string"&&d.destination.trim().length>0:!1;p?(g.classList.add("vault-organizer-rule-error"),g.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-success"),g.textContent=E.WARNINGS.INVALID_REGEX(p.message),g.style.display=""):z?v&&!D?(g.classList.add("vault-organizer-rule-warning"),g.classList.remove("vault-organizer-rule-error","vault-organizer-rule-success"),g.textContent=E.WARNINGS.VALUE_REQUIRED,g.style.display=""):z&&_?(g.classList.add("vault-organizer-rule-success"),g.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),g.textContent=E.SUCCESS.RULE_VALID,g.style.display=""):(g.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error","vault-organizer-rule-success"),g.textContent="",g.style.display="none"):(g.classList.add("vault-organizer-rule-warning"),g.classList.remove("vault-organizer-rule-error","vault-organizer-rule-success"),g.textContent=E.WARNINGS.KEY_REQUIRED,g.style.display="")},L;u.addText(p=>{L=p,p.setPlaceholder(E.PLACEHOLDERS.KEY).setValue(o.key).onChange(d=>{let m=this.plugin.settings.rules[a];m&&(m.key=d,this.scheduleSaveOnly())})}),u.addExtraButton(p=>p.setIcon("list").setTooltip(E.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let d=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(d,m=>{let v=this.plugin.settings.rules[a];!v||!L||(L.setValue(m),v.key=m,this.scheduleSaveOnly())})}));let P;u.addText(p=>{P=p,p.setPlaceholder(E.PLACEHOLDERS.VALUE).setValue(o.value).onChange(d=>{let m=this.plugin.settings.rules[a];m&&(m.value=d,this.scheduleSaveOnly(),f())})}),u.addExtraButton(p=>p.setIcon("hashtag").setTooltip(E.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let d=this.getAggregatedTags();this.openTagPicker(d,m=>{let v=this.plugin.settings.rules[a];if(!v||!P)return;let D=this.toggleTagValue(P.getValue(),m);P.setValue(D),v.value=D,this.scheduleSaveOnly()})}));let y=document.createElement("div");y.classList.add("vault-organizer-destination-preview"),y.style.display="none";let N=p=>{let d=p.trim();if(!d){y.style.display="none";return}let{variables:m}=_e(d);if(m.length===0){y.style.display="none";return}y.innerHTML="";let v=document.createElement("span");v.className="vault-organizer-destination-preview-label",v.textContent="Variables: ",y.appendChild(v);let D=document.createTextNode(m.map(z=>`{${z}}`).join(", "));y.appendChild(D),y.style.display=""};N(o.destination),u.addText(p=>p.setPlaceholder(E.PLACEHOLDERS.DESTINATION).setValue(o.destination).onChange(d=>{let m=this.plugin.settings.rules[a];m&&(m.destination=d,N(d),this.scheduleSaveOnly(),f())})),u.settingEl.appendChild(y);let w,K,j=()=>{var m;let p=this.plugin.settings.rules[a],d=((m=p==null?void 0:p.matchType)!=null?m:"equals")==="regex";w&&(w.inputEl.toggleAttribute("disabled",!d),w.inputEl.disabled=!d,w.inputEl.style.display=d?"":"none"),K&&(K.toggleEl.style.display=d?"none":"")};if(u.addDropdown(p=>{p.selectEl.setAttribute("aria-label","Match type"),Ae.forEach(d=>p.addOption(d.value,d.label)),p.setValue(l).onChange(async d=>{var v;let m=this.plugin.settings.rules[a];m&&(m.matchType=d,d==="regex"?(m.isRegex=!0,m.flags=(v=m.flags)!=null?v:""):(delete m.isRegex,"flags"in m&&delete m.flags),j(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),j(),f())})}),u.addDropdown(p=>{var d;p.selectEl.setAttribute("aria-label","Conflict resolution"),p.selectEl.setAttribute("title",E.TOOLTIPS.CONFLICT_RESOLUTION),p.addOption("fail","Fail"),p.addOption("skip","Skip"),p.addOption("append-number","Add number"),p.addOption("append-timestamp","Add timestamp"),p.setValue((d=o.conflictResolution)!=null?d:"fail").onChange(m=>{let v=this.plugin.settings.rules[a];v&&(v.conflictResolution=m,this.scheduleSaveOnly())})}),u.addDropdown(p=>{var m;p.selectEl.setAttribute("aria-label","Condition operator"),p.selectEl.setAttribute("title",E.TOOLTIPS.CONDITION_OPERATOR),p.addOption("AND","AND"),p.addOption("OR","OR");let d=o.conditions&&o.conditions.length>0;p.selectEl.style.display=d?"":"none",p.setValue((m=o.conditionOperator)!=null?m:"AND").onChange(v=>{let D=this.plugin.settings.rules[a];D&&(D.conditionOperator=v,this.scheduleSaveOnly())})}),u.addText(p=>{var d;w=p,p.setPlaceholder(E.PLACEHOLDERS.FLAGS).setValue((d=o.flags)!=null?d:"").onChange(m=>{let v=this.plugin.settings.rules[a];if(v&&v.matchType==="regex"){let D=Ve(m);D.valid?(p.inputEl.classList.remove("vault-organizer-invalid-flags"),p.inputEl.title=""):(p.inputEl.classList.add("vault-organizer-invalid-flags"),p.inputEl.title=`Invalid flag(s): ${D.invalid.join(", ")}. Valid flags: g, i, m, s, u, y, d`),v.flags=D.sanitized,m!==D.sanitized&&p.setValue(D.sanitized),this.scheduleSaveOnly()}})}),j(),u.addToggle(p=>{var d;K=p,p.setTooltip(E.TOOLTIPS.CASE_INSENSITIVE).setValue((d=o.caseInsensitive)!=null?d:!1).onChange(async m=>{let v=this.plugin.settings.rules[a];v&&(v.caseInsensitive=m,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),u.addToggle(p=>{var d;return p.setTooltip(E.TOOLTIPS.DEBUG_MODE).setValue((d=o.debug)!=null?d:!1).onChange(async m=>{let v=this.plugin.settings.rules[a];v&&(v.debug=m,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),u.addButton(p=>p.setButtonText(E.BUTTONS.ADD_CONDITION).setTooltip(E.TOOLTIPS.ADD_CONDITION).onClick(async()=>{let d=this.plugin.settings.rules[a];if(d){d.conditions||(d.conditions=[]),d.conditions.push({key:"",value:"",matchType:"equals"}),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new I.Notice("Failed to save settings. Please try again."),console.error("Settings save error:",m),d.conditions.pop()}}})),u.addButton(p=>p.setButtonText(E.BUTTONS.DUPLICATE).setTooltip(E.TOOLTIPS.DUPLICATE_RULE).onClick(async()=>{let d=this.plugin.settings.rules[a];if(!d)return;let m=JSON.parse(JSON.stringify(d));m.enabled=!1,this.plugin.settings.rules.splice(a+1,0,m),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(v){new I.Notice("Failed to save settings. Rule was not duplicated."),console.error("Settings save error:",v),this.plugin.settings.rules.splice(a+1,1)}})),u.addButton(p=>p.setButtonText(E.BUTTONS.REMOVE).onClick(async()=>{let d=this.plugin.settings.rules.splice(a,1)[0];this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(m){new I.Notice("Failed to save settings. Rule was not removed."),console.error("Settings save error:",m),this.plugin.settings.rules.splice(a,0,d)}})),o.conditions&&o.conditions.length>0){let p=document.createElement("div");p.className="vault-organizer-conditions-header",e.appendChild(p);let d=(we=o.conditionOperator)!=null?we:"AND",m=document.createElement("span");m.className=`vault-organizer-operator-badge vault-organizer-operator-${d.toLowerCase()}`,m.textContent=d,p.appendChild(m);let v=document.createElement("span");v.className="vault-organizer-operator-desc",v.textContent=d==="AND"?"All conditions below must match":"Any condition below can match",p.appendChild(v);let D=document.createElement("div");D.className="vault-organizer-conditions-container",e.appendChild(D),o.conditions.forEach((z,_)=>{var Le;let F=new I.Setting(D).setName(`${E.LABELS.CONDITIONS_SECTION} ${_+1}`).setClass("vault-organizer-condition"),ge;F.addText(S=>{ge=S,S.setPlaceholder(E.PLACEHOLDERS.KEY).setValue(z.key).onChange(O=>{var R;let T=this.plugin.settings.rules[a];(R=T==null?void 0:T.conditions)!=null&&R[_]&&(T.conditions[_].key=O,this.scheduleSaveOnly())})}),F.addExtraButton(S=>S.setIcon("list").setTooltip(E.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let O=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(O,T=>{var M;let R=this.plugin.settings.rules[a];!((M=R==null?void 0:R.conditions)!=null&&M[_])||!ge||(ge.setValue(T),R.conditions[_].key=T,this.scheduleSaveOnly())})}));let ne;F.addText(S=>{ne=S,S.setPlaceholder(E.PLACEHOLDERS.VALUE).setValue(z.value).onChange(O=>{var R;let T=this.plugin.settings.rules[a];(R=T==null?void 0:T.conditions)!=null&&R[_]&&(T.conditions[_].value=O,this.scheduleSaveOnly())})}),F.addExtraButton(S=>S.setIcon("hashtag").setTooltip(E.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let O=this.getAggregatedTags();this.openTagPicker(O,T=>{var V;let R=this.plugin.settings.rules[a];if(!((V=R==null?void 0:R.conditions)!=null&&V[_])||!ne)return;let M=this.toggleTagValue(ne.getValue(),T);ne.setValue(M),R.conditions[_].value=M,this.scheduleSaveOnly()})}));let ke=(Le=z.matchType)!=null?Le:"equals",Q,de,pe=()=>{var R,M;let S=this.plugin.settings.rules[a],O=(R=S==null?void 0:S.conditions)==null?void 0:R[_],T=((M=O==null?void 0:O.matchType)!=null?M:"equals")==="regex";Q&&(Q.inputEl.toggleAttribute("disabled",!T),Q.inputEl.disabled=!T,Q.inputEl.style.display=T?"":"none"),de&&(de.toggleEl.style.display=T?"none":"")};F.addDropdown(S=>{S.selectEl.setAttribute("aria-label","Match type"),Ae.forEach(O=>S.addOption(O.value,O.label)),S.setValue(ke).onChange(async O=>{var R,M;let T=this.plugin.settings.rules[a];(R=T==null?void 0:T.conditions)!=null&&R[_]&&(T.conditions[_].matchType=O,O==="regex"?(T.conditions[_].isRegex=!0,T.conditions[_].flags=(M=T.conditions[_].flags)!=null?M:""):(delete T.conditions[_].isRegex,"flags"in T.conditions[_]&&delete T.conditions[_].flags),pe(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),pe())})}),F.addText(S=>{var O;Q=S,S.setPlaceholder(E.PLACEHOLDERS.FLAGS).setValue((O=z.flags)!=null?O:"").onChange(T=>{var M;let R=this.plugin.settings.rules[a];if((M=R==null?void 0:R.conditions)!=null&&M[_]&&R.conditions[_].matchType==="regex"){let V=Ve(T);V.valid?(S.inputEl.classList.remove("vault-organizer-invalid-flags"),S.inputEl.title=""):(S.inputEl.classList.add("vault-organizer-invalid-flags"),S.inputEl.title=`Invalid flag(s): ${V.invalid.join(", ")}. Valid flags: g, i, m, s, u, y, d`),R.conditions[_].flags=V.sanitized,T!==V.sanitized&&S.setValue(V.sanitized),this.scheduleSaveOnly()}})}),F.addToggle(S=>{var O;de=S,S.setTooltip(E.TOOLTIPS.CASE_INSENSITIVE).setValue((O=z.caseInsensitive)!=null?O:!1).onChange(async T=>{var M;let R=this.plugin.settings.rules[a];(M=R==null?void 0:R.conditions)!=null&&M[_]&&(R.conditions[_].caseInsensitive=T,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),F.addButton(S=>S.setButtonText(E.BUTTONS.REMOVE_CONDITION).onClick(async()=>{let O=this.plugin.settings.rules[a];if(!(O!=null&&O.conditions))return;let T=O.conditions.splice(_,1)[0];this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(R){new I.Notice("Failed to save settings. Condition was not removed."),console.error("Settings save error:",R),O.conditions.splice(_,0,T)}})),pe()})}f(),h()}),new I.Setting(e).addButton(o=>o.setButtonText(E.BUTTONS.ADD_RULE).onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(a){new I.Notice("Failed to save settings. Rule was not added."),console.error("Settings save error:",a),this.plugin.settings.rules.pop()}})),new I.Setting(e).setName(E.EXCLUSION_PATTERNS_NAME).setDesc(E.EXCLUSION_PATTERNS_DESCRIPTION),this.plugin.settings.excludePatterns.forEach((o,a)=>{new I.Setting(e).setName(`Pattern ${a+1}`).addText(l=>{l.setPlaceholder(E.PLACEHOLDERS.EXCLUSION_PATTERN).setValue(o).onChange(async u=>{let g=u.trim(),h=Fe(g);!h.valid&&g!==""?(l.inputEl.classList.add("vault-organizer-invalid-pattern"),l.inputEl.title=h.error||"Invalid pattern"):(l.inputEl.classList.remove("vault-organizer-invalid-pattern"),l.inputEl.title=""),this.plugin.settings.excludePatterns[a]=g,this.scheduleSaveOnly()}),l.inputEl.style.width="300px"}).addButton(l=>l.setButtonText(E.BUTTONS.REMOVE).setTooltip("Remove this exclusion pattern").onClick(async()=>{this.plugin.settings.excludePatterns.splice(a,1),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(u){new I.Notice("Failed to save settings. Pattern was not removed."),console.error("Settings save error:",u),this.plugin.settings.excludePatterns.splice(a,0,o)}}))}),new I.Setting(e).addButton(o=>o.setButtonText(E.BUTTONS.ADD_EXCLUSION).setTooltip("Add a new exclusion pattern").onClick(async()=>{this.plugin.settings.excludePatterns.push(""),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),this.display()}catch(a){new I.Notice("Failed to save settings. Pattern was not added."),console.error("Settings save error:",a),this.plugin.settings.excludePatterns.pop()}}));let t=document.createElement("div");t.className="vault-organizer-pattern-templates",e.appendChild(t);let s=document.createElement("h3");s.className="vault-organizer-templates-heading",s.textContent="Common Patterns",t.appendChild(s);let i=[{pattern:"Templates/**",description:"Exclude all files in Templates folder"},{pattern:"*.excalidraw.md",description:"Exclude Excalidraw drawings"},{pattern:"Archive/**",description:"Exclude all files in Archive folder"},{pattern:".obsidian/**",description:"Exclude Obsidian config files"},{pattern:"**/Daily Notes/**",description:"Exclude Daily Notes in any location"}],c=document.createElement("div");c.className="vault-organizer-template-list",t.appendChild(c),i.forEach(({pattern:o,description:a})=>{let l=document.createElement("div");l.className="vault-organizer-template-item",c.appendChild(l);let u=document.createElement("span");u.className="vault-organizer-template-pattern",u.textContent=o,l.appendChild(u);let g=document.createElement("span");g.className="vault-organizer-template-desc",g.textContent=` - ${a}`,l.appendChild(g);let h=document.createElement("button");h.className="vault-organizer-template-add-btn",h.textContent="Add",l.appendChild(h),h.addEventListener("click",async()=>{if(this.plugin.settings.excludePatterns.includes(o)){new I.Notice("This pattern is already in your exclusion list.");return}this.plugin.settings.excludePatterns.push(o),this.cancelPendingSaveOnly();try{await this.plugin.saveSettingsWithoutReorganizing(),new I.Notice(`Added exclusion pattern: ${o}`),this.display()}catch(f){new I.Notice("Failed to save settings. Pattern was not added."),console.error("Settings save error:",f),this.plugin.settings.excludePatterns.pop()}})}),new I.Setting(e).addButton(o=>o.setButtonText(E.BUTTONS.APPLY_NOW).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(o=>o.setButtonText(E.BUTTONS.TEST_ALL_RULES).setTooltip(E.TOOLTIPS.TEST_ALL_RULES).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let a=this.plugin.testAllRules();new oe(this.app,a,this.plugin.settings.rules).open()}))}hide(){this.cancelPendingSaveOnly(),this.debouncedRefreshMetadata.cancel()}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".vault-organizer-rule-item[data-rule-index]").forEach(s=>{var N,w;let i=s.querySelector(".vault-organizer-rule-message");if(!i)return;let c=s.getAttribute("data-rule-index");if(c===null)return;let o=parseInt(c,10);if(isNaN(o))return;let a=this.plugin.settings.rules[o],l=(N=a==null?void 0:a.enabled)!=null?N:!1;s.classList.toggle("vault-organizer-rule-disabled",!l);let u=this.plugin.getRuleErrorForIndex(o),g=(w=a==null?void 0:a.matchType)!=null?w:"equals",h=fe(g),f=!0,L=a?ve(a):!1,P=a?typeof a.key=="string"&&a.key.trim().length>0:!1,y=a?typeof a.destination=="string"&&a.destination.trim().length>0:!1;u?(i.classList.add("vault-organizer-rule-error"),i.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-success"),i.textContent=E.WARNINGS.INVALID_REGEX(u.message),i.style.display=""):f&&!P?(i.classList.add("vault-organizer-rule-warning"),i.classList.remove("vault-organizer-rule-error","vault-organizer-rule-success"),i.textContent=E.WARNINGS.KEY_REQUIRED,i.style.display=""):h&&!L?(i.classList.add("vault-organizer-rule-warning"),i.classList.remove("vault-organizer-rule-error","vault-organizer-rule-success"),i.textContent=E.WARNINGS.VALUE_REQUIRED,i.style.display=""):P&&y?(i.classList.add("vault-organizer-rule-success"),i.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),i.textContent=E.SUCCESS.RULE_VALID,i.style.display=""):(i.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error","vault-organizer-rule-success"),i.textContent="",i.style.display="none")})}};function Ne(n,r,e){var u,g,h,f,L,P,y;let t=[],s=n.trim();if(!s)return{valid:!1,error:new C(n,"empty","Destination path cannot be empty"),warnings:t};let i=Ue(s,e);i.missing.length>0&&t.push(`Missing variables: ${i.missing.join(", ")}`);let c=i.substitutedPath,o=Se(c);if(!o.valid||!o.sanitizedPath)return{valid:!1,substitution:i,error:(u=o.error)!=null?u:new C(c,"invalid-characters","Destination path validation failed"),warnings:[...t,...(g=o.warnings)!=null?g:[]]};let a=o.sanitizedPath,l=J(`${a}/${r}`,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});return!l.valid||!l.sanitizedPath?{valid:!1,substitution:i,destinationFolder:a,error:(h=l.error)!=null?h:new C(`${a}/${r}`,"invalid-characters","Full path validation failed"),warnings:[...t,...(f=o.warnings)!=null?f:[],...(L=l.warnings)!=null?L:[]]}:{valid:!0,destinationFolder:a,fullPath:l.sanitizedPath,substitution:i,warnings:[...t,...(P=o.warnings)!=null?P:[],...(y=l.warnings)!=null?y:[]].filter(Boolean)}}var ue=class extends x.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[];this.batchOperationInProgress=!1;this.filesBeingProcessed=new Set}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async t=>{!(t instanceof x.TFile)||t.extension!=="md"||await this.applyRulesToFile(t)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async t=>{!(t instanceof x.TFile)||t.extension!=="md"||await this.applyRulesToFile(t)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:se.REORGANIZE.name,callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:se.UNDO.name,callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:se.VIEW_HISTORY.name,callback:()=>{new le(this.app,this).open()}}),this.ruleSettingTab=new ce(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var s;let e=await this.loadData(),t=Array.isArray(e==null?void 0:e.rules)?e.rules.map(ee):[];this.settings={...Oe,...e,rules:t,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(s=e==null?void 0:e.maxHistorySize)!=null?s:Oe.maxHistorySize,excludePatterns:Array.isArray(e==null?void 0:e.excludePatterns)?e.excludePatterns:[]}}async saveSettings(){var t,s;if(this.settings.rules=this.settings.rules.map(ee),this.batchOperationInProgress)return;let e={...this.settings,excludePatterns:(s=(t=this.settings.excludePatterns)==null?void 0:t.filter(i=>i&&i.trim().length>0))!=null?s:[]};await this.saveData(e)}async withBatchOperation(e){var t,s;if(this.batchOperationInProgress)return b.warn(De.NESTED_BATCH_OPERATION),await e();this.batchOperationInProgress=!0;try{return await e()}finally{this.batchOperationInProgress=!1;let i={...this.settings,excludePatterns:(s=(t=this.settings.excludePatterns)==null?void 0:t.filter(c=>c&&c.trim().length>0))!=null?s:[]};await this.saveData(i)}}updateRulesFromSettings(){let{rules:e,successes:t,errors:s}=be(this.settings.rules);return this.rules=e,this.ruleParseErrors=s,{successes:t,errors:s}}async persistSettingsAndRefreshRules(){var c;let{successes:e,errors:t}=this.updateRulesFromSettings(),s=Ce(e.map(o=>o.rule)),i=[...this.settings.rules];e.forEach((o,a)=>{i[o.index]=s[a]}),this.settings.rules=i,await this.saveSettings(),t.length&&t.forEach(o=>{let a=o.rule.key||"(unnamed rule)",l=U.REGEX_PARSE_ERROR(a,o.message);new x.Notice(l)}),(c=this.ruleSettingTab)==null||c.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(t=>t.index===e)}async recordMove(e,t,s,i){if(!e||!t||!s||!i)throw new C(e||t||"(empty)","empty","fromPath, toPath, fileName, and ruleKey are required for recording move history");let c={timestamp:Date.now(),fileName:s,fromPath:e,toPath:t,ruleKey:i};this.settings.moveHistory.unshift(c),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new x.Notice(U.UNDO.NO_MOVES);return}let e=this.settings.moveHistory[0],t=this.app.vault.getAbstractFileByPath(e.toPath);if(!t){new x.Notice(U.UNDO.FILE_NOT_EXISTS(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(t instanceof x.TFile)){new x.Notice(U.UNDO.NOT_A_FILE(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new x.Notice(U.UNDO.DESTINATION_EXISTS(e.fromPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let i=e.fromPath.lastIndexOf("/");if(i>0){let c=e.fromPath.substring(0,i);await this.ensureFolderExists(c)}await this.app.fileManager.renameFile(t,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new x.Notice(U.UNDO.SUCCESS(e.fileName,e.fromPath))}catch(i){let c=Z(i,e.toPath,"move",e.fromPath);new x.Notice(c.getUserMessage()),b.warn(ie.FILE_PROCESSING.UNDO_FAILED,i)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let t=J(e,{allowEmpty:!1,allowAbsolute:!1});if(!t.valid||!t.sanitizedPath)throw t.error||new C(e,"invalid-characters","Path validation failed");let i=t.sanitizedPath.split("/").filter(Boolean);if(!i.length)return;let c="";for(let o of i){c=c?`${c}/${o}`:o;let a=this.app.vault.getAbstractFileByPath(c);if(a){if(a instanceof x.TFile)throw new $(c,void 0,"exists","create-folder");continue}try{await this.app.vault.createFolder(c)}catch(l){throw Z(l,c,"create-folder")}}}generateUniqueFilename(e,t,s){if(s==="append-timestamp"){let a=Date.now(),l=`${e}-${a}${t}`;if(!this.app.vault.getAbstractFileByPath(l))return l;for(let u=0;u<G.MAX_UNIQUE_FILENAME_ATTEMPTS;u++){let g=Math.random().toString(36).substring(2,8),h=`${e}-${a}-${g}${t}`;if(!this.app.vault.getAbstractFileByPath(h))return h}return b.warn(`Could not find unique timestamp filename after ${G.MAX_UNIQUE_FILENAME_ATTEMPTS} attempts. Using potentially conflicting path for ${e}${t}`),`${e}-${a}-${Math.random().toString(36).substring(2,8)}${t}`}let i=1,c;for(;i<=G.MAX_UNIQUE_FILENAME_ATTEMPTS;){if(c=`${e}-${i}${t}`,!this.app.vault.getAbstractFileByPath(c))return c;i++}b.warn(`Could not find unique numbered filename after ${G.MAX_UNIQUE_FILENAME_ATTEMPTS} attempts. Falling back to timestamp-based naming for ${e}${t}`);let o=Date.now();return`${e}-${o}${t}`}async applyRulesToFile(e){var c,o;let t=e.path;if(this.filesBeingProcessed.has(t))return;this.filesBeingProcessed.add(t);let s,i;try{if(Ie(e.path,this.settings.excludePatterns))return;let a=this.app.metadataCache.getFileCache(e),l=a==null?void 0:a.frontmatter;if(!l)return;let u=Ee.call(this,e,this.rules,l);if(!u)return;let g=u.destination.trim();if(!g){if(u.debug){let N=this.app.vault.getName();new x.Notice(U.DEBUG.EMPTY_DESTINATION(e.basename,N))}return}let h=Ne(g,e.name,l);if(!h.valid||!h.fullPath||!h.destinationFolder)throw(c=h.error)!=null?c:new C(g,"invalid-characters","Destination validation failed");u.debug&&h.substitution&&h.substitution.missing.length>0&&new x.Notice(`DEBUG: Missing variables in destination: ${h.substitution.missing.join(", ")}`);let f=h.fullPath,L=h.destinationFolder;if(s=f,e.path===f)return;if(u.debug){let N=this.app.vault.getName();new x.Notice(U.DEBUG.WOULD_MOVE(e.basename,N,L));return}if(await this.ensureFolderExists(L),this.app.vault.getAbstractFileByPath(f)){let N=(o=u.conflictResolution)!=null?o:"fail";if(N==="skip")return;if(N==="append-number"||N==="append-timestamp"){let w=e.name.lastIndexOf("."),K=w>0?e.name.substring(0,w):e.name,j=w>0?e.name.substring(w):"",te=`${L}/${K}`;f=this.generateUniqueFilename(te,j,N),s=f}else throw new $(f,e.path,"exists","move")}let y=e.path;f!==t&&(this.filesBeingProcessed.add(f),i=f);try{await this.app.fileManager.renameFile(e,f),await this.recordMove(y,f,e.name,u.key)}catch(N){throw i&&i!==t&&(this.filesBeingProcessed.delete(i),i=void 0),Z(N,e.path,"move",f)}}catch(a){if(a instanceof B)new x.Notice(a.getUserMessage()),b.warn(ie.FILE_PROCESSING.EXPECTED_ERROR(a.name),a.message);else{let l=Z(a,e.path,"move",s);new x.Notice(l.getUserMessage()),b.error(ie.FILE_PROCESSING.UNEXPECTED_ERROR,a)}}finally{this.filesBeingProcessed.delete(t),i&&i!==t&&this.filesBeingProcessed.delete(i)}}async reorganizeAllMarkdownFiles(){var t,s;let e=(s=(t=this.app.vault).getMarkdownFiles)==null?void 0:s.call(t);e!=null&&e.length&&await this.withBatchOperation(async()=>{for(let i=0;i<e.length;i++){let c=e[i];await this.applyRulesToFile(c),(i+1)%G.BULK_OPERATION_BATCH_SIZE===0&&await new Promise(o=>setTimeout(o,G.BULK_OPERATION_BATCH_DELAY_MS))}})}testAllRules(){var s,i,c,o,a;let e=((i=(s=this.app.vault).getMarkdownFiles)==null?void 0:i.call(s))||[],t=[];for(let l of e){if(Ie(l.path,this.settings.excludePatterns))continue;let u=this.app.metadataCache.getFileCache(l),g=u==null?void 0:u.frontmatter;if(!g)continue;let h=Ee.call(this,l,this.rules,g);if(!h)continue;let f=this.rules.indexOf(h),P=h.destination.trim();if(!P)continue;let y=Ne(P,l.name,g);if(!y.valid||!y.fullPath){t.push({file:l,currentPath:l.path,ruleIndex:f,error:(c=y.error)!=null?c:new C(P,"invalid-characters","Unknown validation error"),warnings:(o=y.warnings)!=null&&o.length?y.warnings:void 0});continue}let N=y.fullPath;l.path!==N&&t.push({file:l,currentPath:l.path,newPath:N,ruleIndex:f,warnings:(a=y.warnings)!=null&&a.length?y.warnings:void 0})}return t}};
