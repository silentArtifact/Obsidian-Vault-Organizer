/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var L=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(i,l)=>{for(var e in l)L(i,e,{get:l[e],enumerable:!0})},se=(i,l,e,s)=>{if(l&&typeof l=="object"||typeof l=="function")for(let t of Q(l))!ee.call(i,t)&&t!==e&&L(i,t,{get:()=>l[t],enumerable:!(s=Z(l,t))||s.enumerable});return i};var ne=i=>se(L({},"__esModule",{value:!0}),i);var ge={};te(ge,{default:()=>H});module.exports=ne(ge);var w=require("obsidian");function B(i,l,e){var t;let s=e!=null?e:(t=this.app.metadataCache.getFileCache(i))==null?void 0:t.frontmatter;if(s)return l.find(a=>{var p;if(a.enabled===!1)return!1;let r=s[a.key];if(r==null)return!1;let n=Array.isArray(r),c=n?r:[r],o=(p=a.matchType)!=null?p:"equals";if(o==="regex"){if(!(a.value instanceof RegExp))return!1;let f=a.value;return c.some(v=>{let b=String(v);return f.lastIndex=0,f.test(b)})}let h=re(String(a.value),n),m=o==="contains"||o==="starts-with"||o==="ends-with"?h.filter(f=>f.length>0):h;return m.length?c.some(f=>{let v=String(f);return m.some(b=>ae(v,b,o,a.caseInsensitive))}):!1})}function re(i,l){if(!l)return[i];let e=i.trim(),s=e.split(/\s+/).map(a=>a.trim()).filter(Boolean);if(!s.length)return[e];let t=new Set;return e&&t.add(e),s.forEach(a=>t.add(a)),Array.from(t)}function ae(i,l,e,s){let t=s?i.toLowerCase():i,a=s?l.toLowerCase():l;switch(e){case"contains":return t.includes(a);case"starts-with":return t.startsWith(a);case"ends-with":return t.endsWith(a);case"equals":default:return t===a}}function G(i){return i.map(l=>{var s,t,a;let e=(s=l.matchType)!=null?s:"equals";if(e==="regex"){let r=l.value instanceof RegExp?l.value.source:String(l.value),n=l.value instanceof RegExp?l.value.flags:"";return{key:l.key,matchType:e,value:r,destination:l.destination,enabled:(t=l.enabled)!=null?t:!1,isRegex:!0,flags:n,debug:l.debug,caseInsensitive:l.caseInsensitive}}return{key:l.key,matchType:e,value:String(l.value),destination:l.destination,enabled:(a=l.enabled)!=null?a:!1,debug:l.debug,caseInsensitive:l.caseInsensitive}})}function N(i){return i==="contains"||i==="starts-with"||i==="ends-with"}function q(i){return typeof i.value=="string"&&i.value.trim().length>0}function Y(i=[]){let l=[],e=[],s=[];return i.forEach((t,a)=>{var n,c,o;let r=(n=t.matchType)!=null?n:t.isRegex?"regex":"equals";if(r==="regex")try{let h=new RegExp(t.value,t.flags),m={key:t.key,matchType:r,value:h,destination:t.destination,enabled:(c=t.enabled)!=null?c:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};l.push(m),e.push({index:a,rule:m})}catch(h){let m=h instanceof Error?h.message:String(h),p=t.destination?` (destination: "${t.destination}")`:"",f=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${p}: ${m}. Rule will be ignored.`;console.warn(f),s.push({index:a,message:m,rule:{...t,matchType:r},cause:h})}else{let h={key:t.key,matchType:r,value:t.value,destination:t.destination,enabled:(o=t.enabled)!=null?o:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};l.push(h),e.push({index:a,rule:h})}}),{rules:l,successes:e,errors:s}}var S=class extends Error{constructor(l){super(l),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},U=class extends S{constructor(e,s,t){let a=F(s);super(`Permission denied: Cannot ${a} "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${F(this.operation)} "${this.filePath}". Check file permissions and try again.`}},C=class extends S{constructor(e,s,t,a,r){let n=F(a),c=s?`Cannot ${n} "${e}" to "${s}"`:`Cannot ${n} "${e}"`;super(`File conflict: ${c} - file ${t}`);this.sourcePath=e;this.destinationPath=s;this.conflictType=t;this.operation=a;this.originalError=r}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},s=F(this.operation);return`${this.destinationPath?`Cannot ${s} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${s} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},x=class extends S{constructor(e,s,t){super(`Invalid path "${e}": ${s}${t?` - ${t}`:""}`);this.path=e;this.reason=s;this.details=t}getUserMessage(){let s={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${s}${t}.`}},W=class extends S{constructor(e,s,t){let a=F(s);super(`File operation failed: ${a} on "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){var t;let e=F(this.operation),s=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${s}.`}};function k(i,l,e,s){let t=i instanceof Error?i:new Error(String(i)),a=t.message.toLowerCase();return a.includes("permission")||a.includes("eacces")||a.includes("eperm")||a.includes("access denied")?new U(l,e,t):a.includes("already exists")||a.includes("eexist")||a.includes("file exists")?new C(l,s||l,"exists",e,t):a.includes("locked")||a.includes("ebusy")?new C(l,s||l,"locked",e,t):a.includes("in use")||a.includes("being used")||a.includes("etxtbsy")?new C(l,s||l,"in-use",e,t):a.includes("invalid path")||a.includes("invalid character")||a.includes("einval")?new x(s||l,"invalid-characters"):a.includes("path too long")||a.includes("enametoolong")?new x(s||l,"too-long"):new W(l,e,t)}function F(i){return i.replace(/-/g," ")}var X=require("obsidian");var _={windows:260,unix:4096,component:255},ie=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),oe=/[<>:"|?*\x00-\x1F]/,le=/^([A-Za-z]:[\\/]|\/)/,ce=/(^|[\\/])\.\.($|[\\/])/,ue=/\/{2,}|\\{2,}/;function A(i,l={}){let{allowEmpty:e=!1,allowAbsolute:s=!1,maxLength:t=_.windows,checkReservedNames:a=!0}=l,r=[];if(!i||i.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:r}:{valid:!1,error:new x(i,"empty")};if(le.test(i)&&!s)return{valid:!1,error:new x(i,"absolute","Use relative paths within the vault")};if(ce.test(i))return{valid:!1,error:new x(i,"traversal",'Paths cannot contain ".." segments')};let n=(0,X.normalizePath)(i);ue.test(n)&&(n=n.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),r.push("Multiple consecutive slashes were normalized")),n=n.trim().replace(/^\/+|\/+$/g,"");let c=n.match(oe);if(c)return{valid:!1,error:new x(i,"invalid-characters",`Contains invalid character: "${c[0]}"`)};if(n.length>t)return{valid:!1,error:new x(i,"too-long",`Path length (${n.length}) exceeds maximum (${t})`)};let o=n.split("/").filter(Boolean);for(let h of o){if(h.length>_.component)return{valid:!1,error:new x(i,"too-long",`Path component "${h}" exceeds ${_.component} characters`)};if(a){let m=h.split(".")[0].toUpperCase();if(ie.has(m))return{valid:!1,error:new x(i,"reserved-name",`"${h}" is a reserved system name on Windows`)}}if(h.endsWith(".")||h.endsWith(" "))return{valid:!1,error:new x(i,"invalid-characters",`Path component "${h}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:n,warnings:r.length>0?r:void 0}}function K(i){return A(i,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var j={rules:[],moveHistory:[],maxHistorySize:50},J=[{value:"equals",label:"Equals"},{value:"contains",label:"Contains"},{value:"starts-with",label:"Starts with"},{value:"ends-with",label:"Ends with"},{value:"regex",label:"Regular expression"}];function M(i){var s,t,a,r,n,c;let l=(s=i.matchType)!=null?s:i.isRegex?"regex":"equals",e={...i,matchType:l,key:(t=i.key)!=null?t:"",value:(a=i.value)!=null?a:"",destination:(r=i.destination)!=null?r:"",enabled:(n=i.enabled)!=null?n:!1};return l==="regex"?(e.isRegex=!0,e.flags=(c=i.flags)!=null?c:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var R=require("obsidian");var z=require("obsidian"),$=class extends z.FuzzySuggestModal{constructor(e,s,t){super(e);this.tags=s;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},O=class extends z.FuzzySuggestModal{constructor(e,s,t){super(e);this.keys=s;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},V=class extends z.Modal{constructor(e,s,t){super(e);this.results=s;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Test All Rules - Preview"});let s=this.results.filter(n=>n.newPath&&!n.error),t=this.results.filter(n=>n.error);if(s.length===0&&t.length===0)e.createEl("p",{text:"No files would be moved. All files are either already in the correct location or have no matching rules."});else{if(s.length){e.createEl("p",{text:`${s.length} file(s) would be moved:`});let n=e.createDiv({cls:"vault-organizer-test-results"});n.style.maxHeight="400px",n.style.overflowY="auto",n.style.marginTop="1em",s.forEach(c=>{var v,b;let o=n.createDiv({cls:"vault-organizer-test-result-item"});o.style.marginBottom="1em",o.style.padding="0.5em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px";let h=o.createDiv();h.createEl("strong",{text:"File: "}),h.createSpan({text:c.file.basename});let m=o.createDiv();m.createEl("strong",{text:"From: "}),m.createSpan({text:c.currentPath});let p=o.createDiv();p.createEl("strong",{text:"To: "}),p.createSpan({text:c.newPath});let f=o.createDiv();if(f.createEl("strong",{text:"Rule: "}),f.createSpan({text:`Rule ${c.ruleIndex+1} (${((v=this.rules[c.ruleIndex])==null?void 0:v.key)||"unknown"})`}),(b=c.warnings)!=null&&b.length){let g=o.createDiv();g.createEl("strong",{text:"Warnings: "}),g.createSpan({text:c.warnings.join("; ")})}})}else e.createEl("p",{text:"No files would be moved. All matching files are already in the correct location."});if(t.length){e.createEl("h3",{text:"Skipped due to invalid destinations"});let n=e.createDiv({cls:"vault-organizer-test-results"});n.style.maxHeight="400px",n.style.overflowY="auto",n.style.marginTop="1em",t.forEach(c=>{var v,b,g,u;let o=n.createDiv({cls:"vault-organizer-test-result-item"});o.style.marginBottom="1em",o.style.padding="0.5em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px";let h=o.createDiv();h.createEl("strong",{text:"File: "}),h.createSpan({text:c.file.basename});let m=o.createDiv();m.createEl("strong",{text:"From: "}),m.createSpan({text:c.currentPath});let p=o.createDiv();p.createEl("strong",{text:"Rule: "}),p.createSpan({text:`Rule ${c.ruleIndex+1} (${((v=this.rules[c.ruleIndex])==null?void 0:v.key)||"unknown"})`});let f=o.createDiv();if(f.createEl("strong",{text:"Reason: "}),f.createSpan({text:(g=(b=c.error)==null?void 0:b.getUserMessage())!=null?g:"Destination path is invalid and the move cannot be previewed."}),(u=c.warnings)!=null&&u.length){let d=o.createDiv();d.createEl("strong",{text:"Warnings: "}),d.createSpan({text:c.warnings.join("; ")})}})}}let a=e.createDiv({cls:"modal-button-container"});a.style.marginTop="1.5em",a.style.textAlign="right";let r=a.createEl("button",{text:"Close"});r.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},D=class extends z.Modal{constructor(e,s){super(e);this.plugin=s}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Move History"}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:"No move history yet."});else{e.createEl("p",{text:`Showing ${this.plugin.settings.moveHistory.length} of last ${this.plugin.settings.maxHistorySize} moves.`});let r=e.createDiv({cls:"vault-organizer-history-container"});r.style.maxHeight="500px",r.style.overflowY="auto",r.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((n,c)=>{let o=r.createDiv({cls:"vault-organizer-history-item"});o.style.marginBottom="1em",o.style.padding="0.8em",o.style.border="1px solid var(--background-modifier-border)",o.style.borderRadius="4px",o.style.position="relative",c===0&&(o.style.backgroundColor="var(--background-secondary-alt)",o.style.borderColor="var(--interactive-accent)");let h=o.createDiv();h.style.marginBottom="0.5em",h.style.fontWeight="bold";let p=new Date(n.timestamp).toLocaleString();c===0&&h.createEl("span",{text:"\u{1F504} Most Recent: ",cls:"vault-organizer-recent-label"}),h.createSpan({text:n.fileName});let f=o.createDiv();f.style.fontSize="0.9em",f.style.color="var(--text-muted)",f.style.marginBottom="0.5em",f.textContent=`\u23F0 ${p}`;let v=o.createDiv();v.createEl("strong",{text:"From: "}),v.createSpan({text:n.fromPath});let b=o.createDiv();b.createEl("strong",{text:"To: "}),b.createSpan({text:n.toPath});let g=o.createDiv();if(g.createEl("strong",{text:"Rule: "}),g.createSpan({text:n.ruleKey||"(unknown)"}),c===0){let u=o.createDiv();u.style.marginTop="0.8em";let d=u.createEl("button",{text:"Undo This Move"});d.style.backgroundColor="var(--interactive-accent)",d.style.color="var(--text-on-accent)",d.style.padding="0.4em 0.8em",d.style.border="none",d.style.borderRadius="4px",d.style.cursor="pointer",d.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let s=e.createDiv({cls:"modal-button-container"});s.style.marginTop="1.5em",s.style.textAlign="right";let t=s.createEl("button",{text:"Clear History"});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new z.Notice("Move history cleared."),this.close()};let a=s.createEl("button",{text:"Close"});a.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};var I=class extends R.PluginSettingTab{constructor(e,s){super(e,s);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=s,this.debouncedSaveOnly=(0,R.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},300),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,a,r;let e=new Set;((r=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?r:[]).forEach(n=>{let c=this.plugin.app.metadataCache.getFileCache(n);if(!c)return;let o=(0,R.getAllTags)(c);o&&o.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((n,c)=>n.localeCompare(c))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,a,r;let e=new Set;((r=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?r:[]).forEach(n=>{let c=this.plugin.app.metadataCache.getFileCache(n),o=c==null?void 0:c.frontmatter;o&&Object.keys(o).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((n,c)=>n.localeCompare(c))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,s){if(!e.length)return;new $(this.app,e,s).open()}openFrontmatterKeyPicker(e,s){if(!e.length)return;new O(this.app,e,s).open()}toggleTagValue(e,s){let t=e.split(/\s+/).filter(Boolean);return(t.includes(s)?t.filter(n=>n!==s):[...t,s]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(M),this.plugin.settings.rules.forEach((s,t)=>{var b;let a=(b=s.matchType)!=null?b:"equals",r=new R.Setting(e).setName(`Rule ${t+1}`).setDesc("Destination folder is required before the rule can move files.");r.settingEl.classList.add("setting-item");let n=document.createElement("div");n.classList.add("vault-organizer-rule-message"),n.style.display="none",r.settingEl.appendChild(n);let c=()=>{var d;let g=this.plugin.settings.rules[t],u=(d=g==null?void 0:g.enabled)!=null?d:!1;r.settingEl.classList.toggle("vault-organizer-rule-disabled",!u)};r.addToggle(g=>{var u;return g.setTooltip("Activate this rule").setValue((u=s.enabled)!=null?u:!1).onChange(async d=>{let y=this.plugin.settings.rules[t];y&&(y.enabled=d,c(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),c())})}),r.addExtraButton(g=>g.setIcon("arrow-up").setTooltip("Move rule up").setDisabled(t===0).onClick(async()=>{if(t===0)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),r.addExtraButton(g=>g.setIcon("arrow-down").setTooltip("Move rule down").setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let o=()=>{var P;let g=this.plugin.getRuleErrorForIndex(t),u=this.plugin.settings.rules[t],d=(P=u==null?void 0:u.matchType)!=null?P:"equals",y=N(d),E=u?q(u):!1;g?(n.classList.add("vault-organizer-rule-error"),n.classList.remove("vault-organizer-rule-warning"),n.textContent=`Invalid regular expression: ${g.message}`,n.style.display=""):y&&!E?(n.classList.add("vault-organizer-rule-warning"),n.classList.remove("vault-organizer-rule-error"),n.textContent="Value is required for contains/starts-with/ends-with rules.",n.style.display=""):(n.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),n.textContent="",n.style.display="none")},h;r.addText(g=>{h=g,g.setPlaceholder("key").setValue(s.key).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.key=u,this.scheduleSaveOnly())})}),r.addExtraButton(g=>g.setIcon("list").setTooltip("Browse frontmatter keys").onClick(()=>{let u=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(u,d=>{let y=this.plugin.settings.rules[t];!y||!h||(h.setValue(d),y.key=d,this.scheduleSaveOnly())})}));let m;r.addText(g=>{m=g,g.setPlaceholder("value").setValue(s.value).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.value=u,this.scheduleSaveOnly(),o())})}),r.addExtraButton(g=>g.setIcon("hashtag").setTooltip("Browse tags").onClick(()=>{let u=this.getAggregatedTags();this.openTagPicker(u,d=>{let y=this.plugin.settings.rules[t];if(!y||!m)return;let E=this.toggleTagValue(m.getValue(),d);m.setValue(E),y.value=E,this.scheduleSaveOnly()})})),r.addText(g=>g.setPlaceholder("destination folder (required)").setValue(s.destination).onChange(u=>{let d=this.plugin.settings.rules[t];d&&(d.destination=u,this.scheduleSaveOnly())}));let p,f,v=()=>{var d;let g=this.plugin.settings.rules[t],u=((d=g==null?void 0:g.matchType)!=null?d:"equals")==="regex";p&&(p.inputEl.toggleAttribute("disabled",!u),p.inputEl.disabled=!u,p.inputEl.style.display=u?"":"none"),f&&(f.toggleEl.style.display=u?"none":"")};r.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),J.forEach(u=>g.addOption(u.value,u.label)),g.setValue(a).onChange(async u=>{var y;let d=this.plugin.settings.rules[t];d&&(d.matchType=u,u==="regex"?(d.isRegex=!0,d.flags=(y=d.flags)!=null?y:""):(delete d.isRegex,"flags"in d&&delete d.flags),v(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),v(),o())})}),r.addText(g=>{var u;p=g,g.setPlaceholder("flags").setValue((u=s.flags)!=null?u:"").onChange(d=>{let y=this.plugin.settings.rules[t];y&&y.matchType==="regex"&&(y.flags=d,this.scheduleSaveOnly())})}),v(),r.addToggle(g=>{var u;f=g,g.setTooltip("Case insensitive matching").setValue((u=s.caseInsensitive)!=null?u:!1).onChange(async d=>{let y=this.plugin.settings.rules[t];y&&(y.caseInsensitive=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),r.addToggle(g=>{var u;return g.setTooltip("Enable debug mode").setValue((u=s.debug)!=null?u:!1).onChange(async d=>{let y=this.plugin.settings.rules[t];y&&(y.debug=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),r.addButton(g=>g.setButtonText("Remove").onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),o(),c()}),new R.Setting(e).addButton(s=>s.setButtonText("Add Rule").onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new R.Setting(e).addButton(s=>s.setButtonText("Apply now").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(s=>s.setButtonText("Test All Rules").setTooltip("Preview what moves would be made without actually moving files").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new V(this.app,t,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,a)=>{var f,v;let r=t.querySelector(".vault-organizer-rule-message");if(!r)return;let n=this.plugin.settings.rules[a],c=(f=n==null?void 0:n.enabled)!=null?f:!1;t.classList.toggle("vault-organizer-rule-disabled",!c);let o=this.plugin.getRuleErrorForIndex(a),h=(v=n==null?void 0:n.matchType)!=null?v:"equals",m=N(h),p=n?q(n):!1;o?(r.classList.add("vault-organizer-rule-error"),r.classList.remove("vault-organizer-rule-warning"),r.textContent=`Invalid regular expression: ${o.message}`,r.style.display=""):m&&!p?(r.classList.add("vault-organizer-rule-warning"),r.classList.remove("vault-organizer-rule-error"),r.textContent="Value is required for contains/starts-with/ends-with rules.",r.style.display=""):(r.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),r.textContent="",r.style.display="none")})}};var H=class extends w.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[]}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async s=>{!(s instanceof w.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async s=>{!(s instanceof w.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:"Reorganize notes based on frontmatter rules",callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:"Undo last automatic move",callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:"View move history",callback:()=>{new D(this.app,this).open()}}),this.ruleSettingTab=new I(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),s=Array.isArray(e==null?void 0:e.rules)?e.rules.map(M):[];this.settings={...j,...e,rules:s,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:j.maxHistorySize}}async saveSettings(){let e=this.settings.rules.map(M);this.settings.rules=e,await this.saveData({...this.settings,rules:e})}updateRulesFromSettings(){let{rules:e,successes:s,errors:t}=Y(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:s,errors:t}}async persistSettingsAndRefreshRules(){var r;let{successes:e,errors:s}=this.updateRulesFromSettings(),t=G(e.map(n=>n.rule)),a=[...this.settings.rules];e.forEach((n,c)=>{a[n.index]=t[c]}),this.settings.rules=a,await this.saveSettings(),s.length&&s.forEach(n=>{let o=`Failed to parse regular expression for rule "${n.rule.key||"(unnamed rule)"}": ${n.message}`;new w.Notice(o)}),(r=this.ruleSettingTab)==null||r.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(s=>s.index===e)}async recordMove(e,s,t,a){let r={timestamp:Date.now(),fileName:t,fromPath:e,toPath:s,ruleKey:a};this.settings.moveHistory.unshift(r),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new w.Notice("No moves to undo.");return}let e=this.settings.moveHistory[0],s=this.app.vault.getAbstractFileByPath(e.toPath);if(!s){new w.Notice(`Cannot undo: File no longer exists at ${e.toPath}`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(s instanceof w.TFile)){new w.Notice(`Cannot undo: ${e.toPath} is not a file.`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new w.Notice(`Cannot undo: A file already exists at ${e.fromPath}`);return}try{let a=e.fromPath.lastIndexOf("/");if(a>0){let r=e.fromPath.substring(0,a);await this.ensureFolderExists(r)}await this.app.fileManager.renameFile(s,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new w.Notice(`Undone: Moved ${e.fileName} back to ${e.fromPath}`)}catch(a){let r=k(a,e.toPath,"move",e.fromPath);new w.Notice(r.getUserMessage()),console.error("[Vault Organizer] Undo failed:",a)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let s=A(e,{allowEmpty:!1,allowAbsolute:!1});if(!s.valid)throw s.error;let a=s.sanitizedPath.split("/").filter(Boolean);if(!a.length)return;let r="";for(let n of a)if(r=r?`${r}/${n}`:n,!this.app.vault.getAbstractFileByPath(r))try{await this.app.vault.createFolder(r)}catch(c){throw k(c,r,"create-folder")}}async applyRulesToFile(e){var a;let s=e.basename,t;try{let r=(a=this.app.metadataCache.getFileCache(e))==null?void 0:a.frontmatter;if(!r)return;let n=B.call(this,e,this.rules,r);if(!n)return;let c=n.destination.trim();if(!c){if(n.debug){let v=this.app.vault.getName();new w.Notice(`DEBUG: ${e.basename} would not be moved because destination is empty in ${v}.`)}return}let o=K(c);if(!o.valid)throw o.error;let h=o.sanitizedPath,m=A(`${h}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!m.valid)throw m.error;let p=m.sanitizedPath;if(t=p,e.path===p)return;if(n.debug){let v=this.app.vault.getName();new w.Notice(`DEBUG: ${e.basename} would be moved to ${v}/${h}`);return}await this.ensureFolderExists(h);let f=e.path;try{await this.app.fileManager.renameFile(e,p),await this.recordMove(f,p,e.name,n.key)}catch(v){throw k(v,e.path,"move",p)}}catch(r){if(r instanceof S)new w.Notice(r.getUserMessage()),console.error(`[Vault Organizer] ${r.name}:`,r.message,r);else{let n=k(r,e.path,"move",t);new w.Notice(n.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",r)}}}async reorganizeAllMarkdownFiles(){var s,t;let e=(t=(s=this.app.vault).getMarkdownFiles)==null?void 0:t.call(s);if(e!=null&&e.length)for(let a of e)await this.applyRulesToFile(a)}testAllRules(){var t,a,r,n,c,o,h,m;let e=((a=(t=this.app.vault).getMarkdownFiles)==null?void 0:a.call(t))||[],s=[];for(let p of e){let f=(r=this.app.metadataCache.getFileCache(p))==null?void 0:r.frontmatter;if(!f)continue;let v=this.rules.findIndex(T=>T.enabled===!1?!1:B.call(this,p,[T],f));if(v===-1)continue;let g=this.rules[v].destination.trim();if(!g)continue;let u=K(g);if(!u.valid){s.push({file:p,currentPath:p.path,ruleIndex:v,error:u.error,warnings:u.warnings});continue}let d=(n=u.sanitizedPath)!=null?n:"",y=d?`${d}/${p.name}`:p.name,E=A(y,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!E.valid){let T=[...(c=u.warnings)!=null?c:[],...(o=E.warnings)!=null?o:[]];s.push({file:p,currentPath:p.path,ruleIndex:v,error:E.error,warnings:T.length?T:void 0});continue}let P=E.sanitizedPath;if(p.path!==P){let T=[...(h=u.warnings)!=null?h:[],...(m=E.warnings)!=null?m:[]];s.push({file:p,currentPath:p.path,newPath:P,ruleIndex:v,warnings:T.length?T:void 0})}}return s}};
