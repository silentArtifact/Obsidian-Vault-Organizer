/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var A=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Z=Object.prototype.hasOwnProperty;var Q=(i,o)=>{for(var e in o)A(i,e,{get:o[e],enumerable:!0})},ee=(i,o,e,s)=>{if(o&&typeof o=="object"||typeof o=="function")for(let t of J(o))!Z.call(i,t)&&t!==e&&A(i,t,{get:()=>o[t],enumerable:!(s=X(o,t))||s.enumerable});return i};var te=i=>ee(A({},"__esModule",{value:!0}),i);var ue={};Q(ue,{default:()=>k});module.exports=te(ue);var f=require("obsidian");function $(i,o,e){var t,r;let s=e!=null?e:(t=this.app.metadataCache.getFileCache(i))==null?void 0:t.frontmatter;if(s)for(let a of o){if(a.enabled===!1)continue;let n=s[a.key];if(n==null)continue;let l=Array.isArray(n),c=l?n:[n],d=(r=a.matchType)!=null?r:"equals";if(d==="regex"){if(!(a.value instanceof RegExp))continue;let m=a.value;for(let y of c){let b=String(y);if(m.lastIndex=0,m.test(b))return{rule:a,matchedKey:a.key,matchedValue:b,frontmatterValue:n,matchType:d}}continue}let v=se(String(a.value),l),p=d==="contains"||d==="starts-with"||d==="ends-with"?v.filter(m=>m.length>0):v;if(p.length)for(let m of c){let y=String(m);for(let b of p)if(ne(y,b,d,a.caseInsensitive))return{rule:a,matchedKey:a.key,matchedValue:y,frontmatterValue:n,matchType:d}}}}function K(i,o,e){let s=$.call(this,i,o,e);return s==null?void 0:s.rule}function se(i,o){if(!o)return[i];let e=i.trim(),s=e.split(/\s+/).map(r=>r.trim()).filter(Boolean);if(!s.length)return[e];let t=new Set;return e&&t.add(e),s.forEach(r=>t.add(r)),Array.from(t)}function ne(i,o,e,s){let t=s?i.toLowerCase():i,r=s?o.toLowerCase():o;switch(e){case"contains":return t.includes(r);case"starts-with":return t.startsWith(r);case"ends-with":return t.endsWith(r);case"equals":default:return t===r}}function _(i){return i.map(o=>{var s,t,r;let e=(s=o.matchType)!=null?s:"equals";if(e==="regex"){let a=o.value instanceof RegExp?o.value.source:String(o.value),n=o.value instanceof RegExp?o.value.flags:"";return{key:o.key,matchType:e,value:a,destination:o.destination,enabled:(t=o.enabled)!=null?t:!1,isRegex:!0,flags:n,debug:o.debug,caseInsensitive:o.caseInsensitive}}return{key:o.key,matchType:e,value:String(o.value),destination:o.destination,enabled:(r=o.enabled)!=null?r:!1,debug:o.debug,caseInsensitive:o.caseInsensitive}})}function M(i){return i==="contains"||i==="starts-with"||i==="ends-with"}function V(i){return typeof i.value=="string"&&i.value.trim().length>0}function j(i=[]){let o=[],e=[],s=[];return i.forEach((t,r)=>{var n,l,c;let a=(n=t.matchType)!=null?n:t.isRegex?"regex":"equals";if(a==="regex")try{let d=new RegExp(t.value,t.flags),v={key:t.key,matchType:a,value:d,destination:t.destination,enabled:(l=t.enabled)!=null?l:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};o.push(v),e.push({index:r,rule:v})}catch(d){let v=d instanceof Error?d.message:String(d),p=t.destination?` (destination: "${t.destination}")`:"",m=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${p}: ${v}. Rule will be ignored.`;console.warn(m),s.push({index:r,message:v,rule:{...t,matchType:a},cause:d})}else{let d={key:t.key,matchType:a,value:t.value,destination:t.destination,enabled:(c=t.enabled)!=null?c:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};o.push(d),e.push({index:r,rule:d})}}),{rules:o,successes:e,errors:s}}var T=class extends Error{constructor(o){super(o),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},O=class extends T{constructor(e,s,t){let r=S(s);super(`Permission denied: Cannot ${r} "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${S(this.operation)} "${this.filePath}". Check file permissions and try again.`}},z=class extends T{constructor(e,s,t,r,a){let n=S(r),l=s?`Cannot ${n} "${e}" to "${s}"`:`Cannot ${n} "${e}"`;super(`File conflict: ${l} - file ${t}`);this.sourcePath=e;this.destinationPath=s;this.conflictType=t;this.operation=r;this.originalError=a}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},s=S(this.operation);return`${this.destinationPath?`Cannot ${s} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${s} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},x=class extends T{constructor(e,s,t){super(`Invalid path "${e}": ${s}${t?` - ${t}`:""}`);this.path=e;this.reason=s;this.details=t}getUserMessage(){let s={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${s}${t}.`}},D=class extends T{constructor(e,s,t){let r=S(s);super(`File operation failed: ${r} on "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){var t;let e=S(this.operation),s=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${s}.`}};function P(i,o,e,s){let t=i instanceof Error?i:new Error(String(i)),r=t.message.toLowerCase();return r.includes("permission")||r.includes("eacces")||r.includes("eperm")||r.includes("access denied")?new O(o,e,t):r.includes("already exists")||r.includes("eexist")||r.includes("file exists")?new z(o,s||o,"exists",e,t):r.includes("locked")||r.includes("ebusy")?new z(o,s||o,"locked",e,t):r.includes("in use")||r.includes("being used")||r.includes("etxtbsy")?new z(o,s||o,"in-use",e,t):r.includes("invalid path")||r.includes("invalid character")||r.includes("einval")?new x(s||o,"invalid-characters"):r.includes("path too long")||r.includes("enametoolong")?new x(s||o,"too-long"):new D(o,e,t)}function S(i){return i.replace(/-/g," ")}var G=require("obsidian");var I={windows:260,unix:4096,component:255},ae=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),re=/[<>:"|?*\x00-\x1F]/,ie=/^([A-Za-z]:[\\/]|\/)/,oe=/(^|[\\/])\.\.($|[\\/])/,le=/\/{2,}|\\{2,}/;function C(i,o={}){let{allowEmpty:e=!1,allowAbsolute:s=!1,maxLength:t=I.windows,checkReservedNames:r=!0}=o,a=[];if(!i||i.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:a}:{valid:!1,error:new x(i,"empty")};if(ie.test(i)&&!s)return{valid:!1,error:new x(i,"absolute","Use relative paths within the vault")};if(oe.test(i))return{valid:!1,error:new x(i,"traversal",'Paths cannot contain ".." segments')};let n=(0,G.normalizePath)(i);le.test(n)&&(n=n.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),a.push("Multiple consecutive slashes were normalized")),n=n.trim().replace(/^\/+|\/+$/g,"");let l=n.match(re);if(l)return{valid:!1,error:new x(i,"invalid-characters",`Contains invalid character: "${l[0]}"`)};if(n.length>t)return{valid:!1,error:new x(i,"too-long",`Path length (${n.length}) exceeds maximum (${t})`)};let c=n.split("/").filter(Boolean);for(let d of c){if(d.length>I.component)return{valid:!1,error:new x(i,"too-long",`Path component "${d}" exceeds ${I.component} characters`)};if(r){let v=d.split(".")[0].toUpperCase();if(ae.has(v))return{valid:!1,error:new x(i,"reserved-name",`"${d}" is a reserved system name on Windows`)}}if(d.endsWith(".")||d.endsWith(" "))return{valid:!1,error:new x(i,"invalid-characters",`Path component "${d}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:n,warnings:a.length>0?a:void 0}}function L(i){return C(i,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var Y={rules:[],moveHistory:[],maxHistorySize:50},ce=[{value:"equals",label:"Equals"},{value:"contains",label:"Contains"},{value:"starts-with",label:"Starts with"},{value:"ends-with",label:"Ends with"},{value:"regex",label:"Regular expression"}];function H(i){var s,t,r,a,n,l;let o=(s=i.matchType)!=null?s:i.isRegex?"regex":"equals",e={...i,matchType:o,key:(t=i.key)!=null?t:"",value:(r=i.value)!=null?r:"",destination:(a=i.destination)!=null?a:"",enabled:(n=i.enabled)!=null?n:!1};return o==="regex"?(e.isRegex=!0,e.flags=(l=i.flags)!=null?l:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var k=class extends f.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[]}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async s=>{!(s instanceof f.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async s=>{!(s instanceof f.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:"Reorganize notes based on frontmatter rules",callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:"Undo last automatic move",callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:"View move history",callback:()=>{new W(this.app,this).open()}}),this.ruleSettingTab=new B(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),s=Array.isArray(e==null?void 0:e.rules)?e.rules.map(H):[];this.settings={...Y,...e,rules:s,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:Y.maxHistorySize}}async saveSettings(){let e=this.settings.rules.map(H);this.settings.rules=e,await this.saveData({...this.settings,rules:e})}updateRulesFromSettings(){let{rules:e,successes:s,errors:t}=j(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:s,errors:t}}async persistSettingsAndRefreshRules(){var a;let{successes:e,errors:s}=this.updateRulesFromSettings(),t=_(e.map(n=>n.rule)),r=[...this.settings.rules];e.forEach((n,l)=>{r[n.index]=t[l]}),this.settings.rules=r,await this.saveSettings(),s.length&&s.forEach(n=>{let c=`Failed to parse regular expression for rule "${n.rule.key||"(unnamed rule)"}": ${n.message}`;new f.Notice(c)}),(a=this.ruleSettingTab)==null||a.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(s=>s.index===e)}getMatchTypeLabel(e){return{equals:"==",contains:"contains","starts-with":"starts with","ends-with":"ends with",regex:"matches"}[e]}async recordMove(e,s,t,r){let a={timestamp:Date.now(),fileName:t,fromPath:e,toPath:s,ruleKey:r};this.settings.moveHistory.unshift(a),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new f.Notice("No moves to undo.");return}let e=this.settings.moveHistory[0],s=this.app.vault.getAbstractFileByPath(e.toPath);if(!s){new f.Notice(`Cannot undo: File no longer exists at ${e.toPath}`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(s instanceof f.TFile)){new f.Notice(`Cannot undo: ${e.toPath} is not a file.`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new f.Notice(`Cannot undo: A file already exists at ${e.fromPath}`);return}try{let r=e.fromPath.lastIndexOf("/");if(r>0){let a=e.fromPath.substring(0,r);await this.ensureFolderExists(a)}await this.app.fileManager.renameFile(s,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new f.Notice(`Undone: Moved ${e.fileName} back to ${e.fromPath}`)}catch(r){let a=P(r,e.toPath,"move",e.fromPath);new f.Notice(a.getUserMessage()),console.error("[Vault Organizer] Undo failed:",r)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let s=C(e,{allowEmpty:!1,allowAbsolute:!1});if(!s.valid)throw s.error;let r=s.sanitizedPath.split("/").filter(Boolean);if(!r.length)return;let a="";for(let n of r)if(a=a?`${a}/${n}`:n,!this.app.vault.getAbstractFileByPath(a))try{await this.app.vault.createFolder(a)}catch(l){throw P(l,a,"create-folder")}}async applyRulesToFile(e){var r;let s=e.basename,t;try{let a=(r=this.app.metadataCache.getFileCache(e))==null?void 0:r.frontmatter;if(!a)return;let n=$.call(this,e,this.rules,a);if(!n)return;let l=n.rule,c=l.destination.trim();if(!c){if(l.debug){let b=this.app.vault.getName();new f.Notice(`DEBUG: ${e.basename} would not be moved because destination is empty in ${b}.`)}return}let d=L(c);if(!d.valid)throw d.error;let v=d.sanitizedPath,p=C(`${v}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!p.valid)throw p.error;let m=p.sanitizedPath;if(t=m,e.path===m)return;if(l.debug){let b=this.app.vault.getName(),g=this.getMatchTypeLabel(n.matchType),u=l.value instanceof RegExp?`/${l.value.source}/${l.value.flags}`:`"${l.value}"`,h=[`DEBUG: ${e.basename} would be moved to ${b}/${v}`,`  \u2713 Matched: ${n.matchedKey} ${g} ${u}`,`  \u2713 Found value: "${n.matchedValue}"`].join(`
`);new f.Notice(h,8e3);return}await this.ensureFolderExists(v);let y=e.path;try{await this.app.fileManager.renameFile(e,m),await this.recordMove(y,m,e.name,l.key)}catch(b){throw P(b,e.path,"move",m)}}catch(a){if(a instanceof T)new f.Notice(a.getUserMessage()),console.error(`[Vault Organizer] ${a.name}:`,a.message,a);else{let n=P(a,e.path,"move",t);new f.Notice(n.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",a)}}}async reorganizeAllMarkdownFiles(){var s,t;let e=(t=(s=this.app.vault).getMarkdownFiles)==null?void 0:t.call(s);if(e!=null&&e.length)for(let r of e)await this.applyRulesToFile(r)}testAllRules(){var t,r,a,n,l,c,d,v;let e=((r=(t=this.app.vault).getMarkdownFiles)==null?void 0:r.call(t))||[],s=[];for(let p of e){let m=(a=this.app.metadataCache.getFileCache(p))==null?void 0:a.frontmatter;if(!m)continue;let y=this.rules.findIndex(R=>R.enabled===!1?!1:K.call(this,p,[R],m));if(y===-1)continue;let g=this.rules[y].destination.trim();if(!g)continue;let u=L(g);if(!u.valid){s.push({file:p,currentPath:p.path,ruleIndex:y,error:u.error,warnings:u.warnings});continue}let h=(n=u.sanitizedPath)!=null?n:"",w=h?`${h}/${p.name}`:p.name,E=C(w,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!E.valid){let R=[...(l=u.warnings)!=null?l:[],...(c=E.warnings)!=null?c:[]];s.push({file:p,currentPath:p.path,ruleIndex:y,error:E.error,warnings:R.length?R:void 0});continue}let F=E.sanitizedPath;if(p.path!==F){let R=[...(d=u.warnings)!=null?d:[],...(v=E.warnings)!=null?v:[]];s.push({file:p,currentPath:p.path,newPath:F,ruleIndex:y,warnings:R.length?R:void 0})}}return s}},B=class extends f.PluginSettingTab{constructor(e,s){super(e,s);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=s,this.debouncedSaveOnly=(0,f.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},300),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,r,a;let e=new Set;((a=(r=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(t))!=null?a:[]).forEach(n=>{let l=this.plugin.app.metadataCache.getFileCache(n);if(!l)return;let c=(0,f.getAllTags)(l);c&&c.forEach(d=>e.add(d))}),this.aggregatedTags=Array.from(e).sort((n,l)=>n.localeCompare(l))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,r,a;let e=new Set;((a=(r=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(t))!=null?a:[]).forEach(n=>{let l=this.plugin.app.metadataCache.getFileCache(n),c=l==null?void 0:l.frontmatter;c&&Object.keys(c).filter(d=>d!=="position").forEach(d=>e.add(d))}),this.frontmatterKeys=Array.from(e).sort((n,l)=>n.localeCompare(l))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,s){if(!e.length)return;new N(this.app,e,s).open()}openFrontmatterKeyPicker(e,s){if(!e.length)return;new q(this.app,e,s).open()}toggleTagValue(e,s){let t=e.split(/\s+/).filter(Boolean);return(t.includes(s)?t.filter(n=>n!==s):[...t,s]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(H),this.plugin.settings.rules.forEach((s,t)=>{var b;let r=(b=s.matchType)!=null?b:"equals",a=new f.Setting(e).setName(`Rule ${t+1}`).setDesc("Destination folder is required before the rule can move files.");a.settingEl.classList.add("setting-item");let n=document.createElement("div");n.classList.add("vault-organizer-rule-message"),n.style.display="none",a.settingEl.appendChild(n);let l=()=>{var h;let g=this.plugin.settings.rules[t],u=(h=g==null?void 0:g.enabled)!=null?h:!1;a.settingEl.classList.toggle("vault-organizer-rule-disabled",!u)};a.addToggle(g=>{var u;return g.setTooltip("Activate this rule").setValue((u=s.enabled)!=null?u:!1).onChange(async h=>{let w=this.plugin.settings.rules[t];w&&(w.enabled=h,l(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),l())})}),a.addExtraButton(g=>g.setIcon("arrow-up").setTooltip("Move rule up").setDisabled(t===0).onClick(async()=>{if(t===0)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),a.addExtraButton(g=>g.setIcon("arrow-down").setTooltip("Move rule down").setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let u=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let c=()=>{var F;let g=this.plugin.getRuleErrorForIndex(t),u=this.plugin.settings.rules[t],h=(F=u==null?void 0:u.matchType)!=null?F:"equals",w=M(h),E=u?V(u):!1;g?(n.classList.add("vault-organizer-rule-error"),n.classList.remove("vault-organizer-rule-warning"),n.textContent=`Invalid regular expression: ${g.message}`,n.style.display=""):w&&!E?(n.classList.add("vault-organizer-rule-warning"),n.classList.remove("vault-organizer-rule-error"),n.textContent="Value is required for contains/starts-with/ends-with rules.",n.style.display=""):(n.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),n.textContent="",n.style.display="none")},d;a.addText(g=>{d=g,g.setPlaceholder("key").setValue(s.key).onChange(u=>{let h=this.plugin.settings.rules[t];h&&(h.key=u,this.scheduleSaveOnly())})}),a.addExtraButton(g=>g.setIcon("list").setTooltip("Browse frontmatter keys").onClick(()=>{let u=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(u,h=>{let w=this.plugin.settings.rules[t];!w||!d||(d.setValue(h),w.key=h,this.scheduleSaveOnly())})}));let v;a.addText(g=>{v=g,g.setPlaceholder("value").setValue(s.value).onChange(u=>{let h=this.plugin.settings.rules[t];h&&(h.value=u,this.scheduleSaveOnly(),c())})}),a.addExtraButton(g=>g.setIcon("hashtag").setTooltip("Browse tags").onClick(()=>{let u=this.getAggregatedTags();this.openTagPicker(u,h=>{let w=this.plugin.settings.rules[t];if(!w||!v)return;let E=this.toggleTagValue(v.getValue(),h);v.setValue(E),w.value=E,this.scheduleSaveOnly()})})),a.addText(g=>g.setPlaceholder("destination folder (required)").setValue(s.destination).onChange(u=>{let h=this.plugin.settings.rules[t];h&&(h.destination=u,this.scheduleSaveOnly())}));let p,m,y=()=>{var h;let g=this.plugin.settings.rules[t],u=((h=g==null?void 0:g.matchType)!=null?h:"equals")==="regex";p&&(p.inputEl.toggleAttribute("disabled",!u),p.inputEl.disabled=!u,p.inputEl.style.display=u?"":"none"),m&&(m.toggleEl.style.display=u?"none":"")};a.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),ce.forEach(u=>g.addOption(u.value,u.label)),g.setValue(r).onChange(async u=>{var w;let h=this.plugin.settings.rules[t];h&&(h.matchType=u,u==="regex"?(h.isRegex=!0,h.flags=(w=h.flags)!=null?w:""):(delete h.isRegex,"flags"in h&&delete h.flags),y(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),y(),c())})}),a.addText(g=>{var u;p=g,g.setPlaceholder("flags").setValue((u=s.flags)!=null?u:"").onChange(h=>{let w=this.plugin.settings.rules[t];w&&w.matchType==="regex"&&(w.flags=h,this.scheduleSaveOnly())})}),y(),a.addToggle(g=>{var u;m=g,g.setTooltip("Case insensitive matching").setValue((u=s.caseInsensitive)!=null?u:!1).onChange(async h=>{let w=this.plugin.settings.rules[t];w&&(w.caseInsensitive=h,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),a.addToggle(g=>{var u;return g.setTooltip("Enable debug mode").setValue((u=s.debug)!=null?u:!1).onChange(async h=>{let w=this.plugin.settings.rules[t];w&&(w.debug=h,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),a.addButton(g=>g.setButtonText("Remove").onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),c(),l()}),new f.Setting(e).addButton(s=>s.setButtonText("Add Rule").onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new f.Setting(e).addButton(s=>s.setButtonText("Apply now").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(s=>s.setButtonText("Test All Rules").setTooltip("Preview what moves would be made without actually moving files").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new U(this.app,t,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,r)=>{var m,y;let a=t.querySelector(".vault-organizer-rule-message");if(!a)return;let n=this.plugin.settings.rules[r],l=(m=n==null?void 0:n.enabled)!=null?m:!1;t.classList.toggle("vault-organizer-rule-disabled",!l);let c=this.plugin.getRuleErrorForIndex(r),d=(y=n==null?void 0:n.matchType)!=null?y:"equals",v=M(d),p=n?V(n):!1;c?(a.classList.add("vault-organizer-rule-error"),a.classList.remove("vault-organizer-rule-warning"),a.textContent=`Invalid regular expression: ${c.message}`,a.style.display=""):v&&!p?(a.classList.add("vault-organizer-rule-warning"),a.classList.remove("vault-organizer-rule-error"),a.textContent="Value is required for contains/starts-with/ends-with rules.",a.style.display=""):(a.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),a.textContent="",a.style.display="none")})}},N=class extends f.FuzzySuggestModal{constructor(e,s,t){super(e);this.tags=s;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},q=class extends f.FuzzySuggestModal{constructor(e,s,t){super(e);this.keys=s;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},U=class extends f.Modal{constructor(e,s,t){super(e);this.results=s;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Test All Rules - Preview"});let s=this.results.filter(n=>n.newPath&&!n.error),t=this.results.filter(n=>n.error);if(s.length===0&&t.length===0)e.createEl("p",{text:"No files would be moved. All files are either already in the correct location or have no matching rules."});else{if(s.length){e.createEl("p",{text:`${s.length} file(s) would be moved:`});let n=e.createDiv({cls:"vault-organizer-test-results"});n.style.maxHeight="400px",n.style.overflowY="auto",n.style.marginTop="1em",s.forEach(l=>{var y,b;let c=n.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let d=c.createDiv();d.createEl("strong",{text:"File: "}),d.createSpan({text:l.file.basename});let v=c.createDiv();v.createEl("strong",{text:"From: "}),v.createSpan({text:l.currentPath});let p=c.createDiv();p.createEl("strong",{text:"To: "}),p.createSpan({text:l.newPath});let m=c.createDiv();if(m.createEl("strong",{text:"Rule: "}),m.createSpan({text:`Rule ${l.ruleIndex+1} (${((y=this.rules[l.ruleIndex])==null?void 0:y.key)||"unknown"})`}),(b=l.warnings)!=null&&b.length){let g=c.createDiv();g.createEl("strong",{text:"Warnings: "}),g.createSpan({text:l.warnings.join("; ")})}})}else e.createEl("p",{text:"No files would be moved. All matching files are already in the correct location."});if(t.length){e.createEl("h3",{text:"Skipped due to invalid destinations"});let n=e.createDiv({cls:"vault-organizer-test-results"});n.style.maxHeight="400px",n.style.overflowY="auto",n.style.marginTop="1em",t.forEach(l=>{var y,b,g,u;let c=n.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let d=c.createDiv();d.createEl("strong",{text:"File: "}),d.createSpan({text:l.file.basename});let v=c.createDiv();v.createEl("strong",{text:"From: "}),v.createSpan({text:l.currentPath});let p=c.createDiv();p.createEl("strong",{text:"Rule: "}),p.createSpan({text:`Rule ${l.ruleIndex+1} (${((y=this.rules[l.ruleIndex])==null?void 0:y.key)||"unknown"})`});let m=c.createDiv();if(m.createEl("strong",{text:"Reason: "}),m.createSpan({text:(g=(b=l.error)==null?void 0:b.getUserMessage())!=null?g:"Destination path is invalid and the move cannot be previewed."}),(u=l.warnings)!=null&&u.length){let h=c.createDiv();h.createEl("strong",{text:"Warnings: "}),h.createSpan({text:l.warnings.join("; ")})}})}}let r=e.createDiv({cls:"modal-button-container"});r.style.marginTop="1.5em",r.style.textAlign="right";let a=r.createEl("button",{text:"Close"});a.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},W=class extends f.Modal{constructor(e,s){super(e);this.plugin=s}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Move History"}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:"No move history yet."});else{e.createEl("p",{text:`Showing ${this.plugin.settings.moveHistory.length} of last ${this.plugin.settings.maxHistorySize} moves.`});let a=e.createDiv({cls:"vault-organizer-history-container"});a.style.maxHeight="500px",a.style.overflowY="auto",a.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((n,l)=>{let c=a.createDiv({cls:"vault-organizer-history-item"});c.style.marginBottom="1em",c.style.padding="0.8em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px",c.style.position="relative",l===0&&(c.style.backgroundColor="var(--background-secondary-alt)",c.style.borderColor="var(--interactive-accent)");let d=c.createDiv();d.style.marginBottom="0.5em",d.style.fontWeight="bold";let p=new Date(n.timestamp).toLocaleString();l===0&&d.createEl("span",{text:"\u{1F504} Most Recent: ",cls:"vault-organizer-recent-label"}),d.createSpan({text:n.fileName});let m=c.createDiv();m.style.fontSize="0.9em",m.style.color="var(--text-muted)",m.style.marginBottom="0.5em",m.textContent=`\u23F0 ${p}`;let y=c.createDiv();y.createEl("strong",{text:"From: "}),y.createSpan({text:n.fromPath});let b=c.createDiv();b.createEl("strong",{text:"To: "}),b.createSpan({text:n.toPath});let g=c.createDiv();if(g.createEl("strong",{text:"Rule: "}),g.createSpan({text:n.ruleKey||"(unknown)"}),l===0){let u=c.createDiv();u.style.marginTop="0.8em";let h=u.createEl("button",{text:"Undo This Move"});h.style.backgroundColor="var(--interactive-accent)",h.style.color="var(--text-on-accent)",h.style.padding="0.4em 0.8em",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let s=e.createDiv({cls:"modal-button-container"});s.style.marginTop="1.5em",s.style.textAlign="right";let t=s.createEl("button",{text:"Clear History"});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new f.Notice("Move history cleared."),this.close()};let r=s.createEl("button",{text:"Close"});r.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};
