/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var q=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var pe=Object.prototype.hasOwnProperty;var me=(s,i)=>{for(var e in i)q(s,e,{get:i[e],enumerable:!0})},Ee=(s,i,e,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of he(i))!pe.call(s,t)&&t!==e&&q(s,t,{get:()=>i[t],enumerable:!(n=de(i,t))||n.enumerable});return s};var fe=s=>Ee(q({},"__esModule",{value:!0}),s);var Ce={};me(Ce,{default:()=>Y});module.exports=fe(Ce);var R=require("obsidian");function ie(s,i){var l;let e=i[s.key];if(e==null)return!1;let n=Array.isArray(e),t=n?e:[e],a=(l=s.matchType)!=null?l:"equals";if(a==="regex"){if(!(s.value instanceof RegExp))return!1;let c=s.value;return t.some(h=>{let p=String(h);return c.lastIndex=0,c.test(p)})}let o=ve(String(s.value),n),r=a==="contains"||a==="starts-with"||a==="ends-with"?o.filter(c=>c.length>0):o;return r.length?t.some(c=>{let h=String(c);return r.some(p=>Te(h,p,a,s.caseInsensitive))}):!1}function X(s,i,e){var t;let n=e!=null?e:(t=this.app.metadataCache.getFileCache(s))==null?void 0:t.frontmatter;if(n)return i.find(a=>{var h;if(a.enabled===!1)return!1;let o={key:a.key,matchType:a.matchType,value:a.value,caseInsensitive:a.caseInsensitive},r=ie(o,n);if(!a.conditions||a.conditions.length===0)return r;let l=a.conditions.map(p=>ie(p,n));return((h=a.conditionOperator)!=null?h:"AND")==="AND"?r&&l.every(p=>p):r||l.some(p=>p)})}function ve(s,i){if(!i)return[s];let e=s.trim(),n=e.split(/\s+/).map(a=>a.trim()).filter(Boolean);if(!n.length)return[e];let t=new Set;return e&&t.add(e),n.forEach(a=>t.add(a)),Array.from(t)}function Te(s,i,e,n){let t=n?s.toLowerCase():s,a=n?i.toLowerCase():i;switch(e){case"contains":return t.includes(a);case"starts-with":return t.startsWith(a);case"ends-with":return t.endsWith(a);case"equals":default:return t===a}}function ye(s){var e;let i=(e=s.matchType)!=null?e:"equals";if(i==="regex"){let n=s.value instanceof RegExp?s.value.source:String(s.value),t=s.value instanceof RegExp?s.value.flags:"";return{key:s.key,matchType:i,value:n,isRegex:!0,flags:t,caseInsensitive:s.caseInsensitive}}return{key:s.key,matchType:i,value:String(s.value),caseInsensitive:s.caseInsensitive}}function ae(s){return s.map(i=>{var t,a;let e=(t=i.matchType)!=null?t:"equals",n={key:i.key,matchType:e,value:e==="regex"&&i.value instanceof RegExp?i.value.source:String(i.value),destination:i.destination,enabled:(a=i.enabled)!=null?a:!1,debug:i.debug,caseInsensitive:i.caseInsensitive,conditionOperator:i.conditionOperator,conflictResolution:i.conflictResolution};return e==="regex"&&(n.isRegex=!0,n.flags=i.value instanceof RegExp?i.value.flags:""),i.conditions&&i.conditions.length>0&&(n.conditions=i.conditions.map(ye)),n})}function K(s){return s==="contains"||s==="starts-with"||s==="ends-with"}function j(s){return typeof s.value=="string"&&s.value.trim().length>0}function Se(s){var e;let i=(e=s.matchType)!=null?e:s.isRegex?"regex":"equals";if(i==="regex")try{let n=new RegExp(s.value,s.flags);return{key:s.key,matchType:i,value:n,caseInsensitive:s.caseInsensitive}}catch(n){console.warn(`[Vault Organizer] Failed to deserialize regex condition for key "${s.key}":`,n);return}return{key:s.key,matchType:i,value:s.value,caseInsensitive:s.caseInsensitive}}function re(s=[]){let i=[],e=[],n=[];return s.forEach((t,a)=>{var l,c,h;let o=(l=t.matchType)!=null?l:t.isRegex?"regex":"equals",r;if(t.conditions&&t.conditions.length>0){let p=t.conditions.map(Se).filter(m=>m!==void 0);p.length>0&&(r=p)}if(o==="regex")try{let p=new RegExp(t.value,t.flags),m={key:t.key,matchType:o,value:p,destination:t.destination,enabled:(c=t.enabled)!=null?c:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:r,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};i.push(m),e.push({index:a,rule:m})}catch(p){let m=p instanceof Error?p.message:String(p),T=t.destination?` (destination: "${t.destination}")`:"",S=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${T}: ${m}. Rule will be ignored.`;console.warn(S),n.push({index:a,message:m,rule:{...t,matchType:o},cause:p})}else{let p={key:t.key,matchType:o,value:t.value,destination:t.destination,enabled:(h=t.enabled)!=null?h:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:r,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};i.push(p),e.push({index:a,rule:p})}}),{rules:i,successes:e,errors:n}}var P=class extends Error{constructor(i){super(i),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},Q=class extends P{constructor(e,n,t){let a=_(n);super(`Permission denied: Cannot ${a} "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${_(this.operation)} "${this.filePath}". Check file permissions and try again.`}},L=class extends P{constructor(e,n,t,a,o){let r=_(a),l=n?`Cannot ${r} "${e}" to "${n}"`:`Cannot ${r} "${e}"`;super(`File conflict: ${l} - file ${t}`);this.sourcePath=e;this.destinationPath=n;this.conflictType=t;this.operation=a;this.originalError=o}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},n=_(this.operation);return`${this.destinationPath?`Cannot ${n} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${n} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},O=class extends P{constructor(e,n,t){super(`Invalid path "${e}": ${n}${t?` - ${t}`:""}`);this.path=e;this.reason=n;this.details=t}getUserMessage(){let n={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${n}${t}.`}},Z=class extends P{constructor(e,n,t){let a=_(n);super(`File operation failed: ${a} on "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){var t;let e=_(this.operation),n=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${n}.`}};function D(s,i,e,n){let t=s instanceof Error?s:new Error(String(s)),a=t.message.toLowerCase();return a.includes("permission")||a.includes("eacces")||a.includes("eperm")||a.includes("access denied")?new Q(i,e,t):a.includes("already exists")||a.includes("eexist")||a.includes("file exists")?new L(i,n||i,"exists",e,t):a.includes("locked")||a.includes("ebusy")?new L(i,n||i,"locked",e,t):a.includes("in use")||a.includes("being used")||a.includes("etxtbsy")?new L(i,n||i,"in-use",e,t):a.includes("invalid path")||a.includes("invalid character")||a.includes("einval")?new O(n||i,"invalid-characters",t.message):a.includes("path too long")||a.includes("enametoolong")?new O(n||i,"too-long",t.message):new Z(i,e,t)}function _(s){return s.replace(/-/g," ")}var oe=require("obsidian");var J={windows:260,unix:4096,component:255},Re=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),Oe=/[<>:"|?*\x00-\x1F]/,be=/^([A-Za-z]:[\\/]|\/)/,xe=/(^|[\\/])\.\.($|[\\/])/,we=/\/{2,}|\\{2,}/;function M(s,i={}){let{allowEmpty:e=!1,allowAbsolute:n=!1,maxLength:t=J.windows,checkReservedNames:a=!0}=i,o=[];if(!s||s.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:o}:{valid:!1,error:new O(s,"empty")};if(be.test(s)&&!n)return{valid:!1,error:new O(s,"absolute","Use relative paths within the vault")};if(xe.test(s))return{valid:!1,error:new O(s,"traversal",'Paths cannot contain ".." segments')};let r=(0,oe.normalizePath)(s);we.test(r)&&(r=r.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),o.push("Multiple consecutive slashes were normalized")),r=r.trim().replace(/^\/+|\/+$/g,"");let l=r.match(Oe);if(l)return{valid:!1,error:new O(s,"invalid-characters",`Contains invalid character: "${l[0]}"`)};if(r.length>t)return{valid:!1,error:new O(s,"too-long",`Path length (${r.length}) exceeds maximum (${t})`)};let c=r.split("/").filter(Boolean);for(let h of c){if(h.length>J.component)return{valid:!1,error:new O(s,"too-long",`Path component "${h}" exceeds ${J.component} characters`)};if(a){let p=h.split(".")[0].toUpperCase();if(Re.has(p))return{valid:!1,error:new O(s,"reserved-name",`"${h}" is a reserved system name on Windows`)}}if(h.endsWith(".")||h.endsWith(" "))return{valid:!1,error:new O(s,"invalid-characters",`Path component "${h}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:r,warnings:o.length>0?o:void 0}}function U(s){return M(s,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var k={REORGANIZE:{name:"Reorganize notes based on frontmatter rules",description:"Apply all configured rules to reorganize vault files"},UNDO:{name:"Undo last automatic move",description:"Revert the most recent file move"},VIEW_HISTORY:{name:"View move history",description:"Show all recent file moves and undo options"}},f={RULE_NAME:"Frontmatter rule",RULE_DESCRIPTION:"Move files to destination folder based on frontmatter matching",EXCLUSION_PATTERNS_NAME:"Exclusion Patterns",EXCLUSION_PATTERNS_DESCRIPTION:"Files and folders matching these patterns will not be automatically organized",TOOLTIPS:{ACTIVATE_RULE:"Activate this rule",MOVE_UP:"Move rule up",MOVE_DOWN:"Move rule down",BROWSE_FRONTMATTER:"Browse frontmatter keys",BROWSE_TAGS:"Browse tags",CASE_INSENSITIVE:"Case insensitive matching",DEBUG_MODE:"Enable debug mode",TEST_ALL_RULES:"Preview what moves would be made without actually moving files",CONFLICT_RESOLUTION:"How to handle file conflicts at destination",CONDITION_OPERATOR:"How to combine multiple conditions (AND/OR)",ADD_CONDITION:"Add another condition to this rule",EXCLUSION_PATTERN:"Glob pattern (e.g., Templates/**, *.excalidraw)"},PLACEHOLDERS:{KEY:"key",VALUE:"value",DESTINATION:"destination folder (supports {variables})",FLAGS:"flags",EXCLUSION_PATTERN:"e.g., Templates/**, Archive/**"},BUTTONS:{REMOVE:"Remove",ADD_RULE:"Add Rule",APPLY_NOW:"Apply now",TEST_ALL_RULES:"Test All Rules",ADD_CONDITION:"+",REMOVE_CONDITION:"Remove Condition",ADD_EXCLUSION:"Add Pattern"},LABELS:{CONFLICT_RESOLUTION:"On Conflict:",CONDITION_OPERATOR:"Combine:",CONDITIONS_SECTION:"Additional Conditions"},WARNINGS:{INVALID_REGEX:s=>`Invalid regular expression: ${s}`,VALUE_REQUIRED:"Value is required for contains/starts-with/ends-with rules."}},v={TEST_ALL_RULES:{TITLE:"Test All Rules - Preview",NO_MOVES_OVERALL:"No files would be moved. All files are either already in the correct location or have no matching rules.",NO_MOVES_ALREADY_CORRECT:"No files would be moved. All matching files are already in the correct location.",FILES_WOULD_MOVE:s=>`${s} file(s) would be moved:`,SKIPPED_SECTION:"Skipped due to invalid destinations",INVALID_DESTINATION_WARNING:"Destination path is invalid and the move cannot be previewed.",LABELS:{FILE:"File:",FROM:"From:",TO:"To:",RULE:"Rule:",WARNINGS:"Warnings:"},BUTTONS:{CLOSE:"Close"}},MOVE_HISTORY:{TITLE:"Move History",NO_HISTORY:"No move history yet.",SHOWING_COUNT:(s,i)=>`Showing ${s} of last ${i} moves.`,MOST_RECENT_PREFIX:"\u{1F504} Most Recent: ",TIME_PREFIX:s=>`\u23F0 ${s}`,LABELS:{FROM:"From:",TO:"To:",RULE:"Rule:"},BUTTONS:{UNDO:"Undo This Move",CLEAR_HISTORY:"Clear History",CLOSE:"Close"},NOTICES:{HISTORY_CLEARED:"Move history cleared."}}},A={UNDO:{NO_MOVES:"No moves to undo.",FILE_NOT_EXISTS:s=>`Cannot undo: File no longer exists at ${s}`,NOT_A_FILE:s=>`Cannot undo: ${s} is not a file.`,DESTINATION_EXISTS:s=>`Cannot undo: A file already exists at ${s}`,SUCCESS:(s,i)=>`Undone: Moved ${s} back to ${i}`},DEBUG:{EMPTY_DESTINATION:(s,i)=>`DEBUG: ${s} would not be moved because destination is empty in ${i}.`,WOULD_MOVE:(s,i,e)=>`DEBUG: ${s} would be moved to ${i}/${e}`},REGEX_PARSE_ERROR:(s,i)=>`Failed to parse regular expression for rule "${s}": ${i}`},F={equals:"Equals",contains:"Contains","starts-with":"Starts with","ends-with":"Ends with",regex:"Regex"};var ee={rules:[],moveHistory:[],maxHistorySize:50,excludePatterns:[]},le=[{value:"equals",label:F.equals},{value:"contains",label:F.contains},{value:"starts-with",label:F["starts-with"]},{value:"ends-with",label:F["ends-with"]},{value:"regex",label:F.regex}];function z(s){var n,t,a,o,r,l;let i=(n=s.matchType)!=null?n:s.isRegex?"regex":"equals",e={...s,matchType:i,key:(t=s.key)!=null?t:"",value:(a=s.value)!=null?a:"",destination:(o=s.destination)!=null?o:"",enabled:(r=s.enabled)!=null?r:!1};return i==="regex"?(e.isRegex=!0,e.flags=(l=s.flags)!=null?l:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var b=require("obsidian");var C=require("obsidian");var $=class extends C.FuzzySuggestModal{constructor(e,n,t){super(e);this.tags=n;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},B=class extends C.FuzzySuggestModal{constructor(e,n,t){super(e);this.keys=n;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},H=class extends C.Modal{constructor(e,n,t){super(e);this.results=n;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:v.TEST_ALL_RULES.TITLE});let n=this.results.filter(r=>r.newPath&&!r.error),t=this.results.filter(r=>r.error);if(n.length===0&&t.length===0)e.createEl("p",{text:v.TEST_ALL_RULES.NO_MOVES_OVERALL});else{if(n.length){e.createEl("p",{text:v.TEST_ALL_RULES.FILES_WOULD_MOVE(n.length)});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",n.forEach(l=>{var S,y;let c=r.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let h=c.createDiv();h.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:l.file.basename});let p=c.createDiv();p.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:l.currentPath});let m=c.createDiv();m.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.TO}),m.createSpan({text:l.newPath||"(unknown)"});let T=c.createDiv();if(T.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.RULE}),T.createSpan({text:`Rule ${l.ruleIndex+1} (${((S=this.rules[l.ruleIndex])==null?void 0:S.key)||"unknown"})`}),(y=l.warnings)!=null&&y.length){let g=c.createDiv();g.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.WARNINGS}),g.createSpan({text:l.warnings.join("; ")})}})}else e.createEl("p",{text:v.TEST_ALL_RULES.NO_MOVES_ALREADY_CORRECT});if(t.length){e.createEl("h3",{text:v.TEST_ALL_RULES.SKIPPED_SECTION});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",t.forEach(l=>{var S,y,g,d;let c=r.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let h=c.createDiv();h.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:l.file.basename});let p=c.createDiv();p.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:l.currentPath});let m=c.createDiv();m.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.RULE}),m.createSpan({text:`Rule ${l.ruleIndex+1} (${((S=this.rules[l.ruleIndex])==null?void 0:S.key)||"unknown"})`});let T=c.createDiv();if(T.createEl("strong",{text:"Reason: "}),T.createSpan({text:(g=(y=l.error)==null?void 0:y.getUserMessage())!=null?g:v.TEST_ALL_RULES.INVALID_DESTINATION_WARNING}),(d=l.warnings)!=null&&d.length){let u=c.createDiv();u.createEl("strong",{text:v.TEST_ALL_RULES.LABELS.WARNINGS}),u.createSpan({text:l.warnings.join("; ")})}})}}let a=e.createDiv({cls:"modal-button-container"});a.style.marginTop="1.5em",a.style.textAlign="right";let o=a.createEl("button",{text:v.TEST_ALL_RULES.BUTTONS.CLOSE});o.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},W=class extends C.Modal{constructor(e,n){super(e);this.plugin=n}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:v.MOVE_HISTORY.TITLE}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:v.MOVE_HISTORY.NO_HISTORY});else{e.createEl("p",{text:v.MOVE_HISTORY.SHOWING_COUNT(this.plugin.settings.moveHistory.length,this.plugin.settings.maxHistorySize)});let o=e.createDiv({cls:"vault-organizer-history-container"});o.style.maxHeight="500px",o.style.overflowY="auto",o.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((r,l)=>{let c=o.createDiv({cls:"vault-organizer-history-item"});c.style.marginBottom="1em",c.style.padding="0.8em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px",c.style.position="relative",l===0&&(c.style.backgroundColor="var(--background-secondary-alt)",c.style.borderColor="var(--interactive-accent)");let h=c.createDiv();h.style.marginBottom="0.5em",h.style.fontWeight="bold";let m=new Date(r.timestamp).toLocaleString();l===0&&h.createEl("span",{text:v.MOVE_HISTORY.MOST_RECENT_PREFIX,cls:"vault-organizer-recent-label"}),h.createSpan({text:r.fileName});let T=c.createDiv();T.style.fontSize="0.9em",T.style.color="var(--text-muted)",T.style.marginBottom="0.5em",T.textContent=v.MOVE_HISTORY.TIME_PREFIX(m);let S=c.createDiv();S.createEl("strong",{text:v.MOVE_HISTORY.LABELS.FROM}),S.createSpan({text:r.fromPath});let y=c.createDiv();y.createEl("strong",{text:v.MOVE_HISTORY.LABELS.TO}),y.createSpan({text:r.toPath});let g=c.createDiv();if(g.createEl("strong",{text:v.MOVE_HISTORY.LABELS.RULE}),g.createSpan({text:r.ruleKey||"(unknown)"}),l===0){let d=c.createDiv();d.style.marginTop="0.8em";let u=d.createEl("button",{text:v.MOVE_HISTORY.BUTTONS.UNDO});u.style.backgroundColor="var(--interactive-accent)",u.style.color="var(--text-on-accent)",u.style.padding="0.4em 0.8em",u.style.border="none",u.style.borderRadius="4px",u.style.cursor="pointer",u.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="1.5em",n.style.textAlign="right";let t=n.createEl("button",{text:v.MOVE_HISTORY.BUTTONS.CLEAR_HISTORY});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new C.Notice(v.MOVE_HISTORY.NOTICES.HISTORY_CLEARED),this.close()};let a=n.createEl("button",{text:v.MOVE_HISTORY.BUTTONS.CLOSE});a.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};var Ae=300,Ie=1e3,G=class extends b.PluginSettingTab{constructor(e,n){super(e,n);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=n,this.debouncedSaveOnly=(0,b.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},Ae),this.debouncedRefreshMetadata=(0,b.debounce)(()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()},Ie),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.debouncedRefreshMetadata()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,a,o;let e=new Set;((o=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?o:[]).forEach(r=>{let l=this.plugin.app.metadataCache.getFileCache(r);if(!l)return;let c=(0,b.getAllTags)(l);c&&c.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((r,l)=>r.localeCompare(l))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,a,o;let e=new Set;((o=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?o:[]).forEach(r=>{let l=this.plugin.app.metadataCache.getFileCache(r),c=l==null?void 0:l.frontmatter;c&&Object.keys(c).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((r,l)=>r.localeCompare(l))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,n){if(!e.length)return;new $(this.app,e,n).open()}openFrontmatterKeyPicker(e,n){if(!e.length)return;new B(this.app,e,n).open()}toggleTagValue(e,n){let t=e.split(/\s+/).filter(Boolean);return(t.includes(n)?t.filter(r=>r!==n):[...t,n]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(z),this.plugin.settings.rules.forEach((n,t)=>{var y;let a=(y=n.matchType)!=null?y:"equals",o=new b.Setting(e).setName(`${f.RULE_NAME} ${t+1}`).setDesc(f.RULE_DESCRIPTION);o.settingEl.classList.add("setting-item");let r=document.createElement("div");r.classList.add("vault-organizer-rule-message"),r.style.display="none",o.settingEl.appendChild(r);let l=()=>{var u;let g=this.plugin.settings.rules[t],d=(u=g==null?void 0:g.enabled)!=null?u:!1;o.settingEl.classList.toggle("vault-organizer-rule-disabled",!d)};o.addToggle(g=>{var d;return g.setTooltip(f.TOOLTIPS.ACTIVATE_RULE).setValue((d=n.enabled)!=null?d:!1).onChange(async u=>{let E=this.plugin.settings.rules[t];E&&(E.enabled=u,l(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),l())})}),o.addExtraButton(g=>g.setIcon("arrow-up").setTooltip(f.TOOLTIPS.MOVE_UP).setDisabled(t===0).onClick(async()=>{if(t===0)return;let d=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),o.addExtraButton(g=>g.setIcon("arrow-down").setTooltip(f.TOOLTIPS.MOVE_DOWN).setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let d=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let c=()=>{var x;let g=this.plugin.getRuleErrorForIndex(t),d=this.plugin.settings.rules[t],u=(x=d==null?void 0:d.matchType)!=null?x:"equals",E=K(u),w=d?j(d):!1;g?(r.classList.add("vault-organizer-rule-error"),r.classList.remove("vault-organizer-rule-warning"),r.textContent=f.WARNINGS.INVALID_REGEX(g.message),r.style.display=""):E&&!w?(r.classList.add("vault-organizer-rule-warning"),r.classList.remove("vault-organizer-rule-error"),r.textContent=f.WARNINGS.VALUE_REQUIRED,r.style.display=""):(r.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),r.textContent="",r.style.display="none")},h;o.addText(g=>{h=g,g.setPlaceholder(f.PLACEHOLDERS.KEY).setValue(n.key).onChange(d=>{let u=this.plugin.settings.rules[t];u&&(u.key=d,this.scheduleSaveOnly())})}),o.addExtraButton(g=>g.setIcon("list").setTooltip(f.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let d=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(d,u=>{let E=this.plugin.settings.rules[t];!E||!h||(h.setValue(u),E.key=u,this.scheduleSaveOnly())})}));let p;o.addText(g=>{p=g,g.setPlaceholder(f.PLACEHOLDERS.VALUE).setValue(n.value).onChange(d=>{let u=this.plugin.settings.rules[t];u&&(u.value=d,this.scheduleSaveOnly(),c())})}),o.addExtraButton(g=>g.setIcon("hashtag").setTooltip(f.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let d=this.getAggregatedTags();this.openTagPicker(d,u=>{let E=this.plugin.settings.rules[t];if(!E||!p)return;let w=this.toggleTagValue(p.getValue(),u);p.setValue(w),E.value=w,this.scheduleSaveOnly()})})),o.addText(g=>g.setPlaceholder(f.PLACEHOLDERS.DESTINATION).setValue(n.destination).onChange(d=>{let u=this.plugin.settings.rules[t];u&&(u.destination=d,this.scheduleSaveOnly())}));let m,T,S=()=>{var u;let g=this.plugin.settings.rules[t],d=((u=g==null?void 0:g.matchType)!=null?u:"equals")==="regex";m&&(m.inputEl.toggleAttribute("disabled",!d),m.inputEl.disabled=!d,m.inputEl.style.display=d?"":"none"),T&&(T.toggleEl.style.display=d?"none":"")};o.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),le.forEach(d=>g.addOption(d.value,d.label)),g.setValue(a).onChange(async d=>{var E;let u=this.plugin.settings.rules[t];u&&(u.matchType=d,d==="regex"?(u.isRegex=!0,u.flags=(E=u.flags)!=null?E:""):(delete u.isRegex,"flags"in u&&delete u.flags),S(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),S(),c())})}),o.addDropdown(g=>{var d;g.selectEl.setAttribute("aria-label","Conflict resolution"),g.selectEl.setAttribute("title",f.TOOLTIPS.CONFLICT_RESOLUTION),g.addOption("fail","Fail"),g.addOption("skip","Skip"),g.addOption("append-number","Add number"),g.addOption("append-timestamp","Add timestamp"),g.setValue((d=n.conflictResolution)!=null?d:"fail").onChange(u=>{let E=this.plugin.settings.rules[t];E&&(E.conflictResolution=u,this.scheduleSaveOnly())})}),o.addText(g=>{var d;m=g,g.setPlaceholder(f.PLACEHOLDERS.FLAGS).setValue((d=n.flags)!=null?d:"").onChange(u=>{let E=this.plugin.settings.rules[t];E&&E.matchType==="regex"&&(E.flags=u,this.scheduleSaveOnly())})}),S(),o.addToggle(g=>{var d;T=g,g.setTooltip(f.TOOLTIPS.CASE_INSENSITIVE).setValue((d=n.caseInsensitive)!=null?d:!1).onChange(async u=>{let E=this.plugin.settings.rules[t];E&&(E.caseInsensitive=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),o.addToggle(g=>{var d;return g.setTooltip(f.TOOLTIPS.DEBUG_MODE).setValue((d=n.debug)!=null?d:!1).onChange(async u=>{let E=this.plugin.settings.rules[t];E&&(E.debug=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),o.addButton(g=>g.setButtonText(f.BUTTONS.REMOVE).onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),c(),l()}),new b.Setting(e).addButton(n=>n.setButtonText(f.BUTTONS.ADD_RULE).onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new b.Setting(e).addButton(n=>n.setButtonText(f.BUTTONS.APPLY_NOW).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(n=>n.setButtonText(f.BUTTONS.TEST_ALL_RULES).setTooltip(f.TOOLTIPS.TEST_ALL_RULES).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new H(this.app,t,this.plugin.settings.rules).open()})),e.createEl("h2",{text:f.EXCLUSION_PATTERNS_NAME}),e.createEl("p",{text:f.EXCLUSION_PATTERNS_DESCRIPTION}),this.plugin.settings.excludePatterns.forEach((n,t)=>{new b.Setting(e).addText(o=>o.setPlaceholder(f.PLACEHOLDERS.EXCLUSION_PATTERN).setValue(n).onChange(r=>{this.plugin.settings.excludePatterns[t]=r,this.scheduleSaveOnly()})).addButton(o=>o.setButtonText(f.BUTTONS.REMOVE).onClick(async()=>{this.plugin.settings.excludePatterns.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})).settingEl.classList.add("vault-organizer-exclusion-pattern")}),new b.Setting(e).addButton(n=>n.setButtonText(f.BUTTONS.ADD_EXCLUSION).onClick(async()=>{this.plugin.settings.excludePatterns.push(""),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,a)=>{var T,S;let o=t.querySelector(".vault-organizer-rule-message");if(!o)return;let r=this.plugin.settings.rules[a],l=(T=r==null?void 0:r.enabled)!=null?T:!1;t.classList.toggle("vault-organizer-rule-disabled",!l);let c=this.plugin.getRuleErrorForIndex(a),h=(S=r==null?void 0:r.matchType)!=null?S:"equals",p=K(h),m=r?j(r):!1;c?(o.classList.add("vault-organizer-rule-error"),o.classList.remove("vault-organizer-rule-warning"),o.textContent=f.WARNINGS.INVALID_REGEX(c.message),o.style.display=""):p&&!m?(o.classList.add("vault-organizer-rule-warning"),o.classList.remove("vault-organizer-rule-error"),o.textContent=f.WARNINGS.VALUE_REQUIRED,o.style.display=""):(o.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),o.textContent="",o.style.display="none")})}};function Le(s){let i=/\{([^}]+)\}/g,e=[],n;for(;(n=i.exec(s))!==null;)e.push(n[1]);return e}function ce(s){if(s==null)return"";let i=String(s);return i=i.replace(/[<>:"|?*]/g,""),i=i.replace(/\\/g,"-"),i=i.replace(/\//g,"-"),i=i.trim().replace(/^\.+|\.+$/g,""),i=i.replace(/\s+/g," "),i}function te(s,i){let e=Le(s);if(e.length===0)return{substitutedPath:s,substituted:[],missing:[],hasVariables:!1};let n=[],t=[],a=s;for(let o of e){let r=i==null?void 0:i[o];if(r==null)t.push(o),a=a.replace(new RegExp(`\\{${ue(o)}\\}`,"g"),"");else{n.push(o);let l;Array.isArray(r)?l=r.map(c=>ce(c)).filter(Boolean).join(","):l=ce(r),a=a.replace(new RegExp(`\\{${ue(o)}\\}`,"g"),l)}}return a=a.replace(/\/+/g,"/").replace(/^\/+|\/+$/g,""),a=a.split("/").filter(Boolean).join("/"),{substitutedPath:a,substituted:n,missing:t,hasVariables:!0}}function ue(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Pe(s){let i="^",e=0;for(;e<s.length;){let n=s[e];if(n==="*")s[e+1]==="*"?(i+=".*",e+=2):(i+="[^/]*",e+=1);else if(n==="?")i+="[^/]",e+=1;else if(n==="["){let t=s.indexOf("]",e);t===-1?(i+="\\[",e+=1):(i+=s.substring(e,t+1),e=t+1)}else/[.+^${}()|\\]/.test(n)?(i+="\\"+n,e+=1):(i+=n,e+=1)}return i+="$",new RegExp(i)}function ne(s,i){if(!i||i.length===0)return!1;let e=s.replace(/\\/g,"/");for(let n of i){if(!n||n.trim()==="")continue;let t=n.trim().replace(/\\/g,"/");if(Pe(t).test(e))return!0;let o=t.replace(/\/$/,"");if(e.startsWith(o+"/"))return!0}return!1}var Y=class extends R.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[];this.batchOperationInProgress=!1}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async n=>{!(n instanceof R.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async n=>{!(n instanceof R.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:k.REORGANIZE.name,callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:k.UNDO.name,callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:k.VIEW_HISTORY.name,callback:()=>{new W(this.app,this).open()}}),this.ruleSettingTab=new G(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),n=Array.isArray(e==null?void 0:e.rules)?e.rules.map(z):[];this.settings={...ee,...e,rules:n,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:ee.maxHistorySize,excludePatterns:Array.isArray(e==null?void 0:e.excludePatterns)?e.excludePatterns:[]}}async saveSettings(){this.settings.rules=this.settings.rules.map(z),!this.batchOperationInProgress&&await this.saveData(this.settings)}async withBatchOperation(e){if(this.batchOperationInProgress)return console.warn("[Vault Organizer] Nested batch operations are not supported. Using existing batch context."),await e();this.batchOperationInProgress=!0;try{return await e()}finally{this.batchOperationInProgress=!1,await this.saveData(this.settings)}}updateRulesFromSettings(){let{rules:e,successes:n,errors:t}=re(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:n,errors:t}}async persistSettingsAndRefreshRules(){var o;let{successes:e,errors:n}=this.updateRulesFromSettings(),t=ae(e.map(r=>r.rule)),a=[...this.settings.rules];e.forEach((r,l)=>{a[r.index]=t[l]}),this.settings.rules=a,await this.saveSettings(),n.length&&n.forEach(r=>{let l=r.rule.key||"(unnamed rule)",c=A.REGEX_PARSE_ERROR(l,r.message);new R.Notice(c)}),(o=this.ruleSettingTab)==null||o.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(n=>n.index===e)}async recordMove(e,n,t,a,o=!1){if(!e||!n||!t)throw new Error("Invalid move parameters: fromPath, toPath, and fileName are required");let r={timestamp:Date.now(),fileName:t,fromPath:e,toPath:n,ruleKey:a};this.settings.moveHistory.unshift(r),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),o||await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new R.Notice(A.UNDO.NO_MOVES);return}let e=this.settings.moveHistory[0],n=this.app.vault.getAbstractFileByPath(e.toPath);if(!n){new R.Notice(A.UNDO.FILE_NOT_EXISTS(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(n instanceof R.TFile)){new R.Notice(A.UNDO.NOT_A_FILE(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new R.Notice(A.UNDO.DESTINATION_EXISTS(e.fromPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let a=e.fromPath.lastIndexOf("/");if(a>0){let o=e.fromPath.substring(0,a);await this.ensureFolderExists(o)}await this.app.fileManager.renameFile(n,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new R.Notice(A.UNDO.SUCCESS(e.fileName,e.fromPath))}catch(a){let o=D(a,e.toPath,"move",e.fromPath);new R.Notice(o.getUserMessage()),console.error("[Vault Organizer] Undo failed:",a)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let n=M(e,{allowEmpty:!1,allowAbsolute:!1});if(!n.valid||!n.sanitizedPath)throw n.error||new Error("Path validation failed");let a=n.sanitizedPath.split("/").filter(Boolean);if(!a.length)return;let o="";for(let r of a){o=o?`${o}/${r}`:r;let l=this.app.vault.getAbstractFileByPath(o);if(l){if(l instanceof R.TFile)throw new L(o,void 0,"exists","create-folder");continue}try{await this.app.vault.createFolder(o)}catch(c){throw D(c,o,"create-folder")}}}generateUniqueFilename(e,n,t){if(t==="append-timestamp"){let r=Date.now();return`${e}-${r}${n}`}let a=1,o=`${e}-${a}${n}`;for(;this.app.vault.getAbstractFileByPath(o);)a++,o=`${e}-${a}${n}`;return o}async applyRulesToFile(e,n=!1){var a;let t;try{if(ne(e.path,this.settings.excludePatterns))return;let o=this.app.metadataCache.getFileCache(e),r=o==null?void 0:o.frontmatter;if(!r)return;let l=X.call(this,e,this.rules,r);if(!l)return;let c=l.destination.trim();if(!c){if(l.debug){let u=this.app.vault.getName();new R.Notice(A.DEBUG.EMPTY_DESTINATION(e.basename,u))}return}let h=te(c,r),p=h.substitutedPath;l.debug&&h.missing.length>0&&new R.Notice(`DEBUG: Missing variables in destination: ${h.missing.join(", ")}`);let m=U(p);if(!m.valid||!m.sanitizedPath)throw m.error||new Error("Destination path validation failed");let T=m.sanitizedPath,S=M(`${T}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!S.valid||!S.sanitizedPath)throw S.error||new Error("Full path validation failed");let y=S.sanitizedPath;if(t=y,e.path===y)return;if(l.debug){let u=this.app.vault.getName();new R.Notice(A.DEBUG.WOULD_MOVE(e.basename,u,T));return}if(await this.ensureFolderExists(T),this.app.vault.getAbstractFileByPath(y)){let u=(a=l.conflictResolution)!=null?a:"fail";if(u==="skip")return;if(u==="append-number"||u==="append-timestamp"){let E=e.name.lastIndexOf("."),w=E>0?e.name.substring(0,E):e.name,x=E>0?e.name.substring(E):"",V=`${T}/${w}`;y=this.generateUniqueFilename(V,x,u),t=y}else throw new L(y,e.path,"exists","move")}let d=e.path;try{await this.app.fileManager.renameFile(e,y),await this.recordMove(d,y,e.name,l.key,n)}catch(u){throw D(u,e.path,"move",y)}}catch(o){if(o instanceof P)new R.Notice(o.getUserMessage()),console.error(`[Vault Organizer] ${o.name}:`,o.message,o);else{let r=D(o,e.path,"move",t);new R.Notice(r.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",o)}}}async reorganizeAllMarkdownFiles(){var n,t;let e=(t=(n=this.app.vault).getMarkdownFiles)==null?void 0:t.call(n);e!=null&&e.length&&await this.withBatchOperation(async()=>{for(let a of e)await this.applyRulesToFile(a,!0)})}testAllRules(){var t,a,o,r,l,c,h,p;let e=((a=(t=this.app.vault).getMarkdownFiles)==null?void 0:a.call(t))||[],n=[];for(let m of e){if(ne(m.path,this.settings.excludePatterns))continue;let T=this.app.metadataCache.getFileCache(m),S=T==null?void 0:T.frontmatter;if(!S)continue;let y=this.rules.findIndex(I=>I.enabled===!1?!1:X.call(this,m,[I],S));if(y===-1)continue;let d=this.rules[y].destination.trim();if(!d)continue;let u=te(d,S),E=u.substitutedPath,w=u.missing.length>0?[`Missing variables: ${u.missing.join(", ")}`]:[],x=U(E);if(!x.valid){n.push({file:m,currentPath:m.path,ruleIndex:y,error:x.error,warnings:[...w,...(o=x.warnings)!=null?o:[]]});continue}let V=(r=x.sanitizedPath)!=null?r:"",ge=V?`${V}/${m.name}`:m.name,N=M(ge,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!N.valid||!N.sanitizedPath){let I=[...w,...(l=x.warnings)!=null?l:[],...(c=N.warnings)!=null?c:[]];n.push({file:m,currentPath:m.path,ruleIndex:y,error:N.error,warnings:I.length?I:void 0});continue}let se=N.sanitizedPath;if(m.path!==se){let I=[...w,...(h=x.warnings)!=null?h:[],...(p=N.warnings)!=null?p:[]];n.push({file:m,currentPath:m.path,newPath:se,ruleIndex:y,warnings:I.length?I:void 0})}}return n}};
