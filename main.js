/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var q=Object.defineProperty;var de=Object.getOwnPropertyDescriptor;var he=Object.getOwnPropertyNames;var pe=Object.prototype.hasOwnProperty;var me=(s,i)=>{for(var e in i)q(s,e,{get:i[e],enumerable:!0})},Ee=(s,i,e,n)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of he(i))!pe.call(s,t)&&t!==e&&q(s,t,{get:()=>i[t],enumerable:!(n=de(i,t))||n.enumerable});return s};var fe=s=>Ee(q({},"__esModule",{value:!0}),s);var Ce={};me(Ce,{default:()=>Y});module.exports=fe(Ce);var S=require("obsidian");function ie(s,i){var l;let e=i[s.key];if(e==null)return!1;let n=Array.isArray(e),t=n?e:[e],r=(l=s.matchType)!=null?l:"equals";if(r==="regex"){if(!(s.value instanceof RegExp))return!1;let c=s.value;return t.some(h=>{let p=String(h);return c.lastIndex=0,c.test(p)})}let o=ve(String(s.value),n),a=r==="contains"||r==="starts-with"||r==="ends-with"?o.filter(c=>c.length>0):o;return a.length?t.some(c=>{let h=String(c);return a.some(p=>Te(h,p,r,s.caseInsensitive))}):!1}function X(s,i,e){var t;let n=e!=null?e:(t=this.app.metadataCache.getFileCache(s))==null?void 0:t.frontmatter;if(n)return i.find(r=>{var h;if(r.enabled===!1)return!1;let o={key:r.key,matchType:r.matchType,value:r.value,caseInsensitive:r.caseInsensitive},a=ie(o,n);if(!r.conditions||r.conditions.length===0)return a;let l=r.conditions.map(p=>ie(p,n));return((h=r.conditionOperator)!=null?h:"AND")==="AND"?a&&l.every(p=>p):a||l.some(p=>p)})}function ve(s,i){if(!i)return[s];let e=s.trim(),n=e.split(/\s+/).map(r=>r.trim()).filter(Boolean);if(!n.length)return[e];let t=new Set;return e&&t.add(e),n.forEach(r=>t.add(r)),Array.from(t)}function Te(s,i,e,n){let t=n?s.toLowerCase():s,r=n?i.toLowerCase():i;switch(e){case"contains":return t.includes(r);case"starts-with":return t.startsWith(r);case"ends-with":return t.endsWith(r);case"equals":default:return t===r}}function ye(s){var e;let i=(e=s.matchType)!=null?e:"equals";if(i==="regex"){let n=s.value instanceof RegExp?s.value.source:String(s.value),t=s.value instanceof RegExp?s.value.flags:"";return{key:s.key,matchType:i,value:n,isRegex:!0,flags:t,caseInsensitive:s.caseInsensitive}}return{key:s.key,matchType:i,value:String(s.value),caseInsensitive:s.caseInsensitive}}function re(s){return s.map(i=>{var t,r;let e=(t=i.matchType)!=null?t:"equals",n={key:i.key,matchType:e,value:e==="regex"&&i.value instanceof RegExp?i.value.source:String(i.value),destination:i.destination,enabled:(r=i.enabled)!=null?r:!1,debug:i.debug,caseInsensitive:i.caseInsensitive,conditionOperator:i.conditionOperator,conflictResolution:i.conflictResolution};return e==="regex"&&(n.isRegex=!0,n.flags=i.value instanceof RegExp?i.value.flags:""),i.conditions&&i.conditions.length>0&&(n.conditions=i.conditions.map(ye)),n})}function K(s){return s==="contains"||s==="starts-with"||s==="ends-with"}function j(s){return typeof s.value=="string"&&s.value.trim().length>0}function Re(s){var e;let i=(e=s.matchType)!=null?e:s.isRegex?"regex":"equals";if(i==="regex")try{let n=new RegExp(s.value,s.flags);return{key:s.key,matchType:i,value:n,caseInsensitive:s.caseInsensitive}}catch(n){console.warn(`[Vault Organizer] Failed to deserialize regex condition for key "${s.key}":`,n);return}return{key:s.key,matchType:i,value:s.value,caseInsensitive:s.caseInsensitive}}function ae(s=[]){let i=[],e=[],n=[];return s.forEach((t,r)=>{var l,c,h;let o=(l=t.matchType)!=null?l:t.isRegex?"regex":"equals",a;if(t.conditions&&t.conditions.length>0){let p=t.conditions.map(Re).filter(m=>m!==void 0);p.length>0&&(a=p)}if(o==="regex")try{let p=new RegExp(t.value,t.flags),m={key:t.key,matchType:o,value:p,destination:t.destination,enabled:(c=t.enabled)!=null?c:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:a,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};i.push(m),e.push({index:r,rule:m})}catch(p){let m=p instanceof Error?p.message:String(p),v=t.destination?` (destination: "${t.destination}")`:"",y=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${v}: ${m}. Rule will be ignored.`;console.warn(y),n.push({index:r,message:m,rule:{...t,matchType:o},cause:p})}else{let p={key:t.key,matchType:o,value:t.value,destination:t.destination,enabled:(h=t.enabled)!=null?h:!1,debug:t.debug,caseInsensitive:t.caseInsensitive,conditions:a,conditionOperator:t.conditionOperator,conflictResolution:t.conflictResolution};i.push(p),e.push({index:r,rule:p})}}),{rules:i,successes:e,errors:n}}var P=class extends Error{constructor(i){super(i),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},Q=class extends P{constructor(e,n,t){let r=N(n);super(`Permission denied: Cannot ${r} "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${N(this.operation)} "${this.filePath}". Check file permissions and try again.`}},L=class extends P{constructor(e,n,t,r,o){let a=N(r),l=n?`Cannot ${a} "${e}" to "${n}"`:`Cannot ${a} "${e}"`;super(`File conflict: ${l} - file ${t}`);this.sourcePath=e;this.destinationPath=n;this.conflictType=t;this.operation=r;this.originalError=o}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},n=N(this.operation);return`${this.destinationPath?`Cannot ${n} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${n} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},O=class extends P{constructor(e,n,t){super(`Invalid path "${e}": ${n}${t?` - ${t}`:""}`);this.path=e;this.reason=n;this.details=t}getUserMessage(){let n={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${n}${t}.`}},Z=class extends P{constructor(e,n,t){let r=N(n);super(`File operation failed: ${r} on "${e}"`);this.filePath=e;this.operation=n;this.originalError=t}getUserMessage(){var t;let e=N(this.operation),n=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${n}.`}};function D(s,i,e,n){let t=s instanceof Error?s:new Error(String(s)),r=t.message.toLowerCase();return r.includes("permission")||r.includes("eacces")||r.includes("eperm")||r.includes("access denied")?new Q(i,e,t):r.includes("already exists")||r.includes("eexist")||r.includes("file exists")?new L(i,n||i,"exists",e,t):r.includes("locked")||r.includes("ebusy")?new L(i,n||i,"locked",e,t):r.includes("in use")||r.includes("being used")||r.includes("etxtbsy")?new L(i,n||i,"in-use",e,t):r.includes("invalid path")||r.includes("invalid character")||r.includes("einval")?new O(n||i,"invalid-characters",t.message):r.includes("path too long")||r.includes("enametoolong")?new O(n||i,"too-long",t.message):new Z(i,e,t)}function N(s){return s.replace(/-/g," ")}var oe=require("obsidian");var J={windows:260,unix:4096,component:255},Se=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),Oe=/[<>:"|?*\x00-\x1F]/,be=/^([A-Za-z]:[\\/]|\/)/,xe=/(^|[\\/])\.\.($|[\\/])/,we=/\/{2,}|\\{2,}/;function M(s,i={}){let{allowEmpty:e=!1,allowAbsolute:n=!1,maxLength:t=J.windows,checkReservedNames:r=!0}=i,o=[];if(!s||s.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:o}:{valid:!1,error:new O(s,"empty")};if(be.test(s)&&!n)return{valid:!1,error:new O(s,"absolute","Use relative paths within the vault")};if(xe.test(s))return{valid:!1,error:new O(s,"traversal",'Paths cannot contain ".." segments')};let a=(0,oe.normalizePath)(s);we.test(a)&&(a=a.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),o.push("Multiple consecutive slashes were normalized")),a=a.trim().replace(/^\/+|\/+$/g,"");let l=a.match(Oe);if(l)return{valid:!1,error:new O(s,"invalid-characters",`Contains invalid character: "${l[0]}"`)};if(a.length>t)return{valid:!1,error:new O(s,"too-long",`Path length (${a.length}) exceeds maximum (${t})`)};let c=a.split("/").filter(Boolean);for(let h of c){if(h.length>J.component)return{valid:!1,error:new O(s,"too-long",`Path component "${h}" exceeds ${J.component} characters`)};if(r){let p=h.split(".")[0].toUpperCase();if(Se.has(p))return{valid:!1,error:new O(s,"reserved-name",`"${h}" is a reserved system name on Windows`)}}if(h.endsWith(".")||h.endsWith(" "))return{valid:!1,error:new O(s,"invalid-characters",`Path component "${h}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:a,warnings:o.length>0?o:void 0}}function U(s){return M(s,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var k={REORGANIZE:{name:"Reorganize notes based on frontmatter rules",description:"Apply all configured rules to reorganize vault files"},UNDO:{name:"Undo last automatic move",description:"Revert the most recent file move"},VIEW_HISTORY:{name:"View move history",description:"Show all recent file moves and undo options"}},R={RULE_NAME:"Frontmatter rule",RULE_DESCRIPTION:"Move files to destination folder based on frontmatter matching",EXCLUSION_PATTERNS_NAME:"Exclusion Patterns",EXCLUSION_PATTERNS_DESCRIPTION:"Files and folders matching these patterns will not be automatically organized",TOOLTIPS:{ACTIVATE_RULE:"Activate this rule",MOVE_UP:"Move rule up",MOVE_DOWN:"Move rule down",BROWSE_FRONTMATTER:"Browse frontmatter keys",BROWSE_TAGS:"Browse tags",CASE_INSENSITIVE:"Case insensitive matching",DEBUG_MODE:"Enable debug mode",TEST_ALL_RULES:"Preview what moves would be made without actually moving files",CONFLICT_RESOLUTION:"How to handle file conflicts at destination",CONDITION_OPERATOR:"How to combine multiple conditions (AND/OR)",ADD_CONDITION:"Add another condition to this rule",EXCLUSION_PATTERN:"Glob pattern (e.g., Templates/**, *.excalidraw)"},PLACEHOLDERS:{KEY:"key",VALUE:"value",DESTINATION:"destination folder (supports {variables})",FLAGS:"flags",EXCLUSION_PATTERN:"e.g., Templates/**, Archive/**"},BUTTONS:{REMOVE:"Remove",ADD_RULE:"Add Rule",APPLY_NOW:"Apply now",TEST_ALL_RULES:"Test All Rules",ADD_CONDITION:"+",REMOVE_CONDITION:"Remove Condition",ADD_EXCLUSION:"Add Pattern"},LABELS:{CONFLICT_RESOLUTION:"On Conflict:",CONDITION_OPERATOR:"Combine:",CONDITIONS_SECTION:"Additional Conditions"},WARNINGS:{INVALID_REGEX:s=>`Invalid regular expression: ${s}`,VALUE_REQUIRED:"Value is required for contains/starts-with/ends-with rules."}},f={TEST_ALL_RULES:{TITLE:"Test All Rules - Preview",NO_MOVES_OVERALL:"No files would be moved. All files are either already in the correct location or have no matching rules.",NO_MOVES_ALREADY_CORRECT:"No files would be moved. All matching files are already in the correct location.",FILES_WOULD_MOVE:s=>`${s} file(s) would be moved:`,SKIPPED_SECTION:"Skipped due to invalid destinations",INVALID_DESTINATION_WARNING:"Destination path is invalid and the move cannot be previewed.",LABELS:{FILE:"File:",FROM:"From:",TO:"To:",RULE:"Rule:",WARNINGS:"Warnings:"},BUTTONS:{CLOSE:"Close"}},MOVE_HISTORY:{TITLE:"Move History",NO_HISTORY:"No move history yet.",SHOWING_COUNT:(s,i)=>`Showing ${s} of last ${i} moves.`,MOST_RECENT_PREFIX:"\u{1F504} Most Recent: ",TIME_PREFIX:s=>`\u23F0 ${s}`,LABELS:{FROM:"From:",TO:"To:",RULE:"Rule:"},BUTTONS:{UNDO:"Undo This Move",CLEAR_HISTORY:"Clear History",CLOSE:"Close"},NOTICES:{HISTORY_CLEARED:"Move history cleared."}}},A={UNDO:{NO_MOVES:"No moves to undo.",FILE_NOT_EXISTS:s=>`Cannot undo: File no longer exists at ${s}`,NOT_A_FILE:s=>`Cannot undo: ${s} is not a file.`,DESTINATION_EXISTS:s=>`Cannot undo: A file already exists at ${s}`,SUCCESS:(s,i)=>`Undone: Moved ${s} back to ${i}`},DEBUG:{EMPTY_DESTINATION:(s,i)=>`DEBUG: ${s} would not be moved because destination is empty in ${i}.`,WOULD_MOVE:(s,i,e)=>`DEBUG: ${s} would be moved to ${i}/${e}`},REGEX_PARSE_ERROR:(s,i)=>`Failed to parse regular expression for rule "${s}": ${i}`},F={equals:"Equals",contains:"Contains","starts-with":"Starts with","ends-with":"Ends with",regex:"Regex"};var ee={rules:[],moveHistory:[],maxHistorySize:50,excludePatterns:[]},le=[{value:"equals",label:F.equals},{value:"contains",label:F.contains},{value:"starts-with",label:F["starts-with"]},{value:"ends-with",label:F["ends-with"]},{value:"regex",label:F.regex}];function z(s){var n,t,r,o,a,l;let i=(n=s.matchType)!=null?n:s.isRegex?"regex":"equals",e={...s,matchType:i,key:(t=s.key)!=null?t:"",value:(r=s.value)!=null?r:"",destination:(o=s.destination)!=null?o:"",enabled:(a=s.enabled)!=null?a:!1};return i==="regex"?(e.isRegex=!0,e.flags=(l=s.flags)!=null?l:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var x=require("obsidian");var C=require("obsidian");var $=class extends C.FuzzySuggestModal{constructor(e,n,t){super(e);this.tags=n;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},B=class extends C.FuzzySuggestModal{constructor(e,n,t){super(e);this.keys=n;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},H=class extends C.Modal{constructor(e,n,t){super(e);this.results=n;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:f.TEST_ALL_RULES.TITLE});let n=this.results.filter(a=>a.newPath&&!a.error),t=this.results.filter(a=>a.error);if(n.length===0&&t.length===0)e.createEl("p",{text:f.TEST_ALL_RULES.NO_MOVES_OVERALL});else{if(n.length){e.createEl("p",{text:f.TEST_ALL_RULES.FILES_WOULD_MOVE(n.length)});let a=e.createDiv({cls:"vault-organizer-test-results"});a.style.maxHeight="400px",a.style.overflowY="auto",a.style.marginTop="1em",n.forEach(l=>{var y,T;let c=a.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let h=c.createDiv();h.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:l.file.basename});let p=c.createDiv();p.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:l.currentPath});let m=c.createDiv();m.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.TO}),m.createSpan({text:l.newPath||"(unknown)"});let v=c.createDiv();if(v.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.RULE}),v.createSpan({text:`Rule ${l.ruleIndex+1} (${((y=this.rules[l.ruleIndex])==null?void 0:y.key)||"unknown"})`}),(T=l.warnings)!=null&&T.length){let g=c.createDiv();g.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.WARNINGS}),g.createSpan({text:l.warnings.join("; ")})}})}else e.createEl("p",{text:f.TEST_ALL_RULES.NO_MOVES_ALREADY_CORRECT});if(t.length){e.createEl("h3",{text:f.TEST_ALL_RULES.SKIPPED_SECTION});let a=e.createDiv({cls:"vault-organizer-test-results"});a.style.maxHeight="400px",a.style.overflowY="auto",a.style.marginTop="1em",t.forEach(l=>{var y,T,g,d;let c=a.createDiv({cls:"vault-organizer-test-result-item"});c.style.marginBottom="1em",c.style.padding="0.5em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px";let h=c.createDiv();h.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.FILE}),h.createSpan({text:l.file.basename});let p=c.createDiv();p.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.FROM}),p.createSpan({text:l.currentPath});let m=c.createDiv();m.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.RULE}),m.createSpan({text:`Rule ${l.ruleIndex+1} (${((y=this.rules[l.ruleIndex])==null?void 0:y.key)||"unknown"})`});let v=c.createDiv();if(v.createEl("strong",{text:"Reason: "}),v.createSpan({text:(g=(T=l.error)==null?void 0:T.getUserMessage())!=null?g:f.TEST_ALL_RULES.INVALID_DESTINATION_WARNING}),(d=l.warnings)!=null&&d.length){let u=c.createDiv();u.createEl("strong",{text:f.TEST_ALL_RULES.LABELS.WARNINGS}),u.createSpan({text:l.warnings.join("; ")})}})}}let r=e.createDiv({cls:"modal-button-container"});r.style.marginTop="1.5em",r.style.textAlign="right";let o=r.createEl("button",{text:f.TEST_ALL_RULES.BUTTONS.CLOSE});o.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},W=class extends C.Modal{constructor(e,n){super(e);this.plugin=n}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:f.MOVE_HISTORY.TITLE}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:f.MOVE_HISTORY.NO_HISTORY});else{e.createEl("p",{text:f.MOVE_HISTORY.SHOWING_COUNT(this.plugin.settings.moveHistory.length,this.plugin.settings.maxHistorySize)});let o=e.createDiv({cls:"vault-organizer-history-container"});o.style.maxHeight="500px",o.style.overflowY="auto",o.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((a,l)=>{let c=o.createDiv({cls:"vault-organizer-history-item"});c.style.marginBottom="1em",c.style.padding="0.8em",c.style.border="1px solid var(--background-modifier-border)",c.style.borderRadius="4px",c.style.position="relative",l===0&&(c.style.backgroundColor="var(--background-secondary-alt)",c.style.borderColor="var(--interactive-accent)");let h=c.createDiv();h.style.marginBottom="0.5em",h.style.fontWeight="bold";let m=new Date(a.timestamp).toLocaleString();l===0&&h.createEl("span",{text:f.MOVE_HISTORY.MOST_RECENT_PREFIX,cls:"vault-organizer-recent-label"}),h.createSpan({text:a.fileName});let v=c.createDiv();v.style.fontSize="0.9em",v.style.color="var(--text-muted)",v.style.marginBottom="0.5em",v.textContent=f.MOVE_HISTORY.TIME_PREFIX(m);let y=c.createDiv();y.createEl("strong",{text:f.MOVE_HISTORY.LABELS.FROM}),y.createSpan({text:a.fromPath});let T=c.createDiv();T.createEl("strong",{text:f.MOVE_HISTORY.LABELS.TO}),T.createSpan({text:a.toPath});let g=c.createDiv();if(g.createEl("strong",{text:f.MOVE_HISTORY.LABELS.RULE}),g.createSpan({text:a.ruleKey||"(unknown)"}),l===0){let d=c.createDiv();d.style.marginTop="0.8em";let u=d.createEl("button",{text:f.MOVE_HISTORY.BUTTONS.UNDO});u.style.backgroundColor="var(--interactive-accent)",u.style.color="var(--text-on-accent)",u.style.padding="0.4em 0.8em",u.style.border="none",u.style.borderRadius="4px",u.style.cursor="pointer",u.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="1.5em",n.style.textAlign="right";let t=n.createEl("button",{text:f.MOVE_HISTORY.BUTTONS.CLEAR_HISTORY});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new C.Notice(f.MOVE_HISTORY.NOTICES.HISTORY_CLEARED),this.close()};let r=n.createEl("button",{text:f.MOVE_HISTORY.BUTTONS.CLOSE});r.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}};var Ae=300,Ie=1e3,G=class extends x.PluginSettingTab{constructor(e,n){super(e,n);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=n,this.debouncedSaveOnly=(0,x.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},Ae),this.debouncedRefreshMetadata=(0,x.debounce)(()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()},Ie),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.debouncedRefreshMetadata()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,r,o;let e=new Set;((o=(r=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(t))!=null?o:[]).forEach(a=>{let l=this.plugin.app.metadataCache.getFileCache(a);if(!l)return;let c=(0,x.getAllTags)(l);c&&c.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((a,l)=>a.localeCompare(l))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,r,o;let e=new Set;((o=(r=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(t))!=null?o:[]).forEach(a=>{let l=this.plugin.app.metadataCache.getFileCache(a),c=l==null?void 0:l.frontmatter;c&&Object.keys(c).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((a,l)=>a.localeCompare(l))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,n){if(!e.length)return;new $(this.app,e,n).open()}openFrontmatterKeyPicker(e,n){if(!e.length)return;new B(this.app,e,n).open()}toggleTagValue(e,n){let t=e.split(/\s+/).filter(Boolean);return(t.includes(n)?t.filter(a=>a!==n):[...t,n]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(z),this.plugin.settings.rules.forEach((n,t)=>{var T;let r=(T=n.matchType)!=null?T:"equals",o=new x.Setting(e).setName(`${R.RULE_NAME} ${t+1}`).setDesc(R.RULE_DESCRIPTION);o.settingEl.classList.add("setting-item");let a=document.createElement("div");a.classList.add("vault-organizer-rule-message"),a.style.display="none",o.settingEl.appendChild(a);let l=()=>{var u;let g=this.plugin.settings.rules[t],d=(u=g==null?void 0:g.enabled)!=null?u:!1;o.settingEl.classList.toggle("vault-organizer-rule-disabled",!d)};o.addToggle(g=>{var d;return g.setTooltip(R.TOOLTIPS.ACTIVATE_RULE).setValue((d=n.enabled)!=null?d:!1).onChange(async u=>{let E=this.plugin.settings.rules[t];E&&(E.enabled=u,l(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),l())})}),o.addExtraButton(g=>g.setIcon("arrow-up").setTooltip(R.TOOLTIPS.MOVE_UP).setDisabled(t===0).onClick(async()=>{if(t===0)return;let d=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),o.addExtraButton(g=>g.setIcon("arrow-down").setTooltip(R.TOOLTIPS.MOVE_DOWN).setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let d=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=d,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let c=()=>{var b;let g=this.plugin.getRuleErrorForIndex(t),d=this.plugin.settings.rules[t],u=(b=d==null?void 0:d.matchType)!=null?b:"equals",E=K(u),w=d?j(d):!1;g?(a.classList.add("vault-organizer-rule-error"),a.classList.remove("vault-organizer-rule-warning"),a.textContent=R.WARNINGS.INVALID_REGEX(g.message),a.style.display=""):E&&!w?(a.classList.add("vault-organizer-rule-warning"),a.classList.remove("vault-organizer-rule-error"),a.textContent=R.WARNINGS.VALUE_REQUIRED,a.style.display=""):(a.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),a.textContent="",a.style.display="none")},h;o.addText(g=>{h=g,g.setPlaceholder(R.PLACEHOLDERS.KEY).setValue(n.key).onChange(d=>{let u=this.plugin.settings.rules[t];u&&(u.key=d,this.scheduleSaveOnly())})}),o.addExtraButton(g=>g.setIcon("list").setTooltip(R.TOOLTIPS.BROWSE_FRONTMATTER).onClick(()=>{let d=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(d,u=>{let E=this.plugin.settings.rules[t];!E||!h||(h.setValue(u),E.key=u,this.scheduleSaveOnly())})}));let p;o.addText(g=>{p=g,g.setPlaceholder(R.PLACEHOLDERS.VALUE).setValue(n.value).onChange(d=>{let u=this.plugin.settings.rules[t];u&&(u.value=d,this.scheduleSaveOnly(),c())})}),o.addExtraButton(g=>g.setIcon("hashtag").setTooltip(R.TOOLTIPS.BROWSE_TAGS).onClick(()=>{let d=this.getAggregatedTags();this.openTagPicker(d,u=>{let E=this.plugin.settings.rules[t];if(!E||!p)return;let w=this.toggleTagValue(p.getValue(),u);p.setValue(w),E.value=w,this.scheduleSaveOnly()})})),o.addText(g=>g.setPlaceholder(R.PLACEHOLDERS.DESTINATION).setValue(n.destination).onChange(d=>{let u=this.plugin.settings.rules[t];u&&(u.destination=d,this.scheduleSaveOnly())}));let m,v,y=()=>{var u;let g=this.plugin.settings.rules[t],d=((u=g==null?void 0:g.matchType)!=null?u:"equals")==="regex";m&&(m.inputEl.toggleAttribute("disabled",!d),m.inputEl.disabled=!d,m.inputEl.style.display=d?"":"none"),v&&(v.toggleEl.style.display=d?"none":"")};o.addDropdown(g=>{g.selectEl.setAttribute("aria-label","Match type"),le.forEach(d=>g.addOption(d.value,d.label)),g.setValue(r).onChange(async d=>{var E;let u=this.plugin.settings.rules[t];u&&(u.matchType=d,d==="regex"?(u.isRegex=!0,u.flags=(E=u.flags)!=null?E:""):(delete u.isRegex,"flags"in u&&delete u.flags),y(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),y(),c())})}),o.addDropdown(g=>{var d;g.selectEl.setAttribute("aria-label","Conflict resolution"),g.selectEl.setAttribute("title",R.TOOLTIPS.CONFLICT_RESOLUTION),g.addOption("fail","Fail"),g.addOption("skip","Skip"),g.addOption("append-number","Add number"),g.addOption("append-timestamp","Add timestamp"),g.setValue((d=n.conflictResolution)!=null?d:"fail").onChange(u=>{let E=this.plugin.settings.rules[t];E&&(E.conflictResolution=u,this.scheduleSaveOnly())})}),o.addText(g=>{var d;m=g,g.setPlaceholder(R.PLACEHOLDERS.FLAGS).setValue((d=n.flags)!=null?d:"").onChange(u=>{let E=this.plugin.settings.rules[t];E&&E.matchType==="regex"&&(E.flags=u,this.scheduleSaveOnly())})}),y(),o.addToggle(g=>{var d;v=g,g.setTooltip(R.TOOLTIPS.CASE_INSENSITIVE).setValue((d=n.caseInsensitive)!=null?d:!1).onChange(async u=>{let E=this.plugin.settings.rules[t];E&&(E.caseInsensitive=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),o.addToggle(g=>{var d;return g.setTooltip(R.TOOLTIPS.DEBUG_MODE).setValue((d=n.debug)!=null?d:!1).onChange(async u=>{let E=this.plugin.settings.rules[t];E&&(E.debug=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),o.addButton(g=>g.setButtonText(R.BUTTONS.REMOVE).onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),c(),l()}),new x.Setting(e).addButton(n=>n.setButtonText(R.BUTTONS.ADD_RULE).onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new x.Setting(e).addButton(n=>n.setButtonText(R.BUTTONS.APPLY_NOW).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(n=>n.setButtonText(R.BUTTONS.TEST_ALL_RULES).setTooltip(R.TOOLTIPS.TEST_ALL_RULES).onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new H(this.app,t,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,r)=>{var v,y;let o=t.querySelector(".vault-organizer-rule-message");if(!o)return;let a=this.plugin.settings.rules[r],l=(v=a==null?void 0:a.enabled)!=null?v:!1;t.classList.toggle("vault-organizer-rule-disabled",!l);let c=this.plugin.getRuleErrorForIndex(r),h=(y=a==null?void 0:a.matchType)!=null?y:"equals",p=K(h),m=a?j(a):!1;c?(o.classList.add("vault-organizer-rule-error"),o.classList.remove("vault-organizer-rule-warning"),o.textContent=R.WARNINGS.INVALID_REGEX(c.message),o.style.display=""):p&&!m?(o.classList.add("vault-organizer-rule-warning"),o.classList.remove("vault-organizer-rule-error"),o.textContent=R.WARNINGS.VALUE_REQUIRED,o.style.display=""):(o.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),o.textContent="",o.style.display="none")})}};function Le(s){let i=/\{([^}]+)\}/g,e=[],n;for(;(n=i.exec(s))!==null;)e.push(n[1]);return e}function ce(s){if(s==null)return"";let i=String(s);return i=i.replace(/[<>:"|?*]/g,""),i=i.replace(/\\/g,"-"),i=i.replace(/\//g,"-"),i=i.trim().replace(/^\.+|\.+$/g,""),i=i.replace(/\s+/g," "),i}function te(s,i){let e=Le(s);if(e.length===0)return{substitutedPath:s,substituted:[],missing:[],hasVariables:!1};let n=[],t=[],r=s;for(let o of e){let a=i==null?void 0:i[o];if(a==null)t.push(o),r=r.replace(new RegExp(`\\{${ue(o)}\\}`,"g"),"");else{n.push(o);let l;Array.isArray(a)?l=a.map(c=>ce(c)).filter(Boolean).join(","):l=ce(a),r=r.replace(new RegExp(`\\{${ue(o)}\\}`,"g"),l)}}return r=r.replace(/\/+/g,"/").replace(/^\/+|\/+$/g,""),r=r.split("/").filter(Boolean).join("/"),{substitutedPath:r,substituted:n,missing:t,hasVariables:!0}}function ue(s){return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Pe(s){let i="^",e=0;for(;e<s.length;){let n=s[e];if(n==="*")s[e+1]==="*"?(i+=".*",e+=2):(i+="[^/]*",e+=1);else if(n==="?")i+="[^/]",e+=1;else if(n==="["){let t=s.indexOf("]",e);t===-1?(i+="\\[",e+=1):(i+=s.substring(e,t+1),e=t+1)}else/[.+^${}()|\\]/.test(n)?(i+="\\"+n,e+=1):(i+=n,e+=1)}return i+="$",new RegExp(i)}function ne(s,i){if(!i||i.length===0)return!1;let e=s.replace(/\\/g,"/");for(let n of i){if(!n||n.trim()==="")continue;let t=n.trim().replace(/\\/g,"/");if(Pe(t).test(e))return!0;let o=t.replace(/\/$/,"");if(e.startsWith(o+"/"))return!0}return!1}var Y=class extends S.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[];this.batchOperationInProgress=!1}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async n=>{!(n instanceof S.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async n=>{!(n instanceof S.TFile)||n.extension!=="md"||await this.applyRulesToFile(n)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:k.REORGANIZE.name,callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:k.UNDO.name,callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:k.VIEW_HISTORY.name,callback:()=>{new W(this.app,this).open()}}),this.ruleSettingTab=new G(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),n=Array.isArray(e==null?void 0:e.rules)?e.rules.map(z):[];this.settings={...ee,...e,rules:n,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:ee.maxHistorySize,excludePatterns:Array.isArray(e==null?void 0:e.excludePatterns)?e.excludePatterns:[]}}async saveSettings(){this.settings.rules=this.settings.rules.map(z),!this.batchOperationInProgress&&await this.saveData(this.settings)}async withBatchOperation(e){if(this.batchOperationInProgress)return console.warn("[Vault Organizer] Nested batch operations are not supported. Using existing batch context."),await e();this.batchOperationInProgress=!0;try{return await e()}finally{this.batchOperationInProgress=!1,await this.saveData(this.settings)}}updateRulesFromSettings(){let{rules:e,successes:n,errors:t}=ae(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:n,errors:t}}async persistSettingsAndRefreshRules(){var o;let{successes:e,errors:n}=this.updateRulesFromSettings(),t=re(e.map(a=>a.rule)),r=[...this.settings.rules];e.forEach((a,l)=>{r[a.index]=t[l]}),this.settings.rules=r,await this.saveSettings(),n.length&&n.forEach(a=>{let l=a.rule.key||"(unnamed rule)",c=A.REGEX_PARSE_ERROR(l,a.message);new S.Notice(c)}),(o=this.ruleSettingTab)==null||o.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(n=>n.index===e)}async recordMove(e,n,t,r,o=!1){if(!e||!n||!t)throw new Error("Invalid move parameters: fromPath, toPath, and fileName are required");let a={timestamp:Date.now(),fileName:t,fromPath:e,toPath:n,ruleKey:r};this.settings.moveHistory.unshift(a),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),o||await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new S.Notice(A.UNDO.NO_MOVES);return}let e=this.settings.moveHistory[0],n=this.app.vault.getAbstractFileByPath(e.toPath);if(!n){new S.Notice(A.UNDO.FILE_NOT_EXISTS(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(n instanceof S.TFile)){new S.Notice(A.UNDO.NOT_A_FILE(e.toPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new S.Notice(A.UNDO.DESTINATION_EXISTS(e.fromPath)),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let r=e.fromPath.lastIndexOf("/");if(r>0){let o=e.fromPath.substring(0,r);await this.ensureFolderExists(o)}await this.app.fileManager.renameFile(n,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new S.Notice(A.UNDO.SUCCESS(e.fileName,e.fromPath))}catch(r){let o=D(r,e.toPath,"move",e.fromPath);new S.Notice(o.getUserMessage()),console.error("[Vault Organizer] Undo failed:",r)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let n=M(e,{allowEmpty:!1,allowAbsolute:!1});if(!n.valid||!n.sanitizedPath)throw n.error||new Error("Path validation failed");let r=n.sanitizedPath.split("/").filter(Boolean);if(!r.length)return;let o="";for(let a of r){o=o?`${o}/${a}`:a;let l=this.app.vault.getAbstractFileByPath(o);if(l){if(l instanceof S.TFile)throw new L(o,void 0,"exists","create-folder");continue}try{await this.app.vault.createFolder(o)}catch(c){throw D(c,o,"create-folder")}}}generateUniqueFilename(e,n,t){if(t==="append-timestamp"){let a=Date.now();return`${e}-${a}${n}`}let r=1,o=`${e}-${r}${n}`;for(;this.app.vault.getAbstractFileByPath(o);)r++,o=`${e}-${r}${n}`;return o}async applyRulesToFile(e,n=!1){var r;let t;try{if(ne(e.path,this.settings.excludePatterns))return;let o=this.app.metadataCache.getFileCache(e),a=o==null?void 0:o.frontmatter;if(!a)return;let l=X.call(this,e,this.rules,a);if(!l)return;let c=l.destination.trim();if(!c){if(l.debug){let u=this.app.vault.getName();new S.Notice(A.DEBUG.EMPTY_DESTINATION(e.basename,u))}return}let h=te(c,a),p=h.substitutedPath;l.debug&&h.missing.length>0&&new S.Notice(`DEBUG: Missing variables in destination: ${h.missing.join(", ")}`);let m=U(p);if(!m.valid||!m.sanitizedPath)throw m.error||new Error("Destination path validation failed");let v=m.sanitizedPath,y=M(`${v}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!y.valid||!y.sanitizedPath)throw y.error||new Error("Full path validation failed");let T=y.sanitizedPath;if(t=T,e.path===T)return;if(l.debug){let u=this.app.vault.getName();new S.Notice(A.DEBUG.WOULD_MOVE(e.basename,u,v));return}if(await this.ensureFolderExists(v),this.app.vault.getAbstractFileByPath(T)){let u=(r=l.conflictResolution)!=null?r:"fail";if(u==="skip")return;if(u==="append-number"||u==="append-timestamp"){let E=e.name.lastIndexOf("."),w=E>0?e.name.substring(0,E):e.name,b=E>0?e.name.substring(E):"",V=`${v}/${w}`;T=this.generateUniqueFilename(V,b,u),t=T}else throw new L(T,e.path,"exists","move")}let d=e.path;try{await this.app.fileManager.renameFile(e,T),await this.recordMove(d,T,e.name,l.key,n)}catch(u){throw D(u,e.path,"move",T)}}catch(o){if(o instanceof P)new S.Notice(o.getUserMessage()),console.error(`[Vault Organizer] ${o.name}:`,o.message,o);else{let a=D(o,e.path,"move",t);new S.Notice(a.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",o)}}}async reorganizeAllMarkdownFiles(){var n,t;let e=(t=(n=this.app.vault).getMarkdownFiles)==null?void 0:t.call(n);e!=null&&e.length&&await this.withBatchOperation(async()=>{for(let r of e)await this.applyRulesToFile(r,!0)})}testAllRules(){var t,r,o,a,l,c,h,p;let e=((r=(t=this.app.vault).getMarkdownFiles)==null?void 0:r.call(t))||[],n=[];for(let m of e){if(ne(m.path,this.settings.excludePatterns))continue;let v=this.app.metadataCache.getFileCache(m),y=v==null?void 0:v.frontmatter;if(!y)continue;let T=this.rules.findIndex(I=>I.enabled===!1?!1:X.call(this,m,[I],y));if(T===-1)continue;let d=this.rules[T].destination.trim();if(!d)continue;let u=te(d,y),E=u.substitutedPath,w=u.missing.length>0?[`Missing variables: ${u.missing.join(", ")}`]:[],b=U(E);if(!b.valid){n.push({file:m,currentPath:m.path,ruleIndex:T,error:b.error,warnings:[...w,...(o=b.warnings)!=null?o:[]]});continue}let V=(a=b.sanitizedPath)!=null?a:"",ge=V?`${V}/${m.name}`:m.name,_=M(ge,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!_.valid||!_.sanitizedPath){let I=[...w,...(l=b.warnings)!=null?l:[],...(c=_.warnings)!=null?c:[]];n.push({file:m,currentPath:m.path,ruleIndex:T,error:_.error,warnings:I.length?I:void 0});continue}let se=_.sanitizedPath;if(m.path!==se){let I=[...w,...(h=b.warnings)!=null?h:[],...(p=_.warnings)!=null?p:[]];n.push({file:m,currentPath:m.path,newPath:se,ruleIndex:T,warnings:I.length?I:void 0})}}return n}};
