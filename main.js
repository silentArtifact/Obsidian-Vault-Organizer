/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var T=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var M=Object.getOwnPropertyNames;var $=Object.prototype.hasOwnProperty;var q=(g,l)=>{for(var t in l)T(g,t,{get:l[t],enumerable:!0})},B=(g,l,t,s)=>{if(l&&typeof l=="object"||typeof l=="function")for(let e of M(l))!$.call(g,e)&&e!==t&&T(g,e,{get:()=>l[e],enumerable:!(s=D(l,e))||s.enumerable});return g};var K=g=>B(T({},"__esModule",{value:!0}),g);var H={};q(H,{default:()=>F});module.exports=K(H);var d=require("obsidian");function w(g,l){var s;let t=(s=this.app.metadataCache.getFileCache(g))==null?void 0:s.frontmatter;if(t)return l.find(e=>{var m;if(e.enabled===!1)return!1;let r=t[e.key];if(r==null)return!1;let n=Array.isArray(r),a=n?r:[r],i=(m=e.matchType)!=null?m:"equals";if(i==="regex"){if(!(e.value instanceof RegExp))return!1;let y=e.value;return a.some(v=>{let b=String(v);return y.lastIndex=0,y.test(b)})}let p=L(String(e.value),n),h=i==="contains"||i==="starts-with"||i==="ends-with"?p.filter(y=>y.length>0):p;return h.length?a.some(y=>{let v=String(y);return h.some(b=>W(v,b,i,e.caseInsensitive))}):!1})}function L(g,l){if(!l)return[g];let t=g.trim(),s=t.split(/\s+/).map(r=>r.trim()).filter(Boolean);if(!s.length)return[t];let e=new Set;return t&&e.add(t),s.forEach(r=>e.add(r)),Array.from(e)}function W(g,l,t,s){let e=s?g.toLowerCase():g,r=s?l.toLowerCase():l;switch(t){case"contains":return e.includes(r);case"starts-with":return e.startsWith(r);case"ends-with":return e.endsWith(r);case"equals":default:return e===r}}function V(g){return g.map(l=>{var s,e,r;let t=(s=l.matchType)!=null?s:"equals";if(t==="regex"){let n=l.value instanceof RegExp?l.value.source:String(l.value),a=l.value instanceof RegExp?l.value.flags:"";return{key:l.key,matchType:t,value:n,destination:l.destination,enabled:(e=l.enabled)!=null?e:!1,isRegex:!0,flags:a,debug:l.debug,caseInsensitive:l.caseInsensitive}}return{key:l.key,matchType:t,value:String(l.value),destination:l.destination,enabled:(r=l.enabled)!=null?r:!1,debug:l.debug,caseInsensitive:l.caseInsensitive}})}function S(g){return g==="contains"||g==="starts-with"||g==="ends-with"}function x(g){return typeof g.value=="string"&&g.value.trim().length>0}function O(g=[]){let l=[],t=[],s=[];return g.forEach((e,r)=>{var a,i,p;let n=(a=e.matchType)!=null?a:e.isRegex?"regex":"equals";if(n==="regex")try{let h=new RegExp(e.value,e.flags),m={key:e.key,matchType:n,value:h,destination:e.destination,enabled:(i=e.enabled)!=null?i:!1,debug:e.debug,caseInsensitive:e.caseInsensitive};l.push(m),t.push({index:r,rule:m})}catch(h){let m=h instanceof Error?h.message:String(h),y=e.destination?` (destination: "${e.destination}")`:"",v=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${e.key}"${y}: ${m}. Rule will be ignored.`;console.warn(v),s.push({index:r,message:m,rule:{...e,matchType:n},cause:h})}else{let h={key:e.key,matchType:n,value:e.value,destination:e.destination,enabled:(p=e.enabled)!=null?p:!1,debug:e.debug,caseInsensitive:e.caseInsensitive};l.push(h),t.push({index:r,rule:h})}}),{rules:l,successes:t,errors:s}}var N={rules:[]},G=[{value:"equals",label:"Equals"},{value:"contains",label:"Contains"},{value:"starts-with",label:"Starts with"},{value:"ends-with",label:"Ends with"},{value:"regex",label:"Regular expression"}];function E(g){var s,e,r,n,a,i;let l=(s=g.matchType)!=null?s:g.isRegex?"regex":"equals",t={...g,matchType:l,key:(e=g.key)!=null?e:"",value:(r=g.value)!=null?r:"",destination:(n=g.destination)!=null?n:"",enabled:(a=g.enabled)!=null?a:!1};return l==="regex"?(t.isRegex=!0,t.flags=(i=g.flags)!=null?i:""):(delete t.isRegex,"flags"in t&&delete t.flags),t}var F=class extends d.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[]}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let t=async s=>{!(s instanceof d.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)};this.registerEvent(this.app.vault.on("modify",t)),this.registerEvent(this.app.vault.on("create",t)),this.registerEvent(this.app.vault.on("rename",t)),this.registerEvent(this.app.metadataCache.on("changed",async s=>{!(s instanceof d.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:"Reorganize notes based on frontmatter rules",callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.ruleSettingTab=new z(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){let t=await this.loadData(),s=Array.isArray(t==null?void 0:t.rules)?t.rules.map(E):[];this.settings={...N,...t,rules:s}}async saveSettings(){let t=this.settings.rules.map(E);this.settings.rules=t,await this.saveData({...this.settings,rules:t})}updateRulesFromSettings(){let{rules:t,successes:s,errors:e}=O(this.settings.rules);return this.rules=t,this.ruleParseErrors=e,{successes:s,errors:e}}async persistSettingsAndRefreshRules(){var n;let{successes:t,errors:s}=this.updateRulesFromSettings(),e=V(t.map(a=>a.rule)),r=[...this.settings.rules];t.forEach((a,i)=>{r[a.index]=e[i]}),this.settings.rules=r,await this.saveSettings(),s.length&&s.forEach(a=>{let p=`Failed to parse regular expression for rule "${a.rule.key||"(unnamed rule)"}": ${a.message}`;new d.Notice(p)}),(n=this.ruleSettingTab)==null||n.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(t){return this.ruleParseErrors.find(s=>s.index===t)}async ensureFolderExists(t){if(!t||t==="."||t==="/")return;let s=(0,d.normalizePath)(t).split("/").filter(Boolean);if(!s.length)return;let e="";for(let r of s)e=e?`${e}/${r}`:r,!this.app.vault.getAbstractFileByPath(e)&&await this.app.vault.createFolder(e)}async applyRulesToFile(t){var r;let s=t.basename,e;try{if(!((r=this.app.metadataCache.getFileCache(t))==null?void 0:r.frontmatter))return;let a=w.call(this,t,this.rules);if(!a)return;let i=a.destination.trim();if(!i){if(a.debug){let m=this.app.vault.getName();new d.Notice(`DEBUG: ${t.basename} would not be moved because destination is empty in ${m}.`)}return}let p=(0,d.normalizePath)(i),h=(0,d.normalizePath)(`${i}/${t.name}`);if(e=h,t.path===h)return;if(a.debug){let m=this.app.vault.getName();new d.Notice(`DEBUG: ${t.basename} would be moved to ${m}/${i}`);return}await this.ensureFolderExists(p),await this.app.fileManager.renameFile(t,h)}catch(n){let a=n instanceof Error?n.message:String(n),i=e!=null?e:"the configured destination";new d.Notice(`Failed to move "${s}" to "${i}": ${a}`),console.error("Failed to handle file change",n)}}async reorganizeAllMarkdownFiles(){var s,e;let t=(e=(s=this.app.vault).getMarkdownFiles)==null?void 0:e.call(s);if(t!=null&&t.length)for(let r of t)await this.applyRulesToFile(r)}testAllRules(){var e,r,n;let t=((r=(e=this.app.vault).getMarkdownFiles)==null?void 0:r.call(e))||[],s=[];for(let a of t){if(!((n=this.app.metadataCache.getFileCache(a))==null?void 0:n.frontmatter))continue;let p=this.rules.findIndex(v=>v.enabled===!1?!1:w.call(this,a,[v]));if(p===-1)continue;let m=this.rules[p].destination.trim();if(!m)continue;let y=(0,d.normalizePath)(`${m}/${a.name}`);a.path!==y&&s.push({file:a,currentPath:a.path,newPath:y,ruleIndex:p})}return s}},z=class extends d.PluginSettingTab{constructor(t,s){super(t,s);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=s,this.debouncedSaveOnly=(0,d.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},300),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var e,r,n;let t=new Set;((n=(r=(e=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(e))!=null?n:[]).forEach(a=>{let i=this.plugin.app.metadataCache.getFileCache(a);if(!i)return;let p=(0,d.getAllTags)(i);p&&p.forEach(h=>t.add(h))}),this.aggregatedTags=Array.from(t).sort((a,i)=>a.localeCompare(i))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var e,r,n;let t=new Set;((n=(r=(e=this.plugin.app.vault).getMarkdownFiles)==null?void 0:r.call(e))!=null?n:[]).forEach(a=>{let i=this.plugin.app.metadataCache.getFileCache(a),p=i==null?void 0:i.frontmatter;p&&Object.keys(p).filter(h=>h!=="position").forEach(h=>t.add(h))}),this.frontmatterKeys=Array.from(t).sort((a,i)=>a.localeCompare(i))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(t,s){if(!t.length)return;new C(this.app,t,s).open()}openFrontmatterKeyPicker(t,s){if(!t.length)return;new k(this.app,t,s).open()}toggleTagValue(t,s){let e=t.split(/\s+/).filter(Boolean);return(e.includes(s)?e.filter(a=>a!==s):[...e,s]).join(" ")}display(){let{containerEl:t}=this;t.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(E),this.plugin.settings.rules.forEach((s,e)=>{var P;let r=(P=s.matchType)!=null?P:"equals",n=new d.Setting(t).setName(`Rule ${e+1}`).setDesc("Destination folder is required before the rule can move files.");n.settingEl.classList.add("setting-item");let a=document.createElement("div");a.classList.add("vault-organizer-rule-warning"),a.style.display="none",n.settingEl.appendChild(a);let i=()=>{var c;let u=this.plugin.settings.rules[e],o=(c=u==null?void 0:u.enabled)!=null?c:!1;n.settingEl.classList.toggle("vault-organizer-rule-disabled",!o)};n.addToggle(u=>{var o;return u.setTooltip("Activate this rule").setValue((o=s.enabled)!=null?o:!1).onChange(async c=>{let f=this.plugin.settings.rules[e];f&&(f.enabled=c,i(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),i())})}),n.addExtraButton(u=>u.setIcon("arrow-up").setTooltip("Move rule up").setDisabled(e===0).onClick(async()=>{if(e===0)return;let o=this.plugin.settings.rules[e];this.plugin.settings.rules[e]=this.plugin.settings.rules[e-1],this.plugin.settings.rules[e-1]=o,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),n.addExtraButton(u=>u.setIcon("arrow-down").setTooltip("Move rule down").setDisabled(e===this.plugin.settings.rules.length-1).onClick(async()=>{if(e===this.plugin.settings.rules.length-1)return;let o=this.plugin.settings.rules[e];this.plugin.settings.rules[e]=this.plugin.settings.rules[e+1],this.plugin.settings.rules[e+1]=o,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let p=()=>{var I;let u=this.plugin.getRuleErrorForIndex(e),o=this.plugin.settings.rules[e],c=(I=o==null?void 0:o.matchType)!=null?I:"equals",f=S(c),R=o?x(o):!1;u?(n.settingEl.classList.add("vault-organizer-rule-error"),a.textContent=`Invalid regular expression: ${u.message}`,a.style.display=""):f&&!R?(n.settingEl.classList.add("vault-organizer-rule-error"),a.textContent="Value is required for contains/starts-with/ends-with rules.",a.style.display=""):(n.settingEl.classList.remove("vault-organizer-rule-error"),a.textContent="",a.style.display="none")},h;n.addText(u=>{h=u,u.setPlaceholder("key").setValue(s.key).onChange(o=>{let c=this.plugin.settings.rules[e];c&&(c.key=o,this.scheduleSaveOnly())})}),n.addExtraButton(u=>u.setIcon("list").setTooltip("Browse frontmatter keys").onClick(()=>{let o=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(o,c=>{let f=this.plugin.settings.rules[e];!f||!h||(h.setValue(c),f.key=c,this.scheduleSaveOnly())})}));let m;n.addText(u=>{m=u,u.setPlaceholder("value").setValue(s.value).onChange(o=>{let c=this.plugin.settings.rules[e];c&&(c.value=o,this.scheduleSaveOnly(),p())})}),n.addExtraButton(u=>u.setIcon("hashtag").setTooltip("Browse tags").onClick(()=>{let o=this.getAggregatedTags();this.openTagPicker(o,c=>{let f=this.plugin.settings.rules[e];if(!f||!m)return;let R=this.toggleTagValue(m.getValue(),c);m.setValue(R),f.value=R,this.scheduleSaveOnly()})})),n.addText(u=>u.setPlaceholder("destination folder (required)").setValue(s.destination).onChange(o=>{let c=this.plugin.settings.rules[e];c&&(c.destination=o,this.scheduleSaveOnly())}));let y,v,b=()=>{var c;let u=this.plugin.settings.rules[e],o=((c=u==null?void 0:u.matchType)!=null?c:"equals")==="regex";y&&(y.inputEl.toggleAttribute("disabled",!o),y.inputEl.disabled=!o,y.inputEl.style.display=o?"":"none"),v&&(v.toggleEl.style.display=o?"none":"")};n.addDropdown(u=>{u.selectEl.setAttribute("aria-label","Match type"),G.forEach(o=>u.addOption(o.value,o.label)),u.setValue(r).onChange(async o=>{var f;let c=this.plugin.settings.rules[e];c&&(c.matchType=o,o==="regex"?(c.isRegex=!0,c.flags=(f=c.flags)!=null?f:""):(delete c.isRegex,"flags"in c&&delete c.flags),b(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),b(),p())})}),n.addText(u=>{var o;y=u,u.setPlaceholder("flags").setValue((o=s.flags)!=null?o:"").onChange(c=>{let f=this.plugin.settings.rules[e];f&&f.matchType==="regex"&&(f.flags=c,this.scheduleSaveOnly())})}),b(),n.addToggle(u=>{var o;v=u,u.setTooltip("Case insensitive matching").setValue((o=s.caseInsensitive)!=null?o:!1).onChange(async c=>{let f=this.plugin.settings.rules[e];f&&(f.caseInsensitive=c,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),n.addToggle(u=>{var o;return u.setTooltip("Enable debug mode").setValue((o=s.debug)!=null?o:!1).onChange(async c=>{let f=this.plugin.settings.rules[e];f&&(f.debug=c,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),n.addButton(u=>u.setButtonText("Remove").onClick(async()=>{this.plugin.settings.rules.splice(e,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),p(),i()}),new d.Setting(t).addButton(s=>s.setButtonText("Add Rule").onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new d.Setting(t).addButton(s=>s.setButtonText("Apply now").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(s=>s.setButtonText("Test All Rules").setTooltip("Preview what moves would be made without actually moving files").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let e=this.plugin.testAllRules();new A(this.app,e,this.plugin.settings.rules).open()}))}refreshWarnings(){let{containerEl:t}=this;if(!t)return;t.querySelectorAll(".setting-item").forEach((e,r)=>{var v,b;let n=e.querySelector(".vault-organizer-rule-warning");if(!n)return;let a=this.plugin.settings.rules[r],i=(v=a==null?void 0:a.enabled)!=null?v:!1;e.classList.toggle("vault-organizer-rule-disabled",!i);let p=this.plugin.getRuleErrorForIndex(r),h=(b=a==null?void 0:a.matchType)!=null?b:"equals",m=S(h),y=a?x(a):!1;p?(e.classList.add("vault-organizer-rule-error"),n.textContent=`Invalid regular expression: ${p.message}`,n.style.display=""):m&&!y?(e.classList.add("vault-organizer-rule-error"),n.textContent="Value is required for contains/starts-with/ends-with rules.",n.style.display=""):(e.classList.remove("vault-organizer-rule-error"),n.textContent="",n.style.display="none")})}},C=class extends d.FuzzySuggestModal{constructor(t,s,e){super(t);this.tags=s;this.onSelect=e}getItems(){return this.tags}getItemText(t){return t}onChooseItem(t){this.onSelect(t)}},k=class extends d.FuzzySuggestModal{constructor(t,s,e){super(t);this.keys=s;this.onSelect=e}getItems(){return this.keys}getItemText(t){return t}onChooseItem(t){this.onSelect(t)}},A=class extends d.Modal{constructor(t,s,e){super(t);this.results=s;this.rules=e}onOpen(){let{contentEl:t}=this;if(t.empty(),t.createEl("h2",{text:"Test All Rules - Preview"}),this.results.length===0)t.createEl("p",{text:"No files would be moved. All files are either already in the correct location or have no matching rules."});else{t.createEl("p",{text:`${this.results.length} file(s) would be moved:`});let r=t.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",this.results.forEach((n,a)=>{var v;let i=r.createDiv({cls:"vault-organizer-test-result-item"});i.style.marginBottom="1em",i.style.padding="0.5em",i.style.border="1px solid var(--background-modifier-border)",i.style.borderRadius="4px";let p=i.createDiv();p.createEl("strong",{text:"File: "}),p.createSpan({text:n.file.basename});let h=i.createDiv();h.createEl("strong",{text:"From: "}),h.createSpan({text:n.currentPath});let m=i.createDiv();m.createEl("strong",{text:"To: "}),m.createSpan({text:n.newPath});let y=i.createDiv();y.createEl("strong",{text:"Rule: "}),y.createSpan({text:`Rule ${n.ruleIndex+1} (${((v=this.rules[n.ruleIndex])==null?void 0:v.key)||"unknown"})`})})}let s=t.createDiv({cls:"modal-button-container"});s.style.marginTop="1.5em",s.style.textAlign="right";let e=s.createEl("button",{text:"Close"});e.onclick=()=>this.close()}onClose(){let{contentEl:t}=this;t.empty()}};
