/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var L=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var ee=Object.getOwnPropertyNames;var te=Object.prototype.hasOwnProperty;var se=(c,a)=>{for(var e in a)L(c,e,{get:a[e],enumerable:!0})},ne=(c,a,e,s)=>{if(a&&typeof a=="object"||typeof a=="function")for(let t of ee(a))!te.call(c,t)&&t!==e&&L(c,t,{get:()=>a[t],enumerable:!(s=Q(a,t))||s.enumerable});return c};var re=c=>ne(L({},"__esModule",{value:!0}),c);var he={};se(he,{default:()=>H});module.exports=re(he);var w=require("obsidian");var ie=new Set(["__proto__","constructor","prototype"]);function N(c,a,e){var t;let s=e!=null?e:(t=this.app.metadataCache.getFileCache(c))==null?void 0:t.frontmatter;if(s)return a.find(n=>{var p;if(n.enabled===!1||ie.has(n.key))return!1;let i=s[n.key];if(i==null)return!1;let r=Array.isArray(i),o=r?i:[i],l=(p=n.matchType)!=null?p:"equals";if(l==="regex"){if(!(n.value instanceof RegExp))return!1;let v=n.value;return o.some(f=>{let x=String(f);return v.lastIndex=0,v.test(x)})}let u=ae(String(n.value),r),m=l==="contains"||l==="starts-with"||l==="ends-with"?u.filter(v=>v.length>0):u;return m.length?o.some(v=>{let f=String(v);return m.some(x=>oe(f,x,l,n.caseInsensitive))}):!1})}function ae(c,a){if(!a)return[c];let e=c.trim(),s=e.split(/\s+/).map(n=>n.trim()).filter(Boolean);if(!s.length)return[e];let t=new Set;return e&&t.add(e),s.forEach(n=>t.add(n)),Array.from(t)}function oe(c,a,e,s){let t=s?c.toLowerCase():c,n=s?a.toLowerCase():a;switch(e){case"contains":return t.includes(n);case"starts-with":return t.startsWith(n);case"ends-with":return t.endsWith(n);case"equals":default:return t===n}}function G(c){return c.map(a=>{var s,t,n;let e=(s=a.matchType)!=null?s:"equals";if(e==="regex"){let i=a.value instanceof RegExp?a.value.source:String(a.value),r=a.value instanceof RegExp?a.value.flags:"";return{key:a.key,matchType:e,value:i,destination:a.destination,enabled:(t=a.enabled)!=null?t:!1,isRegex:!0,flags:r,debug:a.debug,caseInsensitive:a.caseInsensitive}}return{key:a.key,matchType:e,value:String(a.value),destination:a.destination,enabled:(n=a.enabled)!=null?n:!1,debug:a.debug,caseInsensitive:a.caseInsensitive}})}function U(c){return c==="contains"||c==="starts-with"||c==="ends-with"}function q(c){return typeof c.value=="string"&&c.value.trim().length>0}function X(c=[]){let a=[],e=[],s=[];return c.forEach((t,n)=>{var r,o,l;let i=(r=t.matchType)!=null?r:t.isRegex?"regex":"equals";if(i==="regex")try{let u=new RegExp(t.value,t.flags),m={key:t.key,matchType:i,value:u,destination:t.destination,enabled:(o=t.enabled)!=null?o:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};a.push(m),e.push({index:n,rule:m})}catch(u){let m=u instanceof Error?u.message:String(u),p=t.destination?` (destination: "${t.destination}")`:"",v=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${p}: ${m}. Rule will be ignored.`;console.warn(v),s.push({index:n,message:m,rule:{...t,matchType:i},cause:u})}else{let u={key:t.key,matchType:i,value:t.value,destination:t.destination,enabled:(l=t.enabled)!=null?l:!1,debug:t.debug,caseInsensitive:t.caseInsensitive};a.push(u),e.push({index:n,rule:u})}}),{rules:a,successes:e,errors:s}}var z=class extends Error{constructor(a){super(a),this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},W=class extends z{constructor(e,s,t){let n=P(s);super(`Permission denied: Cannot ${n} "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){return`Permission denied: Cannot ${P(this.operation)} "${this.filePath}". Check file permissions and try again.`}},C=class extends z{constructor(e,s,t,n,i){let r=P(n),o=s?`Cannot ${r} "${e}" to "${s}"`:`Cannot ${r} "${e}"`;super(`File conflict: ${o} - file ${t}`);this.sourcePath=e;this.destinationPath=s;this.conflictType=t;this.operation=n;this.originalError=i}getUserMessage(){let e={exists:"a file already exists at that location",locked:"the destination file is locked","in-use":"the destination file is currently in use"},s=P(this.operation);return`${this.destinationPath?`Cannot ${s} "${this.sourcePath}" to "${this.destinationPath}"`:`Cannot ${s} "${this.sourcePath}"`}: ${e[this.conflictType]}.`}},b=class extends z{constructor(e,s,t){super(`Invalid path "${e}": ${s}${t?` - ${t}`:""}`);this.path=e;this.reason=s;this.details=t}getUserMessage(){let s={empty:"Path cannot be empty",absolute:"Absolute paths are not allowed",traversal:"Path traversal (../) is not allowed","invalid-characters":"Path contains invalid characters","too-long":"Path is too long","reserved-name":"Path uses a reserved system name"}[this.reason],t=this.details?` (${this.details})`:"";return`Invalid path "${this.path}": ${s}${t}.`}},_=class extends z{constructor(e,s,t){let n=P(s);super(`File operation failed: ${n} on "${e}"`);this.filePath=e;this.operation=s;this.originalError=t}getUserMessage(){var t;let e=P(this.operation),s=(t=this.originalError)!=null&&t.message?`: ${this.originalError.message}`:"";return`Failed to ${e} "${this.filePath}"${s}.`}};function k(c,a,e,s){let t=c instanceof Error?c:new Error(String(c)),n=t.message.toLowerCase();return n.includes("permission")||n.includes("eacces")||n.includes("eperm")||n.includes("access denied")?new W(a,e,t):n.includes("already exists")||n.includes("eexist")||n.includes("file exists")?new C(a,s||a,"exists",e,t):n.includes("locked")||n.includes("ebusy")?new C(a,s||a,"locked",e,t):n.includes("in use")||n.includes("being used")||n.includes("etxtbsy")?new C(a,s||a,"in-use",e,t):n.includes("invalid path")||n.includes("invalid character")||n.includes("einval")?new b(s||a,"invalid-characters"):n.includes("path too long")||n.includes("enametoolong")?new b(s||a,"too-long"):new _(a,e,t)}function P(c){return c.replace(/-/g," ")}var T=require("obsidian"),$=class extends T.FuzzySuggestModal{constructor(e,s,t){super(e);this.tags=s;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},O=class extends T.FuzzySuggestModal{constructor(e,s,t){super(e);this.keys=s;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},D=class extends T.Modal{constructor(e,s,t){super(e);this.results=s;this.rules=t}onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Test All Rules - Preview"});let s=this.results.filter(r=>r.newPath&&!r.error),t=this.results.filter(r=>r.error);if(s.length===0&&t.length===0)e.createEl("p",{text:"No files would be moved. All files are either already in the correct location or have no matching rules."});else{if(s.length){e.createEl("p",{text:`${s.length} file(s) would be moved:`});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",s.forEach(o=>{var f,x;let l=r.createDiv({cls:"vault-organizer-test-result-item"});l.style.marginBottom="1em",l.style.padding="0.5em",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="4px";let u=l.createDiv();u.createEl("strong",{text:"File: "}),u.createSpan({text:o.file.basename});let m=l.createDiv();m.createEl("strong",{text:"From: "}),m.createSpan({text:o.currentPath});let p=l.createDiv();p.createEl("strong",{text:"To: "}),p.createSpan({text:o.newPath||"(unknown)"});let v=l.createDiv();if(v.createEl("strong",{text:"Rule: "}),v.createSpan({text:`Rule ${o.ruleIndex+1} (${((f=this.rules[o.ruleIndex])==null?void 0:f.key)||"unknown"})`}),(x=o.warnings)!=null&&x.length){let d=l.createDiv();d.createEl("strong",{text:"Warnings: "}),d.createSpan({text:o.warnings.join("; ")})}})}else e.createEl("p",{text:"No files would be moved. All matching files are already in the correct location."});if(t.length){e.createEl("h3",{text:"Skipped due to invalid destinations"});let r=e.createDiv({cls:"vault-organizer-test-results"});r.style.maxHeight="400px",r.style.overflowY="auto",r.style.marginTop="1em",t.forEach(o=>{var f,x,d,g;let l=r.createDiv({cls:"vault-organizer-test-result-item"});l.style.marginBottom="1em",l.style.padding="0.5em",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="4px";let u=l.createDiv();u.createEl("strong",{text:"File: "}),u.createSpan({text:o.file.basename});let m=l.createDiv();m.createEl("strong",{text:"From: "}),m.createSpan({text:o.currentPath});let p=l.createDiv();p.createEl("strong",{text:"Rule: "}),p.createSpan({text:`Rule ${o.ruleIndex+1} (${((f=this.rules[o.ruleIndex])==null?void 0:f.key)||"unknown"})`});let v=l.createDiv();if(v.createEl("strong",{text:"Reason: "}),v.createSpan({text:(d=(x=o.error)==null?void 0:x.getUserMessage())!=null?d:"Destination path is invalid and the move cannot be previewed."}),(g=o.warnings)!=null&&g.length){let h=l.createDiv();h.createEl("strong",{text:"Warnings: "}),h.createSpan({text:o.warnings.join("; ")})}})}}let n=e.createDiv({cls:"modal-button-container"});n.style.marginTop="1.5em",n.style.textAlign="right";let i=n.createEl("button",{text:"Close"});i.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},V=class extends T.Modal{constructor(e,s){super(e);this.plugin=s}onOpen(){let{contentEl:e}=this;if(e.empty(),e.createEl("h2",{text:"Move History"}),this.plugin.settings.moveHistory.length===0)e.createEl("p",{text:"No move history yet."});else{e.createEl("p",{text:`Showing ${this.plugin.settings.moveHistory.length} of last ${this.plugin.settings.maxHistorySize} moves.`});let i=e.createDiv({cls:"vault-organizer-history-container"});i.style.maxHeight="500px",i.style.overflowY="auto",i.style.marginTop="1em",this.plugin.settings.moveHistory.forEach((r,o)=>{let l=i.createDiv({cls:"vault-organizer-history-item"});l.style.marginBottom="1em",l.style.padding="0.8em",l.style.border="1px solid var(--background-modifier-border)",l.style.borderRadius="4px",l.style.position="relative",o===0&&(l.style.backgroundColor="var(--background-secondary-alt)",l.style.borderColor="var(--interactive-accent)");let u=l.createDiv();u.style.marginBottom="0.5em",u.style.fontWeight="bold";let p=new Date(r.timestamp).toLocaleString();o===0&&u.createEl("span",{text:"\u{1F504} Most Recent: ",cls:"vault-organizer-recent-label"}),u.createSpan({text:r.fileName});let v=l.createDiv();v.style.fontSize="0.9em",v.style.color="var(--text-muted)",v.style.marginBottom="0.5em",v.textContent=`\u23F0 ${p}`;let f=l.createDiv();f.createEl("strong",{text:"From: "}),f.createSpan({text:r.fromPath});let x=l.createDiv();x.createEl("strong",{text:"To: "}),x.createSpan({text:r.toPath});let d=l.createDiv();if(d.createEl("strong",{text:"Rule: "}),d.createSpan({text:r.ruleKey||"(unknown)"}),o===0){let g=l.createDiv();g.style.marginTop="0.8em";let h=g.createEl("button",{text:"Undo This Move"});h.style.backgroundColor="var(--interactive-accent)",h.style.color="var(--text-on-accent)",h.style.padding="0.4em 0.8em",h.style.border="none",h.style.borderRadius="4px",h.style.cursor="pointer",h.onclick=async()=>{this.close(),await this.plugin.undoLastMove()}}})}let s=e.createDiv({cls:"modal-button-container"});s.style.marginTop="1.5em",s.style.textAlign="right";let t=s.createEl("button",{text:"Clear History"});t.style.marginRight="0.5em",t.onclick=async()=>{this.plugin.settings.moveHistory=[],await this.plugin.saveSettings(),new T.Notice("Move history cleared."),this.close()};let n=s.createEl("button",{text:"Close"});n.onclick=()=>this.close()}onClose(){let{contentEl:e}=this;e.empty()}},B=class extends T.Modal{constructor(a,e,s,t){super(a),this.results=e,this.onConfirm=s,this.onCancel=t,this.validMoves=e.filter(n=>n.newPath&&!n.error).length,this.errorCount=e.filter(n=>n.error).length}onOpen(){let{contentEl:a}=this;a.empty(),a.createEl("h2",{text:"Confirm Bulk File Move"});let e=a.createDiv({cls:"vault-organizer-confirmation-summary"});if(e.createEl("p",{text:`${this.validMoves} file(s) will be moved based on your enabled rules.`}),this.errorCount>0){let r=e.createEl("p",{text:`\u26A0\uFE0F ${this.errorCount} file(s) have invalid destinations and will be skipped.`,cls:"vault-organizer-warning-text"});r.style.color="var(--text-warning)"}if(this.validMoves>0){let r=a.createEl("h3",{text:"Preview (first 10 moves)"});r.style.marginTop="1em";let o=a.createDiv({cls:"vault-organizer-preview-container"});if(o.style.maxHeight="300px",o.style.overflowY="auto",o.style.marginBottom="1em",o.style.padding="0.5em",o.style.backgroundColor="var(--background-secondary)",o.style.borderRadius="4px",this.results.filter(u=>u.newPath&&!u.error).slice(0,10).forEach(u=>{let m=o.createDiv({cls:"vault-organizer-preview-item"});m.style.marginBottom="0.5em",m.style.padding="0.5em",m.style.borderLeft="2px solid var(--interactive-accent)",m.createEl("div",{text:`\u{1F4C4} ${u.file.basename}`,cls:"vault-organizer-file-name"}).style.fontWeight="bold";let p=m.createDiv();p.style.fontSize="0.9em",p.style.color="var(--text-muted)",p.createSpan({text:`From: ${u.currentPath}`}),p.createEl("br"),p.createSpan({text:`To: ${u.newPath}`})}),this.validMoves>10){let u=o.createEl("p",{text:`... and ${this.validMoves-10} more file(s)`});u.style.textAlign="center",u.style.color="var(--text-muted)",u.style.fontStyle="italic"}}let s=a.createDiv({cls:"vault-organizer-warning-box"});s.style.padding="1em",s.style.marginBottom="1em",s.style.backgroundColor="var(--background-modifier-error)",s.style.borderRadius="4px",s.createEl("p",{text:"\u26A0\uFE0F This action cannot be undone for all files at once. You can undo individual moves from the move history."}).style.margin="0";let t=a.createDiv({cls:"vault-organizer-button-container"});t.style.display="flex",t.style.justifyContent="flex-end",t.style.gap="0.5em",t.style.marginTop="1em";let n=t.createEl("button",{text:"Cancel"});n.onclick=()=>{this.onCancel(),this.close()};let i=t.createEl("button",{text:`Move ${this.validMoves} file(s)`,cls:"mod-cta"});i.onclick=()=>{this.onConfirm(),this.close()},this.validMoves===0&&(i.disabled=!0)}onClose(){let{contentEl:a}=this;a.empty()}};var J=require("obsidian");var K={windows:260,unix:4096,component:255},le=new Set(["CON","PRN","AUX","NUL","COM1","COM2","COM3","COM4","COM5","COM6","COM7","COM8","COM9","LPT1","LPT2","LPT3","LPT4","LPT5","LPT6","LPT7","LPT8","LPT9"]),ce=/[<>:"|?*\x00-\x1F]/,ue=/^([A-Za-z]:[\\/]|\/)/,ge=/(^|[\\/])\.\.($|[\\/])/,de=/\/{2,}|\\{2,}/;function M(c,a={}){let{allowEmpty:e=!1,allowAbsolute:s=!1,maxLength:t=K.windows,checkReservedNames:n=!0}=a,i=[];if(!c||c.trim().length===0)return e?{valid:!0,sanitizedPath:"",warnings:i}:{valid:!1,error:new b(c,"empty")};if(ue.test(c)&&!s)return{valid:!1,error:new b(c,"absolute","Use relative paths within the vault")};if(ge.test(c))return{valid:!1,error:new b(c,"traversal",'Paths cannot contain ".." segments')};let r=(0,J.normalizePath)(c);de.test(r)&&(r=r.replace(/\/{2,}/g,"/").replace(/\\{2,}/g,"/"),i.push("Multiple consecutive slashes were normalized")),r=r.trim().replace(/^\/+|\/+$/g,"");let o=r.match(ce);if(o)return{valid:!1,error:new b(c,"invalid-characters",`Contains invalid character: "${o[0]}"`)};if(r.length>t)return{valid:!1,error:new b(c,"too-long",`Path length (${r.length}) exceeds maximum (${t})`)};let l=r.split("/").filter(Boolean);for(let u of l){if(u.length>K.component)return{valid:!1,error:new b(c,"too-long",`Path component "${u}" exceeds ${K.component} characters`)};if(n){let m=u.split(".")[0].toUpperCase();if(le.has(m))return{valid:!1,error:new b(c,"reserved-name",`"${u}" is a reserved system name on Windows`)}}if(u.endsWith(".")||u.endsWith(" "))return{valid:!1,error:new b(c,"invalid-characters",`Path component "${u}" cannot end with a dot or space`)}}return{valid:!0,sanitizedPath:r,warnings:i.length>0?i:void 0}}function Y(c){return M(c,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0})}var j={rules:[],moveHistory:[],maxHistorySize:50,confirmBeforeBulkMove:!0},Z=[{value:"equals",label:"Equals"},{value:"contains",label:"Contains"},{value:"starts-with",label:"Starts with"},{value:"ends-with",label:"Ends with"},{value:"regex",label:"Regular expression"}];function A(c){var s,t,n,i,r,o;let a=(s=c.matchType)!=null?s:c.isRegex?"regex":"equals",e={...c,matchType:a,key:(t=c.key)!=null?t:"",value:(n=c.value)!=null?n:"",destination:(i=c.destination)!=null?i:"",enabled:(r=c.enabled)!=null?r:!1};return a==="regex"?(e.isRegex=!0,e.flags=(o=c.flags)!=null?o:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var R=require("obsidian");var I=class extends R.PluginSettingTab{constructor(e,s){super(e,s);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=s,this.debouncedSaveOnly=(0,R.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},300),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,n,i;let e=new Set;((i=(n=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:n.call(t))!=null?i:[]).forEach(r=>{let o=this.plugin.app.metadataCache.getFileCache(r);if(!o)return;let l=(0,R.getAllTags)(o);l&&l.forEach(u=>e.add(u))}),this.aggregatedTags=Array.from(e).sort((r,o)=>r.localeCompare(o))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,n,i;let e=new Set;((i=(n=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:n.call(t))!=null?i:[]).forEach(r=>{let o=this.plugin.app.metadataCache.getFileCache(r),l=o==null?void 0:o.frontmatter;l&&Object.keys(l).filter(u=>u!=="position").forEach(u=>e.add(u))}),this.frontmatterKeys=Array.from(e).sort((r,o)=>r.localeCompare(o))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,s){if(!e.length)return;new $(this.app,e,s).open()}openFrontmatterKeyPicker(e,s){if(!e.length)return;new O(this.app,e,s).open()}toggleTagValue(e,s){let t=e.split(/\s+/).filter(Boolean);return(t.includes(s)?t.filter(r=>r!==s):[...t,s]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(A),this.plugin.settings.rules.forEach((s,t)=>{var x;let n=(x=s.matchType)!=null?x:"equals",i=new R.Setting(e).setName(`Rule ${t+1}`).setDesc("Destination folder is required before the rule can move files.");i.settingEl.classList.add("setting-item");let r=document.createElement("div");r.classList.add("vault-organizer-rule-message"),r.style.display="none",i.settingEl.appendChild(r);let o=()=>{var h;let d=this.plugin.settings.rules[t],g=(h=d==null?void 0:d.enabled)!=null?h:!1;i.settingEl.classList.toggle("vault-organizer-rule-disabled",!g)};i.addToggle(d=>{var g;return d.setTooltip("Activate this rule").setValue((g=s.enabled)!=null?g:!1).onChange(async h=>{let y=this.plugin.settings.rules[t];y&&(y.enabled=h,o(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),o())})}),i.addExtraButton(d=>d.setIcon("arrow-up").setTooltip("Move rule up").setDisabled(t===0).onClick(async()=>{if(t===0)return;let g=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t-1],this.plugin.settings.rules[t-1]=g,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),i.addExtraButton(d=>d.setIcon("arrow-down").setTooltip("Move rule down").setDisabled(t===this.plugin.settings.rules.length-1).onClick(async()=>{if(t===this.plugin.settings.rules.length-1)return;let g=this.plugin.settings.rules[t];this.plugin.settings.rules[t]=this.plugin.settings.rules[t+1],this.plugin.settings.rules[t+1]=g,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()}));let l=()=>{var F;let d=this.plugin.getRuleErrorForIndex(t),g=this.plugin.settings.rules[t],h=(F=g==null?void 0:g.matchType)!=null?F:"equals",y=U(h),E=g?q(g):!1;d?(r.classList.add("vault-organizer-rule-error"),r.classList.remove("vault-organizer-rule-warning"),r.textContent=`Invalid regular expression: ${d.message}`,r.style.display=""):y&&!E?(r.classList.add("vault-organizer-rule-warning"),r.classList.remove("vault-organizer-rule-error"),r.textContent="Value is required for contains/starts-with/ends-with rules.",r.style.display=""):(r.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),r.textContent="",r.style.display="none")},u;i.addText(d=>{u=d,d.setPlaceholder("key").setValue(s.key).onChange(g=>{let h=this.plugin.settings.rules[t];h&&(h.key=g,this.scheduleSaveOnly())})}),i.addExtraButton(d=>d.setIcon("list").setTooltip("Browse frontmatter keys").onClick(()=>{let g=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(g,h=>{let y=this.plugin.settings.rules[t];!y||!u||(u.setValue(h),y.key=h,this.scheduleSaveOnly())})}));let m;i.addText(d=>{m=d,d.setPlaceholder("value").setValue(s.value).onChange(g=>{let h=this.plugin.settings.rules[t];h&&(h.value=g,this.scheduleSaveOnly(),l())})}),i.addExtraButton(d=>d.setIcon("hashtag").setTooltip("Browse tags").onClick(()=>{let g=this.getAggregatedTags();this.openTagPicker(g,h=>{let y=this.plugin.settings.rules[t];if(!y||!m)return;let E=this.toggleTagValue(m.getValue(),h);m.setValue(E),y.value=E,this.scheduleSaveOnly()})})),i.addText(d=>d.setPlaceholder("destination folder (required)").setValue(s.destination).onChange(g=>{let h=this.plugin.settings.rules[t];h&&(h.destination=g,this.scheduleSaveOnly())}));let p,v,f=()=>{var h;let d=this.plugin.settings.rules[t],g=((h=d==null?void 0:d.matchType)!=null?h:"equals")==="regex";p&&(p.inputEl.toggleAttribute("disabled",!g),p.inputEl.disabled=!g,p.inputEl.style.display=g?"":"none"),v&&(v.toggleEl.style.display=g?"none":"")};i.addDropdown(d=>{d.selectEl.setAttribute("aria-label","Match type"),Z.forEach(g=>d.addOption(g.value,g.label)),d.setValue(n).onChange(async g=>{var y;let h=this.plugin.settings.rules[t];h&&(h.matchType=g,g==="regex"?(h.isRegex=!0,h.flags=(y=h.flags)!=null?y:""):(delete h.isRegex,"flags"in h&&delete h.flags),f(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),f(),l())})}),i.addText(d=>{var g;p=d,d.setPlaceholder("flags").setValue((g=s.flags)!=null?g:"").onChange(h=>{let y=this.plugin.settings.rules[t];y&&y.matchType==="regex"&&(y.flags=h,this.scheduleSaveOnly())})}),f(),i.addToggle(d=>{var g;v=d,d.setTooltip("Case insensitive matching").setValue((g=s.caseInsensitive)!=null?g:!1).onChange(async h=>{let y=this.plugin.settings.rules[t];y&&(y.caseInsensitive=h,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),i.addToggle(d=>{var g;return d.setTooltip("Enable debug mode").setValue((g=s.debug)!=null?g:!1).onChange(async h=>{let y=this.plugin.settings.rules[t];y&&(y.debug=h,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),i.addButton(d=>d.setButtonText("Remove").onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),l(),o()}),new R.Setting(e).addButton(s=>s.setButtonText("Add Rule").onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new R.Setting(e).addButton(s=>s.setButtonText("Apply now").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()})).addButton(s=>s.setButtonText("Test All Rules").setTooltip("Preview what moves would be made without actually moving files").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing();let t=this.plugin.testAllRules();new D(this.app,t,this.plugin.settings.rules).open()})),e.createEl("h3",{text:"General Settings"}),new R.Setting(e).setName("Confirm before bulk moves").setDesc('Show a confirmation dialog before moving multiple files with "Apply now". This helps prevent accidental mass file moves.').addToggle(s=>{var t;return s.setValue((t=this.plugin.settings.confirmBeforeBulkMove)!=null?t:!0).onChange(async n=>{this.plugin.settings.confirmBeforeBulkMove=n,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing()})})}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,n)=>{var v,f;let i=t.querySelector(".vault-organizer-rule-message");if(!i)return;let r=this.plugin.settings.rules[n],o=(v=r==null?void 0:r.enabled)!=null?v:!1;t.classList.toggle("vault-organizer-rule-disabled",!o);let l=this.plugin.getRuleErrorForIndex(n),u=(f=r==null?void 0:r.matchType)!=null?f:"equals",m=U(u),p=r?q(r):!1;l?(i.classList.add("vault-organizer-rule-error"),i.classList.remove("vault-organizer-rule-warning"),i.textContent=`Invalid regular expression: ${l.message}`,i.style.display=""):m&&!p?(i.classList.add("vault-organizer-rule-warning"),i.classList.remove("vault-organizer-rule-error"),i.textContent="Value is required for contains/starts-with/ends-with rules.",i.style.display=""):(i.classList.remove("vault-organizer-rule-warning","vault-organizer-rule-error"),i.textContent="",i.style.display="none")})}};var H=class extends w.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[]}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async s=>{!(s instanceof w.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async s=>{!(s instanceof w.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:"Reorganize notes based on frontmatter rules",callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.addCommand({id:"obsidian-vault-organizer-undo-last-move",name:"Undo last automatic move",callback:async()=>{await this.undoLastMove()}}),this.addCommand({id:"obsidian-vault-organizer-view-history",name:"View move history",callback:()=>{new V(this.app,this).open()}}),this.ruleSettingTab=new I(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){var t;let e=await this.loadData(),s=Array.isArray(e==null?void 0:e.rules)?e.rules.map(A):[];this.settings={...j,...e,rules:s,moveHistory:Array.isArray(e==null?void 0:e.moveHistory)?e.moveHistory:[],maxHistorySize:(t=e==null?void 0:e.maxHistorySize)!=null?t:j.maxHistorySize}}async saveSettings(){let e=this.settings.rules.map(A);this.settings.rules=e,await this.saveData({...this.settings,rules:e})}updateRulesFromSettings(){let{rules:e,successes:s,errors:t}=X(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:s,errors:t}}async persistSettingsAndRefreshRules(){var i;let{successes:e,errors:s}=this.updateRulesFromSettings(),t=G(e.map(r=>r.rule)),n=[...this.settings.rules];e.forEach((r,o)=>{n[r.index]=t[o]}),this.settings.rules=n,await this.saveSettings(),s.length&&s.forEach(r=>{let l=`Failed to parse regular expression for rule "${r.rule.key||"(unnamed rule)"}": ${r.message}`;new w.Notice(l)}),(i=this.ruleSettingTab)==null||i.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(s=>s.index===e)}async recordMove(e,s,t,n){let i={timestamp:Date.now(),fileName:t,fromPath:e,toPath:s,ruleKey:n};this.settings.moveHistory.unshift(i),this.settings.moveHistory.length>this.settings.maxHistorySize&&(this.settings.moveHistory=this.settings.moveHistory.slice(0,this.settings.maxHistorySize)),await this.saveSettings()}async undoLastMove(){if(this.settings.moveHistory.length===0){new w.Notice("No moves to undo.");return}let e=this.settings.moveHistory[0],s=this.app.vault.getAbstractFileByPath(e.toPath);if(!s){new w.Notice(`Cannot undo: File no longer exists at ${e.toPath}`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(!(s instanceof w.TFile)){new w.Notice(`Cannot undo: ${e.toPath} is not a file.`),this.settings.moveHistory.shift(),await this.saveSettings();return}if(this.app.vault.getAbstractFileByPath(e.fromPath)){new w.Notice(`Cannot undo: A file already exists at ${e.fromPath}`),this.settings.moveHistory.shift(),await this.saveSettings();return}try{let n=e.fromPath.lastIndexOf("/");if(n>0){let i=e.fromPath.substring(0,n);await this.ensureFolderExists(i)}await this.app.fileManager.renameFile(s,e.fromPath),this.settings.moveHistory.shift(),await this.saveSettings(),new w.Notice(`Undone: Moved ${e.fileName} back to ${e.fromPath}`)}catch(n){let i=k(n,e.toPath,"move",e.fromPath);new w.Notice(i.getUserMessage()),console.error("[Vault Organizer] Undo failed:",n)}}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let s=M(e,{allowEmpty:!1,allowAbsolute:!1});if(!s.valid||!s.sanitizedPath)throw s.error||new Error("Path validation failed");let n=s.sanitizedPath.split("/").filter(Boolean);if(!n.length)return;let i="";for(let r of n)if(i=i?`${i}/${r}`:r,!this.app.vault.getAbstractFileByPath(i))try{await this.app.vault.createFolder(i)}catch(o){throw k(o,i,"create-folder")}}async applyRulesToFile(e){var t;let s;try{let n=(t=this.app.metadataCache.getFileCache(e))==null?void 0:t.frontmatter;if(!n)return;let i=N.call(this,e,this.rules,n);if(!i)return;let r=i.destination.trim();if(!r){if(i.debug){let v=this.app.vault.getName();new w.Notice(`DEBUG: ${e.basename} would not be moved because destination is empty in ${v}.`)}return}let o=Y(r);if(!o.valid||!o.sanitizedPath)throw o.error||new Error("Destination path validation failed");let l=o.sanitizedPath,u=M(`${l}/${e.name}`,{allowEmpty:!1,allowAbsolute:!1});if(!u.valid||!u.sanitizedPath)throw u.error||new Error("Full path validation failed");let m=u.sanitizedPath;if(s=m,e.path===m)return;if(i.debug){let v=this.app.vault.getName();new w.Notice(`DEBUG: ${e.basename} would be moved to ${v}/${l}`);return}await this.ensureFolderExists(l);let p=e.path;try{await this.app.fileManager.renameFile(e,m),await this.recordMove(p,m,e.name,i.key)}catch(v){throw k(v,e.path,"move",m)}}catch(n){if(n instanceof z)new w.Notice(n.getUserMessage()),console.error(`[Vault Organizer] ${n.name}:`,n.message,n);else{let i=k(n,e.path,"move",s);new w.Notice(i.getUserMessage()),console.error("[Vault Organizer] Unexpected error:",n)}}}async reorganizeAllMarkdownFiles(){var s,t;let e=(t=(s=this.app.vault).getMarkdownFiles)==null?void 0:t.call(s);if(e!=null&&e.length){if(this.settings.confirmBeforeBulkMove){let n=this.testAllRules();if(n.filter(r=>r.newPath&&!r.error).length===0){new w.Notice("No files need to be moved. All files are already in their correct locations.");return}return new Promise(r=>{new B(this.app,n,async()=>{for(let l of e)await this.applyRulesToFile(l);r()},()=>{new w.Notice("Bulk move canceled."),r()}).open()})}for(let n of e)await this.applyRulesToFile(n)}}testAllRules(){var t,n,i,r,o,l,u,m;let e=((n=(t=this.app.vault).getMarkdownFiles)==null?void 0:n.call(t))||[],s=[];for(let p of e){let v=(i=this.app.metadataCache.getFileCache(p))==null?void 0:i.frontmatter;if(!v)continue;let f=this.rules.findIndex(S=>S.enabled===!1?!1:N.call(this,p,[S],v));if(f===-1)continue;let d=this.rules[f].destination.trim();if(!d)continue;let g=Y(d);if(!g.valid){s.push({file:p,currentPath:p.path,ruleIndex:f,error:g.error,warnings:g.warnings});continue}let h=(r=g.sanitizedPath)!=null?r:"",y=h?`${h}/${p.name}`:p.name,E=M(y,{allowEmpty:!1,allowAbsolute:!1,checkReservedNames:!0});if(!E.valid||!E.sanitizedPath){let S=[...(o=g.warnings)!=null?o:[],...(l=E.warnings)!=null?l:[]];s.push({file:p,currentPath:p.path,ruleIndex:f,error:E.error,warnings:S.length?S:void 0});continue}let F=E.sanitizedPath;if(p.path!==F){let S=[...(u=g.warnings)!=null?u:[],...(m=E.warnings)!=null?m:[]];s.push({file:p,currentPath:p.path,newPath:F,ruleIndex:f,warnings:S.length?S:void 0})}}return s}};
