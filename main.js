/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var F=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var P=Object.prototype.hasOwnProperty;var M=(c,i)=>{for(var e in i)F(c,e,{get:i[e],enumerable:!0})},V=(c,i,e,s)=>{if(i&&typeof i=="object"||typeof i=="function")for(let t of O(i))!P.call(c,t)&&t!==e&&F(c,t,{get:()=>i[t],enumerable:!(s=A(i,t))||s.enumerable});return c};var D=c=>V(F({},"__esModule",{value:!0}),c);var B={};M(B,{default:()=>R});module.exports=D(B);var d=require("obsidian");function z(c,i){var s;let e=(s=this.app.metadataCache.getFileCache(c))==null?void 0:s.frontmatter;if(e)return i.find(t=>{if(t.enabled===!1)return!1;let a=e[t.key];return a==null?!1:(Array.isArray(a)?a:[a]).some(r=>{let o=String(r);switch(t.matchType){case"regex":return t.value instanceof RegExp?(t.value.lastIndex=0,t.value.test(o)):!1;case"contains":return o.includes(String(t.value));case"starts-with":return o.startsWith(String(t.value));case"ends-with":return o.endsWith(String(t.value));case"equals":default:return o===String(t.value)}})})}function k(c){return c.map(i=>{var s,t,a;let e=(s=i.matchType)!=null?s:"equals";if(e==="regex"){let n=i.value instanceof RegExp?i.value.source:String(i.value),r=i.value instanceof RegExp?i.value.flags:"";return{key:i.key,matchType:e,value:n,destination:i.destination,enabled:(t=i.enabled)!=null?t:!1,isRegex:!0,flags:r,debug:i.debug}}return{key:i.key,matchType:e,value:String(i.value),destination:i.destination,enabled:(a=i.enabled)!=null?a:!1,debug:i.debug}})}function C(c=[]){let i=[],e=[],s=[];return c.forEach((t,a)=>{var r,o,p;let n=(r=t.matchType)!=null?r:t.isRegex?"regex":"equals";if(n==="regex")try{let h=new RegExp(t.value,t.flags),f={key:t.key,matchType:n,value:h,destination:t.destination,enabled:(o=t.enabled)!=null?o:!1,debug:t.debug};i.push(f),e.push({index:a,rule:f})}catch(h){let f=h instanceof Error?h.message:String(h),y=t.destination?` (destination: "${t.destination}")`:"",v=`[Obsidian Vault Organizer] Failed to deserialize regex for frontmatter rule "${t.key}"${y}: ${f}. Rule will be ignored.`;console.warn(v),s.push({index:a,message:f,rule:{...t,matchType:n},cause:h})}else{let h={key:t.key,matchType:n,value:t.value,destination:t.destination,enabled:(p=t.enabled)!=null?p:!1,debug:t.debug};i.push(h),e.push({index:a,rule:h})}}),{rules:i,successes:e,errors:s}}var $={rules:[]},I=[{value:"equals",label:"Equals"},{value:"contains",label:"Contains"},{value:"starts-with",label:"Starts with"},{value:"ends-with",label:"Ends with"},{value:"regex",label:"Regular expression"}];function b(c){var s,t,a,n,r,o;let i=(s=c.matchType)!=null?s:c.isRegex?"regex":"equals",e={...c,matchType:i,key:(t=c.key)!=null?t:"",value:(a=c.value)!=null?a:"",destination:(n=c.destination)!=null?n:"",enabled:(r=c.enabled)!=null?r:!1};return i==="regex"?(e.isRegex=!0,e.flags=(o=c.flags)!=null?o:""):(delete e.isRegex,"flags"in e&&delete e.flags),e}var R=class extends d.Plugin{constructor(){super(...arguments);this.rules=[];this.ruleParseErrors=[]}async onload(){await this.loadSettings(),this.updateRulesFromSettings();let e=async s=>{!(s instanceof d.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)};this.registerEvent(this.app.vault.on("modify",e)),this.registerEvent(this.app.vault.on("create",e)),this.registerEvent(this.app.vault.on("rename",e)),this.registerEvent(this.app.metadataCache.on("changed",async s=>{!(s instanceof d.TFile)||s.extension!=="md"||await this.applyRulesToFile(s)})),this.addCommand({id:"obsidian-vault-organizer-apply-rules",name:"Reorganize notes based on frontmatter rules",callback:async()=>{await this.reorganizeAllMarkdownFiles()}}),this.ruleSettingTab=new T(this.app,this),this.addSettingTab(this.ruleSettingTab)}onunload(){}async loadSettings(){let e=await this.loadData(),s=Array.isArray(e==null?void 0:e.rules)?e.rules.map(b):[];this.settings={...$,...e,rules:s}}async saveSettings(){let e=this.settings.rules.map(b);this.settings.rules=e,await this.saveData({...this.settings,rules:e})}updateRulesFromSettings(){let{rules:e,successes:s,errors:t}=C(this.settings.rules);return this.rules=e,this.ruleParseErrors=t,{successes:s,errors:t}}async persistSettingsAndRefreshRules(){var n;let{successes:e,errors:s}=this.updateRulesFromSettings(),t=k(e.map(r=>r.rule)),a=[...this.settings.rules];e.forEach((r,o)=>{a[r.index]=t[o]}),this.settings.rules=a,await this.saveSettings(),s.length&&s.forEach(r=>{let p=`Failed to parse regular expression for rule "${r.rule.key||"(unnamed rule)"}": ${r.message}`;new d.Notice(p)}),(n=this.ruleSettingTab)==null||n.refreshWarnings()}async saveSettingsWithoutReorganizing(){await this.persistSettingsAndRefreshRules()}async saveSettingsAndRefreshRules(){await this.persistSettingsAndRefreshRules(),await this.reorganizeAllMarkdownFiles()}getRuleErrorForIndex(e){return this.ruleParseErrors.find(s=>s.index===e)}async ensureFolderExists(e){if(!e||e==="."||e==="/")return;let s=(0,d.normalizePath)(e).split("/").filter(Boolean);if(!s.length)return;let t="";for(let a of s)t=t?`${t}/${a}`:a,!this.app.vault.getAbstractFileByPath(t)&&await this.app.vault.createFolder(t)}async applyRulesToFile(e){var s;try{if(!((s=this.app.metadataCache.getFileCache(e))==null?void 0:s.frontmatter))return;let a=z.call(this,e,this.rules);if(!a)return;let n=a.destination.trim();if(!n){if(a.debug){let p=this.app.vault.getName();new d.Notice(`DEBUG: ${e.basename} would not be moved because destination is empty in ${p}.`)}return}let r=(0,d.normalizePath)(n),o=(0,d.normalizePath)(`${n}/${e.name}`);if(e.path===o)return;if(a.debug){let p=this.app.vault.getName();new d.Notice(`DEBUG: ${e.basename} would be moved to ${p}/${n}`);return}await this.ensureFolderExists(r),await this.app.fileManager.renameFile(e,o)}catch(t){console.error("Failed to handle file change",t)}}async reorganizeAllMarkdownFiles(){var s,t;let e=(t=(s=this.app.vault).getMarkdownFiles)==null?void 0:t.call(s);if(e!=null&&e.length)for(let a of e)await this.applyRulesToFile(a)}},T=class extends d.PluginSettingTab{constructor(e,s){super(e,s);this.aggregatedTags=[];this.frontmatterKeys=[];this.plugin=s,this.debouncedSaveOnly=(0,d.debounce)(async()=>{await this.plugin.saveSettingsWithoutReorganizing()},300),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.registerEvent(this.plugin.app.metadataCache.on("resolved",()=>{this.refreshAggregatedTags(),this.refreshFrontmatterKeys()}))}scheduleSaveOnly(){this.debouncedSaveOnly()}cancelPendingSaveOnly(){this.debouncedSaveOnly.cancel()}refreshAggregatedTags(){var t,a,n;let e=new Set;((n=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?n:[]).forEach(r=>{let o=this.plugin.app.metadataCache.getFileCache(r);if(!o)return;let p=(0,d.getAllTags)(o);p&&p.forEach(h=>e.add(h))}),this.aggregatedTags=Array.from(e).sort((r,o)=>r.localeCompare(o))}getAggregatedTags(){return this.aggregatedTags.length||this.refreshAggregatedTags(),this.aggregatedTags}refreshFrontmatterKeys(){var t,a,n;let e=new Set;((n=(a=(t=this.plugin.app.vault).getMarkdownFiles)==null?void 0:a.call(t))!=null?n:[]).forEach(r=>{let o=this.plugin.app.metadataCache.getFileCache(r),p=o==null?void 0:o.frontmatter;p&&Object.keys(p).filter(h=>h!=="position").forEach(h=>e.add(h))}),this.frontmatterKeys=Array.from(e).sort((r,o)=>r.localeCompare(o))}getFrontmatterKeys(){return this.frontmatterKeys.length||this.refreshFrontmatterKeys(),this.frontmatterKeys}openTagPicker(e,s){if(!e.length)return;new S(this.app,e,s).open()}openFrontmatterKeyPicker(e,s){if(!e.length)return;new x(this.app,e,s).open()}toggleTagValue(e,s){let t=e.split(/\s+/).filter(Boolean);return(t.includes(s)?t.filter(r=>r!==s):[...t,s]).join(" ")}display(){let{containerEl:e}=this;e.empty(),this.refreshAggregatedTags(),this.refreshFrontmatterKeys(),this.plugin.settings.rules=this.plugin.settings.rules.map(b),this.plugin.settings.rules.forEach((s,t)=>{var w;let a=(w=s.matchType)!=null?w:"equals",n=new d.Setting(e).setName(`Rule ${t+1}`).setDesc("Destination folder is required before the rule can move files.");n.settingEl.classList.add("setting-item");let r=document.createElement("div");r.classList.add("vault-organizer-rule-warning"),r.style.display="none",n.settingEl.appendChild(r);let o=()=>{var u;let l=this.plugin.settings.rules[t],g=(u=l==null?void 0:l.enabled)!=null?u:!1;n.settingEl.classList.toggle("vault-organizer-rule-disabled",!g)};n.addToggle(l=>{var g;return l.setTooltip("Activate this rule").setValue((g=s.enabled)!=null?g:!1).onChange(async u=>{let m=this.plugin.settings.rules[t];m&&(m.enabled=u,o(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),o())})});let p=()=>{let l=this.plugin.getRuleErrorForIndex(t);l?(n.settingEl.classList.add("vault-organizer-rule-error"),r.textContent=`Invalid regular expression: ${l.message}`,r.style.display=""):(n.settingEl.classList.remove("vault-organizer-rule-error"),r.textContent="",r.style.display="none")},h;n.addText(l=>{h=l,l.setPlaceholder("key").setValue(s.key).onChange(g=>{let u=this.plugin.settings.rules[t];u&&(u.key=g,this.scheduleSaveOnly())})}),n.addExtraButton(l=>l.setIcon("list").setTooltip("Browse frontmatter keys").onClick(()=>{let g=this.getFrontmatterKeys();this.openFrontmatterKeyPicker(g,u=>{let m=this.plugin.settings.rules[t];!m||!h||(h.setValue(u),m.key=u,this.scheduleSaveOnly())})}));let f;n.addText(l=>{f=l,l.setPlaceholder("value").setValue(s.value).onChange(g=>{let u=this.plugin.settings.rules[t];u&&(u.value=g,this.scheduleSaveOnly())})}),n.addExtraButton(l=>l.setIcon("hashtag").setTooltip("Browse tags").onClick(()=>{let g=this.getAggregatedTags();this.openTagPicker(g,u=>{let m=this.plugin.settings.rules[t];if(!m||!f)return;let E=this.toggleTagValue(f.getValue(),u);f.setValue(E),m.value=E,this.scheduleSaveOnly()})})),n.addText(l=>l.setPlaceholder("destination folder (required)").setValue(s.destination).onChange(g=>{let u=this.plugin.settings.rules[t];u&&(u.destination=g,this.scheduleSaveOnly())}));let y,v=()=>{var u;let l=this.plugin.settings.rules[t],g=((u=l==null?void 0:l.matchType)!=null?u:"equals")==="regex";y&&(y.inputEl.toggleAttribute("disabled",!g),y.inputEl.disabled=!g,y.inputEl.style.display=g?"":"none")};n.addDropdown(l=>{l.selectEl.setAttribute("aria-label","Match type"),I.forEach(g=>l.addOption(g.value,g.label)),l.setValue(a).onChange(async g=>{var m;let u=this.plugin.settings.rules[t];u&&(u.matchType=g,g==="regex"?(u.isRegex=!0,u.flags=(m=u.flags)!=null?m:""):(delete u.isRegex,"flags"in u&&delete u.flags),v(),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules(),v())})}),n.addText(l=>{var g;y=l,l.setPlaceholder("flags").setValue((g=s.flags)!=null?g:"").onChange(u=>{let m=this.plugin.settings.rules[t];m&&m.matchType==="regex"&&(m.flags=u,this.scheduleSaveOnly())})}),v(),n.addToggle(l=>{var g;return l.setTooltip("Enable debug mode").setValue((g=s.debug)!=null?g:!1).onChange(async u=>{let m=this.plugin.settings.rules[t];m&&(m.debug=u,this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules())})}),n.addButton(l=>l.setButtonText("Remove").onClick(async()=>{this.plugin.settings.rules.splice(t,1),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),p(),o()}),new d.Setting(e).addButton(s=>s.setButtonText("Add Rule").onClick(async()=>{this.plugin.settings.rules.push({key:"",value:"",destination:"",matchType:"equals",debug:!1,enabled:!1}),this.cancelPendingSaveOnly(),await this.plugin.saveSettingsWithoutReorganizing(),this.display()})),new d.Setting(e).addButton(s=>s.setButtonText("Apply now").onClick(async()=>{this.cancelPendingSaveOnly(),await this.plugin.saveSettingsAndRefreshRules()}))}refreshWarnings(){let{containerEl:e}=this;if(!e)return;e.querySelectorAll(".setting-item").forEach((t,a)=>{var h;let n=t.querySelector(".vault-organizer-rule-warning");if(!n)return;let r=this.plugin.settings.rules[a],o=(h=r==null?void 0:r.enabled)!=null?h:!1;t.classList.toggle("vault-organizer-rule-disabled",!o);let p=this.plugin.getRuleErrorForIndex(a);p?(t.classList.add("vault-organizer-rule-error"),n.textContent=`Invalid regular expression: ${p.message}`,n.style.display=""):(t.classList.remove("vault-organizer-rule-error"),n.textContent="",n.style.display="none")})}},S=class extends d.FuzzySuggestModal{constructor(e,s,t){super(e);this.tags=s;this.onSelect=t}getItems(){return this.tags}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}},x=class extends d.FuzzySuggestModal{constructor(e,s,t){super(e);this.keys=s;this.onSelect=t}getItems(){return this.keys}getItemText(e){return e}onChooseItem(e){this.onSelect(e)}};
